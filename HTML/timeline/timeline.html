<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<script type="text/javascript">
  /* Select Files from FileDialog */
  window.onload = function() {
      if (typeof window.FileReader !== 'function') {
          alert("The file API isn't supported on this browser yet.");
      }
  }
  
  function readmultifiles(files) {
    filenames = [];
    filecontents = [];
    var ul = document.querySelector("#bag>ul");
    while (ul.hasChildNodes()) {
        ul.removeChild(ul.firstChild);
    }
    // Read first file
    setup_reader(files, 0);
    
  }

  // Don't define functions in functions in functions, when possible.

  function setup_reader(files, i) {
    var file = files[i];
    var name = file.name;
    var reader = new FileReader();
    reader.onload = function(e){
        readerLoaded(e, files, i, name);
    };
    reader.readAsBinaryString(file);
    // After reading, read the next file.
  }

  function readerLoaded(e, files, i, name) {
    // get file content  
    var bin = e.target.result;
    // do sth with text
    filenames.push(name);
    filecontents.push(bin);
    
    // If there's a file left to load
    if (i < files.length - 1) {
        // Load the next file
        setup_reader(files, i+1);
    }
    else{
      redrawchart();
    }
  }
  // Accepts a Date object or date string that is recognized by the Date.parse() method
  function getDayOfWeek(date) {
    var dayOfWeek = new Date(date).getDay();    
    return isNaN(dayOfWeek) ? null : ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][dayOfWeek];
  }
  //weekdays = ["Sun", "Mon", "Tue", "Wed", "Thr", "Fri", "Sat"];
  filenames = [];
  filecontents = [];
  google.charts.load("current", {packages:["timeline"]});
  google.charts.setOnLoadCallback(drawChart);
  
  function redrawchart()
  {
    
    var container = document.getElementById('board');
    var chart = new google.visualization.Timeline(container);
    var dataTable = new google.visualization.DataTable();
    dataTable.addColumn({ type: 'string', id: 'Date' });
    dataTable.addColumn({ type: 'string', id: 'Name' });
    dataTable.addColumn({ type: 'date', id: 'Start' });
    dataTable.addColumn({ type: 'date', id: 'End' });
    monstr = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "July", "Aug", "Sep", "Oct", "Nov", "Dec"];
    var options = {
      timeline: { singleColor: '#558' },
      avoidOverlappingGridLines: false,
      width: '100%', 
      height: '100%',
      viewWindow: {min: new Date(0,0,0,0,0,0),  max: new Date(0,0,0,24,0,0)   }
    };
     
    for (i = 0; i < filenames.length; i ++)
    {
      weekname = filenames[i].substring(0, filenames[i].lastIndexOf('.txt'));
      inputline = filecontents[i].split("\n");
      
      for (iline = 0; iline < inputline.length; iline ++)
      {
          //parsing "Content.js:14 11/2/2018, 10:30:28 AM : The contact goes online/offline"
      
          linedata0 = inputline[iline].split(" : ");
          if (linedata0.length != 2)
          {
            console.log("Bad File Format 1");
            break;
          }
         
          on_off_status = linedata0[1];// The contact goes online
          linedata1 = linedata0[0].split(", ");
          if (linedata1.length != 2)
          {
            console.log("Bad File Format 2");
            return;
          }
         
          time_apm_val = linedata1[1]; // 10:30:28 AM
          linedata2 = linedata1[0].split(" ");
          if (linedata2.length != 2)
          {
            console.log("Bad File Format 3");
            return;
          }
       
          date_val = linedata2[1]; // 11/2/2018
          linedata3 = time_apm_val.split(" ");
          if (linedata3.length != 2)
          {
            console.log("Bad File Format 4");
            return;
          }
         
          time_val = linedata3[0]; // 10:30:28
          apm_val = linedata3[1].toUpperCase(); // PM
          linedata4 = time_val.split(":");
          if (linedata4.length != 3)
          {
            console.log("Bad File Format 5");
            return;
          }
     
        
          hour_val = linedata4[0];
          min_val = linedata4[1];
          sec_val = linedata4[2];
     
          linedata5 = date_val.split("/");
          if (linedata5.length != 3)
          {
            console.log("Bad File Format 6");
            return;
          }
          
          mon_val = linedata5[0];
          day_val = linedata5[1];
          year_val = linedata5[2];
          if (iline == 0)
            start_day_val = day_val;
          else if (start_day_val != day_val)
          {
            alert("Bad File Format: There is data over one day. Ignore data from here");
            break;
          }
          topic = weekname + " " + monstr[mon_val - 1] + " " + day_val;
          
          if (apm_val == "PM" && hour_val < 12)
            hour_val = parseInt(hour_val, 10) + 12;
          else if (apm_val == "AM" && hour_val == 12)
            hour_val = 0;
          
          if (on_off_status.indexOf("online") > 0)
          {
              
              start_date = new Date(0, 0, 0, hour_val, min_val, (parseInt((sec_val - 1)/ 30) + 1) * 30);
          }
          else
          {
              end_date = new Date(0, 0, 0, hour_val, min_val, parseInt(sec_val / 30) * 30);
              if (end_date > start_date)
              {
                dataTable.addRows([
                  [ topic, '', start_date,  end_date ]
                  
                ]);
              }
          }
 
      }
    }
    
    chart.draw(dataTable, options);
   
  }
  
  function drawChart() {

    var container = document.getElementById('board');
    var chart = new google.visualization.Timeline(container);
    var dataTable = new google.visualization.DataTable();
    dataTable.addColumn({ type: 'string', id: 'Date' });
    dataTable.addColumn({ type: 'string', id: 'Name' });
    dataTable.addColumn({ type: 'date', id: 'Start' });
    dataTable.addColumn({ type: 'date', id: 'End' });
    
    dataTable.addRows([
      [ 'Week Month Day', '',       new Date(0,0,0,0,0,0),  new Date(0,0,0,0,0,0) ],
      [ 'Week Month Day', '',       new Date(0,0,0,24,0,0),  new Date(0,0,0,24,0,0) ]
     ]);
     

    var options = {
      timeline: { singleColor: '#558'},
      viewWindow: {min: new Date(0,0,0,0,0,0),  max: new Date(0,0,0,24,0,0)}
    };


    chart.draw(dataTable, options);
    
  }


</script>
 <body>

  
  <input type="file" id="filesx" name="filesx[]"
    onchange="readmultifiles(this.files);" multiple=""/>
  <div id="bag"><ul/></div>
  <pre id="data"></pre>
  <div id="board" style="height: 100%;" ></div>
</body>