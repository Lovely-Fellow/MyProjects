define(["./room","angular","lodash","jquery","../common/url-preview-setting-service"],function(e,t,r){"use strict";e.directive("eoRoomStoryList",function(){return{restrict:"EA",replace:!0,controllerAs:"roomStoryList",scope:!0,templateUrl:e.templatePath+"room-story-list-directive.html",controller:["$scope","$rootScope","$element","$attrs","$q","$timeout","$window","$document","eoAuth","htmlToTextFilter","dateFilter","eoPageVisibility","upMarkdownItFormatFilter","upDashMetrics","escapeHtmlFilter","eoBasicFormatFilter","eoDashConfig","eoDashContext","eoUrlPreviewSetting","eoUsers","deviceDetector",function(e,i,o,n,s,a,l,c,u,d,f,h,g,p,m,y,v,S,b,E,w){function $(){R.updateStoryVisibility(),R.updateContextualRoomTimestamp()}var x=p.getFirstRunSequence();x.time("StoryListDirectiveStart");var R=this,N=!1;R.stories=[],R.currentlyVisibleStoriesRange={start:-1,end:-1,initialized:!1},e.hideUrlPreview=b.get();var V=function(){return E.getLocalSettings(u.user.userId).then(function(t){e.hideUrlPreview=t.url.hidePreview,e.$emit("url:hideUrlPreviewSettingChanged")})};e.$on("url:hideUrlPreviewSettingChanged",function(){b.get()!==e.hideUrlPreview&&b.set(e.hideUrlPreview)}),e.$on("settings:updated",function(t,r){r&&r.url&&a(function(){e.hideUrlPreview=r.url.hidePreview}),V()}),V(),this.loadOlderStories=function(){return this.room.loadOlderStories()},this.loadNewerStories=function(){return this.room.loadNewerStories()},this.getStoryByElement=function(r){if(!r)return null;r=t.element(r);var i=r.attr("eo-story-id");return i||(i=r.is(".story-wrapper")?r.children("[eo-story-id]").attr("eo-story-id"):r.parents("[eo-story-id]").attr("eo-story-id"))?e.room.getStory(i):null},o.on("click","a.story-quote.direct",function(r){var i=t.element(r.currentTarget);if(!i.is(".panel-opener")){var o=R.getStoryByElement(i);o&&e.$emit("room:quote",o)}}),o.on("$destroy",function(){o.off("click")}),this.getLatestStory=function(){return R.stories[R.stories.length-1]},this.contextualRoomTimestamp=null,this.getFirstVisibleStory=function(){return this.stories?this.stories[this.currentlyVisibleStoriesRange.start]:null},this.getLastVisibleStory=function(){return this.stories?this.stories[this.currentlyVisibleStoriesRange.end]:null},this.shouldRenderStoryByIndex=function(e,t){return t=+t||1,!this.currentlyVisibleStoriesRange.initialized||this.currentlyVisibleStoriesRange.start-t<=e&&this.currentlyVisibleStoriesRange.end+t>=e},this.setVisibleStoriesRange=function(e,t){this.currentlyVisibleStoriesRange.start=+e,this.currentlyVisibleStoriesRange.end=+t,this.currentlyVisibleStoriesRange.initialized=!0},e.$on("scrollContinuum:visibilityChange",function(e,r,i){r=t.element(r);var o=r.attr("story-index")||r.parents(".story-wrapper").attr("story-index");i=t.element(i);var n=i.attr("story-index")||i.parents(".story-wrapper").attr("story-index");o=isNaN(+o)?R.currentlyVisibleStoriesRange.start:+o,n=isNaN(+n)?R.stories.length-1:+n,R.setVisibleStoriesRange(+o,+n),$()}),this.updateStoryVisibility=function(){if(!R.stories||e.leftNav||!h.isVisible()||!R.currentlyVisibleStoriesRange.initialized)return this;for(var t=R.currentlyVisibleStoriesRange.start;t<=R.currentlyVisibleStoriesRange.end;)C(R.stories[t]),t++;return this},this.updateContextualRoomTimestamp=function(){var e=this.getFirstVisibleStory();if(!e||!e.created)return this;var t=new Date(e.created).setHours(0,0,0,0);return this.contextualRoomTimestamp!==t&&(this.contextualRoomTimestamp=t,this.digest()),this};var I={},O=function(){var e=Object.keys(I);e.length&&(R.room&&t.forEach(e.slice(0,20),function(e){var t=I[e];delete I[e],R.room.readStory(t)}),R.digest())},T=r.throttle(O,500,{leading:!1,trailing:!0});e.wasSeen={};var C=function(t){t&&(e.wasSeen[t.storyId]=!0,t.wasRead||(I[t.storyId]=t,T()))};e.$onRootScope("story:editLast",function(){if(R.stories.length){var t=r.findLast(R.stories,function(e){return e.isOwner()&&!e.deleted&&u.organization.enableEditStory&&"eo:post"===e.actionType});t&&e.$broadcast("story:edit",t.storyId)}}),this.loadStory=function(t){return r.find(R.stories,function(e){return e.storyId===t})?s.when():(e.room.disregardMissingStories(!0),e.room.loadStoriesAround(t).finally(function(){e.room.disregardMissingStories(!1)}))},this.highlightStory=function(t){return a(function(){e.$broadcast("story:highlight:"+t)},200)},this.digest=function(){return e.$$phase||e.$digest(),this};var D=function(e){return!S.markdownEnabled(e.updated||e.created)},z=function e(r,i,o,n){if(!n&&(n=r.parents(".story-message-text"),!n.size()))return i;var s="";return n.contents().each(function(n,a){var l=3===a.nodeType;if(a=t.element(a),"P"===s&&++i,a.is(r))return!1;if(!l&&a.has(r).length)return i=e(r,i,o,a),!1;switch(s=a.prop("tagName")){case"BR":o&&++i;break;case"PRE":case"BLOCKQUOTE":i+=e(r,0,o,a);break;default:i+=a.text().length}}),i},L=function(e,r,i,o){if(e.is(".story-message-text")||e.parents(".story-message-text").size())return z(e,r,i);var n=e.parents().has(".story-message-text");if(!n.size())return o?0:9999;var s,a,l,c=-1,u=-1,d=3!==e.get(0).nodeType;if(n.contents().each(function(r,i){if(s=3===i.nodeType,i=t.element(i),(i.is(".story-message-text")||!s&&i.has(".story-message-text").size())&&(c=r,a=i),!i.is(e)&&(s&&d||!i.has(e).size())||(u=r,l=i),c>=0&&u>=0)return!1}),o){if(u<c)return 0;if(u>c)return null}else{if(c<u)return 9999;if(c>u)return 0}return z(e,r,i)},k=function(e,r){if(3===e.nodeType)return r;for(var i=0,o=0;o<r;++o)i+=t.element(e.childNodes[o]).text().length,"BR"===e.childNodes[o].tagName&&++i;return i},F=function(e){return{anchorNode:e.anchorNode,anchorOffset:k(e.anchorNode,e.anchorOffset),focusNode:e.focusNode,focusOffset:k(e.focusNode,e.focusOffset)}},P=function(e,i,o,n){var s,a,l,c,u,f=[],h=[],p=i?y:g,v=d(p(e.replace(/<([^|>]+)(?:\|([^>]+))?>/g,function(e,t,r){return f.push(t),""+(r||t)+""}),{emoji:!0,escaped:!0}).replace(/<b>/g,"").replace(/<\/b>/g,"").replace(/<em>/g,"").replace(/<\/em>/g,"").replace(/<pre><code(?: class=.*language-([a-z0-9-]+)[^>]+)?>/g,function(e,t){return h.push(t||""),""}).replace(/<\/code><\/pre>/g,"").replace(/<code>/g,"").replace(/<\/code>/g,"").replace(/<pre>/g,"").replace(/<\/pre>/g,"").replace(/<blockquote>/g,"").replace(/<\/blockquote>/g,"").replace(/<strong>/g,"").replace(/<\/strong>/g,"").replace(/<del>/g,"").replace(/<\/del>/g,"").replace(/<s>/g,"").replace(/<\/s>/g,"")),S=/[\uE000-\uE1FF]/g,b=[],E=[],w=[],$=!1;for(t.isUndefined(n)&&(n=v.length);null!==(c=S.exec(v))&&(l=c[0],s=l.charCodeAt(0),c.index<=o?++o:$=!0,c.index<n);)++n,s<57600?(b.push(s),w.push($)):(a=b.lastIndexOf(s-256))>-1&&(u=b.splice(a,1),$||57600!==s||f.shift(),$&&!w[a]&&(E=E.concat(u)),w.splice(a,1));r.some(w,function(e,t){return e||E.unshift(b[t]),e}),v=String.fromCharCode.apply(this,E)+m(v.slice(o,n))+String.fromCharCode.apply(this,b.reverse().map(function(e){return e+256}));var x=0,R=0;return v.replace(/\uE001(.*?)\uE101/g,"*$1*").replace(/\uE002(.*?)\uE102/g,"_$1_").replace(/\uE003(.*?)\uE103/g,"`$1`").replace(/\uE009([^\uE109]*)?\uE109/g,function(e,t){return"\n```"+h[R++]+"\n"+t+"\n```\n"}).replace(/\uE005([^]*?)\uE105/gm,function(e,t){return"&gt;"+t.replace(/\n/g,"\n&gt;")+"\n"}).replace(/\uE006(.*?)\uE106/g,"**$1**").replace(/\uE007(.*?)\uE107/g,"~~$1~~").replace(/\uE008(.*?)\uE108/g,"~~$1~~").replace(/\uE000(.*?)\uE100/g,function(e,t){return 0===t.length?"":f[x]===t?"<"+f[x++]+">":"<"+f[x++]+"|"+t+">"}).replace(/[\uE000-\uE1FF]/g,"")},U=function(){function r(r){var i=c.get(0).getSelection();if(i&&!i.isCollapsed){var o=F(i),n=t.element(o.anchorNode),s=t.element(o.focusNode),u=[i.anchorNode,i.anchorOffset,i.focusNode,i.focusOffset],h=n.parents(".content");if(h.size()&&s.parents(".content").size()){h=h.children().first();var g=h.children().has(n);if(g.size()||(g=h.children().filter(n),g.size())){var p=h.children().has(s);if((p.size()||(p=h.children().filter(s),p.size()))&&(g=R.getStoryByElement(g),p=R.getStoryByElement(p),g&&p)){var m=e.roomStoryList.stories,y=m.indexOf(g),v=m.indexOf(p),S=L(n,o.anchorOffset,D(g)),b=L(s,o.focusOffset,D(p)),E=0,$=0;(y>v||y===v&&S>b)&&(v=[y,y=v][0],b=[S,S=b][0],s=[n,n=s][0],p=[g,g=p][0]);var x,N,V,I,O,T,C,z,k,U,B=t.element("<span>"),q=function(e){z?z=!1:I.append("<br/>"),I.append(c[0].createTextNode(e))};for(T=!1,C=null,V=y;V<=v;++V)if(x=m[V],!(V===y&&S>x.message.length||V===v&&0===b)){if(C&&(x.userId!==C[0]||x.orgId!==C[1])){T=!0;break}C=[x.userId,x.orgId]}for(V=y;V<=v;++V)x=m[V],x.blockedTimestamp>0||(N=x.message,k=function(e){return d(e.replace(/<\/pre>/g,"</pre>")).replace(/\uE000/g,function(e,t){return V===y&&t<S+E&&++E,V===v&&t<b+$&&++$,"\n"})}(x.messageHtml),U=D(x),y===v?(N=P(N,U,S,b),k=k.slice(S+E,b+$)):V===y?(N=P(N,U,S),k=k.slice(S+E)):V===v&&(N=P(N,U,0,b),k=k.slice(0,b+$)),N.trim().length&&(O={"data-story-id":x.storyId,"data-room-id":x.roomId,"data-timestamp":x.created,"data-text":N},x.integrationData?(O["data-user"]=x.user.info.fullName,O["data-photo"]=x.user.info.photoUrl):(O["data-userid"]=x.userId,O["data-orgid"]=x.orgId),I=t.element("<span>").attr(O),z=!0,k.split("\n").forEach(q),T&&B.append(t.element("<span>").text("["+f(x.created,"M/d/yyyy h:mm:ss a")+"] "+x.user.info.fullName+": ")),B.append(I),V<v&&B.append(t.element("<br /><br />"))));if(B.text().trim().length){B.css({position:"absolute",left:-99999,top:0,height:1,overflow:"hidden"}).appendTo(c.find("body")),i.selectAllChildren(B.get(0));var A=B.get(0).innerText;"windows"===w.os&&(A=A.replace(/\r?\n/g,"\r\n"));var M=B.html(),j=function(){r.originalEvent.clipboardData.setData("text/plain",A),r.originalEvent.clipboardData.setData("text/html",M)};["ie","ms-edge"].indexOf(w.browser)>-1?a(function(){r.originalEvent&&r.originalEvent.clipboardData?j():l.clipboardData&&(l.clipboardData.setData("text",A),l.localStorage.setItem("eo-dash-html-clipboard",M))}):r.originalEvent&&r.originalEvent.clipboardData&&(j(),r.preventDefault()),a(function(){B.remove();var e=c.get(0).createRange();e.setStart(u[0],u[1]),e.setEnd(u[2],u[3]),e.startContainer!==u[0]&&(e.setStart(u[2],u[3]),e.setEnd(u[0],u[1])),i.removeAllRanges(),i.addRange(e)})}}}}}}c.bind("copy",r),e.$on("$destroy",function(){c.unbind("copy",r)})};this.watchNewStory=function(e){return this.room.watchNewStory(e)},this.init=function(){x.time("RoomStoryListInitialize");var r=this;this.room=e.room;var i,o=this.room.watchStories(function(e){N||(N=!0,x.time("RoomStoryListWatchStories")),r.stories=e.stories}),n=this.room.watchNewStory(function(t){e.leftNav||t.isOwner()||!h.isVisible()||r.room.updateLastRead("onTab")}),s=this.room.watchStoriesLoading(function(e){a.cancel(i),i=a(function(){r.storiesLoading=e},200)});e.$on("$destroy",function(){n.unsubscribe(),o.unsubscribe(),s.unsubscribe()}),U(),this.room.loadMissingStories(),a(function(){e.room&&e.room.roomId&&(e.$emit("stories:rendered",e.room.roomId),e.room.hasUnread()&&h.isVisible()&&e.room.updateLastRead("roomOpened"))}),e.$on("scrollContinuum:init",function(){r.updateContextualRoomTimestamp(),$()});var l=h.$on("visibilitychange",function(){!e.leftNav&&h.isVisible()&&$()});e.$on("$destroy",l),this.init=t.noop};var B=function(r){if(!(r.button>0)){var i=t.element(r.target);i.is("[eo-room-id]")||(i=i.parents("[eo-room-id]").eq(0));var o=i.attr("eo-room-id"),n=i.attr("href");o&&(r.preventDefault(),e.open(o).catch(function(e){n&&403!==e[0].code&&(l.location.href=n)}))}};o.bind("click",B),e.$on("$destroy",function(){o.unbind("click",B),delete R.room,delete R.stories}),x.time("StoryListDirectiveStop")}],link:function(e){e.roomStoryList.init()}}})});