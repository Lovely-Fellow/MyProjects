define(["./common","angular","favicojs","crosstab","lodash","config-service","./context-service","./debug-service"],function(t,e,i,n,o){"use strict";t.value("FavicoService",i).value("eoCrosstab",n).factory("eoNotification",["$window","$rootScope","$cookies","$q","FavicoService","eoDashConfig","eoDashContext","eoCrosstab","eoDebug",function(t,i,n,a,r,c,s,u,f){var d,l=["granted","default","denied"],m=t.Notification,v=t.webkitNotifications,p=t.navigator.mozNotification,g={icon:c.assets.url+c.imagesPath+"/noticon-up.png"};u.init({orgId:s.getOrgId(),isDashTab:!0}),i.$on("organization:set",function(t,e){u.setData({orgId:e,isDashTab:!0})});var h,b=function(){return!!(m||v&&v.createNotification||p&&p.createNotification)}(),y=function(){return m&&m.permission?m.permission:v&&v.checkPermission?l[v.checkPermission()]:p?"granted":"default"},$=function(){return"granted"===y()},T=function(){return"default"===y()},w=function(){var e=a.defer(),o=function(t){d.permission=t,$()?(n.put("hide_dash_notif_bar",!1),e.resolve(t)):e.reject(t),i.$apply()};return m?m.requestPermission(o):v?v.requestPermission(function(){o($()?"granted":"denied")}):p?t.setTimeout(function(){o("granted")},0):t.setTimeout(function(){o("default")},0),e.promise},k=function(t,e){var n=i.$new(!0);return n.native=t,n.options=e,n},D=function(){var n=function(t){return e.extend({},g,t)};return m?function(e,o){if($()){o=n(o);var a,r,c=new m(e,o),s=k(c,o),u=function(){if(!o.persist){var e=o.autoHideDelay?o.autoHideDelay:6e3;a=t.setTimeout(s.close,e)}};return s.close=function(){t.clearTimeout(r),t.clearTimeout(a),c.close(),s.$destroy(),r=null,a=null,s=null,c=null},c.addEventListener("show",function(){u(),i.$emit("notification:show",s)}),r=t.setTimeout(u,1e3),c.addEventListener("click",function(){i.$emit("notification:click",s)}),s}}:v?function(e,o){if($()){o=n(o);try{var a=v.createNotification(o.icon,e,o.body),r=k(a,o),c=function(){o.persist||t.setTimeout(r.close,6e3)};return r.close=function(){r.$destroy(),a.cancel()},a.ondisplay=function(){c(),i.$emit("notification:show",r)},a.onclick=function(){i.$emit("notification:click",r)},t.setTimeout(c,1e3),a.show(),r}catch(t){}}}:p?function(e,o){o=n(o);try{var a=p.createNotification(e,o.body,o.icon),r=k(a,o);return r.close=function(){r.$destroy(),a.close()},a.onclick=function(){i.$emit("notification:click",r)},a.show(),i.$evalAsync(function(){i.$emit("notification:show",r),o.persist||t.setTimeout(r.close,6e3)}),r}catch(t){}}:e.noop},N=function(t,e){return h||(h=D()),i.$emit("desktopNotification",{title:t,body:e.body,iconUrl:g.icon,roomId:e.roomId,roomType:e.roomType}),h(t,e)},I=function(t,e){var i=null,n=null;for(var o in t){var a=t[o];n||(n=a),a.data&&a.data.orgId&&a.data.orgId===e&&((!i||!i.data.isDashTab&&a.data.isDashTab)&&(i=a))}return i||(i=n||u),i?{id:i.id,isDashTab:!!i.data&&i.data.isDashTab}:null},C=function(t){var e=f.debug("notification:events");if(s.isTeamApp())return!0;if(!u.supported)return e("Crosstab not supported!"),!0;var i=I(u.all(),t),n=null!==i&&i.id===u.id;return e("isMaster:",n),n},P=new r({animation:"popFade",type:"rectangle"}),q=o.throttle(function(t){P.badge(t)},3e3,{leading:!0,trailing:!0});return d={permission:y(),setUnread:function(t){var n=0,o=0;"*"===t?n=1:(n=t,o=t),i.$emit("messageCounterChanged",{unread:n,unreadImportant:o}),"*"===t&&(t=" "),e.isNumber(t)&&t>99&&(t="99+"),s.showFavIcon()&&q(t)},show:N,isMaster:C,request:w,granted:$,alwaysAsk:T,supported:b}}])});