define(["angular","lodash","ui.router"],function(e,t){"use strict";var o=e.module("eoRoomsDirectory",["ui.router"]);return o.config(["$stateProvider","$urlRouterProvider",function(t,o){o.when("/rooms/directory","/rooms/directory/all"),t.state("rooms.directory",{url:"/directory",abstract:!0,template:"<ui-view/>"}).state("rooms.directory.main",{url:"/:type",controller:"roomsDirectoryCtrl",templateUrl:"@templates/rooms/rooms-directory/rooms-directory.html",resolve:{results:["eoSearch","$stateParams","eoRetryWorkflow","eoRooms","$q","$log",function(t,o,r,a,n,i){var s="all"===o.type?"":o.type;return r.create(function(){return t.browse("",s,15)},{scale:5e3,maxWait:6e4,maxAttempts:10,preflightCheck:function(){return i.info("Running preflight check to see if Search API is up."),t.isUp()},shortCircuitCheck:function(t){return!(e.isArray(t)&&500===t[0].code)}}).try()}]}})}]).controller("roomsDirectoryCtrl",["$scope","$stateParams","$timeout","eoAuth","eoSearch","eoUsers","results","eventLog","$window","eoGoogleAnalytics","eoThriftRoomType",function(o,r,a,n,i,s,l,c,m,p,u){o.search={type:"all"===r.type?"":r.type,name:""},o.sortField="time",o.sortOrder="desc",o.enablePublicRooms=n.organization&&n.organization.enablePublicRooms;var d=e.element('[id="filterInput"]');o.tabs=[{name:"all",type:"",active:"all"===r.type||""},{name:"interviews",type:"interviews",active:"interviews"===r.type},{name:"groups",type:"rooms",active:"rooms"===r.type},{name:"people",type:"people",active:"people"===r.type}];var y=function(t){40!==t.keyCode&&13!==t.keyCode||e.element(".directory-table").find("a")[0].focus()};d.on("keydown",y),o.$on("$destroy",function(){d.off("keydown",y)});var f=e.element(".directory-table"),g=function(t){var o=e.element(this);return 40===t.keyCode?(o.parent().parent().next().find("a")[0]&&o.parent().parent().next().find("a")[0].focus(),!1):38===t.keyCode?(o.parent().parent().prev().find("a")[0]&&o.parent().parent().prev().find("a")[0].focus(),!1):void 0};f.on("keydown","a",g),o.$on("$destroy",function(){f.off("keydown","a",g)}),o.sort=function(e,t){o.sortField=e,o.sortOrder=t,o.page.num=1,i.browse(o.search.name,o.search.type,15,0,o.sortField,o.sortOrder).then(I);var r={event:"click",location:"My Rooms & People",sublocation:"sort results",timestamp:new Date,userId:n.user.userId,data:[{org_id:n.user.orgId,action:"sort results",type:o.search.type||"all",sort_field:e,sort_order:t,event_label:"sort_results"}]};c.log(r),p.ga("Rooms","sort my rooms and people","sort"+e+" "+t)},o.changePage=function(){i.browse(o.search.name,o.search.type,15,o.page.num-1,o.sortField,o.sortOrder).then(I)},o.openDirectoryItem=function(e,t){t.stopPropagation(),"people"===e.type?null!==e.roomId?o.open(e.roomId):o.openContact(e.user.userId,e.orgId):"rooms"===e.type&&o.open(e.room.roomId)};var h=function(e){o.page.num=1,i.browse(e,o.search.type,15,0,o.sortField,o.sortOrder).then(I)},v=t.throttle(h,300),D=!0;o.$watch("search.name",function(e){D?a(function(){D=!1}):e?v(e):h("")});var I=function(t){return s.settleDuplicates(t.records,function(e){return"contact"!==e.type||"contact"===e.type&&e.metaData.roomType?null:e.metaData.firstName.stringVal+" "+e.metaData.lastName.stringVal},function(e){return e.metaData.orgId.stringVal},function(e){return e.metaData.legacyId.stringVal}).then(function(){var r=[];e.forEach(t.records,function(t){if("contact"===t.type||"oneToOneRoom"===t.type){var o=[];e.isDefined(t.metaData.location.locationVal)&&(t.metaData.location.locationVal.city&&o.push(t.metaData.location.locationVal.city),t.metaData.location.locationVal.country&&o.push(t.metaData.location.locationVal.country)),r.push({type:"people",id:t.metaData.userId.stringVal+"_"+t.metaData.orgId.stringVal,name:t.metaData.firstName.stringVal+" "+t.metaData.lastName.stringVal,tag:t.tag,location:o.join(", "),user:t.user,orgId:t.metaData.orgId.stringVal,roomId:t.metaData.roomId?t.metaData.roomId.stringVal:null,activity:t.metaData.lastUpdate?t.metaData.lastUpdate.intVal:0})}else"room"!==t.type&&"interviewRoom"!==t.type||r.push({type:"rooms",id:t.metaData.roomId.stringVal,name:t.room.roomName,room:t.room,tag:t.room.roomType===u.INTERVIEW&&t.room.hasTopic()&&t.room.topic?t.room.topic:"",activity:t.metaData.lastUpdate?t.metaData.lastUpdate.intVal:0})}),o.total=t.total,o.resultsPerPage=15,o.results=r,e.element(".room-directory").scrollTop(0)})};o.page={num:1},I(l)}]),o});