define(["../room","angular","lodash"],function(i,n,e){"use strict";i.directive("eoDisintermediationHighlighter",["escapeHtmlFilter","eoDisintermediation","eoDisintermediationPopover","eoGoogleAnalytics",function(i,o,t,r){return{restrict:"A",link:function(s,a){var d,c=a,u=n.element("<div>").appendTo(n.element('<div class="msg-composer-highlighter" />').insertBefore(a)),l=!1,f=!1,m=function(){var i=u.find("mark.disintermediation:last");return i.length>0?i.first():null},h=function(){var i=m();if(i){var n=i.attr("eo-disintermediation-category");if(!t.isCategoryHidden(n,s.room.roomId)){var e=t.show(c,1,n);d!==e&&(d=e,e.result.then(function(i){"close"===i&&t.hideCategory(n,s.room.roomId),d=null}),r.ga("Disintermediation","popover "+n))}}},g=function(){if(!l){var n=i(a.val()),e=o.highlight(n),t=e!==n;u.html(e),t?(f=!0,s.$evalAsync(function(){h()})):f&&(f=!1,d&&d.dismiss("hide"))}};if(o.isEnabled()){var v=e.debounce(function(){s.$applyAsync(g)},50);g(),s.$on("composer:submit",function(){v()}),s.$onRootScope("disintermediation:turnOff",function(){g()}),a.bind("keyup",function(){v()}).bind("change",function(){v()}),s.$on("$destroy",function(){l=!0,d&&d.dismiss("hide"),a.unbind("keyup",v),a.unbind("change",v)})}}}}])});