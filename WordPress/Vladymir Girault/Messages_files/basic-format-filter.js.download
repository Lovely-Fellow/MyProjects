define(["./common","angular","./emojione-service"],function(e,r){"use strict";e.filter("eoBasicFormat",["escapeHtmlFilter","emojione","upDashTagFilter",function(e,n,c){function t(e,n){n=n||{},n.extended=!1;for(var t,a=/<((?:[@#%]|mailto:|(?:[a-z][a-z0-9+.-]*):\/\/)(?:[^|>]+))(?:\|([^>]+))?>/gi,l="",o=0;null!==(t=a.exec(e));)l+=w(e.slice(o,t.index),n),o=a.lastIndex,l+=c(t[1].replace(/&amp;/g,"&"),(t[2]||"").replace(/`/g,""),n);e&&(l+=w(e.slice(o),n));var p=r.element("<div>");p.html(v(l)),n.emoji&&(n.toUnicode?b(p,R):b(p,E)),b(p,x);var i=_(p.html()).replace(/\u0001/g,"`").trim().replace(/\n/g,"<br />");return p=null,i}var a=function(e){return e.replace(/[*_`]/g,function(e){return"&#"+e.charCodeAt(0)+";"})},l='(^|\\s|[!"#$%&(+,.:;<=>?[^{~@@@-])',o='(?=[!"#$%),.:;=?\\]^}<@@@-]|\\s|$)',p=new RegExp(l.replace("@@@","_`")+"\\*(?![*\\s])((?:.*?)[^*\\s])\\*"+o.replace("@@@","_`"),"g"),i=new RegExp(l.replace("@@@","*`")+"_(?![_\\s])((?:.*?)[^_\\s])_"+o.replace("@@@","*`"),"g"),u=new RegExp(l.replace("@@@","*_")+"```\\n?([^]*?)```","g"),g=new RegExp(l.replace("@@@","*_")+"`(?![`\\s])((?:.*?)[^`\\s])`"+o.replace("@@@","*_"),"g"),m=function(e){var r=e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),n="*_`".replace(e,"");return new RegExp(l.replace("@@@",n)+r+"([^<>"+e+"]*(?:(?:<a[^>]*>[^<]*<\\/a>|<span[^>]*>[^<]*<\\/span>|<code>[^<]*<\\/code>|<pre>[^<]*<\\/pre>)[^<>"+e+"]*)+)"+r+o.replace("@@@",n),"g")},s=m("*"),f=m("_"),d=/^&gt;\s?(.*(\n&gt;.*)*)\n?/gm,$=/^&gt;\s?/gm,h=/<\/pre>\n/g,_=function(e){return e.replace(s,"$1<b>$2</b>").replace(f,"$1<em>$2</em>").replace(d,"<blockquote>$1</blockquote>").replace($,"")},v=function(e){return e.replace(u,function(e,r,n){return r+"<pre>"+a(n)+"</pre>"}).replace(h,"</pre>").replace(g,function(e,r,n){return r+"<code>"+a(n)+"</code>"})},x=function(e){return e.replace(p,"$1<b>$2</b>").replace(i,"$1<em>$2</em>")},b=function(n,c){var t=!0;n.contents().each(function(n,a){if(3!==a.nodeType)return void(t="PRE"===a.nodeName);r.element(a).replaceWith(c(e(a.nodeValue),t))})},E=function(e){return n.toImage(e)},R=function(e){return n.shortnameToUnicode(e)},w=function(e,r){return e=e.replace(/</g,"&lt;").replace(/>/g,"&gt;"),r.highlighter&&(e=r.highlighter(e)),e};return t}])});