(function (angular, applet) {

    'use strict';

    angular.module('mftFeedback').factory('MftFeedbackService', MftFeedbackService);

    MftFeedbackService.$inject = [
        '$window',
        '$modal',
        'screenSize',
        'MftFeedbackStateService',
        'SCREEN_SIZES',
        'ACTIONS_LOGIN_CHECK',
        'LOGIN_PATHS',
        'isMftFeedbackEnabled'
    ];

    function MftFeedbackService(
        $window,
        $modal,
        screenSize,
        MftFeedbackStateService,
        SCREEN_SIZES,
        ACTIONS_LOGIN_CHECK,
        LOGIN_PATHS,
        isMftFeedbackEnabled
    ) {
        function checkResolution() {
            screenSize.init();
            return SCREEN_SIZES.includes(screenSize.get());
        }

        function isReferrerLogin() {
            var url = $window.document.referrer;
            if (!url) {
                return false;
            }
            var pathname = url.replace(/^[^:]+:\/\/[^/]+/, '').replace(/#.*/, '').replace(/\?.*/, '');
            return LOGIN_PATHS.includes(pathname);
        }

        return {
            /**
             * Store login time if feature enabled and screen resolution XS or SM
             */
            trackLogin: function () {
                if (isMftFeedbackEnabled && checkResolution()) {
                    MftFeedbackStateService.setLoginTime();
                }
            },
            /**
             * Store current action code for criterias
             * @param actionType
             */
            trackAction: function (actionType) {
                if (isMftFeedbackEnabled
                    && checkResolution()
                    && (!ACTIONS_LOGIN_CHECK.includes(actionType) || !isReferrerLogin())) {
                    MftFeedbackStateService.addAction(actionType);
                }
            },
            /**
             * Show feedback modal if the trigger criteria is met
             */
            showFeedBackModal: function () {
                if (isMftFeedbackEnabled
                    && checkResolution()
                    && MftFeedbackStateService.isNeedShowModal()
                ) {
                    $modal.open({
                        controller: 'MftFeedbackModalController',
                        size: 'sm',
                        windowClass: 'mft-feedback-modal',
                        templateUrl: applet.buildInternalAssetPath('@UpworkMftFeedbackBundle/partials/mft-feedback-modal.html')
                    });
                }
            }
        };
    }
})(angular, Applet);