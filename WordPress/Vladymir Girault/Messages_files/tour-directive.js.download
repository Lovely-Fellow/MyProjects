define(["./common","angular","lodash"],function(t,e,o){"use strict";t.directive("eoTour",["$compile","$window","$http","$templateCache","$timeout","eoTourService","eoDashContext",function(i,n,r,l,p,s,u){return{restrict:"A",scope:{},link:function(h,f,a){function c(o,p,s){var u=this;this.scope=o,this.target=p,this.config=s,r.get(t.templatePath+"tour-directive.html",{cache:l}).then(function(t){i(t.data)(o,function(t){u.element=t,u.element.appendTo(e.element(n.document.body))}),u.show()})}function T(){return a.eoTourElement?a.eoTourElement:f}if(h.isWidgetAndDisabled=function(){return u.isWidget()&&"true"!==a.eoTourTooltipWidgetEnabled},a.eoTour&&"false"!==a.eoTour&&!e.element(".mobile-menu").is(":visible")&&!h.isWidgetAndDisabled()){var d=null;a.eoTourId=e.isDefined(a.eoTourId)?a.eoTourId:0,a.eoTourTooltipPlacement=a.eoTourTooltipPlacement||"right",a.eoTourPulseAppendToBody=!!e.isDefined(a.eoTourPulseAppendToBody)&&"true"===a.eoTourPulseAppendToBody;var g=s.addStep(h,a.eoTourId,a.eoTour,a.eoTourStep);h.popover=!1,c.prototype.getTargetElement=function(){return e.isString(this.target)?e.element(this.target):this.target},c.prototype.show=function(){var t=this;p(function(){t._show()},100)},c.prototype._show=function(){var t=this;this.element.show(),this.updatePosition(),this.positionFn=o.throttle(function(){p(function(){t.updatePosition.call(t)},100)},100),e.element(n).on("resize layout-resize",this.positionFn)},c.prototype.updatePosition=function(){var t=this.getTargetElement();if(0!==t.length){var e=t.offset(),o=this.config.placement,i=this.config.arrow,r=this.element,l={top:e.top,left:e.left};"bottom"===o?(l.top=l.top+t.height(),l.left=l.left-r.width()/2+t.width()/2):"top"===o?(l.top=l.top-r.height()-t.height()/2,l.left=l.left-r.width()/2+t.width()/2):"left"===o?l.left=l.left-r.width():(l.top=l.top-r.height()/2+t.height()/2,l.left=l.left+t.width()),"right"!==o&&"left"!==o||("align-end"===i?l.top=l.top-r.height()/2+18:"align-start"===i&&(l.top=l.top+r.height()/2-18)),"bottom"!==o&&"top"!==o||("align-end"===i?l.left=l.left-r.width()/2+25:"align-start"===i&&(l.left=l.left+r.width()/2-25)),this.config.left&&(l.left+=parseInt(this.config.left)),this.config.top&&(l.top+=parseInt(this.config.top)),l.left+r.width()+5>n.innerWidth&&(l.left=n.innerWidth-r.width()-10),l.left<0&&(l.left=0),l.top+r.prop("scrollHeight")>n.innerHeight&&(l.top=n.innerHeight-r.prop("scrollHeight")-10),r.css(l)}},c.prototype.remove=function(){this.element.remove(),this.element=null,e.element(n).off("resize layout-resize",this.positionFn)},h.showPopover=function(){g.showStep(a.eoTour)},h.$watch("popover",function(t){t?d=new c(h,T(),{placement:a.eoTourTooltipPlacement,left:a.eoTourTooltipLeft,top:a.eoTourTooltipTop,arrow:a.eoTourTooltipArrow}):d&&(d.remove(),d=null)}),h.visible=!1,a.eoTourTooltipArrow=a.eoTourTooltipArrow||"align-end",h.eoTour=a.eoTour,h.title=a.eoTourTooltipTitle,h.content=a.eoTourTooltip,h.class=a.eoTourTooltipClass+" "+a.eoTourTooltipArrow,h.placement=a.eoTourTooltipPlacement,h.closeTour=function(){g.closeTour(),h.eoTourOnClose()},h.closeStep=function(){g.closeStep()},h.nextStep=function(t){t.stopPropagation(),g.nextStep()},h.isLast=function(){return g.isLast()},h.setTargetElement=function(t){a.eoTourElement=t}}}}}])});