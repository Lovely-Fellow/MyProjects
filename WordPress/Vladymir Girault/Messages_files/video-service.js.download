define(["./common","angular","jquery","lodash","./auth-service","./context-service","config-service","ngDeviceDetector"],function(e,o,t,n){"use strict";e.factory("eoVideo",["$http","$q","$window","$timeout","eoDashConfig","deviceDetector","eoDashContext","upRoomApi","eoAuth","tlRoom","upDashMetrics",function(e,o,r,i,s,a,d,c,u,f,g){function l(e){var o=e.currentTarget.name,t=p[o];t&&i(function(){t.closed&&delete p[o]},100,!1)}var b={},p={};return b.getSession=function(e,t,n){var r={roomId:e,metaData:t,mediaMode:n},i=o.defer();return d.webApiEnabled()&&(g.startMetric("getVideoSessionIdUsingWebApi"),c.getVideoSessionId(r).then(function(e){g.endMetric("getVideoSessionIdUsingWebApi"),i.resolve(e)},function(e){g.count("getVideoSessionIdWebAPIFailure"),g.endMetric("getVideoSessionIdWebApi"),404!==e.status&&console.warn("failed to getVideoSessionId using web api:",e),i.reject(e)})),i.promise},b.isSupported=function(){return["chrome","firefox","opera","safari"].indexOf(a.browser)>-1&&"ios"!==a.os||"ios"===a.os&&"safari"===a.browser},b.open=function(e,o){var t,i=r.location.host+"."+e;if((t=n.get(p,i))&&!1===t.closed)return void t.focus();var a=s.baseURL+"/upvideo/"+e,c=s.baseURL+"/upvideo/"+e+"?video=0",u=Math.floor(.9*r.innerWidth);u<820&&(u=820);var f=Math.floor(.9*r.innerHeight);f<500&&(f=500);var g=o?a:c;g&&(d.isTeamApp()?(t=r.open("",i,"width="+u+", height="+f),t.location=g):t=r.open(g,i,"width="+u+", height="+f),t.addEventListener("unload",l),p[i]=t)},b.loadLastVideoStory=function(e){var o={roomId:e,objectTypes:"eo:video",limit:1,sortDirection:"desc"};return d.webApiEnabled()?c.getObjectReferences(o).then(function(e){return e},function(e){return console.warn("failed to fetch object reference using web api:",e),f.getObjectReferences(o)}):f.getObjectReferences(o)},b.postVideoStartedStory=function(e,o,t){if(!e.isReadOnly){var n={};n.message="",n.objectReferences=[];var r={};r.metadata={},r.objectType="eo:video",r.metadata.tokboxSessionId=o,r.metadata.videoEnabled=t,r.metadata.videoId=e.roomId,n.objectReferences.push(r),n.actionType="eo:initiate",n.roomId=e.roomId,n.userId=u.user.userId,n.orgId=u.user.orgId,n.sourceClient=d.getClientName(),n.messageId=u.user.userId+"-"+(new Date).getTime()%36e5+"-"+Math.floor(100*Math.random());var i={roomId:e.roomId,newStory:n};b.loadLastVideoStory(e.roomId).then(function(e){if(e.total<1||((new Date).getTime()-e.objectReferences[0].created)/1e3>180){if(d.webApiEnabled())return c.newStory(i).then(function(){},function(e){console.warn("failed to create new story using web api:",e),f.newStory(i)});f.newStory(i)}})}},b.getVideoUserCount=function(e){var t={roomId:e},n=o.defer();return d.webApiEnabled()&&(g.startMetric("getNumberUsersInVideoSessionUsingWebApi"),c.getNumberUsersInVideoSession(t).then(function(e){g.endMetric("getNumberUsersInVideoSessionUsingWebApi"),n.resolve(e.connectedUsersCount)},function(e){g.count("getNumberUsersInVideoSessionWebAPIFailure"),g.endMetric("getNumberUsersInVideoSessionWebApi"),404!==e.status&&console.warn("failed to getNumberUsersInVideoSession using web api:",e),n.reject(e)})),n.promise},b.getIdvRecordingInfo=function(){var n={userId:u.user.userId,orgId:u.user.orgId},r=s.tokboxUrl+"/getVideoRecordingInfo",i=o.defer();return e.post(r,t.param(n),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e){e.recordingLength?i.resolve(e.recordingLength):i.resolve(5)}).error(function(){i.resolve(5)}),i.promise},b.startRecordingVideo=function(e){var t={roomId:e},n=o.defer();return d.webApiEnabled()&&(g.startMetric("startCallRecordingsUsingWebApi"),c.startCallRecordings(t).then(function(e){g.endMetric("startCallRecordingsUsingWebApi"),n.resolve(e)},function(e){g.count("startCallRecordingsWebAPIFailure"),g.endMetric("startCallRecordingsWebApi"),404!==e.status&&console.warn("failed to startCallRecordings using web api:",e),n.reject(e)})),n.promise},b}])});