define(["angular","lodash"],function(o,e){"use strict";return["$rootScope","$injector","$window","$q","$scope","$modal","$modalStack","$state","eoDashContext","tlUser","tlRoom","tlStory","eoDashConfig","eoAuth","eoRooms","eoRoomListAPI","eoNotification","eoTimeInst","rooms","eoUsers","eoRoomDialog","eoRetry","$timeout","eventLog","eoSettingsDialog","eoResizerAPI","eoGoogleAnalytics","eoTourService","eoRoomStory","eoThriftRoomType","eoOutOfOfficeDialog","tlSocket","eoAlert","eoCrossCommunication","eoVideo","upRoomApi","upDashMetrics","upStoryNotification","deviceDetector","eoApplet",function(t,n,r,i,s,a,d,c,m,u,l,f,g,p,h,I,v,y,w,b,R,S,T,k,$,U,M,C,N,A,O,B,D,E,j,P,L,F,W,_){s.rooms=w,s.odeskBaseUrl=g.odeskBaseURL,s.odeskSupportUrl=g.odeskSupportURL,s.notifSettings=$.notifSettings,s.outOfOffice=O.showDialog,s.enablePublicRooms=p.organization&&p.organization.enablePublicRooms,s.showSettingsDropdown=m.showSettings(),s.roomloadType="",s.user=p.user,s.isSudo=m.isSudo(),s.showBroadcastMessage=g.feature.broadcast.enabled&&p.isClient(),s.isMobileDevice=W.isMobile(),t.isWidget&&(s.noBorder=r.widgetOptions.flags.noborder),F.start(),s.initUnReadCount=0;var x=function(o){o&&o.counts&&b.getLocalSettings(p.user.userId).then(function(e){for(var t=0;t<o.counts.length;t++)if(p.organization.uid===o.counts[t].orgId){"all"===e.counter.show?s.totalUnreadMentions=o.counts[t].unreadStoriesCount:"important"===e.counter.show?(s.totalUnreadMentions=o.counts[t].mentionsCount,0===o.counts[t].mentionsCount&&o.counts[t].unreadStoriesCount>0&&(s.totalUnreadMentions="*")):s.totalUnreadMentions=0,v.setUnread(s.totalUnreadMentions);break}})},z=function(){L.startMetric("getMessageCountsWebApi"),P.getMessageCounts().then(function(o){L.endMetric("getMessageCountsWebApi"),x(o)},function(o){L.count("getMessageCountsWebAPIFailure"),L.endMetric("getMessageCountsWebApi"),console.warn("failed to get message counts using web api:",o),l.getMessageCounts().then(x)})};z();var V,H=l.$on("updateRoomUserNotifcation",function(e){e.orgCounts&&!o.equals(e.orgCounts,V)&&(x(e.orgCounts),V=e.orgCounts)}),q=l.$on("videoConnectionsUpdated",function(o){t.$emit("videoConnectionsUpdated",o)});s.$onRootScope("editMentionFound",function(o,e){F.showNotification(e.story,e.room)}),s.$onRootScope("disintermediation:turnOff",function(){h.purgeCache([]),o.forEach(s.rooms,function(o){o.reProcessStoriesMessage()})}),s.enablePlugins=function(){return p.organization&&p.organization.enablePlugins},s.openPlugins=function(){r.open(c.href("plugins",{},{absolute:!0}))};var K=!1,G=function(e){if(g.rooms.list.preload.enabled&&!o.element(".mobile-menu").is(":visible")){console.log("preloading room users and stories...");var t=i.when();e.sort(function(o,e){return o.recentTimestamp<e.recentTimestamp?1:o.recentTimestamp>e.recentTimestamp?-1:0}),console.log("# rooms to be preloaded: %s of %s",g.rooms.list.recent.perPage,e.length);var n=0,r=0;o.forEach(e,function(o){(n<g.rooms.list.recent.perPage||o.isFavorite||o.numUnread>0)&&(t=t.then(function(e){return function(){return K?void console.warn("preload stopped"):o.preloadData().then(function(){return console.log('preloaded "%s" (%s/%s)',o.roomName,e,g.rooms.list.recent.perPage),r=0,T(function(){},300)},function(){if(console.warn('failed to preload room data for room "%s" (%s)',o.roomName,o.roomId),++r>2)return console.warn("Stopping room preloading due to multiple sequential failures"),K=!0,i.reject("preloading failed")})}}(n)),o.isFavorite||o.numUnread||n++)}),i.all(t)}},J=function(t,n){n=!!n,"unread"!==s.roomloadType&&e.remove(s.rooms,function(o){return!t.findById(o.roomId)&&!o.active}),o.forEach(t,function(o){o.refreshed=!1,s.rooms.findById(o.roomId)?s.rooms.update(o):s.rooms.add(o)}),n||T(function(){G(w)},1e3)},Q=function(){var o={includeHidden:!1,sortOrder:"recentTimestamp",limit:g.rooms.perPage,includeRoomNote:!0};if("unread"===s.roomloadType)return delete o.limit,o.returnOnlyUnreadRooms=!0,h.search(o);var e=new Date;return e.setDate(e.getDate()-g.rooms.recentDays),e=e.getTime(),o.activeSince=e,S.create(function(){return h.search(o)}).try().then(function(e){return e.length?e:(delete o.activeSince,delete o.includeHidden,h.search(o))},function(){console.log("could not load rooms!")})};s.reInitializeRooms=function(o){var e=i.defer();return s.roomloadType=o,"unread"===o?(Q().then(function(o){o&&o.length&&J(o),e.resolve()}),e.promise):i.when()},w.fromStorage?Q().then(function(o){o&&o.length&&J(o)}):T(function(){G(w)},1e3);var X,Y=!0,Z=function(o){if(!p.isAuthenticated())return i.reject({});s.$broadcast("updateActiveRoom"),Q().then(function(e){Y=!0,e&&e.length&&J(e,o)})},oo=B.on("disconnect",function(){Y&&(X=B.getLastMessageTimestamp(),Y=!1)});s.$onRootScope("socket:reconnect",function(){var e=null;m.webApiEnabled()?(L.startMetric("pingRoomsWebApi"),e=P.ping().then(function(o){return L.endMetric("pingRoomsWebApi"),o},function(o){return L.count("pingRoomsWebAPIFailure"),L.endMetric("pingRoomsWebApi"),console.warn("failed to ping rooms web api:",o),l.ping()})):e=l.ping(),e.then(function(e){function t(e){Y=!0,M.ga("Reconnect Broadcasts",e.length);var t=e.broadcastMessages||[];o.forEach(t,function(e){var t=o.fromJson(e.message);B.dispatchEvent(e.eventType,t)})}var n=Date.now()-e;if(!X)return i.reject("lastMessageTimestamp not set");var r={since:X-n};return m.webApiEnabled()?(L.startMetric("getBroadcastsForUserUsingWebApi"),P.getBroadcastsForUser(r).then(function(o){L.endMetric("getBroadcastsForUserUsingWebApi"),t(o)},function(o){return L.count("getBroadcastsForUserUsingWebAPIFailure"),L.endMetric("getBroadcastsForUserUsingWebApi"),console.warn("failed to fetch broadcasts for user using web api:",o),l.getBroadcastsForUser(r).then(t)})):l.getBroadcastsForUser(r).then(t)}).catch(function(){M.ga("Reconnect Broadcasts","failed"),Z(!0)})}),s.$onRootScope("auth:refresh",Z),s.$onRootScope("view:rooms:show",function(){o.element("#room-nav").removeClass("d-none d-md-block"),o.element("#room-main-body").addClass("d-none d-md-block")}),s.$onRootScope("view:main:show",function(){o.element("#room-nav").addClass("d-none d-md-block"),o.element("#room-main-body").removeClass("d-none d-md-block")});var eo,to=null;s.open=function(o,e){return t.widgetRoomId&&!e?(r.top.location.href=c.href("rooms.chat",{id:o},{absolute:!0}),i.when()):e?(eo=c.params.storyId!==e&&!c.is("rooms.chat.story"),c.go("rooms.chat.story",{id:o,storyId:e}).then(function(){eo||t.$broadcast("story:highlight:"+c.params.storyId)})):c.go(no(o),{id:o})};var no=function(o){return c.is("rooms.chat.preview",{id:o})?c.current.name:"rooms.chat"},ro=t.$on("stories:rendered",function(){to&&T(function(){t.$broadcast("story:jump",to.roomId,to.storyId),to=null},500)}),io=t.$on("settings:changed",function(){z(),o.forEach(w,function(o){o.updateUnreadCounter()})});s.openContact=function(o,e){h.getDirectRoom(o,e).then(function(o){s.open(o)})},s.createRoomModal=function(){m.isReadOnlyMode()||R.create().result.then(function(o){s.open(o.roomId),s.toggleRooms()})},s.broadcastMessageModel=function(){m.isReadOnlyMode()||b.getActiveContractTeamList().then(function(o){if(!o.teams)return D.inline({type:"danger",duration:5e3,template:"Sorry, we could not reach the server. Please try again."}),!1;R.broadcastMessage(o.teams)},function(){D.inline({type:"danger",duration:0,template:"Sorry, we could not reach the server. Please try again."})})},s.findPublicRoomModal=function(){R.findPublic()},s.helpModal=function(){R.showHelp()};var so=function(o){if(t.widgetRoomId&&t.widgetRoomId===o.roomId)c.go("rooms.chat",{id:t.widgetRoomId},{reload:!0});else if(w.remove(o.roomId),c.includes("rooms.chat",{id:o.roomId})){r.localStorage.removeItem("lastRoom");var e=w.getMostRecentRoom();e?(c.go("rooms.chat",{id:e.roomId}),W.isMobile()&&s.$emit("view:rooms:show")):c.go("rooms.index")}},ao=!1,co=f.$on("newStory",function(n){if(!t.widgetRoomId||n.roomId===t.widgetRoomId){var r,a=N.fromData(n),d=w.findById(a.roomId);if(d)r=i.when(d);else{if("eo:join"===a.actionType&&a.isOwner())return;if(a.isSystemStory)return;r=h.isSubscribed(a.roomId).then(function(o){if(o)return h.get(a.roomId).then(function(o){var e=w.findById(a.roomId);return e||w.add(o).then(function(o){return o.refreshed=!1,c.is("rooms.index")&&c.go("rooms.chat",{id:o.roomId},{reload:!0}),o})});console.log("story retrieved for room user is not subscribed")})}r.then(function(n){var r;if(n.isHourPackInterview()&&m.isWidget()&&E.postParent({type:"dash:message:newStory",data:a}),"eo:leave"===a.actionType)n.removeUser(a.userId,a.orgId),a.isOwner()&&so(n);else if("eo:kick"===a.actionType)n.removeUser(a.objectReferences[0].metadata.userId,a.objectReferences[0].metadata.orgId),p.user.userId===a.objectReferences[0].metadata.userId&&p.user.orgId===a.objectReferences[0].metadata.orgId&&so(n);else if("eo:join"===a.actionType){r=a.metadata&&a.metadata.role?a.metadata.role:null,n.addUser(a.userId,a.orgId,r);var i=e.find(a.objectReferences,function(o){return"eo:user"===o.objectType});i&&i.metadata&&i.metadata.email&&n.removeInvite(i.metadata.email),p.user.userId!==a.userId&&n.roomType===A.ONE_ON_ONE&&c.includes("rooms.chat",{id:n.roomId})&&c.go("rooms.chat",{id:n.roomId},{reload:!0})}else if("eo:invite"===a.actionType){var d=e.find(a.objectReferences,function(o){return"eo:user"===o.objectType});d&&(d.metadata.email?n.addInvite({email:d.metadata.email}):(r=d.metadata.role||null,n.addUser(d.metadata.userId,d.metadata.orgId,r)))}else if("eo:rename"===a.actionType)n.roomName=a.objectReferences[0].metadata.newRoomName;else if("eo:change"!==a.actionType&&"eo:clear"!==a.actionType||!a.objectReferences||"eo:topic"!==a.objectReferences[0].objectType)if("eo:archive"===a.actionType){if(n.isReadOnly=!0,!c.includes("rooms.chat",{id:n.roomId}))return h.getInfo(n.roomId,!0).then(function(e){o.extend(n,e)});c.go("rooms.chat",{id:n.roomId})}else{if("eo:block"===a.actionType||"eo:unblock"===a.actionType)return b.getBlockInfo(!0).then(function(){return"eo:unblock"!==a.actionType&&(n.isReadOnly=!0),h.getInfo(n.roomId,!0).then(function(e){o.extend(n,e);var r;"eo:block"===a.actionType&&s.rooms.findById(n.roomId)&&(r=w.getMostRecentRoom(n.roomId,!1))&&s.rooms.remove(n.roomId),c.includes("rooms.chat",{id:n.roomId})&&("eo:unblock"===a.actionType?t.$broadcast("room:update",n):"eo:block"===a.actionType&&(r=w.getMostRecentRoom(n.roomId,!1),c.go("rooms.chat",{id:r.roomId}),W.isMobile()&&s.$emit("view:rooms:show")))})});"upwork:lost_access"===a.actionType&&p.user.userId!==a.userId&&n.roomType===A.ONE_ON_ONE&&c.includes("rooms.chat",{id:n.roomId})&&c.go("rooms.chat",{id:n.roomId},{reload:!0})}else n.topic=a.objectReferences[0].metadata.newTopic;a.isSystemStory||mo(a)})}}),mo=function(n){c.includes("rooms.chat",{id:n.roomId})&&C.getSettings().then(function(i){var s=w.findById(n.roomId);if(s){var a,c='div[eo-story-id="'+n.storyId+'"]';if(n=e.find(s.stories,function(o){return o.storyId===n.storyId})){if(n.isDisplayUser()){if(!i.composerSettingPopup&&i.enterKeyPressed&&C.canShow()&&!e.some(n.objectReferences,{objectType:"eo:file"}))return t.$emit("tour:start:composerSettings"),void C.updateSettings({composerSettingPopup:!0});if(!(i.storyEditNew&&i.videoTour&&i.audioTour&&i.notes&&i.markdownTour)&&i.numberOfStories>=g.tooltip.editTooltipAfter&&C.canShow()){if(i.storyEditNew||e.isEmpty(n)||n.blocked||!n.canEdit()||!1!==ao||!n.message&&!n.hasFiles())ao&&(t.$broadcast("story:downplayoptions:"+ao),C.closeOpenTour(),ao=null);else{a=c+" .story-actions-options";var u=function(){t.$emit("story:scrollToSettings",n.storyId)},l=function(){t.$broadcast("story:downplayoptions:"+n.storyId)};t.$emit("tour:end:composerSettings"),C.setBeforeOpen("storyEditNew","storyEditNew",u),C.setOnClose("storyEditNew","storyEditNew",l),C.setTargetElement("storyEditNew","storyEditNew",a),C.show("storyEditNew"),T(function(){ao=n.storyId,t.$broadcast("story:highlightoptions:"+n.storyId)},100)}i.numberOfStories>=g.tooltip.videoTooltipAfter&&C.show("videoTour"),i.numberOfStories>=g.tooltip.markdownTooltipAfter&&m.markdownEnabled()&&C.show("markdownTour"),s.stories.length>=g.tooltip.notesTooltipAfter&&C.show("notes")}}}else console.warn("A story was expected to exist, but could not be found in the room.");var f=o.element(" .story-user-message").length;if(f&&i.videoTour&&i.storyEditNew&&i.audioTour&&i.markdownTour&&(s.totalStories>=g.tooltip.starredMessageTooltipAfter||s.stories&&s.stories.length>=g.tooltip.starredMessageTooltipAfter)&&C.canShow()){var p=function(){var e=o.element("a.story-favorite:last");t.$emit("story:scrollToElement",e)};C.setBeforeOpen("favorite","favorite",p),C.show("favorite")}if(n&&f&&i.videoTour&&i.storyEditNew&&i.audioTour&&i.markdownTour&&i.favorite&&i.favoriteView&&(s.totalStories>=g.tooltip.markUnreadTooltipAfter||s.stories&&s.stories.length>=g.tooltip.markUnreadTooltipAfter)&&C.canShow()&&w.length>=2){var h=function(){C.closeStep("markUnread")},I=function(){t.$emit("story:scrollToSettings",n.storyId),T(function(){o.element(c+" a.story-actions").click(),o.element(r).on("click",h)},100)},v=function(){d.dismissAll(),o.element(r).off("click",h)};C.setBeforeOpen("markUnread","markUnread",I),C.setOnClose("markUnread","markUnread",v),C.setTargetElement("markUnread","markUnread",c+" a.story-actions"),C.show("markUnread")}n&&n.objectReferences&&C.canShow()&&e.some(n.objectReferences,{objectType:"eo:file"})&&C.show("files")}})},uo=f.$on("updatedStory",function(o){if(!t.widgetRoomId||o.roomId===t.widgetRoomId){var e=h.getFromCache(o.roomId);e&&(e.updatedStory(o),t.$emit("story:updated",o))}}),lo=f.$on("updatedStoryNotes",function(o){if(!t.widgetRoomId||o.roomId===t.widgetRoomId){var e=h.getFromCache(o.roomId);e&&e.updatedStoryNotes(o.storyId,o.notes)}}),fo=f.$on("updateRoom",function(o){if(!t.widgetRoomId||o.roomId===t.widgetRoomId){var e=h.getFromCache(o.roomId);if(e){var n;o.isReadOnly&&!e.isReadOnly?n=b.getBlockInfo(!0).then(function(){e.updatedRoom(o)}):(e.updatedRoom(o),n=i.when()),n.finally(function(){e.active&&s.$broadcast("room:update",e)})}}}),go=l.$on("updateRoomUserNotifcation",function(e){if(e&&e.roomId&&(!t.widgetRoomId||e.roomId===t.widgetRoomId)){var n=h.getFromCache(e.roomId);if(n){if(void 0!==e.roomNote&&n.setNotes(e.roomNote),e.features&&n.setRoomFeatures(e.features),n.updatedRoomUser(e),c.includes("rooms.chat",{id:e.roomId})&&(e.isHidden||e.updateLastRead&&o.isDefined(e.markAllStoriesRead)&&!1===e.markAllStoriesRead)){var r=w.getMostRecentRoom(n.roomId,!1);e.isHidden&&r&&(s.rooms.update(n),c.go("rooms.chat",{id:r.roomId,force:!1})),e.updateLastRead&&o.isDefined(e.markAllStoriesRead)&&!1===e.markAllStoriesRead&&(r=w.getMostRecentRoom(n.roomId,!0))&&(n.setInactive(),c.go("rooms.chat",{id:r.roomId,force:!1}))}}else(e.unreadStories||e.unreadMentions)&&h.get(e.roomId).then(function(o){if(!w.findById(e.roomId))return w.add(o).then(function(o){return o.refreshed=!1,c.is("rooms.index")&&c.go("rooms.chat",{id:o.roomId},{reload:!0}),o})})}}),po=e.noop,ho=function(){var e=o.element("#recent-toggle.dropdown .dropdown-toggle"),t=C.getTour("roomsSortDropdown"),n=function(){t.nextStep()},i=function(){T(function(){e.click(),o.element(r).on("click",n)})},s=function(){T(function(){"true"===e.attr("aria-expanded")&&e.click(),o.element(r).off("click",n)})},a=o.element("#room-nav .room-nav-body-scrollable");e.length&&a.animate({scrollTop:0},function(){C.setBeforeOpen("roomsSortDropdown","roomsSortDropdown",i),C.setOnClose("roomsSortDropdown","roomsSortDropdown",s),C.show("roomsSortDropdown"),po()})},Io=function(o){s.rooms.length>=g.tooltip.roomOrganizeTooltipAfter&&o.roomsSortBy&&!o.roomsSortDropdown&&ho()},vo=l.$on("newRoom",function(o){t.widgetRoomId||o&&o.roomId&&s.rooms.add(o).then(function(e){o.creator.userId===p.user.userId&&o.creator.orgId===p.user.orgId||(e.markAsUnread=!0),s.rooms.length>=g.tooltip.roomOrganizeTooltipAfter&&(po=t.$on("$stateChangeSuccess",function(){ho()}))})}),yo=l.$on("invitedToRoom",function(o){t.widgetRoomId||o&&o.roomId&&!w.findById(o.roomId)&&s.rooms.add(o)}),wo=l.$on("inviteUser",function(o){if(o&&o.roomId){if(t.widgetRoomId&&o.roomId!==t.widgetRoomId)return;var e=w.findById(o.roomId);e&&e.addInvite(o)}}),bo=f.$on("deletedStory",function(o){if(!t.widgetRoomId||o.roomId===t.widgetRoomId){var e=h.getFromCache(o.roomId);e&&(e.updatedStory(o),t.$emit("story:deleted",o))}}),Ro=f.$on("storyBroadcasted",function(o){"SUCCESS"===o.status?t.$emit("broadcast:success",o):t.$emit("broadcast:error",o)}),So=B.on("showPopup",function(o){var e=[{label:o.button,cssClass:"btn-primary",dismiss:!0}];return a.messageBox(o.title,o.text,e)}),To=B.on("objectReferenceUpdatedEvent",function(o){if(o&&o.roomId&&o.referringStoryIds){var n=h.getFromCache(o.roomId);n&&o.referringStoryIds.length&&e.each(o.referringStoryIds,function(r){var i=e.findIndex(n.stories,{storyId:r});if(-1!==i){n.stories[i].updateObjectReference(o.objectReference),t.$emit("story:objectReferenceUpdate",o.objectReference)}})}});s.$onRootScope("notification:click",function(o,e){if(e.options.type&&"video"===e.options.type)F.stopNotificationSound(),j.open(e.options.roomId,!0),o.preventDefault();else{var t=e.options.roomId;t&&(c.go("rooms.chat",{id:t}),r.focus())}}),s.$on("$destroy",function(){K=!0,ro(),io(),vo(),yo(),wo(),co(),go(),uo(),lo(),fo(),bo(),Ro(),So(),To(),H(),q(),oo(),F.stop()}),s.roomListView=I.view,M.ga("Left Nav","initial left nav view",s.roomListView),s.changeListView=function(o){I.changeView(o),s.roomListView=I.view;var e={event:"click",location:"room nav list",sublocation:"toggle nav view button",timestamp:new Date,userId:p.user.userId,data:[{org_id:p.user.orgId,room_id:c.params.id,action:o,event_label:"order_by_"+("recent"===s.roomListView?"recent_msgs":"my_room_&_my_people")}]};k.log(e),M.ga("Left Nav","switch left nav view",o)},s.leftNavW=U.getInitialWidth("room-nav")||300,s.leftNav=!1,s.toggleRooms=function(e){s.leftNav=!e&&!s.leftNav,s.leftNav?(o.element("#room-nav").removeClass("d-none d-md-block"),o.element("#room-main-body").addClass("d-none d-md-block")):(o.element("#room-nav").addClass("d-none d-md-block"),o.element("#room-main-body").removeClass("d-none d-md-block"))};var ko;C.getSettings().then(function(o){if(ko=o,!(m.isMobile()||m.isWidget()||t.$breakpoint.mdDown||_.getVar("skipInterstitials")))if(o.interstitial)Io(e.pick(o,["roomsSortDropdown","roomsSortBy"]));else{var n=p.user.organizations.length>1?"1":"2";R.showInterstitials(n)}}),s.logSettingsWheelEvents=function(o){switch(o){case"SettingsWheel":M.ga("Left Nav","settings wheel","wheel opened");break;case"MessageSettings":M.ga("Left Nav","settings wheel","message settings");break;case"HelpTips":M.ga("Left Nav","settings wheel","helps and tips");break;case"ShortcutKeys":M.ga("Left Nav","settings wheel","shortcut keys");break;case"Integrations":M.ga("Left Nav","settings wheel","configure integrations");break;case"OutOfOffice":M.ga("Left Nav","settings wheel","out of office")}}}]});