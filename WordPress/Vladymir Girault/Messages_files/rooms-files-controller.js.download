define(["angular","lodash"],function(e,t){"use strict";return["$scope","room","eoDashConfig","eoFileAttachment","tlStory","eventLog","eoAuth","eoUsers","$window","$sce","$filter","$q","eoGoogleAnalytics",function(a,o,r,i,n,d,l,s,c,u,f,m,p){var h=function(t){return e.isDefined(t.metadata)&&e.isDefined(t.metadata.deleted)&&"true"===t.metadata.deleted.toString()},y=function(t){i.sanitizeUrls(t.metadata);var a={deleted:h(t),blocked:e.isDefined(t.blocked)&&!!t.blocked,id:t.objectReferenceId,type:"file",typeStr:"File",icon:"dash-icon dash-icon-file",name:t.metadata.fileName,url:u.trustAsResourceUrl(t.metadata.objectUrl),author:t.author,created:t.created,createdDisplay:t.createdDisplay};return t.metadata.spaceId&&t.metadata.fileId&&(a.fileId=t.metadata.fileId,a.spaceId=t.metadata.spaceId),t.metadata.afs&&(a.fileId=t.metadata.fileId,a.afs=t.metadata.afs),t.metadata.imageUrl&&(a.image=u.trustAsResourceUrl(t.metadata.imageUrl)),t.metadata.fileSize&&(a.size=f("humanSize")(t.metadata.fileSize)),a},g=function(t){var a=t.metadata.url,o="",i="";if(t.metadata.preview){var n;try{n=e.fromJson(t.metadata.preview),n.title&&(i=a,a=n.title),n.image!==n.url&&"article"!==n.type||(o=n.image),n.embed&&"photo"===n.embed.type&&(o=n.embed.thumbnailUrl||o||n.embed.url),o&&(o=r.previewImageURL+encodeURIComponent(o))}catch(e){}}return{deleted:!1,blocked:e.isDefined(t.blocked)&&!!t.blocked,id:t.objectReferenceId,type:"url",typeStr:"Link",name:a,objectUrl:t.metadata.url,url:u.trustAsResourceUrl(t.metadata.url),alt:i,image:o,author:t.author,created:t.created,createdDisplay:t.createdDisplay}},I=function(a){if(!a)return m.when([]);var o={today:"h:mm a",yesterday:"'Yesterday'",lastWeek:"EEEE",long:"shortDate"};e.forEach(a,function(e){e.createdDisplay=f("eoRoomTimestamp")(e.created,o)});for(var r=[],i=0;i<a.length;++i)a[i].author&&a[i].author.userId&&r.indexOf(a[i].author.userId)<0&&r.push(a[i].author.userId);return s.several(r,!0).then(function(e){for(var o={},r=0;r<e.length;++r)o[e[r].userId]=e[r];return t.filter(a.map(function(e){return e.author&&e.author.userId&&o[e.author.userId]&&(e.author.info=o[e.author.userId].info),"eo:file"===e.objectType?y(e):"eo:url"===e.objectType?g(e):null}))})},b=null,v=r.rooms.files.perPage;a.isLoading=!0,a.sortField="created",a.sortOrder="desc",a.files=[],a.totalItems=-1,a.hasMore=!1,a.sortBy=function(e,t){e="created",a.sortField===e?a.sortOrder="desc"===a.sortOrder?"asc":"desc":(a.sortOrder=t||"asc",a.sortField=e),b=null,a.getFiles()};var k={FilesAndLinks:"Files & Links",Files:"Files",Links:"Links"};a.typesDisplay=t.values(k),a.selectedType="",a.$watch("selectedType",function(){a.pickType(a.selectedType)},!0);var F="loadFilesAndLinks";a.type="FilesAndLinks",a.typeStr=k[a.type],a.pickType=function(e){a.type=k[e]?e:"FilesAndLinks",a.typeStr=k[a.type],F="load"+a.type,b=null,a.getFiles()};var _=0;a.getFiles=function(e){a.isLoading=!0;var t=v;e&&(b=null,a.files.length>t&&(t*=Math.ceil(a.files.length/t)));var r=++_;o[F](t||v,b,a.sortOrder).then(function(e){if(r===_)return a.totalItems=e.total,b||(a.files=[]),b=e.cursor,I(e.objectReferences).then(function(e){r===_&&(a.files=a.files.concat(e),a.hasMore=a.files.length<a.totalItems,a.isLoading=!1)})})},a.getFiles();var D=function(e){if(e.roomId===o.roomId){var t,r=!1,i=[];if(a.type.indexOf("Files")>=0&&i.push("eo:file"),a.type.indexOf("Links")>=0&&i.push("eo:url"),e.deleted)r=!0;else if(e.objectReferences)for(t=0;t<e.objectReferences.length;++t)if(i.indexOf(e.objectReferences[t].objectType)>=0){r=!0;break}r&&a.getFiles(!0)}},L=n.$on("newStory",D),U=n.$on("updatedStory",D),j=n.$on("deletedStory",D);a.logOpenFile=function(e){if("file"===e){var t={event:"click",location:"room files",sublocation:"file in room file list",timestamp:new Date,userId:l.user.userId,data:[{org_id:l.user.orgId,room_id:o.roomId,action:"file opened",event_label:"file_opened_from_files_list",opening_uid:o.context&&o.context.jobUid,contract_id:o.contractId,contractor_uid:o.context&&o.context.freelancerId}]};d.log(t),p.ga("Files","open file","from file list",{roomId:o.roomId})}};var x={event:"click",location:"room nav header",sublocation:"room files",timestamp:new Date,userId:l.user.userId,data:[{org_id:l.user.orgId,room_id:o.roomId,action:"room files list page displayed",event_label:"room_files_list_page_displayed",opening_uid:o.context&&o.context.jobUid,contract_id:o.contractId,contractor_uid:o.context&&o.context.freelancerId}]};d.log(x),p.ga("Files","open files panel","nav header click",{roomId:o.roomId}),a.$on("$destroy",function(){L(),U(),j()})}]});