define(["./common","angular","config-service","./users-service","./event-log-service","./user-presence-service","./analytics-service"],function(e,i){"use strict";e.factory("eoVisibility",["eoAuth","tlUser","tlSettings","eoDashConfig","eoUsers","eventLog","eoModelFactory","$exceptionHandler","eoUserPresence","eoGoogleAnalytics","eoChannel","eoDashCache",function(e,i,t,n,s,o,r,a,l,c,u,f){function v(){return I}function b(e){var t="Offline"===e?"INVISIBLE":"VISIBLE";c.ga("Rooms","visibility change",t),i.$emit("setVisibility",{visibility:t}),"online"===e.toLowerCase()&&i.$emit("presence",{show:"online"}),I=e,y()}function h(e){var i={global:!0,component:"visibility",preferences:{preferenceList:[{prefKey:"timeLastSetInvisibile",prefValue:e}]}};return t.saveSettings(i)}function y(){if("Online"===I){var e;s.getParsedSettings(!0).then(function(i){if(e=i.visibility&&i.visibility.timeLastSetInvisibile,parseInt(e)){var t=Math.floor(Date.now()/1e3)-parseInt(e);try{o.log({event:"click",location:"header dropdown",sublocation:"visibility button",timestamp:new Date,data:[{action:t,event_label:"timeUserInvisible"}]})}catch(e){a(e)}c.ga("Rooms","visibility change",t);var n=g(t);c.ga("Rooms","visibility change time brackets",n),h(0)}})}else h(Math.floor(Date.now()/1e3))}function g(e){var i,t,n;return e<60?i="less than a minute":e>=60&&e<600?(t=Math.floor(e/60),n=Math.floor(e/60)+1,i="between "+t+" and "+n+" minutes"):e>=600&&e<3600?(t=Math.floor(e/600),n=Math.floor(e/600)+1,i="between "+10*t+" and "+10*n+" minutes"):e>=3600&&e<86400?(t=Math.floor(e/3600),n=Math.floor(e/3600)+1,i="between "+t+" and "+n+" hours"):e>=86400&&(t=Math.floor(e/86400),n=Math.floor(e/86400)+1,i="between "+t+" and "+n+" days"),i}function d(i){var t;if(i){"invisible"===i.toLowerCase()?(I="Offline",t="INVISIBLE"):(I="Online",t="VISIBLE");var s=r.get("Visibility",{visibility:t});if(u.publish("channels.dash.visibility",s),n.enableDashCache){var o=f.get(e.user.userId);try{o.put("presenceStatus","INVISIBLE"===t?3:1)}catch(e){console.warn("There was an error saving the cache",e)}}}else I="Online"}var I="Online";return l.subscribe(function(i){e.user&&e.user.userId===i.userId&&d(i.presence)}),{getVisibility:v,setVisibility:b,setVisibilityFromPresence:d}}]);var t=i.module("components.core.dash",[]);t.run(["eoModelRegistry",function(e){var i=e.get("Base"),t=i.extend({visibility:null,init:function(e){void 0!==e&&this._super(e)}});e.put("Visibility",t)}]),t.service("eoDashVisibility",["eoVisibility",function(e){return{update:function(i){var t="VISIBLE"===i?"Online":"Offline";e.setVisibility(t)}}}])});