define(["./room","angular","lodash"],function(e,t,o){"use strict";function r(e){return e=e||{},e.message=e.message||e.logMessage||"Sorry something went wrong. Please try again",400===e.code&&e.message.match(/not admin/)?"EMAIL_INVITE_DISALLOWED":"NO_PERMISSION_IN_ORG"===e.codeExtended?"USER_ROOM_CREATE_DISALLOWED":"NO_CHAT_PERMISSION_IN_ORG"===e.codeExtended?"USER_CHAT_PERMISSION_REQUIRED":400===e.code&&e.message.match(/User is not PTC Enabled/)?"USER_IS_NOT_PTC_ENABLED":400===e.code&&e.message.match(/Inviter's email is not verified/)?"INVITER_EMAIL_NOT_VERIFIED":409===e.code?"USER_ALREADY_IN_ROOM":403===e.code?"USER_MAX_REACHED":405===e.code?"MESSAGE_PER_ROOM_MAX_REACHED":500===e.code&&e.message.match(/You exceeded the maximum number of rooms/)?"MESSAGE_PER_ROOM_MAX_REACHED":e.message.match(/Only users who are part of the client company .* can be added to interview rooms/)?"USER_MEMBERSHIP_REQUIRED":e.code>=500?"GENERIC":"UNKNOWN"}e.constant("EMAIL_PATTERN",/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]+$/).controller("dashInviteTokenizerController",["$scope","EMAIL_PATTERN","eoUsers","$q",function(e,o,r,n){e.isLoadingUsers=!1,e.query=null,e.selected=null;e.handleKeyPress=function(o){var r=t.element(".tokenizer-token:nth-last-child(1)");if(8===o.keyCode){if(e.$parent.$parent&&e.$parent.$parent.tokens&&e.$parent.$parent.tokens.length>0&&0===o.target.value.length)if(r.hasClass("tokenizer-token-selected")){var n=e.$parent.$parent.tokens;e.$parent.$parent.removeToken(n.length-1),r.removeClass("tokenizer-token-selected")}else r.addClass("tokenizer-token-selected")}else r.hasClass("tokenizer-token-selected")&&r.removeClass("tokenizer-token-selected")},e.loadUsers=function(t,o){var n={query:t,limit:10};if(o&&(n.excludeRoomId=o.roomId,o.isJustInterview())){var s=[];o.context.freelancerOrgId&&s.push(","+o.context.freelancerOrgId),o.context.clientOrgId&&s.push(","+o.context.clientOrgId),o.context.associatedAgencyOrgId&&o.context.freelancerOrgId!==o.context.associatedAgencyOrgId&&s.push(","+o.context.associatedAgencyOrgId),s.length&&(n.includeIds=s)}return e.isLoadingUsers=!0,r.searchForTags(n).then(function(t){var o=[];e.$parent.$parent&&e.$parent.$parent.tokens&&(o=e.$parent.$parent.tokens),t=t.filter(function(e){return!o.some(function(t){return e.username===t.username?e.subtext===t.subtext:e.username===t.username})});var r={};return t.map(function(e){return e.subtext&&(e.text+=" - "+e.subtext),r[e.text]=r[e.text]||0,r[e.text]++,r[e.text]>1&&(e.text+=" ("+r[e.text]+")"),e})}).finally(function(){e.isLoadingUsers=!1})},e.loadUsersOrEmpty=function(t,r,s){var i,a=n.defer();return i=t&&!s?this.loadUsers(t,r):n.when([]),i.then(function(r){0===r.length&&t.match(o)&&r.push({text:t,fullName:t}),e.$emit("userLookupErrorMessage",""),a.resolve(r)},function(){e.$emit("userLookupErrorMessage","We're sorry, your contacts are temporarily unavailable."),a.resolve([])}),a.promise},e.onSelectInvitee=function(t,o){e.$parent.$parent.addToken(t),e.$emit("emailSelected",o),e.selected=null}}]).controller("roomDialogCreateCtrl",["eoRoomDialog","$modalInstance","eoAuth","eoUsers","eoRooms","roomType","roomName","roomUsers","eoRoomStory","$scope","$q","$window","eventLog","canInviteUser","eoGoogleAnalytics","eoPhishingAnalytics","eoDashConfig","EMAIL_PATTERN","escapeHtmlFilter",function(e,n,s,i,a,l,c,u,m,d,h,g,p,f,v,I,y,x,_){var b=this;this.type=l||"private",this.name=c,this.users=u,this.inProgress=!1,b.userLookupErrorMessage=null,this.enablePublicRooms=s.organization.enablePublicRooms,this.addFromAutocompleteOnly=!0,this.placeHolder="Invite users by name",f&&(this.addFromAutocompleteOnly=!1,this.placeHolder+=" or email"),this.placeHolder+="?",this.storyObj=m.create(),d.isLoadingUsers=!1,d.selectedUser="",d.inputFormatter=function(e){return _(e.text)},d.$on("userLookupErrorMessage",function(e,t){b.userLookupErrorMessage=t}),d.$on("emailSelected",function(e,t){d.findUser(t)}),d.findUser=function(e){e.match(x)&&i.searchForTags({email:e}).then(function(r){r.length&&(E.users=o.chain(E.users).map(function(o){return o.text===e?t.extend(o,r[0],{tag:e.text,text:r[0].text+" ("+e+")"}):o}).uniq(function(e){return e.tag?e.tag:e.text}).value())})};var E=this,w=d.$watch(function(){return E.users},function(e){e&&e.length&&(E.placeHolder="Type to add more people")},!0);d.$on("$destroy",function(){w()}),this.contactUs=function(t){n.dismiss("contact upwork");var o={error:t};e.showContactUs(o)},this.submit=function(){var e=this,o={email:0,username:0};this.inProgress=!0,this.name&&(this.name=this.name.replace(/\u00AD/g,"")),this.errors=[],this.name?this.name.trim().length>128&&this.errors.push("The room name can not be more than 128 characters."):this.name="Unnamed Room",this.topic&&this.topic.trim().length>128&&this.errors.push("The room topic can not be more than 128 characters.");var l=[],c={roomName:this.name.trim(),topic:this.topic||"",users:[]};if(t.forEach(this.users,function(t){t.orgId||(t.orgId=s.user.orgId),t.text.match(/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/)?(l.push(t.text),o.email+=1):t.data&&t.orgId?i.isBlockedByUser(t.data)?e.errors.push(t.text+" has blocked you."):i.hasBlockedUser(t.data)?e.errors.push(t.text+" is blocked by you."):(c.users.push({userId:t.data,role:"admin",orgId:t.orgId}),o.username+=1):e.errors.push("Invalid user: "+t.text)}),o.email>y.maxEmailInvites&&this.errors.push("The number of email invites can not exceed "+y.maxEmailInvites+"."),this.users.length>20&&this.errors.push("You can only add 20 users at a time"),this.errors.length>0)return void(this.inProgress=!1);"public"===this.type&&(c.isPublic=!0),c.users.push({userId:s.user.userId,orgId:s.user.orgId}),a.create(c).then(function(o){t.forEach(l,function(e){o.inviteEmail(e,null,null,c.isPublic)}),e.storyObj.message.trim().length&&o.newStory(e.storyObj.plain()),n.close(o)},function(o){e.errors=[];var n;t.isArray(o)&&o.length&&o[0].code?(n=o[0],n.type=r(n),I.sendByType(n.type),e.errors.push(n)):e.errors.push("Sorry something went wrong. Please try again"),e.inProgress=!1});var u={event:"click",location:"room nav list",sublocation:"create room dialog",timestamp:new Date,userId:s.user.userId,data:[{org_id:s.user.orgId,action:"room created",room_name:c.roomName,opening_uid:c.context&&c.context.jobUid,contract_id:c.contractId,contractor_uid:c.context&&c.context.freelancerId,event_label:"room_created"}]};p.log(u),v.ga("Rooms","create room");var m={event:"click",location:"room nav list",sublocation:"create room dialog",timestamp:new Date,userId:s.user.userId,data:[{org_id:s.user.orgId,action:"Invite users at creation",num_invited_by_email:o.email,num_invited_by_username:o.username,room_name:c.roomName,event_label:"Invite_users_at_creation",opening_uid:c.context&&c.context.jobUid,contract_id:c.contractId,contractor_uid:c.context&&c.context.freelancerId}]};p.log(m),o.email>0&&v.ga("Rooms","invite user during creation","by email"),o.username>0&&v.ga("Rooms","invite user during creation","by username")}}]).controller("roomDialogInviteCtrl",["eoRoomDialog","$modalInstance","$q","$modal","eoAuth","eoUsers","room","eoResponseHandler","$window","eventLog","canInviteUser","eoGoogleAnalytics","eoPhishingAnalytics","eoDashConfig","EMAIL_PATTERN","escapeHtmlFilter","$scope","eoDashContext","allowInviteHM","eoAlert",function(e,n,s,i,a,l,c,u,m,d,h,g,p,f,v,I,y,x,_,b){var E=this;if(this.role=c.isMember(a.user)?"participant":"admin",this.room=c,this.allowInviteHM=_,this.inProgress=!1,this.mappingPromises=[],this.addFromAutocompleteOnly=!0,this.placeHolder="Start typing names",h&&(E.addFromAutocompleteOnly=!1,E.placeHolder+=" or emails"),_){E.placeHolder="Start typing emails";var w={event:"impression",location:"dash",sublocation:"help_me_hire_modal",data:[{dash_location:c.isJustInterview()?"interview_room":"workroom"}]};d.log(w)}this.contactUs=function(t){n.dismiss("contact upwork");var o={roomId:c.roomId,error:t};e.showContactUs(o)},this.submit=function(){var e=[],i=[],u={email:0,username:0};this.errors=[],s.all(E.mappingPromises).then(function(){var m=[];if(t.forEach(E.users,function(o){if(m.push(o.text),o.orgId||(o.orgId=a.user.orgId),o.data)t.forEach(c.users,function(e){if(e.userId===o.data&&e.orgId===o.orgId)return void E.errors.push("You cannot invite "+o.text+" who is already in the room.")}),l.isBlockedByUser(o.data)?E.errors.push(o.text+" has blocked you."):l.hasBlockedUser(o.data)?E.errors.push(o.text+" is blocked by you."):(e.push(o),u.username+=1);else{if(!o.text.match(v))return void E.errors.push("Invalid user: "+o.text);o.email=o.text,e.push(o),u.email+=1}}),u.email>f.maxEmailInvites&&E.errors.push("The number of email invites can not exceed "+f.maxEmailInvites+"."),!(E.errors.length>0)){if(!e.length)return void E.errors.push("Please re-enter email address and press enter.");if(e.length>20)return void E.errors.push("You can only add 20 users at a time");if(E.inProgress=!0,_){var h={event:"click",location:"dash",sublocation:"help_me_hire_modal",data:[{dash_location:c.isJustInterview()?"interview_room":"workroom",permission:E.role,emails_list:o.map(e,"email"),inviter_client_id:a.organization.rid}]};d.log(h)}var I=e.map(function(e){if(e.email)return c.inviteEmail(e.email,e.orgId,E.role);i.push({orgId:e.orgId,role:E.role,userId:e.data})});I.push(c.inviteUsers(i)),s.all(I).then(function(){E.inProgress=!1,n.close();var e="";1===m.length?(e+=m.join(", "),e+=" has been invited"):m.length>1&&(e+=m.join(", "),e+=" have been invited"),""!==e&&b.inline({type:"success",duration:3e3,template:e})},function(e){E.inProgress=!1,t.forEach(e,function(e){e.type=r(e),p.sendByType(e.type),E.errors.push(e)})});var y={event:"click",location:"room nav header",sublocation:"Add People in dropdown menu",timestamp:new Date,userId:a.user.userId,data:[{org_id:a.user.orgId,action:"Invite users after room was already created",num_invited_by_email:u.email,num_invited_by_username:u.username,room_name:E.room.roomName,event_label:"Invite_users_after_room_was_already_created",opening_uid:E.room.context&&E.room.context.jobUid,contract_id:E.room.contractId,contractor_uid:E.room.context&&E.room.context.freelancerId}]};d.log(y),u.email>0&&g.ga("Rooms","invite user after creation","by email",{roomId:E.room.roomId}),u.username>0&&g.ga("Rooms","invite user after creation","by username",{roomId:E.room.roomId})}},function(){E.errors.push("Unknown error. Please try again later.")})},y.inputFormatter=function(e){return I(e.text)},y.$on("emailSelected",function(e,t){y.findUser(t)}),y.findUser=function(e){if(e.match(v)){var r=l.searchForTags({email:e});E.mappingPromises.push(r),r.then(function(r){r.length&&(E.users=o.chain(E.users).map(function(o){return o.text===e?t.extend(o,r[0],{tag:e,text:r[0].text+" ("+e+")"}):o}).uniq(function(e){return e.tag?e.tag:e.text}).value())})}}}]).controller("roomDialogFindPublicCtrl",["$modalInstance","$scope","$q","eoResponseHandler","eoRooms","eoUsers","eoAuth","create","eoDashConfig","$state","$window","$timeout",function(e,o,r,n,s,i,a,l,c,u,m,d){this.select=function(t){e.close(t.roomId),u.go("rooms.chat",{id:t.roomId})},s.search({privacy:"public",isSubscribed:!1,limit:c.rooms.perPage}).then(function(e){var r=[];t.forEach(e,function(e){r.push(e.creator.userId)}),i.several(r,!0).then(function(r){var n={};t.forEach(r,function(e){n[e.userId]=e}),t.forEach(e,function(e){e.creatorUser=n[e.creator.userId]}),o.rooms=e,d(function(){m.dispatchEvent(new Event("resize"))})})},n.errors),this.createRoom=function(){e.dismiss("creating room instead"),l("public").result.then(function(e){e&&u.go("rooms.chat",{id:e.roomId})})},this.canCreate=a.isClient(),o.search="",o.filterResults=function(e){return!o.search||e.roomName&&e.roomName.toLowerCase().indexOf(o.search.toLowerCase())>=0||e.topic&&e.topic.toLowerCase().indexOf(o.search.toLowerCase())>=0||e.creatorUser.info.fullName&&e.creatorUser.info.fullName.toLowerCase().indexOf(o.search.toLowerCase())>=0}}]).controller("roomDialogInterstitialsCtrl",["$rootScope","$scope","$modalInstance","eoUsers","eoAuth","eoDashConfig","eoRooms","eoNotification","eoDashContext","eoTourService","interstitialType",function(e,o,r,n,s,i,a,l,c,u,m){o.isClient=s.isClient(),o.type=m,o.odeskBaseUrl=i.odeskBaseURL,o.enableNotif=function(){l.granted()?l.show("Success",{body:"You have successfully enabled desktop notifications."}):l.request()},o.slides=[{name:"welcome",title:"Messages in one place",img:i.assets.url+i.imagesPath+"/tour/welcome.png"},{name:"accounts",title:"Toggle between your different accounts",img:i.assets.url+i.imagesPath+"/tour/sort.png"},{name:"mobile",title:"Message anytime, anywhere",img:i.assets.url+i.imagesPath+"/tour/mobile.png",appStoreImg:i.assets.url+i.imagesPath+"/tour/app_store_download.png",googlePlayImg:i.assets.url+i.imagesPath+"/tour/google-play-badge.png"},{name:"uta",title:"Already use the Desktop App?",img:i.assets.url+i.imagesPath+"/tour/team-app.png"},{name:"notif",title:"Enable notifications",img:i.assets.url+i.imagesPath+"/tour/enable_notification.png"}];var d=function(e){t.forEach(o.slides,function(t,r){t.name===e&&o.slides.splice(r,1)})};"2"===o.type&&d("accounts"),c.isTeamApp()&&(d("notif"),d("uta")),o.showNext=function(){var e=t.element(".interstial-carousel .active").index();e++,o.slides[e].active=!0},o.isDone=function(){return t.element(".interstial-carousel .active").index()+1===o.slides.length},o.done=function(){u.saveSettings({interstitial:!0}),r.close()}}]).controller("roomDialogHelpCtrl",["$window","upMarkdownItFormatFilter","deviceDetector",function(e,o,r){this.isApple=!(!e.navigator.platform||!e.navigator.platform.match(/^Mac|^iPhone|^iPad/)),this.isSupportedCtrlShiftV=["ie","ms-edge","firefox"].indexOf(r.browser)<0,this.formatting=[{label:"Bolded Text",text:"**Bolded Text**\n__Bolded Text__"},{label:"Italic Text",text:"*Italic Text*\n_Italic Text_"},{label:"Strikethrough Text",text:"~~Strikethrough Text~~"},{label:"Blockquotes",text:"> quoted text\n> second quoted line\n\nor\n> quoted text\nsecond quoted line"},{label:"Code Blocks",text:"`inline fixed width text`"},{text:"Block code \"fences\":\n```\nif (code) {\n  print('text');\n}\n```\n\nSyntax highlighting:\n```javascript\nvar foo = function (bar) {\n  return bar++;\n};\nconsole.log('Foo', foo(5));\n```"}],t.forEach(this.formatting,function(e){e.html=o(e.text)}),console.log(this.formatting)}]).controller("roomDialogMessagingLimitCtrl",["context","$modalInstance","eoRoomDialog",function(e,t,o){this.context=e,this.contactUs=function(e){t.close(),o.showContactUs(e)}}]).controller("roomDialogContactUsCtrl",["context","$modalInstance","eoDashContext","eoOauth","$http","$interpolate","eoDashConfig","eoPhishingAnalytics",function(e,t,o,r,n,s,i,a){this.context=e,this.userComment="",this.errors=[],this.confirmation=!1;var l;if(e&&e.error)switch(e.error.type){case"USER_MAX_REACHED":l="user-max-ticket",e.message="You can request an exception below if you need to exceed the maximum user limit per room. Be sure to explain why you need this exception.";break;case"MESSAGE_PER_ROOM_MAX_REACHED":l="message-max-ticket",e.message="You can request an exception below if you need to exceed the daily maximum messaging limit. Be sure to explain why you need this exception.";break;default:e.message=""}if(!e||!e.message)throw new Error("The contact us modal must be supplied with a recognizable context");this.submit=function(){this.inProgress=!0,this.errors=[];var t=this;if(!this.userComment)return this.errors.push("Please provide details as to why you need this exception"),void(this.inProgress=!1);var c=s("{{baseUrl}}/{{action}}")({baseUrl:i.zendeskUrl,action:l}),u={};o.useOauth2()&&(u={Authorization:"Bearer "+r.getToken()});var m=e.roomId?{roomId:e.roomId}:{};return m.comment=this.userComment,a.sendByType(e.error.type,"exception request submitted"),n.post(c,m,{headers:u}).then(function(e){e.data.error?(t.errors.push("Sorry, Something went wrong. Please try again."),t.inProgress=!1):(t.confirmation=!0,t.inProgress=!1)},function(){t.errors.push("Sorry, Something went wrong. Please try again."),t.inProgress=!1})}}]).factory("eoPhishingAnalytics",["eoGoogleAnalytics",function(e){return{sendUserLimit:function(e){return this.send("user limit",e)},sendMessagingLimit:function(e){return this.send("message limit",e)},send:function(t,o){o=o||"reached",e.ga("PhishingLimits",t,o)},sendByType:function(e,o){switch(e){case"USER_MAX_REACHED":return this.sendUserLimit(o);case"MESSAGE_PER_ROOM_MAX_REACHED":return this.sendMessagingLimit(o);default:t.noop()}}}}]).factory("eoRoomDialog",["$modal","$modalStack","$window","$q","eoAuth","eoPhishingAnalytics",function(t,o,n,s,i,a){var l=e.templatePath+"room-dialog-",c=function(){var e=o.getTop();n.setTimeout(function(){e.value.modalDomEl.find("[autofocus]").focus()})};return{create:function(e,o,r){var n=t.open({templateUrl:l+"create.html",controller:"roomDialogCreateCtrl as newRoom",resolve:{roomType:function(){return e},roomName:function(){return o||""},roomUsers:function(){return r||[]},canInviteUser:function(){return i.canInviteUser()}}});return n.opened.then(c),n},invite:function(e,o){var r=t.open({templateUrl:l+"invite.html",controller:"roomDialogInviteCtrl as invite",size:o?"lg":"md",windowClass:o?"invite invite-coworker-dialog":"invite invite-people-dialog",resolve:{room:function(){return e},canInviteUser:function(){return i.canInviteUser()},allowInviteHM:o}});return r.opened.then(c),r},leave:function(e,o,r,n){t.promptBox("Confirm leaving room","Do you really want to leave the room?").result.then(function(t){t&&e.leave(r,n)})},archive:function(e){var o=[{result:!0,label:"Archive Room",cssClass:"btn-primary",focus:!0},{result:!1,label:"Don't Archive",cssClass:"btn-link"}],r=["Archiving this room will not allow anyone to post to this room anymore.","You will be able to search and read its contents even after you have archived it. This action cannot be reversed later.","Are you sure you want to archive this room?"];return t.messageBox("Archive Room",r,o).result.then(function(t){return t?e.archive():s.when(!1)})},error:function(e,o){var r=[{result:!0,label:"OK",cssClass:"btn-primary",focus:!0}],n=[o];return t.messageBox(e,n,r)},resendInvite:function(e,o){t.promptBox("Confirm resending","Do you really want to resend the invitation?").result.then(function(t){t&&e.inviteEmail(o)})},findPublic:function(){var e=this,o=t.open({templateUrl:l+"find-public.html",controller:"roomDialogFindPublicCtrl as publicRoom",windowClass:"modal-compact modal-sticky",resolve:{create:function(){return e.create}}});return o.opened.then(c),o},showInterstitials:function(e){if(!this.ftuModal)return this.ftuModal=t.open({templateUrl:l+"interstitials.html",controller:"roomDialogInterstitialsCtrl as publicRoom",keyboard:!1,backdrop:"static",size:"lg",windowClass:"interstitial-lg-"+e,resolve:{interstitialType:function(){return e}}}),this.ftuModal},showHelp:function(){return t.open({templateUrl:l+"help.html",controller:"roomDialogHelpCtrl as help",windowClass:"room-help",size:"lg"})},showContactUs:function(e){return e&&e.error&&(e.error.type=r(e.error),a.sendByType(e.error.type,"contact us")),t.open({templateUrl:l+"contact-us.html",controller:"roomDialogContactUsCtrl as contactUs",resolve:{context:e}}).result},showMessageLimitError:function(e){return e&&e.error&&(e.error.type=r(e.error),a.sendByType(e.error.type)),t.open({templateUrl:l+"messaging-limit.html",controller:"roomDialogMessagingLimitCtrl as ctrl",resolve:{context:e}}).result},broadcastMessage:function(o){return t.open({templateUrl:e.templatePath+"broadcast-message-dialog.html",controller:"broadcastMessageDialogCtrl as broadcast",size:"sm",resolve:{teams:function(){return o}}})},showGroupInvite:function(o){return t.open({templateUrl:e.templatePath+"group-invite-modal.html",scope:o,windowClass:"group-invite-modal modal-compact modal-sticky"})}}}])});