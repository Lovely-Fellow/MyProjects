define(["./common","angular","lodash","rxjs"],function(e,n,r,t){"use strict";var c={};e.factory("eoUserPresence",["$q","tlUser",function(e,o){function s(){n.forEach(c,function(e,n){delete c[n]})}function i(e){return c[e]}function u(e){l.subscribe(e)}function f(e,r){n.forEach(e,function(e){b[e]&&(b[e].reject(r),delete b[e])})}function a(){if(p.length){var e=n.copy(p);o.getPresence({ids:e}).then(function(e){return e.list},function(n){f(e,n)}).then(function(r){n.forEach(r,function(e,n){d(n,e),b[n]?(b[n].resolve(e.toLowerCase()),delete b[n]):console.info("eoUserPresence.fetch error",e)}),f(e,"eoUserPresence.fetch presence not included in the response")}),p=[]}}function h(r,t){n.isArray(r)||(r=[r]);var o={};return t=n.isUndefined(t)||t,n.forEach(r,function(n){var r=t&&c[n];r?o[n]=e.when(r):(b[n]||(p.push(n),b[n]=e.defer()),o[n]=b[n].promise)}),v(),e.all(o)}function d(e,n){n=n.toLowerCase(),c[e]!==n&&(c[e]=n,l.next({userId:e,presence:n}))}var l=new t.Subject,p=[],b={},v=r.debounce(a,10,{maxWait:200});return o.$on("presence",function(e){d(e.userId,e.show)}),{presence:c,set:d,get:i,subscribe:u,fetch:h,clear:s}}])});