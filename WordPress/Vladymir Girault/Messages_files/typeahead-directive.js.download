define(["../room","angular","lodash","./composer-constants-init"],function(e,t,i){"use strict";e.directive("eoDashTypeahead",["$window","$timeout","$q","COMPOSER_MENTION_END_MARKER","COMPOSER_LOOKUP_KEY_MARKER",function(e,n,o,a,s){var l=function(e){if("function"==typeof e)return e;var t=e.map(function(e){return e.toLowerCase()}),i=t.length;return function(n){for(var a=n.toLowerCase(),s=[],l=0;l<i;++l)t[l].indexOf(a)>-1&&s.push(e[l]);return o.when(s)}};return{restrict:"AC",scope:!0,controller:["$scope","$attrs",function(e,n){var o=null;e.list={active:!1,data:[],selected:0,lookupError:!1,errorMessage:"Temporarily Unavailable"},e.pos=0,e.source=e.$eval(n.eoDashTypeahead),e.source||(e.source=[]),t.isObject(e.source)&&!t.isArray(e.source)?t.forEach(e.source,function(t,i){e.source[i]=l(t)}):e.source={"@":l(e.source)};var a=e.$eval(n.eoDashTypeaheadLookupOptions),s=t.isObject(a)&&!t.isArray(a);e.lookupOptions=i.merge({maxLength:30,maxWords:4,debounce:250},s?a:{}),e.prev=function(t){e.list.$apply(function(){var i=t?5:1;e.list.selected>=i?e.list.selected-=i:e.list.selected=t?0:e.list.data.length-1})},e.next=function(t){e.list.$apply(function(){var i=t?5:1;e.list.selected<e.list.data.length-i?e.list.selected+=i:e.list.selected=t?e.list.data.length-1:0})},e.home=function(){e.list.$apply(function(){e.list.selected=0})},e.end=function(){e.list.$apply(function(){e.list.selected=e.list.data.length-1})},e.close=function(){(e.list.active||e.list.data.length)&&e.list.$apply(function(){e.list.active=!1,e.list.data=[],o=null})},e.hideTypeaheadList=function(){e.list.active=!1},e._select=function(t,i){if(e.list.active){var n=e.list.data[e.list.selected];e.$emit("typeahead:callback",e.pos,i,n),e.close()}},e.resetLookupError=function(){e.list.lookupError=!1},e.setLookupError=function(){e.list.lookupError=!0},e.lookup=function(n,a){e.list.active=!0,a!==o&&(o=a,t.isUndefined(e.source[n])||e.source[n](a).then(function(t){e.resetLookupError(),e.list.active&&o===a&&(e.list.selected=0,e.list.data=t.map(function(t){return t.focus=function(t){e.list.selected=t},t.select=function(t){i.delay(function(){e.select(t)},0)},t}))}).catch(function(){e.setLookupError()}))},this.linkList=function(t){e.list=t}}],link:function(n,o){function l(e){if(27===e.keyCode)return void n.close();var i,o=r.get(0).selectionStart,l=r.val(),c=-1;if(t.forEach(n.source,function(e,t){var n=l.slice(0,o).replace(new RegExp("(^|\\s)"+t+"(?!\\s)","g"),"$1"+s).lastIndexOf(s);n>c&&(c=n,i=t)}),c<0)return void n.close();var u=l.slice(c+1,o);if(u.length>n.lookupOptions.maxLength||u.match(/\s+/g)&&u.match(/\s+/g).length+1>n.lookupOptions.maxWords||u.indexOf(a)>-1)return void n.close();n.pos=c,n.lookup(i,u)}var c,r=o.find("[eo-dash-typeahead-input]");n.select=function(e){t.isDefined(e)&&(n.list.selected=e),n._select(r,r.get(0).selectionStart)};var u=function(e){switch(e.keyCode){case 38:case 33:e.altKey||(c=r.val(),n.list.active&&n.list.data.length?(n.prev(33===e.keyCode),e.preventDefault()):""===c.trim()&&38===e.keyCode&&n.$emit("typeahead:keyup"));break;case 40:case 34:!e.altKey&&n.list.active&&n.list.data.length&&(n.next(34===e.keyCode),e.preventDefault());break;case 36:!e.altKey&&n.list.active&&n.list.data.length&&(n.home(),e.preventDefault());break;case 35:!e.altKey&&n.list.active&&n.list.data.length&&(n.end(),e.preventDefault());break;case 27:n.list.active||(n.$apply(function(){n.$emit("typeahead:cancel")}),e.preventDefault());break;case 13:case 9:n.list.active&&n.list.data.length?(n.select(),e.preventDefault()):13===e.keyCode&&(e.shiftKey||e.altKey||e.ctrlKey||n.$emit("typeahead:submit",e))}},d=n.lookupOptions.debounce?i.debounce(l,n.lookupOptions.debounce):l,p=function(){var e=n.list.data.length>0;n.list.active!==e&&n.$evalAsync(function(){n.list.active=e})},f=function(e){o.find(e.target).size()||n.list.active&&n.$evalAsync(function(){n.list.active=!1})};r.bind("keydown",u),r.bind("keyup",d),r.bind("focus",p),t.element(e.document).bind("click",f),n.$on("$destroy",function(){r.unbind("keydown",u),r.unbind("keyup",d),r.unbind("focus",p),r=null,c=null,t.element(e.document).unbind("click",f)})}}}]).directive("eoDashTypeaheadList",function(){return{restrict:"E",templateUrl:e.templatePath+"composer/typeahead-directive.html",require:"^eoDashTypeahead",scope:{data:"=",selected:"=",errorMessage:"=?"},transclude:!0,link:function(e,t,i,n){e.active=!1,e.data=[],e.selected=0,e.up=i.hasOwnProperty("up"),e.lookupError=!1,e.errorMessage=e.errorMessage||"Temporarily Unavailable",e.close=function(){e.active=!1,e.lookupError=!1},n.linkList(e)}}}).directive("eoDashTypeaheadItem",function(){return{restrict:"E",templateUrl:e.templatePath+"composer/typeahead-item-directive.html",transclude:!0,replace:!0,scope:{item:"=",selected:"=",index:"="},link:function(e,t){var i=t.parent(),n=e.$watch("selected",function(n){if(n===e.index){t.focus();var o=i.scrollTop(),a=t.position();if(a.top<0)i.scrollTop(o+a.top);else{var s=i.height(),l=a.top+t.height();s<l&&i.scrollTop(o+l-s)}}});e.$on("$destroy",function(){n(),i=null})}}})});