define(["./room","lodash","angular"],function(e,t,o){"use strict";var r=!1;e.factory("eoRoomListAPI",["$window",function(e){var t=e.localStorage.getItem("listView")||"recent";return{scrollParams:{},scrollToRoom:function(e,t,o){this.scrollParams.checkVisible=t,this.scrollParams.noAnimate=o,this.scrollParams.roomId=e},view:t,changeView:function(t){this.view=t,this.viewChange=(new Date).getTime(),e.localStorage.setItem("listView",t)}}}]).directive("eoRoomList",["$rootScope","$location","$state","$q","eoRoomDialog","eoRooms","eoRoomListCache","$filter","eoAuth","eoUsers","$document","$exceptionHandler","eventLog","$window","$timeout","eoFavoriteStoriesModal","eoGoogleAnalytics","upDashMetrics","eoDashContext","deviceDetector",function(n,a,i,s,c,m,l,u,d,f,p,g,v,y,h,T,S,w,I,_){return{restrict:"E",replace:!0,scope:!0,templateUrl:e.templatePath+"room-list-directive.html",controller:["$scope","eoRoomListAPI","$timeout","$element",function(e,t,o,n){e.showFavoriteStories=function(){T.showFavoriteStories(e).then(function(){e.toggleRooms()})},e.api=t,e.$watch("api.scrollParams.roomId",function(t){var r=e.api.scrollParams.checkVisible,a=e.api.scrollParams.noAnimate;if(t){var i=n.find("#rl_"+t);if(i&&i[0]){var s=n;o(function(){var t=i[0].getBoundingClientRect(),o=s[0].getBoundingClientRect();if(!r||!(t.top>=0+o.top&&t.bottom<=o.top+s.outerHeight())){var c=i[0].offsetTop-s[0].offsetTop;a?n.scrollTop(c):n.animate({scrollTop:c})}e.api.scrollParams={}})}}}),e.view="",e.$watch("api.viewChange",function(){e.view=t.view,e.pagination.currentPage=1,e.rooms.resetKeepUnread(),n[0].scrollTop=0}),r||(r=!0,o(function(){w.time("roomListLoad",y.performance.now())}))}],link:function(e,r){function n(e){return t.filter(e,function(e){return e.isInterviewRoom()})}e.isClient=d.isClient(),e.selected=i.params.id||i.current.name,e.$on("$stateChangeStart",function(t,o,r){e.selected=r.id||o.name}),e.$onRootScope("story:markedUnread",function(o,r){var n=u("recent")(e.rooms),a=t.find(n,function(e){return e.roomId!==r.roomId&&!e.numUnread});a&&(e.open(a.roomId),_.isMobile()&&e.$emit("view:rooms:show"))}),e.roomsCategoryName="Groups",e.filterTypes={recent:"All Recent",unread:"Unread",interviews:"Interviews Only",contracts:"Contracts Only"},e.categoriesOrder=["groups","people","interviews"],e.filterType="recent",e.filterName=e.filterTypes.recent,e.goDirectory=function(t){i.go("rooms.directory.main",{type:t}),e.toggleRooms(),S.ga("Rooms","my rooms and people","opened");var o={event:"click",location:"room nav list",sublocation:"My Rooms & People",timestamp:new Date,userId:d.user.userId,data:[{org_id:d.user.orgId,action:"My Rooms & People clicked",event_label:"my_rooms_&_people_clicked"}]};v.log(o)},e.canHide=function(){return e.roomList&&e.roomList.total&&e.roomList.total>1},e.hasActions=function(t){return t.canArchive()||e.canHide()},e.hideRecent=function(t,o,r){if(!I.isReadOnlyMode()){var n=e.rooms.findById(t);n.setHidden(!0).then(function(){o&&n.setFavorite(!1)}),r.stopPropagation()}},e.archive=function(t,o){if(!I.isReadOnlyMode()){var r=e.rooms.findById(t);if(r){c.archive(r).then(function(o){if(o){e.$emit("room:archived",r);var n=u("recent")(e.rooms);if(i.includes("rooms.chat",{id:t})&&n.length>1){for(var a=1,s=n[0];s&&s.roomId===t;)s=n[a++];i.go("rooms.chat",{id:s.roomId})}_.isMobile()&&e.$emit("view:rooms:show")}});var n={event:"click",location:"left nav",sublocation:"archive this room",timestamp:new Date,userId:d.user.userId,data:[{org_id:d.user.orgId,room_id:r.roomId,action:"archive room",event_label:"archive_room",opening_uid:r.context&&r.context.jobUid,contract_id:r.contractId,contractor_uid:r.context&&r.context.freelancerId}]};v.log(n),S.ga("Rooms","room archived","from room list",{roomId:r.roomId})}o.stopPropagation()}},e.clickOptions=function(e){e.stopPropagation()};var a=!1;e.sortableOptions={beforeStop:function(){a=!0},stop:function(){a=!1,m.reorderFavorites(e.roomList.favorites);var t={event:"click",location:"room nav list",sublocation:"favorites",timestamp:new Date,userId:d.user.userId,data:[{org_id:d.user.orgId,event_label:"reorder_fav_rooms"}]};v.log(t),S.ga("Rooms","favorite rooms","drag reorder")}},e.pagination={currentPage:2,itemsPerPage:function(){return e.roomList&&e.roomList.length||-1}},e.setFilterType=function(t){e.loading=!0,e.reInitializeRooms(t).then(function(){e.filterType=t,e.recentUnread="unread"===t,e.filterName=e.filterTypes[t],e.pagination.currentPage=1,e.rooms.resetKeepUnread(),f(),r[0].scrollTop=0}).finally(function(){e.loading=!1})};var f=function(){var t=[];"category"===e.view?(e.roomList=u("groupRecentRooms")(e.rooms),t=n(e.roomList.favorites).concat(n(e.roomList.contacts)).concat(n(e.roomList.interviews)).concat(n(e.roomList.rooms))):(e.roomList=u("recentByPage")(e.rooms,e.pagination.currentPage,e.filterType),t=n(e.roomList)),e.pagination.currentPage=e.roomList.currentPage;var r=s.when();o.forEach(t,function(e){e.enablePresence(),r=r.then(function(){return e.preloadData().then(function(){return h(function(){},300,!1)})})})};e.$watch("view",function(e,t){e!==t&&f()}),e.$watch("pagination.currentPage",function(e,t){e!==t&&(f(),r[0].scrollTop=0)});var y="",T=t.throttle(function(){for(var t="",o=0;o<e.rooms.length;++o){var r=e.rooms[o];t+=r.recentTimestamp+"|"+r.numUnread+"|"+r.numUnreadMentions+"|"+r.isHidden+"|"+r.active+"|"+r.isFavorite+"|"+r.favoriteTimestamp+"|"+(r.latestStory?r.latestStory.storyId+r.latestStory.updated+r.latestStory.deleted:"")+"|"+(r.latestStory?r.latestStory.blockedTimestamp:"")+"|"+r.contractId+"|"+(r.stories&&r.stories.length||0)+"\n"}return y!==t&&e.$applyAsync(),y=t,t},500,{leading:!0,trailing:!0});e.$watch(function(){return T()},function(t,o){t===o&&e.roomList&&0!==e.roomList.length||(y=t,a||(l.put(e.rooms),f()))}),e.onFavoriteDropCallback=function(e,t){var o=t;m.getFromCache(o.roomId).setFavorite(!0)},r.on("click","ul.room-list.proper>li",function(t){for(var r=o.element(t.target);r.length&&!r.hasClass("room-list-item");)r=r.parent();var n=r.data("roomid");if(n){e.open(n),e.toggleRooms(!0);try{var a=e.rooms.findById(n),i={event:"click",location:"room nav list",sublocation:"room link",timestamp:new Date,userId:d.user.userId,data:[{org_id:d.user.orgId,room_id:n,room_name:a.roomName,action:"clicked on room",event_label:"clicked_on_room",opening_uid:a.context&&a.context.jobUid,contract_id:a.contractId,contractor_uid:a.context&&a.context.freelancerId}]};v.log(i)}catch(e){g(e)}S.ga("Rooms","open room","click name on left pane",{roomId:n})}}),r.on("$destroy",function(){r.off("click"),p.unbind("keydown",w)});var w=function(r){if((38===r.keyCode||40===r.keyCode)&&r.altKey){var n=e.rooms.findById(i.params.id);if(n){var a=[];"category"===e.view?o.forEach(e.roomList,function(e){o.forEach(e,function(e){a.push(e)})}):o.forEach(e.roomList,function(e){a.push(e)});var s=null,c=t.indexOf(a,n),m=a.length;if(38===r.keyCode&&c>=1&&r.shiftKey){for(var l=c;l>=0;l--)if(a[l].numUnread>0){s=a[l].roomId;break}}else if(38===r.keyCode&&c>=1)s=a[c-1].roomId;else if(40===r.keyCode&&c<m-1&&r.shiftKey){for(var l=c;l<m;l++)if(a[l].numUnread>0){s=a[l].roomId;break}}else 40===r.keyCode&&c<m-1&&(s=a[c+1].roomId);s&&i.go("rooms.chat",{id:s}).then(function(){e.api.scrollToRoom(s,!0)})}}};p.bind("keydown",w)}}}]).filter("recent",["eoDashConfig","eoThriftRoomType",function(e,t){return function(o){var r=new Date;r.setDate(r.getDate()-e.rooms.recentDays),r=r.getTime();for(var n=[],a=0;a<o.length;a++)(o[a].numUnread>0||o[a].numUnreadMentions>0||!o[a].isHidden&&o[a].recentTimestamp&&o[a].recentTimestamp>r&&(o[a].roomType!==t.ONE_ON_ONE||o[a].roomType===t.ONE_ON_ONE&&(o[a].latestStory||o[a].stories&&o[a].stories.length))||!o[a].isHidden&&o[a].keepRecent||o[a].active)&&n.push(o[a]);return n.sort(function(e,t){return e.recentTimestamp<t.recentTimestamp?1:e.recentTimestamp>t.recentTimestamp?-1:0}),n.total=n.length,n}}]).filter("recentByPage",["eoDashConfig","eoAuth","$filter","eoThriftRoomType","eoUsers","$q",function(e,r,n,a,i,s){return function(r,c,m){var l="unread"===m,u=new Date;u.setDate(u.getDate()-e.rooms.recentDays),u=u.getTime();for(var d={today:"h:mm a",yesterday:"'Yesterday'",lastWeek:"EEEE",long:"shortDate"},f=[],p=0;p<r.length;p++)0===r[p].recentTimestamp&&r[p].latestStory&&r[p].latestStory.updated&&(r[p].recentTimestamp=r[p].latestStory.updated),(r[p].numUnread>0||r[p].numUnreadMentions>0||!r[p].isHidden&&!l&&!r[p].isHidden&&(r[p].roomType!==a.ONE_ON_ONE||r[p].roomType===a.ONE_ON_ONE&&(r[p].latestStory||r[p].stories&&r[p].stories.length))&&(!r[p].isHidden&&r[p].recentTimestamp&&r[p].recentTimestamp>u||!r[p].isHidden&&r[p].keepRecent&&r[p].recentTimestamp>0)||l&&r[p].keepUnread||!l&&r[p].active)&&f.push(r[p]);"interviews"===m?f=f.filter(function(e){return e.isJustInterview()}):"contracts"===m&&(f=f.filter(function(e){return e.isWorkroom()})),f.sort(function(e,t){return e.recentTimestamp<t.recentTimestamp?1:e.recentTimestamp>t.recentTimestamp?-1:0});var g=e.rooms.list.recent.perPage,v=Math.ceil(f.length/g);(c=c||1)>v&&(c=v);var y=(c-1)*g,h=t.drop(f,y).slice(0,g);h.total=f.length,h.maxPage=v,h.itemStart=y+1,h.itemEnd=h.maxPage===c?h.total:y+g,h.currentPage=c;var T=(new Date).getTime()-9e5;return o.forEach(h,function(e){var t;if(t=e.latestStory?e.latestStory.updated||e.latestStory.created:0,(!e.processedRt||e.recentTimestamp&&e.recentTimestamp>e.processedRt||e.processedRt<T||e.lastLatestStoryTimestamp&&e.lastLatestStoryTimestamp<t)&&(e.dateDisplay=n("eoRoomTimestamp")(e.recentTimestamp,d),e.processedRt=(new Date).getTime(),e.lastLatestStoryTimestamp=t),e.latestStory&&(!e.latestStoryDisplay||e.processedLatestTs!==e.latestStory.updated)){if(e.latestStory.isSystemStory)e.latestStoryDisplay="<i>system message</i>";else if(e.latestStory.deleted)e.latestStoryDisplay="<i>message deleted</i>";else if(e.latestStory.blockedTimestamp>0)e.latestStoryDisplay="Upwork has detected a potential risk with the content of this message.";else if(o.isDefined(e.latestStory.messageHtml)){var r;r=e.latestStory.integrationData?s.when([{userId:e.latestStory.userId,orgId:e.latestStory.orgId,info:{userId:e.latestStory.userId,fullName:e.latestStory.integrationData.integrationName,photoUrl:e.latestStory.integrationData.integrationIconUrl}}]):i.several([e.latestStory.userId],!0),r.then(function(t){if(t.length){e.latestStory.user=t[0],e.latestStory.user&&!e.latestStory.user.orgId&&(e.latestStory.user.orgId=e.latestStory.orgId);var o;if(e.latestStory.user&&e.latestStory.user.integrationName)o=s.when(e.latestStory.user.integrationName+": ");else if(e.latestStory.isDisplayUser())o=s.when("You: ");else if(e.roomType!==a.ONE_ON_ONE){var r;r=e.latestStory.user&&e.latestStory.user.info?s.when():i.several([e.latestStory.userId],!0).then(function(t){t.length&&(e.latestStory.user=t[0])}),o=r.then(function(){if(e.latestStory.user&&e.latestStory.user.info)return e.latestStory.user.info.personName?e.latestStory.user.info.personName.firstName+": ":e.latestStory.user.info.fullName+": "})}else o=s.when("");o.then(function(t){var o=e.latestStory,r=e.latestStory.messageHtml;r||(r=o.objectReferences.reduce(function(e,t){return"eo:quote"===t.objectType&&(e+=t.messageHtml+" "),e},"")),e.latestStoryDisplay=t+r.replace(/<br \/>/gm," ").replace(/<[^>]+>/gm,"")})}})}e.processedLatestTs=e.latestStory.updated}}),h}}]).filter("groupRecentRooms",["eoDashConfig","eoUsers","eoAuth","eoThriftRoomType","$q",function(e,o,r,n,a){var i=function(e){var t=e.getTargetUser();return t?t._info.fullName:null},s=function(e){return e.targetOrgId},c=function(e){if(e.isWorkroom())return e.topic;var t=e.getTargetUser();return t?t._info.legacyId:null};return function(r){var m=new Date;m.setDate(m.getDate()-e.rooms.recentDays),m=m.getTime();var l={favorites:[],rooms:[],contacts:[],interviews:[],total:0};if(!r)return l;var u=0,d=0,f=0,p=function(e,t){return e.recentTimestamp<t.recentTimestamp?1:e.recentTimestamp>t.recentTimestamp?-1:0};r.sort(p);for(var g=0;g<r.length;g++){var v=r[g];if(v.isFavorite)l.favorites.push(v);else if(function(e){return e.numUnread>0||e.numUnreadMentions>0||e.active||!e.isHidden&&e.keepUnread||e.recentTimestamp&&e.recentTimestamp>m&&!e.isHidden||e.keepRecent&&e.recentTimestamp>0&&!e.isHidden}(v)){var y=v.active||v.numUnread>0||v.numUnreadMentions>0||!v.isHidden&&v.keepUnread;v.isWorkroom()&&(v.tag=v.topic);var h=v.roomType===n.ONE_ON_ONE||v.isWorkroom();h?!v.isPublic&&(v.active||v.latestStory||v.stories&&v.stories.length)&&(d<e.rooms.list.category.perPage||y)&&(l.contacts.push(v),d++):v.isJustInterview()||v.isStarterProjectsRoom()?(f<e.rooms.list.category.perPage||y)&&(l.interviews.push(v),f++):(u<e.rooms.list.category.perPage||y)&&(l.rooms.push(v),u++)}}l.favorites.sort(function(e,t){return e.favoriteTimestamp>t.favoriteTimestamp?1:e.favoriteTimestamp<t.favoriteTimestamp?-1:0});var T=function(e,t){var o=e.roomName.toLowerCase(),r=t.roomName.toLowerCase();return o>r?1:o<r?-1:0};l.rooms.sort(T),l.contacts.sort(T),l.interviews.sort(T);var S,w=[];return t.forEach(l.favorites,function(e){(S=e.getTargetUser())&&w.push(S.getInfo())}),t.forEach(l.contacts,function(e){(S=e.getTargetUser())&&w.push(S.getInfo())}),a.all(w).then(function(){var e=t.filter(l.favorites,{roomType:n.ONE_ON_ONE}),r=t.filter(l.contacts,{roomType:n.ONE_ON_ONE});o.settleDuplicates(r,i,s,c),o.settleDuplicates(e,i,s,c)}),l.total=l.favorites.length+l.rooms.length+l.contacts.length+l.interviews.length,l}}])});