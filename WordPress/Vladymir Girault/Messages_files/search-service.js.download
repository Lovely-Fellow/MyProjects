define(["./search","angular","lodash"],function(e,t,r){"use strict";e.factory("eoSearch",["tlSearch","tlSearch3","tlSearch4","eoUsers","eoRooms","$q","eoAuth","eoThriftRoomType","eoRoomModel","upSearchApi","eoDashContext","upDashMetrics",function(e,n,o,i,a,s,c,u,l,d,m,g){function h(e){var n=r.find(e.results,{name:"contact"});if(n){var o=[];t.forEach(e.results,function(e){"room"!==e.name&&"interviewRoom"!==e.name||(o=o.concat(e.records))});var i=n.records.length;n.records=n.records.filter(function(e){var t=e.metaData.userId&&e.metaData.userId.stringVal,n=e.metaData.roomId&&e.metaData.roomId.stringVal,i=r.some(o,function(e){return e.room&&e.room.targetUserId===t});return n||!i}),n.total=n.records.length,0===n.total&&r.remove(e.results,{name:"contact"}),e.total=e.total-(i-n.total)}return e}var p=function(e){var r=function(){return e};if("contact"===e.type||"oneToOneRoom"===e.type){var n=null;return n=e.metaData.userId?i.several([e.metaData.userId.stringVal],!0).then(function(t){var r=t[0];e.user=r,e.metaData.orgId&&(e.user.orgId=e.metaData.orgId.stringVal)}):a.getInfo(e.metaData.roomId.stringVal).then(function(t){e.room=t,e.tag=t.topic},function(){var t=l.create({numUsers:0,isPublic:e.metaData.isPublic.boolVal,roomName:e.metaData.roomName.stringVal});"interview"===e.metaData.roomType.stringVal&&(t.roomType=u.INTERVIEW),e.room=t}),n=n.finally(r)}if("room"===e.type||"interviewRoom"===e.type)return a.getInfo(e.metaData.roomId.stringVal).then(function(t){e.room=t,e.tag=t.topic},function(){var t=l.create({numUsers:0,isPublic:e.metaData.isPublic.boolVal,roomName:e.metaData.roomName.stringVal});"oneOnOne"===e.metaData.roomType.stringVal&&(t.roomType=u.ONE_ON_ONE),e.room=t}).finally(r);if("message"===e.type){var o={roomType:"oneOnOne"===e.metaData.roomType.stringVal?u.ONE_ON_ONE:null,isPublic:e.metaData.isPublic.boolVal,getTargetUser:t.noop},c=null;return c="oneOnOne"===e.metaData.roomType.stringVal?a.getInfo(e.metaData.roomId.stringVal,!1).then(function(t){e.room=t},function(){e.room=o,e.user={info:{fullName:"User"}}}):s.when(o).then(function(t){e.room=t}),e.snippet[0].userId&&(c=i.several([e.snippet[0].userId],!0).then(function(t){var r=t[0];e.user=r}).then(c)),c=c.finally(r)}return s.when(e)},f=function(e){var r={},n=[];return r.records=e.records,t.forEach(r.records,function(e){n.push(p(e))}),r.name=e.name,r.total=e.records.length,r.requestId=e.requestId,s.all(n).then(function(){return h(r)})},b=function(e){var r=[],n=e||{};return n.records||(n.records=[]),t.forEach(n.records,function(e){r.push(p(e))}),s.all(r).then(function(){return n})};return{getSpotlightResults:function(e,t){var r={query:e,limit:3,sortField:"time",sortOrder:"desc",section:t};return m.webApiEnabled()?(g.startMetric("getSpotlightSearchUsingWebApi"),d.spotlight4(r).then(function(e){return g.endMetric("getSpotlightSearchUsingWebApi"),f(e)},function(t){return g.count("getSpotlightSearchUsingWebAPIFailure"),g.endMetric("getSpotlightSearchUsingWebApi"),console.warn("failed to get spotlight search result using web api:",t),r.query=encodeURI(e),o.spotlight(r).then(f)})):(r.query=encodeURI(e),o.spotlight(r).then(f))},getSearchResults:function(e,t,r,o,i,a,s){var c=o||0,u=a||"time",l=s||"desc",h={query:e,limit:void 0!==r?r:20,page:c,sortOrder:l,sortField:u};return void 0!==t&&(h.section=t),0!==c&&(h.requestId=i),m.webApiEnabled()?(g.startMetric("getSearchResultsUsingWebApi"),d.search(h).then(function(e){return g.endMetric("getSearchResultsUsingWebApi"),b(e)},function(t){return g.count("getSearchResultsUsingWebAPIFailure"),g.endMetric("getSearchResultsUsingWebApi"),console.warn("failed to get search results using web api:",t),h.query=encodeURI(e),n.search(h).then(b)})):(h.query=encodeURI(e),n.search(h).then(b))},browse:function(e,t,r,o,i,a,s){var c=void 0!==o?o:0,u=void 0!==i?i:"time",l=void 0!==a?a:"desc",h=!0,p=!0,f=!0,R=!0,v=!0,I=!0,U=!0,y=!0,w=!1;"interviews"===t?(h=!1,p=!0,U=!0,y=!1,w=!1,f=!1,R=!1,v=!1,I=!1):"rooms"===t?(h=!0,p=!1,U=!0,y=!0,w=!1,f=!1,R=!1,v=!1,I=!1):"people"===t?(h=!1,R=!1,p=!1,U=!0,y=!0,w=!1):"mention"===t?(h=!0,p=!0,U=!1,y=!0,w=!0):t&&"allrooms"!==t||(h=!0,p=!0,U=!0,y=!0,w=!1,f=!0,R=!1,v=!0,I=!0);var A={query:e,limit:void 0!==r?r:20,page:c,includeGroupRooms:h,includeInterviewRooms:p,includeContractRooms:f,includeOneOnOneRooms:R,includeCompanyContacts:v,includeOtherContacts:I,includeSubscribedPublicRooms:y,includeSubscribedPrivateRooms:U,includeUnsubscribedPublicRooms:w,excludeReadOnlyRooms:s,sortOrder:l,sortField:u};return void 0===s&&delete A.excludeReadOnlyRooms,m.webApiEnabled()?(g.startMetric("getBrowseResultsUsingWebApi"),d.browseRoomAndUser(A).then(function(e){return g.endMetric("getBrowseResultsUsingWebApi"),b(e)},function(t){return g.count("getBrowseResultsUsingWebAPIFailure"),g.endMetric("getBrowseResultsUsingWebApi"),console.warn("failed to get browse results using web api:",t),A.query=encodeURI(e),n.browseRoomAndUser(A).then(b)})):(A.query=encodeURI(e),n.browseRoomAndUser(A).then(b))},isUp:function(){return m.webApiEnabled()?(g.startMetric("searchPingUsingWebApi"),d.ping().then(function(e){return g.endMetric("searchPingUsingWebApi"),e},function(t){return g.count("searchPingUsingWebAPIFailure"),g.endMetric("searchPingUsingWebApi"),console.warn("failed to ping search api using web api:",t),e.ping()})):e.ping()}}}])});