define(["./common","angular"],function(t,e){"use strict";t.factory("eoRetry",["$q","$timeout","eoModelRegistry",function(t,r,n){var i=n.get("Base"),a=i.extend({attempts:0,minWait:0,maxWait:3e5,scale:100,randomizeSlots:!0,init:function(t){if(t=t||{},this.minWait=+t.minWait||0,this.maxWait=+t.maxWait||3e5,this.minWait>this.maxWait)throw console.error("minWait should be less than maxWait when configuring a backoff strategy"),new Error("The minimum wait time must be less that the maximum wait time");this.scale=+t.scale||100,this.randomizeSlots=void 0!==t.randomizeSlots?!!t.randomizeSlots:this.randomizeSlots},calculateBackOffDelay:function(){return this.scale||this.minWait},next:function(){return this._currentBackOffDelay=null,this.attempts++,this.current()},current:function(){if(!this._currentBackOffDelay){var t=this.calculateBackOffDelay();t=t<this.minWait?this.minWait:t,t=t>this.maxWait?this.maxWait:t,this._currentBackOffDelay=t}return this._currentBackOffDelay},reset:function(){return this._currentBackOffDelay=null,this.attempts=0,this.current()}}),c=a.extend({calculateBackOffDelay:function(){return this.attempts*this.scale}}),s=a.extend({calculateBackOffDelay:function(){var t=(Math.pow(2,this.attempts)-1)*this.scale;return this.randomizeSlots&&(t+=Math.floor(Math.random()*this.scale)),t}}),o={CONSTANT:a,LINEAR:c,EXPONENTIAL:s},f=i.extend({_actionToTry:null,_backOff:null,_maxAttempts:3,_shortCircuitCheck:function(){return!1},_preflightCheck:function(){return!0},_runPreflight:!1,_nextAttemptTimeout:null,_currentTryDeferred:null,_lastRejectReason:null,_attempt:function(){var e=this;(this._runPreflight?t.when(this._preflightCheck()):t.when()).then(this._actionToTry).then(function(t){e._currentTryDeferred.notify({type:"ATTEMPT_RESULT",attempts:e._backOff.attempts,success:!0}),e._currentTryDeferred.resolve(t)},function(n){e._runPreflight=!0,e._lastRejectReason=n,e._backOff.next(),e._currentTryDeferred.notify({type:"ATTEMPT_RESULT",attempts:e._backOff.attempts,maxAttempts:e._maxAttempts,backOffDelay:e._backOff.current(),success:!1,reason:e._lastRejectReason}),t.when(e._shortCircuitCheck(n)).then(function(t){t?e._currentTryDeferred.reject(n):e._backOff.attempts<e._maxAttempts?(e._nextAttemptTimeout=r(function(){e._attempt()},e._backOff.current()),e._currentTryDeferred.notify({type:"ATTEMPT_PRIMED",attempts:e._backOff.attempts,maxAttempts:e._maxAttempts,backOffDelay:e._backOff.current(),reason:e._lastRejectReason,attemptRecovery:function(){e.attempt()}})):e._currentTryDeferred.reject(n)},function(t){e._currentTryDeferred.reject(t)})})},try:function(e){if(e=+e||0,!this._currentTryDeferred||this._tryFinished){var n=this;this._currentTryDeferred=t.defer(),this._tryFinished=!1,this._currentTryDeferred.promise.finally(function(){n._tryFinished=!0,r.cancel(n._nextAttemptTimeout)}),e?r(function(){n._attempt()},e):this._attempt()}return this._currentTryDeferred.promise},attempt:function(){r.cancel(this._nextAttemptTimeout),this._attempt()},init:function(t){t=t||{};var r=(t.backOffStrategy||"EXPONENTIAL").toUpperCase();if(!o[r])throw console.error('Back-off stategy "%s" is invalid. (Valid strategies; constant, linear, or exponential',r),new Error("An invalid back-off strategy was provided");if("function"!=typeof t.actionToTry)throw console.error("The action to try must be a function which returns a promise or value"),new Error("The action to try must be a function");this._backOff=new o[r]({minWait:t.minWait,maxWait:t.maxWait,scale:t.scale,randomizeSlots:t.randomizeSlots}),this._maxAttempts=t.maxAttempts||3,this._shortCircuitCheck=t.shortCircuitCheck||e.noop,this._preflightCheck=t.preflightCheck||e.noop,this._runPreflight=!!t.alwaysRunPreflightCheck,this._actionToTry=t.actionToTry},cancel:function(t){t=t||"canceled",r.cancel(this._nextAttemptTimeout),this._currentTryDeferred&&this._currentTryDeferred.reject(t)}});return{create:function(t,r){var n=e.extend({},r||{},{actionToTry:t});return new f(n)}}}])});