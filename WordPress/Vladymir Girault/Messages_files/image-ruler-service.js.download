define(["./common","angular"],function(e,t){"use strict";e.constant("PREVIEW_MAX_FILE_SIZE",5242880),e.factory("eoImageRuler",["$q","$window","eoExif","PREVIEW_MAX_FILE_SIZE",function(e,n,i,o){function r(e){return e*Math.PI/180}function a(n,o,a){var h=e.defer(),s=t.element("<img />");return console.log("[files] Creating image preview"),s.on("load",function(){var o;o=a?i.getTag(s[0],"Orientation"):e.when(!1),o.then(function(e){var i=t.element("<canvas>")[0],o=i.getContext("2d");if(d[e]){if(180===d[e])i.height=n.boundHeight,i.width=n.boundWidth,o.translate(i.width/2,i.height/2),o.rotate(r(d[e])),o.translate(-i.width/2,-i.height/2),o.drawImage(s[0],0,0,n.boundWidth,n.boundHeight);else if(e>4){var a=t.extend({},n);n.boundHeight=a.boundWidth,n.boundWidth=a.boundHeight,n.naturalHeight=a.naturalWidth,n.naturalWidth=a.naturalHeight,n.orientation="landscape"===a.orientation?"portrait":"landscape",i.height=n.boundHeight,i.width=n.boundWidth,o.translate(i.width/2,i.height/2),o.rotate(r(d[e])),o.translate(-i.height/2,-i.width/2),o.drawImage(s[0],0,0,n.boundHeight,n.boundWidth)}}else i.height=n.boundHeight,i.width=n.boundWidth,o.drawImage(s[0],0,0,n.boundWidth,n.boundHeight);n.previewDataUrl=i.toDataURL(),console.log("[files] Image preview created"),h.resolve(n)})}),s.attr("src",o),h.promise}var d={1:0,2:0,3:180,4:180,5:90,6:90,7:-90,8:-90},h={},s={},u=function(n,i,o){var r=[n,i,o].join("-");if(h[r])return h[r];var a=e.defer();h[r]=a.promise;var d=t.element("<img />").addClass("dimensioner").css({position:"absolute",top:"1px",right:"100%",display:"inline-block"}).on("load",function(){var e={naturalWidth:d[0].offsetWidth,naturalHeight:d[0].offsetHeight,orientation:d[0].offsetWidth>=d[0].offsetHeight?"landscape":"portrait"};i&&d.css({"max-width":i}),o&&d.css({"max-height":o}),e.boundWidth=d[0].offsetWidth,e.boundHeight=d[0].offsetHeight,a.resolve(e)}).on("error",function(e){e.stopPropagation(),delete h[r],a.reject("This image appears to have been corrupted.")});return a.promise.finally(function(){d.remove()}),t.element("body").append(d),d.prop("src",n),a.promise},l=function(t,i,r){var d=[t.name,t.size,i,r].join("-");if(s[d])return s[d];if(t.size>o)return e.reject("Image is too big to measure");var h=e.defer();s[d]=h.promise;var l=new n.FileReader;return l.onload=function(e){u(e.target.result,i,r).then(function(n){a(n,e.target.result,/^.*\.jpg$/.test(t.name)).then(function(e){h.resolve(e)})},function(e){delete s[d],h.reject(e)})},l.readAsDataURL(t),h.promise},g=function(){};return g.prototype.measureImage=function(t,i,o){return"string"==typeof t?u(t,i,o):t instanceof n.File||n.Blob&&t instanceof n.Blob?l(t,i,o):e.reject('Invalid Value Supplied For Parameter "image": '+JSON.stringify(t))},new g}])});