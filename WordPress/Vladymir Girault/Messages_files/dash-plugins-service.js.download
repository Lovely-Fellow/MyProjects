define(["./common","angular","jailed","lodash"],function(n,e,o,t){"use strict";n.factory("eoDashPlugins",["$q","eoAuth","eoDashConfig","eoDashContext","eoUsers","eoOauth","$rootScope","$cacheFactory","$http","$window","appVersion","$location",function(n,i,a,s,r,u,l,c,p,d,g,f){var h=!1,m=null,j=[],P=function(n,e){return function(o,t){n.plugin.remote[e](o,t)}},v=function(n,e,o,t){return function(i){if(h&&m&&i&&m.id===i){for(var a=["room:"+n,e,o.plugin],s=0;s<arguments.length;++s)arguments[s]&&t&&t.indexOf(s)>=0&&":"===arguments[s][0]?a.push(P(o,arguments[s].slice(1))):a.push(arguments[s]);l.$evalAsync(function(){l.$emit.apply(l,a)})}}},w=function(n,e){return function(o){h&&m&&o&&o===e.plugin.openPanel&&("val"===n&&(arguments[2]&&":"===arguments[2][0]?arguments[2]=P(e,arguments[2].slice(1)):arguments[2]=arguments[2].replace(/^\\:/,":").replace(/^\\\\/,"\\")),l.$emit.apply(l,["panel:dom",o,n].concat(Array.prototype.slice.call(arguments,1))))}},C=["userId","orgId","role"],B=["userId","orgId","rid","legacyId","fullName","personName","photoUrl","location"],b=function(n){return t.pick(n,B)},I=function(n){return t.pick(n,C)},$={roomId:"id",roomName:"name",objectReferences:"attachments"},_=["orgId","creator","created","isPublic","topic","owner","roomType","contractId","isReadOnly","context"];return{_plugins:[],_initialized:!1,buildApi:function(n){var e={getContext:function(n){h&&n({name:s.getName(),source:d.widgetSource||""})},getConfig:function(n){h&&n(a)},getUser:function(n){h&&n(b(i.user))},getUserInfo:function(n,e){r.several([n],!0).then(function(n){e(b(n[0].info))})},ajax:function(n,e){var o={};s.useOauth2()&&(o.Authorization="Bearer "+u.getToken());var t={};t.withCredentials=!0,t.headers=o,p.get(n,t).then(function(n){e(n.data)})},getQueryData:function(e){e(j[n]||"")}};return e.addButton=v("addButton",n,e,[3]),e.hideButton=v("hideButton",n,e),e.showButton=v("showButton",n,e,[3]),e.addPanel=v("addPanel",n,e,[3]),e.hidePanel=v("hidePanel",n,e),e.showPanel=v("showPanel",n,e),e.openPanel=v("openPanel",n,e),e.closePanel=v("closePanel",n,e),e.setComposerButtonBarTagline=v("setComposerButtonBarTagline",n,e),e.setComposerText=v("setComposerText",n,e),e.domShow=w("show",e),e.domHide=w("hide",e),e.domToggle=w("toggle",e),e.domAddClass=w("addClass",e),e.domRemoveClass=w("removeClass",e),e.domCss=w("css",e),e.domValue=w("val",e),e},_init:function(){if(this._initialized)return this._initialized;var t=this,i=[],r=[],u=f.hash();e.forEach(u.split("|"),function(n){var e=n.split(":");e&&e.length>1&&"plugin"===e[0]&&(j[e[1]]=e[2])}),s.pluginsSupported()&&(i.push({app:"teambuilder",code:a.odeskBaseURL+"/ab/job-post/team-builder/js",loading:n.defer()}),i.push({app:"interview",code:a.odeskBaseURL+"/ab/wm-ui/bundles/odeskworkmanagementuiapplet/js/dash/plugin/interview.js",loading:n.defer()}),i.push({app:"stageinfo",code:a.baseURL+a.localAssetsPath+"plugin/stageinfo.js",loading:n.defer()}),i.push({app:"enterprise_compliance",code:a.odeskBaseURL+"/ab/ptc/bundles/odesktalentcloud/js/external/dash/plugin/compliance.js",loading:n.defer()}));var l=function(i){i.code.then||(i.code=n.when(i.code)),i.code.then(function(s){if(!s||!e.isString(s))return n.reject(s);s.match(/:\/\//)||(s.match(/^\//)||(s="/"+s),s=a.odeskBaseURL+s),i.api=t.buildApi(i.app),i.jail=new o.Plugin(s+"?v="+g,i.api),i.api.plugin=i.jail,i.jail.whenConnected(function(){t.registerPlugin(i),i.loading.resolve()}),i.jail.whenFailed(function(){console.info("Plugin load failed",s),i.loading.resolve()})}).catch(function(n){console.info("Plugin path setup failed",i.app,n)})};return e.forEach(i,function(n){r.push(n.loading.promise),l(n)}),this._initialized=n.all(r),this._initialized},registerPlugin:function(n){return n.jail.remote?n.jail.remote.start?e.isFunction(n.jail.remote.start)?n.jail.remote.stop?e.isFunction(n.jail.remote.stop)?void this._plugins.push({app:n.app,plugin:n.jail.remote,jail:n.jail}):(console.info("Plugin `stop` is not a function",n.app),!1):(console.info("Plugin missing stop() method",n.app),!1):(console.info("Plugin `start` is not a function",n.app),!1):(console.info("Plugin missing start() method",n.app),!1):(console.info("No plugin object provided on registration",n.app),!1)},start:function(){var n=this;this._init().then(function(){h=!0,e.forEach(n._plugins,function(n){n.plugin.start(),m&&e.isFunction(n.plugin.renderRoom)&&n.plugin.renderRoom(m)})})},stop:function(){e.forEach(this._plugins,function(n){n.plugin.stop()}),h=!1},roomChanged:function(n,o){var t,i=this,a=o?"updateRoom":"renderRoom";this._init().then(function(){m={users:n.users.map(I)};for(t in n)$[t]?m[$[t]]=n[t]:_.indexOf(t)>-1&&(m[t]=n[t]);n.targetUserId&&(m.targetUser={userId:n.targetUserId,orgId:n.targetOrgId}),e.forEach(i._plugins,function(n){e.isFunction(n.plugin[a])&&n.plugin[a](m)})})}}}]),n.run(["$rootScope","eoDashPlugins",function(n,e){n.$on("plugins:start",function(){e.start()}),n.$on("plugins:stop",function(){e.stop()}),n.$on("room:changed",function(n,o){e.roomChanged(o)}),n.$on("room:update",function(n,o){e.roomChanged(o,!0)})}])});