/*
       * License for sound files:
       * https://www.upwork.com/messages/bundles/odeskdashbinder/sounds/call-license.txt,
       * https://www.upwork.com/messages/bundles/odeskdashbinder/sounds/calling-license.txt,
       * https://www.upwork.com/messages/bundles/odeskdashbinder/sounds/waiting-license.txt
       */

define(["./room","angular","lodash","buzz","rxjs"],function(o,e,t,i){"use strict";o.factory("upStoryNotification",["$q","eoDashConfig","eoNotification","tlRoom","eoDebug","eoUsers","eoAuth","htmlToTextFilter","eoThriftRoomType","eoPageVisibility","eoStoryProcessor","eoRooms","eoRoomStory","$interval",function(o,n,s,r,a,c,u,l,f,d,m,y,p,g){var h,S=new i.sound(n.assets.url+n.soundsPath+"/dash-ding",{formats:["ogg","mp3"]}),b=new i.sound(n.assets.url+n.soundsPath+"/Calling",{formats:["mp3"]}),T=function(o,e,t){if(t.muted&&t.roomType!==f.ONE_ON_ONE&&t.roomType!==f.INTERVIEW&&!o.directMentioned)return!1;if(s.isMaster(t.orgId)){var i=e.notifications&&e.notifications.desktop;if("all"===i||"important"===i){if(a.debug("notification:events")("Visibility:"+d.isVisible()+" | System Story:"+o.isSystemStory+" | Is Selected:"+t.isSelected()),!(d.isVisible()&&t.isSelected()||o.isOwner()||o.isSystemStory)){if("all"===i)return!0;if("important"===i)return t.isImportantRoom()||o.mentioned||"eo:broadcast"===o.actionType||"eo:initiate"===o.actionType}}return!1}},v=function(i,n){var r=a.debug("notification:events");r("Getting local settings"),m.parseMessage(i.message,i,n),c.getLocalSettings(u.user.userId).then(function(a){if(r("Local settings",e.toJson(a,!1)),T(i,a,n)){r("Should show desktop notification");var u={roomId:i.roomId,roomType:n.roomType,tag:i.storyId},d=l(m.getStoryPlainText(i).trim());if(!d.length){var y=i.objectReferences||i.newObjectReferences;t.some(y,function(o){return"eo:file"===o.objectType?(d=o.metadata.fileName,!0):"eo:video"===o.objectType?(d=i.actionVerb+" "+o.noun,u.type="video",!0):void 0})}if(d.length){var p=null;n.roomType===f.ONE_ON_ONE?p=o.when():i.integrationData?(n.ensureIntegrations(),p=o.when()):p=c.several([i.userId],!0),p.then(function(o){o&&o.length&&(d=o[0].info.fullName+": "+d),d=d.slice(0,200),r("Show desktop notification"),u.body=d,n.isStarterProjectsRoom()&&(u.requireInteraction=!0,u.autoHideDelay=3e4),a.notifications.sound&&("eo:video"===i.objectReferences[0].objectType?(b.play(),h=g(function(){b.play()},4500,2)):S.play()),s.show(n.roomName,u)},function(o){console.log(o)})}}})},N=null;return{start:function(){this.stop(),N=r.$on("newStory",function(o){var e=p.fromData(o);y.get(e.roomId,!0).then(function(o){v(e,o),o.updateLatestStory(e)})})},stop:function(){N&&(N(),N=null)},showNotification:v,stopNotificationSound:function(){h&&g.cancel(h)}}}])});