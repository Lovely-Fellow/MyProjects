define(["./common","angular","lodash"],function(n,e,t){"use strict";return n.config(["$provide",function(n){n.decorator("tlSocket",["$delegate","$q","$rootScope","$log","eoOauth","eoDashContext",function(n,r,o,u,c,i){var f=null,a=null;n.__send=n.send;var h=function(){return i.useOauth2()&&c.hasToken()},l=function(n){return f||(f=c.refreshToken(),f.finally(function(){f=null})),f.catch(function(){o.$emit("auth:expired",{errors:n})}),f},s=function(){var e;return h()&&(e={oauth2_token:c.getToken()}),a||(n.disconnect(),a=n.__send.call(n,"auth",e),a.then(function(){o.$emit("auth:refresh")},function(n){o.$emit("auth:expired",{errors:n})}),a.finally(function(){a=null})),a};return n.on("CLIENT_ERROR",function(n){n&&401===n.code&&h()&&l([n]).then(function(){s()})}),n.on("CONNECTION_CLOSED",function(n){"TOKEN_EXPIRED"===n.reason&&h()&&l([{code:401}]).then(function(){s()})}),n.send=function(){function n(){var n=c.__send.apply(c,o),i=r.defer();return n.then(function(n){i.resolve(n)}),n.catch(function(n){var r=!!t.find(n,{code:401}),f=o.length>1&&"auth"===o[0]&&e.isObject(o[1])&&o[1].hasOwnProperty("username");if(r&&!f){var a=function(){u.warn("Retrying auth",arguments);var e=o.length>1&&"auth"===o[0];return s().then(function(n){if(!e)return c.__send.apply(c,o).then(function(n){i.resolve(n)},function(n){i.reject(n)});i.resolve(n)},function(){i.reject(n)})};return h()?l(n).then(function(){return a()},function(){i.reject(n)}):a()}i.reject(n)}),i.promise}var o=arguments,c=this;return f?f.then(function(){return n()},function(n){return r.reject(n)}):n()},n}])}])});