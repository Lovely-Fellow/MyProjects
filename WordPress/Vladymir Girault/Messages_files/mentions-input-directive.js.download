define(["../room","angular","lodash","./composer-constants-init"],function(e,t,n){"use strict";e.directive("eoMentionsInput",["escapeHtmlFilter","htmlToTextFilter","$timeout","$window","COMPOSER_MENTION_END_MARKER",function(e,i,a,o,r){return{restrict:"AC",link:function(c,u,l){var s=r,d=[],f=t.element("<div>").appendTo(t.element('<div class="msg-composer-highlighter" />').insertBefore(u)),h=function(e){return e+s},v=function(t){return"<"+t.chr+t.id+"|"+e(t.text)+">"},p=function(e,t,n){d.push({id:e,text:t,chr:n||"@"}),c.$parent.mentionsCounterLog=d.length},g=function(e){for(var t,n,a=/<([^|>]+)(?:\|([^>]+))?>/g,o="",r=0;null!==(t=a.exec(e));)o+=e.slice(r,t.index),r=a.lastIndex,n=t[2]?t[2]:t[1],"@"!==t[1].charAt(0)&&"#"!==t[1].charAt(0)||(p(t[1].slice(1),n,t[1].charAt(0)),n=h(n)),o+=n;return o+=e.slice(r),i(o)},m=function(e){return e?e.replace(/<[@#]([^|>]+)(?:\|([^>]+))?>/g,function(e,t,n){return'<span class="hl-mention">'+(n||t)+"</span>"}):e},b=function(){var e=o.document.createEvent("Event");e.initEvent("autosize:update",!0,!0),u.get(0).dispatchEvent(e)},x=function(e){c.value=e,u.val(g(c.value||"")),b(),f.html(m(c.value))};x(c.$eval(l.eoMentionsInput)),c.$on("mentions:update",function(e,t){x(t)});var k=function(t){for(var n,i,a=e(t),o=[],r=0;r<d.length;++r)n=d[r],i=e(h(n.text)),a.indexOf(i)<0||(a=a.replace(i,v(n)),o.push(n));return d=o,a=a.replace(s,"")},y=function(){c.$emit("mentions:updated",c.value)},E=n.debounce(y,200),A=function(e,t){var n=k(e);n!==c.value&&(c.value=n,f.html(m(c.value)),t?E():y())},$=function(e){A(u.val(),e),c.$parent.messageLengthLog=u.val().length},w=function(){$(!0)},C=function(e){u.val(e),b(),A(e)};c.$on("typeahead:callback",function(e,t,i,a){var o,r=u.val();switch(u.focus(),a.type){case"room":o=h(a.text),p(a.roomId,a.text,"#");break;case"emoji":o=a.text;break;case"user":o=h(a.fullName),p(a.data,a.fullName);break;default:return void console.error("Unknown mention type:",a.type)}r=r.slice(0,t)+o+" "+r.slice(i),C(r),n.delay(function(){u.get(0).selectionStart=u.get(0).selectionEnd=t+o.length+1},0)});var S=function(e,t){for(var n,i,a,o,r=0;r<d.length;++r)if(n=h(d[r].text),!((i=e.indexOf(n))<0)&&(a=i,o=i+d[r].text.length,t>=a&&t<=o))return{index:r,start:a,end:o};return!1},I=function(e,t){var n,i=u.get(0).selectionStart,o=u.get(0).selectionEnd,r=u.val();if(i!==o){var c=S(r,i),l=S(r,o);if(!c||!l||c.index!==l.index)return}n=e?o-1:i;var s,f,v,p,g,m;!1!==(s=S(r,n))&&(f=d[s.index],"@"===f.chr?(v=f.text.split(" "),p=f.text.slice(0,n-s.start).split(" ").length-1,v.splice(p,1),g=v.join(" "),(m=v.slice(0,p).join(" ").length)&&++m):(g="",m=0),g.length&&(f.text=g,g=h(g)),r=r.slice(0,s.start)+g+r.slice(s.end+1),C(r),t.stopPropagation(),t.preventDefault(),a(function(){u.get(0).selectionStart=s.start+m,u.get(0).selectionEnd=s.start+m}))},M=function(e){a(function(){var t=u.get(0).selectionStart,n=u.get(0).selectionEnd,i=t,a=n,o=u.val();t===n?o.charAt(t)===s&&(i=a=t+(e?-1:1)):e&&o.charAt(t)===s?i=t-1:e&&o.charAt(n)===s?a=n-1:e||o.charAt(n)!==s?e||o.charAt(t)!==s||(i=t+1):a=n+1,i===t&&a===n||(u.get(0).selectionStart=i,u.get(0).selectionEnd=a)})},N=function(e){switch(e.keyCode){case 8:case 46:I(8===e.keyCode,e);break;case 37:case 39:M(37===e.keyCode);break;case 13:$(),y()}};u.bind("keydown",N).bind("keyup",w).bind("change",w).bind("blur",$).bind("focus",$).bind("input",$),c.$on("$destroy",function(){u.unbind("keydown",N),u.unbind("keyup",w),u.unbind("change",w),u.unbind("blur",$),u.unbind("focus",$),u.unbind("input",$),$=t.noop})}}}])});