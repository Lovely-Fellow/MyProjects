define(["./room","angular"],function(e,o){"use strict";e.directive("eoDisintermediationOpener",["$timeout","eoDisintermediationPopover","eoDisintermediation",function(e,i,t){return{restrict:"AE",link:function(n,r){function s(e){i.hideCategory(e,n.room.roomId)}function d(){var e=r.find("mark.disintermediation:last");if(e.length){var o=e.first(),t=o.attr("eo-disintermediation-category");if(!f&&i.isCategoryHidden(t,n.room.roomId))return;var d=o.closest(".story-message"),a=o.offset(),u=r.offset();if(a.top>u.top+m&&a.top<u.top+r.height()){var c=i.show(d,0,t);c&&f!==c&&(f=c,f.result.then(function(e){f=null,"close"===e&&s(t)}))}else f&&f.dismiss("hide")}else f&&f.dismiss("hide")}function a(){e(d,0,!1)}var f,m=50;t.isEnabled()&&(r.on("mouseover","mark.disintermediation",function(e){var t=o.element(e.target);n.$apply(function(){f=i.show(t,0)})}),n.$on("story:new",d),n.$on("scrollContinuum:visibilityChange",d),n.$on("stories:rendered",d),n.$onRootScope("story:updated",a),n.$onRootScope("story:deleted",a),n.$on("$destroy",function(){f&&f.dismiss("hide"),r.off("mouseover")}))}}}])});