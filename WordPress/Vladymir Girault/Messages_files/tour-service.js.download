define(["./common","angular","lodash"],function(e,t,n){"use strict";e.factory("eoTourService",["$rootScope","$q","$modalStack","eoDisintermediationPopover","eoUsers","eoDashContext",function(e,s,o,r,i,p){function u(){return p.isMobile()}function c(e){return i.saveSettings(!0,"Tour",e)}function f(){return D?s.when(D):P||(P=i.getSettings(!0).then(function(e){var s=n.find(e.componentPreferences,{componentName:"Tour"});return D={},n.isEmpty(s)||n.isEmpty(s.preferences)||t.forEach(s.preferences,function(e){e.prefKey&&("true"===e.prefValue?D[e.prefKey]=!0:"false"===e.prefValue?D[e.prefKey]=!1:D[e.prefKey]=e.prefValue)}),D}))}function a(){D={interstitial:null,numberOfStories:null,enterKeyPressed:null,composerSettingPopup:null},t.forEach(k,function(e){t.forEach(e.getSteps(),function(e){D[e.name]=null})}),c(D)}function h(e){t.forEach(e.getSteps(),function(e){D[e.name]&&(e.seen=!0)})}function l(e){!u()&&$()&&f().then(function(){if(!x){var t=g(e);t&&(h(t),t.hasRemainingSteps()&&(x=!0,t.start()))}})}function S(){t.forEach(k,function(e){e.closeTour()}),x=!1}function g(e){return k[e]}function v(e,t){if(u())return null;var n=g(e);if(n){if(!(t&&n.steps.length>1))return n.steps[0];for(var s=0;s<n.steps.length;s++)if(n.steps[s].name===t)return n.steps[s]}}function m(e,t){if(!u()){var n=g(e);n&&n.start(t)}}function d(e,t,n){var s=v(e,t);s&&(s.beforeOpen=n)}function y(e,t,n){var s=v(e,t);s&&(s.afterClose=n)}function w(e,t,n){var s=v(e,t);s&&(s.showIf=n)}function C(e,t,n){var s=v(e,t);s&&s.scope.setTargetElement(n)}function E(e,t,n,s){var o=g(t);return o||(o=new K,k[t]=o),o.addStep(e,n,s),o}function T(e){var t=g(e);t&&t.closeStep()}function b(e){for(var t in e)D[t]=e[t];c(D)}function O(){x&&(t.forEach(k,function(e){-1!==e.currentStep&&e.closeStep()}),x=!1)}function $(){return!o.getTop()&&!r.isShowing()}function K(){this.steps=[],this.currentStep=-1}var D,P,k={},x=!1;return e.$on("auth:change",function(e,t){t&&t.user||S()}),e.$on("$stateChangeStart",function(){O()}),K.prototype.start=function(){for(var e=0;e<this.steps.length;e++)if(this.steps[e].scope.visible=!0,!this.steps[e].seen){this.currentStep=e,this.showStep(this.steps[e].name);break}},K.prototype.getSteps=function(){return this.steps},K.prototype.closeStep=function(){var e=this.getCurrentStep();e.scope.popover=!1,e.seen=!0,e.afterClose&&e.afterClose.call();var t={};t[e.name]=!0,D[e.name]=!0,c(t),this.hasRemainingSteps()||this.closeTour()},K.prototype.closeTour=function(){t.forEach(this.steps,function(e){e.scope.visible=!1,e.scope.popover=!1}),this.currentStep=-1,x=!1},K.prototype.addStep=function(e,s,o){if(n.some(this.steps,{name:s})){n.find(this.steps,function(e){return e.name===s}).scope=e}else o=t.isDefined(o)?o:99,this.steps.push({name:s,step:o,scope:e,seen:!1}),this.steps.sort(function(e,t){return e.step-t.step})},K.prototype.getCurrentStep=function(){return-1===this.currentStep?null:this.steps[this.currentStep]},K.prototype.showStep=function(e){var t=this.getCurrentStep();t&&t.scope.popover&&this.closeStep(),this._showStep(n.findIndex(this.steps,{name:e}))},K.prototype._showStep=function(e){this.currentStep=e;var t=this.getCurrentStep();t.beforeOpen&&t.beforeOpen.call(),t.scope.visible=!1,t.scope.popover=!0},K.prototype.nextStep=function(){for(var e,n=0;n<this.steps.length;n++){var s=(this.currentStep+n+1)%this.steps.length;if(!this.steps[s].seen){e=s;break}}this.closeStep(),t.isDefined(e)&&this._showStep(e)},K.prototype.isLast=function(){return n.filter(this.steps,{seen:!1}).length<=1},K.prototype.hasRemainingSteps=function(){return n.some(this.steps,{seen:!1})},{getSettings:f,saveSettings:c,setBeforeOpen:d,setOnClose:y,setShowCondition:w,addStep:E,reset:a,start:m,show:l,canShow:$,getTour:g,cancelAll:S,closeStep:T,updateSettings:b,closeOpenTour:O,setTargetElement:C}}])});