define(["angular","lodash"],function(o,e){"use strict";var t=null,n=function(o,e,n){t||(t=e("WPcomposer"));var r=t.get(o);return r||(r=n.create(),t.put(o,r)),r};return["$scope","$cacheFactory","$state","eoRoomDialog","eoRooms","eoUsers","eoRoomStory","eoUserPreference","rooms","room","eoAuth","$window","$filter","$timeout","eventLog","$interval","eoRetry","$interpolate","eoTimezone","eoDashConfig","eoUserBlockConfirmDialog","$modal","$rootScope","$q","escapeHtmlFilter","autolinker","emojione","$sce","eoResizerAPI","eoStoryProcessor","eoGoogleAnalytics","eoDashContext","eoThriftRoomType","eoRoomExport","eoComposerEnterSetting","eoOrganizations","eoPageVisibility","eoFiles","eoTourService","eoVideo","eoExternalLinkChecker","upDashMetrics","eoResponseHandler","eoCrossCommunication","eoBreakpoint","deviceDetector",function(r,i,a,s,c,d,l,m,u,h,p,f,g,v,w,I,R,y,T,b,O,S,U,N,B,_,k,M,$,C,x,E,P,A,F,j,H,D,W,V,L,z,G,q,J,K){var Q=z.getFirstRunSequence();if(Q.time("RoomsChatControllerStart"),r.noSendOnEnter=F.get(),r.roomMutingEnabled=p.organization.enableRoomMuting&&h.roomType!==P.ONE_ON_ONE&&h.roomType!==P.INTERVIEW,h.error)return f.localStorage.removeItem("lastRoom"),u.remove(h.roomId),a.go("rooms.index"),void S.messageBox("Room not found","Sorry, this room wasn't found.");if(u.findById(h.roomId)?u.update(h):u.add(h),r.roomHeaderClick=function(o){J.smDown&&(o.stopPropagation(),r.toggleState("info"))},E.isMobile())r.hideBackArrow=!0;else if(E.isWidget()){var X=function(){r.hideBackArrow=!f.widgetOptions.flags.backnav};r.$on("updateWidget",function(){v(X)}),X()}if(r.roomChatBack=function(){if(E.isWidget())return void q.postParent({type:"dash:room:close"});r.toggleRooms()},r.toggleState=function(o,e,t){o="rooms.chat."+o;var n=e||{};n.id=h.roomId,(a.includes(o,n)&&!0!==t||!1===t)&&(o="rooms.chat"),"files"===o&&W.getSettings().then(function(o){o.files||W.updateSettings({files:!0})}),"rooms.chat"===o&&"rooms.chat.users"===a.current.name&&h.updateRoomFeature("HelpMeHireClosed",!0),a.go(o,n)},r.addToGroup=function(){s.showGroupInvite(r)},!E.isMobile()&&f.innerWidth>991){h.features&&h.features.HelpMeHireClosed||"rooms.chat"!==a.current.name||h.canInviteHM().then(function(o){o&&r.toggleState("users",{},!0)})}var Y,Z=this,oo=null,eo=o.element(f);this.requestingOlderStoriesEnabled=!0,this.requestingNewerStoriesEnabled=!1,r.eoThriftRoomType=P,r.sidePanelW=$.getInitialWidth("side-panel")||300,r.peopleTooltipText="People",r.disableJoinRoomAction=E.isSudo(),r.joinRoom=function(){return h.inviteUser(p.user.userId,p.user.orgId,"admin",!0).then(function(){a.go("rooms.chat",{id:h.roomId})}).catch(function(o){o&&o.length>0&&403===o[0].code&&S.messageBox("Error","This room has reached the maximum number of members allowed.")})};var to=function(){h.getUser(p.user.userId,p.user.orgId)||(h.ensureUsers(e.map(h.users,"userId")),h.isJustInterview()?r.roomTypeString="Interview Room":h.roomType===P.GROUP||h.isWorkroom()?r.roomTypeString=h.isPublic?"Public Room":"Private Room":r.roomTypeString="",a.go("rooms.chat.preview"))};to();var no=function(){r.topic=M.trustAsHtml(k.toImage(_.link(B(h.topic||""),function(o){var e=B(o.getAnchorHref()),t=B(o.getMatchedText());return'<a href="'+e+'" title="'+t+'" target="_blank" rel="noopener noreferrer">'+t+"</a>"})))},ro=r.$watch("room.topic",no);r.handleTopicLinks=function(o){"A"===o.target.tagName&&o.stopPropagation()},r.fileDropDisabled=!1,r.maxFileSize=b.maxFileSize,r.actions=h.getActions(),r.composerButtonBarTagline="",r.$emit("room:changed",h);var io={accept:"accept",reject:"reject reject-generic",delay:400},ao={accept:"",reject:""};r.calculateDragOverClass=function(o){return o.dataTransfer&&o.dataTransfer.types&&Array.prototype.indexOf.call(o.dataTransfer.types,"Files")>-1&&-1===Array.prototype.indexOf.call(o.dataTransfer.types,"text/html")?io:ao};var so={title:"Oops! Sorry about that.",message:"The file was rejected for some unknown reason, Please try again."};r.fileWarning=so,r.acceptFiles=function(e){var t=o.element(".rooms-chat-container");t.addClass("pending");var n=!1;o.forEach(e,function(o){if(!n){var e=D.validateFile(o);e.valid||(n=!0,r.fileWarning.title=e.reason,r.fileWarning.message=e.message,r.fileWarning.fileName=o.name)}}),t.removeClass("pending"),n?(t.addClass("reject"),t.one("click",function(){t.removeClass("reject"),r.fileWarning=so}),r.$on("$destroy",function(){t.off()})):r.$broadcast("rooms-chat:files-attached",{files:e}),t.removeClass(io.accept)},r.$on("updateActiveRoom",function(){r.room.active=!0,R.create(function(){return r.loadNewerStories()}).try().catch(function(){console.error("Error loading latest stories after reconnect on 3 retries, could not load")}).finally(function(){r.room.updateLastRead("activeRoomUpdated"),r.room.reload()})}),r.$onRootScope("organization:change",function(){t&&t.removeAll()}),h.isReadOnly?r.newStoryObj=l.create():r.newStoryObj=n(h.roomId,i,l),r.room=h,r.videoLinkTitle="Start a video/voice conversation with the participants of this room",r.audioLinkTitle="Start a voice conversation with the participants of this room",r.$on("room:update",function(){r.actions=h.getActions(),r.showRoomVideo=lo()}),r.$onRootScope("room:useradded",function(){vo()}),r.$onRootScope("room:userremoved",function(){vo()}),r.$onRootScope("room:inviteadded",function(){vo()}),r.$onRootScope("room:inviteremoved",function(){vo()}),r.showInRoomSearch=!1,r.$onRootScope("inroomsearch:open",function(){r.showInRoomSearch=!0,r.$apply()}),r.$onRootScope("inroomsearch:close",function(){r.showInRoomSearch=!1}),r.$onRootScope("videoConnectionsUpdated",function(o,e){e.roomId===h.roomId&&(r.ongoingVideoCall=e.connectedUsersCount>0)});var co=U.$on("story:new",function(o,e){e.actionType&&e.roomId&&r.room&&r.room.roomId&&r.room.roomId===e.roomId&&("eo:invite"===e.actionType||"eo:join"===e.actionType)&&to()});r.hasTopic=h.hasTopic(),r.$on("$stateChangeStart",function(o,t,n,i,s){r.selected=n.id||t.name,"rooms.chat"===t.name&&e.contains(["rooms.chat.files","rooms.chat.users","rooms.chat.notes"],i.name)&&n.id!==s.id&&(o.preventDefault(),a.go(i.name,n))}),r.$on("$stateChangeSuccess",function(e,t,n){r.fileDropDisabled=h.isReadOnly,n.id===h.roomId&&v(function(){o.element(f).trigger("resize")},10)});var lo=function(){return!(U.isWidget&&!f.widgetOptions.flags.video||h.isReadOnly)};r.videoRoomUrl=b.baseURL+"/upvideo/"+h.roomId,r.audioRoomUrl=b.baseURL+"/upvideo/"+h.roomId+"?video=0",r.openVideoSession=function(o){V.open(h.roomId,o)};r.showAddToGroup=function(){return h.roomType===P.ONE_ON_ONE&&!h.isReadOnly&&!d.isBlockedByUser(h.targetUserId)},r.roomUserName="User",h.getTargetUserName("User").then(function(o){r.roomUserName=o,r.foundUserName=!0}),r.showBlockTargetUser=function(){var o=!1;return h.roomType===P.ONE_ON_ONE&&h.targetUserId&&(o=h.targetUserId!==p.userId&&!d.hasBlockedUser(h.targetUserId)&&!1!==h.targetUserCanBlock),o},r.showUnblockTargetUser=function(){var o=!1;return h.roomType===P.ONE_ON_ONE&&h.targetUserId&&(o=d.hasBlockedUser(h.targetUserId)),o},r.blockTargetUser=function(){if(!E.isReadOnlyMode())return h.roomType===P.ONE_ON_ONE&&h.targetUserId?h.getTargetUserName().then(function(o){return O.confirmUserBlock(o).result.then(function(o){if(o)return x.ga("Rooms","User Blocked","from room menu"),d.blockPerson(h.targetUserId).then(function(){K.isMobile()&&r.$emit("view:rooms:show")}).catch(function(o){o&&o[0]&&400===o[0].code&&o[0].message.match(/contract/i)?S.messageBox("Contract Exists","Sorry, you can't block someone you have an active contract with."):G.errors(o,!0)})})}):N.when()},r.unblockTargetUser=function(){if(!E.isReadOnlyMode()){var o=N.when();return h.roomType===P.ONE_ON_ONE&&h.targetUserId?(x.ga("Rooms","User Unblocked","from room menu"),d.unblockPerson(h.targetUserId)):o}},r.showRoomVideo=lo(),r.ongoingVideoCall=!1,r.showRoomVideo&&function(){V.getVideoUserCount(h.roomId).then(function(o){o>0&&(r.ongoingVideoCall=!0)})}(),r.alwaysShowSearch=!1,U.isWidget?(r.showMiscItems=f.widgetOptions.flags.misc,r.roomMenuEnabled=!f.widgetOptions.flags.nomenu,r.showRoomFiles=f.widgetOptions.flags.files,r.showRoomMembers=h.roomType!==P.ONE_ON_ONE&&f.widgetOptions.flags.users,r.showRoomFav=f.widgetOptions.flags.fav,r.alwaysShowSearch=f.widgetOptions.flags.search,r.hideTitle=f.widgetOptions.flags.notitle,r.showRoomTitle=!r.hideTitle&&!r.alwaysShowSearch,r.showRoomNotes=b.feature.notes.enabled&&f.widgetOptions.flags.notes,r.showActions=!f.widgetOptions.flags.noactions,r.showRoomInformation=r.showCreateRoom=!1):(r.showRoomNotes=b.feature.notes.enabled,r.showRoomMembers=h.roomType!==P.ONE_ON_ONE,r.showActions=!E.isMobile(),r.showRoomInformation=r.showRoomFiles=r.showRoomTitle=r.roomMenuEnabled=r.showMiscItems=r.showRoomFav=!0,r.hideTitle=!1,r.showCreateRoom=!1),r.roomMenuHasCollapsableOptions=e.some([r.showRoomNotes,r.showRoomFiles,r.showRoomMembers,r.showRoomInformation,r.showRoomFav,r.roomMutingEnabled,r.showActions&&r.actions.length],Boolean),r.roomMenuHasFixedOptions=e.some([r.showMiscItems&&r.showCreateRoom,r.showMiscItems&&r.showAddToGroup()&&r.inviteToGroup&&r.invitable.length,r.showMiscItems&&r.showBlockTargetUser(),r.showMiscItems&&r.showUnblockTargetUser(),r.canShowHistory,r.canExport,r.showMiscItems&&h.canEditRoom(),r.showMiscItems&&h.canInvite(),r.showMiscItems&&h.canLeave(),r.showMiscItems&&h.canArchive()],Boolean),r.showBlockUnblockDivider=function(){return r.showMiscItems&&(h.canInvite()||h.canLeave()||h.canArchive()||r.showCreateRoom&&!h.isReadOnly||r.showAddToGroup()&&r.inviteToGroup&&r.invitable.length)},r.showRoomMenu=function(){return r.roomMenuEnabled&&(r.roomMenuHasFixedOptions||r.roomMenuHasCollapsableOptions&&J.mdDown)},r.showRoomNav=(r.roomMenuHasCollapsableOptions||r.showRoomVideo||r.alwaysShowSearch)&&!r.room.isStarterProjectsRoom(),r.showComposer=!r.room.isStarterProjectsRoom(),r.showRoomHeader=r.showRoomTitle||r.alwaysShowSearch||r.showRoomNav&&!r.hideTitle||r.showRoomFiles||r.showRoomVideo,r.showSidePanel=!h.isStarterProjectsRoom(),r.isPublicRoom=function(){return!h.isOneOnOne()&&!h.isHourPackInterview()&&!h.isStarterProjectsRoom()},(E.isMobile()||r.room.isReadOnly)&&(r.showRoomVideo=!1),r.$onRootScope("video:start",function(o,e){r.newVideoSessionStarted(e)}),r.$onRootScope("room:archived",function(o,e){h.roomId===e.roomId&&(r.showRoomVideo=!h.isReadOnly)}),r.newVideoSessionStarted=function(o){if(h.isReadOnly||E.isReadOnlyMode())E.isSudo()&&S.messageBox("Not available in Sudo mode","Sorry, you can't start a video call in sudo mode.");else{W.getSettings().then(function(o){o.videoTour||W.updateSettings({videoTour:!0})});var e="Ready to initiate a video/voice conversation with the participants of this room?";o||(e="Ready to initiate a voice conversation with the participants of this room?"),S.promptBox("Confirmation",e).result.then(function(e){if(e){r.openVideoSession(o);var t={event:"call_initiated",location:"dash",sublocation:o?"video_button":"audio_button",timestamp:new Date,userId:p.user.userId,data:[{type:"dash_call",env:E.getName(),org_id:p.user.orgId,room_id:h.roomId,room_type:h.roomType,action:"new video chat",opening_uid:h.context&&h.context.jobUid,contract_id:h.contractId,contractor_uid:h.context&&h.context.freelancerId,event_label:"new_video_chat"}]};w.log(t),x.ga("Video","start video room button clicked")}})}},r.invite=function(){E.isReadOnlyMode()||s.invite(h)},h.targetUserId&&h.roomType===P.ONE_ON_ONE&&d.fetchBlockability(h.targetUserId,!0).then(function(o){h.targetUserCanBlock=!!o}),r.archive=function(){if(!E.isReadOnlyMode()){s.archive(h).then(function(o){if(o){U.$emit("room:archived",h);var e=g("recent")(u);if(a.includes("rooms.chat",{id:h.roomId})&&e.length>1){for(var t=1,n=e[0];n&&n.roomId===h.roomId;)n=e[t++];a.go("rooms.chat",{id:n.roomId})}K.isMobile()&&U.$emit("view:rooms:show")}});var o={event:"click",location:"room nav header",sublocation:"archive this room",timestamp:new Date,userId:p.user.userId,data:[{org_id:p.user.orgId,room_id:h.roomId,action:"archive room",event_label:"archive_room",opening_uid:h.context&&h.context.jobUid,contract_id:h.contractId,contractor_uid:h.context&&h.context.freelancerId}]};w.log(o),x.ga("Rooms","room archived","from nav header",{roomId:h.roomId})}},r.doAction=function(e){var t={event:"click",location:"dash",sublocation:"addbutton-api",timestamp:new Date,userId:p.user.userId,data:[{org_id:p.user.orgId,roomId:h.roomId,roomType:h.roomType,room_name:h.roomName,participants:h.numUsers,is_freelancer:p.isClient(),user_nid:p.user.userId,app:e.app,event_label:e.app+"_"+e.title,buttonId:e.id,button_label:e.title,placement:e.position}]};w.log(t),o.isFunction(e.action)?e.action(h.roomId):e.action&&f.open(e.action)},r.leave=function(){if(!E.isReadOnlyMode()){s.leave(h,u,p.user.userId,p.user.orgId);var o={event:"click",location:"room nav header",sublocation:"leave room",timestamp:new Date,userId:p.user.userId,data:[{org_id:p.user.orgId,room_id:h.roomId,action:"leave room",event_label:"leave_room",opening_uid:h.context&&h.context.jobUid,contract_id:h.contractId,contractor_uid:h.context&&h.context.freelancerId}]};w.log(o),x.ga("Rooms","leave room","",{roomId:h.roomId})}},r.requestNewerStories=function(){Z.requestingNewerStoriesEnabled&&r.loadNewerStories()};var mo=0;if(r.loadNewerStories=function(){return Y||(Y=h.loadMissingStories().then(function(o){return Y=null,mo=0,r.newerMessagesFailure=!1,o},function(o){return Y=null,r.newerMessagesFailure=!0,mo>4&&(r.newerMessagesTotalFailure=!0),mo++,N.reject(o)})),Y},r.dismissNewerMessagesFailure=function(){r.newerMessagesFailure=!1},r.onDropCallback=function(e,t){if(!E.isReadOnlyMode()){var n=t.targetUserId,i=t.targetOrgId;if(n&&h.targetUserId!==n)if(h.roomType===P.ONE_ON_ONE){var a;if(d.hasBlockedUser(h.targetUserId)?a=h.getTargetUserName("this user").then(function(o){return"you have blocked "+o}):d.isBlockedByUser(h.targetUserId)?a=h.getTargetUserName("this user").then(function(o){return"you have been blocked by "+o}):d.hasBlockedUser(t.targetUserId)?a=h.getTargetUserName("this user").then(function(o){return"you have blocked "+o}):d.isBlockedByUser(t.targetUserId)&&(a=h.getTargetUserName("this user").then(function(o){return"you have been blocked by "+o})),a)return void a.then(function(o){o="A group room can not be created because "+o,S.messageBox("User Blocked",o)});var s=[],l=[];o.forEach(h.users,function(o){s.push(o.userId),l.push({userId:o.userId,orgId:o.orgId})}),s.push(n),l.push({userId:n,orgId:i}),d.several(s,!0).then(function(e){var t=[];o.forEach(e,function(o){t.push(o.info.fullName)});var n={roomName:t.join(", "),users:l,topic:""};c.create(n).then(function(o){r.open(o.roomId)})})}else h.canInvite()&&h.inviteUser(n,i)}},r.validateRoomName=function(o){return o!==h.roomName&&(""===o.trim()?"The room name can not be empty.":o.trim().length>128?"The room name can not be more than 128 characters.":void 0)},r.validateTopic=function(o){return o!==h.topic&&(o.trim().length>128?"The room topic can not be more than 128 characters.":void 0)},r.isClient=p.isClient(),p.isClient()&&h.roomType===P.ONE_ON_ONE&&(r.showCreateRoom=!0,r.createNewGroup=function(){h.getTargetUser().getInfo().then(function(o){var e=p.user.fullName+" - "+o.fullName,t=[{text:o.fullName,img:o.photoUrl,fullName:o.fullName,username:o.legacyId,data:h.targetUserId,orgId:h.targetOrgId?h.targetOrgId:p.user.orgId}];s.create("private",e,t).result.then(function(o){r.open(o.roomId)})})}),h.roomType===P.ONE_ON_ONE&&(r.invitable=u.getInvitableRooms(h.targetUserId,h.targetOrgId,10),r.inviteToGroup=function(o){if(!E.isReadOnlyMode()){var e=u.findById(o);e&&e.inviteUser(h.targetUserId,h.targetOrgId).then(function(){r.open(o)})}}),h.targetUserId&&h.getTargetUser().getInfo().then(function(o){if(o&&o.location){var e=[];o.location.city&&e.push(o.location.city),o.location.country&&e.push(o.location.country),r.location=e.join(", "),r.localTime=T.getLocalTime(o.location.timezone),oo=I(function(){r.localTime=T.getLocalTime(o.location.timezone)},3e4)}}),h.roomType===P.INTERVIEW&&h.context){var uo;if((uo=p.user.orgId===h.context.freelancerOrgId||h.context.associatedAgencyOrgId&&h.context.associatedAgencyOrgId===p.user.orgId?h.context.clientId:h.context.freelancerId)&&h.users){var ho=e.find(h.users,function(o){return o.userId===uo});ho&&ho.info&&ho.info.location&&ho.info.location.timezone&&(r.localTime=T.getLocalTime(ho.info.location.timezone),oo=I(function(){r.localTime=T.getLocalTime(ho.info.location.timezone)},3e4))}}var po=e.debounce(function(o){r.showActionsButton=o.target.innerWidth>991,r.$digest()});eo.on("resize",po),r.showPrimaryButton=function(o){return!(o.hidden||o.position&&"default"!==o.position)},r.showActionMenuButton=function(o){return!o.hidden&&o.position&&"actionMenu"===o.position},r.showComposerButton=function(o){return!o.hidden&&o.position&&"composerBar"===o.position},r.hasComposerButtons=function(){var o=-1!==e.findIndex(r.actions,r.showComposerButton);return r.showActions&&o},r.hasPrimaryButtons=function(){var o=-1!==e.findIndex(r.actions,r.showPrimaryButton);return r.showActions&&o&&r.showActionsButton},r.showPrimaryButtonsInCTA=function(){return r.actions.length&&r.showActions&&!r.showActionsButton};var fo=function(e){return o.isString(e)&&(e.length&&"/"!==e[0]&&(e="/"+e),e=b.odeskBaseURL+e),e||""};r.addButton=function(o,e,t,n,i){if(!e)return!1;"interview"===o&&"wmBtnActionWithPopup"===e&&W.show("wmBtnActionWithPopup");var a=i&&i.class&&"primary"===i.class?"btn-primary":"btn-default";r.actions.push({id:e,app:o,title:t,action:fo(n),hidden:!n,position:i&&i.position,class:a})},r.hideButton=function(o,t){var n=e.find(r.actions,{id:t,app:o});n&&(n.hidden=!0)},r.showButton=function(o,t,n,i){var a=e.find(r.actions,{id:t,app:o});"interview"===o&&"wmBtnActionWithPopup"===t&&W.show("wmBtnActionWithPopup"),a&&(n&&(a.title=n),i&&(a.action=fo(i)),a.hidden=!a.action)},r.panels=[],r.addPanel=function(o,e,t,n,i,a){var s={id:e,app:o,label:t,renderer:n,plugin:a};!i||/^air-icon/.test(i)?s.glyph=i||"air-icon-info":s.icon=i,r.panels.push(s)},r.hidePanel=function(o,t){var n=e.find(r.panels,{id:t,app:o});n&&(n.hidden=!0)},r.showPanel=function(o,t){var n=e.find(r.panels,{id:t,app:o});n&&(n.hidden=!1)},r.openPanel=function(o,t){var n=e.find(r.panels,{id:t,app:o});if(!n)return!1;r.toggleState("panel",{panel:n.id},!0)},r.closePanel=function(o,t){var n=e.find(r.panels,{id:t,app:o});if(!n)return!1;r.toggleState("panel",{panel:n.id},!1)},r.$onRootScope("room:setComposerButtonBarTagline",function(o,e,t,n,i){n===r.room.roomId&&(r.composerButtonBarTagline=i)}),r.$onRootScope("room:addButton",function(o,e,t,n,i,a,s,c){n===r.room.roomId&&r.addButton(e,i,a,s,c)}),r.$onRootScope("room:hideButton",function(o,e,t,n,i){n===r.room.roomId&&r.hideButton(e,i)}),r.$onRootScope("room:showButton",function(o,e,t,n,i,a,s){n===r.room.roomId&&r.showButton(e,i,a,s)}),r.$onRootScope("room:addPanel",function(o,e,t,n,i,a,s,c){n===r.room.roomId&&r.addPanel(e,i,a,s,c,t)}),r.$onRootScope("room:hidePanel",function(o,e,t,n,i){n===r.room.roomId&&r.hidePanel(e,i)}),r.$onRootScope("room:showPanel",function(o,e,t,n,i){n===r.room.roomId&&r.showPanel(e,i)}),r.$onRootScope("room:openPanel",function(o,e,t,n,i){n===r.room.roomId&&r.openPanel(e,i)}),r.$onRootScope("room:closePanel",function(o,e,t,n,i){n===r.room.roomId&&r.closePanel(e,i)}),r.$onRootScope("room:setComposerText",function(o,e,t,n,i){n===r.room.roomId&&(r.newStoryObj.message=i,r.$broadcast("mentions:update",r.newStoryObj.message))}),r.isReadOnlyMode=function(){return!!E.isReadOnlyMode()},r.edit=function(e){if(!E.isReadOnlyMode())if(J.lgUp)v(function(){o.element("#chat-header").trigger("click");var t=o.element("#editable-"+e);t&&t.trigger("click")});else{var t={name:"roomName",topic:"roomTopic"};a.go("rooms.chat.info",{edit:!0,focus:t[e]})}},h.storiesLoaded&&!h.stories.length&&r.$emit("stories:loaded",r.room.roomId),r.canShowHistory=E.hasDashOboAccess(),r.canExport=E.hasDashOboAccess(),r.showHistory=!1,r.toggleHistory=function(){r.showHistory=!r.showHistory},r.export=function(){A.export(r.room.roomId,r.showHistory)},r.$on("$destroy",function(){I.cancel(oo),r.room&&a.params.id!==r.room.roomId&&u.findById(r.room.roomId)&&r.room.setInactive(),r.room=null,r.newStoryObj=null,ro(),go(),co(),ro=null,eo.off("resize",po)}),r.getOrganizationData=function(o){j.get(o).then(function(o){r.organization=o})};var go=H.$on("visibilitychange",function(){!r.leftNav&&H.isVisible()&&m.getItem("readStateTracking").then(function(o){"immediate"===o&&h.updateLastRead("windowFocused")},function(){console.log("error reading preferences for marking last read"),h.updateLastRead("windowFocused")})}),vo=function(){r.peopleTooltipText=h.users.length+" people in the room",h.getInvites().then(function(o){r.peopleTooltipText=h.users.length+" people in the room",o&&o.length>0&&(r.peopleTooltipText+="\n"+o.length+" pending invites")})};vo(),Q.time("RoomsChatControllerStop")}]});