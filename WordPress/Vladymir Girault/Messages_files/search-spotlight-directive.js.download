define(["./search","angular","lodash"],function(e,t,o){"use strict";e.directive("eoSpotlight",["$rootScope","$timeout","$window","$q","eoSearch","eoUsers","$compile","emojione","eoAuth","eventLog","eoGoogleAnalytics",function(a,r,n,s,i,c,l,u,g,m,d){return{restrict:"AE",templateUrl:e.templatePath+"search-spotlight-directive.html",link:function(e,l,h){e.active=!1,e.keyboardInit=-1,e.keyboardPosAllRes=-1,e.events={},e.lastProcessQuery="",e.dateFormat={today:"h:mm a",yesterday:"'Yesterday'",lastWeek:"EEEE",long:"mediumDate"},e.search={query:""},e.typeHeading={contact:"People",room:"Groups",interviewRoom:"Interviews",message:"Messages",file:"Files"},e.isInRoomSearch=!1,e.stickyInRoomSearch=!1,e.pagination={currentPage:1,totalItems:0,itemsPerPage:10,maxSize:5},e.inputPlaceholder="Search",e.activeRoomId="",h.id&&"sticky-inroom-search"===h.id&&(e.stickyInRoomSearch=!0),h.roomId&&(e.isInRoomSearch=!0,e.inputPlaceholder="Search this conversation",e.activeRoomId=h.roomId),e.clearInput=function(){A(!1),e.search.query=""};var f=function(){e.search.error=null},p=function(){e.results=null},y=function(){e.results=[]},I=function(){e.searchDone=null,f(),p()},v=null,S=0,R=function(t){r(function(){if(!t)return e.types=null,I(),r.cancel(v),e.searchTakingLong=null,!1;v=r(function(){e.searchTakingLong=!0},h.showLoadingAfter);var a=++S;if(e.isInRoomSearch){e.lastProcessQuery!==t&&(e.pagination.currentPage=1),e.lastProcessQuery=t;var n=t+" inId:"+e.activeRoomId;i.getSearchResults(n,"message",e.pagination.itemsPerPage,e.pagination.currentPage-1,a).then(function(e){y(),$(e,a,t)}).catch(function(){a===S&&(e.search.error="error",p(),e.searchDone=!0,e.searchTakingLong=!1)})}else{var s=["contact","room","message","interviewRoom"],c=!0,l=s.length;o.each(s,function(o){"message"===o&&t.length<3||i.getSpotlightResults(t,o).then(function(e){l--,!c||!e.total&&l||(y(),c=!1),$(e,a,t)}).catch(function(){a===S&&(e.search.error="error",p(),e.searchDone=!0,e.searchTakingLong=!1)})})}})},k=o.debounce(R,300,{maxWait:800}),_=l.find(".search-box input"),D=function(){e.$evalAsync(function(){A(!0)})};_.on("click",D),e.$on("$destroy",function(){_.off("click",D)});var P,b=l.find(".dropdown-menu"),w=b.find(".spotlight-results"),q=function(){if(r.cancel(P),!e.results||!e.results.length)return void b.css("height","auto");e.active&&(P=r(function(){var e,t=n.innerHeight,o=b[0].getBoundingClientRect(),a=w[0].getBoundingClientRect(),r=w[0].scrollHeight;if(a.bottom>t)e=n.innerHeight-o.bottom+o.height;else if(o.bottom<t&&a.height<r){var s=n.innerHeight-o.bottom,i=r-a.height;e=i>s?o.height+s:o.height+i}e&&b.css("height",e+"px")},0,!1))};t.element(n).on("resize",q),e.$on("$destroy",function(){t.element(n).off("resize",q),r.cancel(P)}),e.$onRootScope("inroomsearch:open",function(){(a.isWidget&&n.widgetOptions.flags.search&&e.stickyInRoomSearch||e.isInRoomSearch&&!e.stickyInRoomSearch)&&_.focus().click()});var $=function(t,o,r){if(o===S){var i=null;"contact"===t.name&&(i=t.records);var l;return l=i?c.settleDuplicates(i,function(e){return e.metaData.firstName?e.metaData.firstName.stringVal+" "+e.metaData.lastName.stringVal:null},function(e){return e.metaData.orgId.stringVal},function(e){return e.metaData.legacyId.stringVal}):s.when(),l.then(function(){if(r!==e.search.query)return void R(e.search.query);var o={};if(o.name=t.name,o.records=t.records,t.total>0){var s={contact:1,room:2,interviewRoom:3,message:4};e.results.push(o),e.results.sort(function(e,t){return s[e.name]-s[t.name]})}e.searchTakingLong=!1;var i,c,l,h,p=0;if(o.records&&o.records.length)for(i=0;i<o.records.length;++i)o.records[i].selectionIndex=p++;if("message"===o.name){if(!o.records)return;for(i=0;i<o.records.length;++i)if(l=o.records[i],e.isInRoomSearch&&l.metaData&&l.metaData.roomId&&l.metaData.storyId&&l.metaData.roomId.stringVal===a.$stateParams.id&&a.$broadcast("story:highlight:"+l.metaData.storyId.stringVal),l.snippet)for(c=0;c<l.snippet.length;++c)h=l.snippet[c],h.message&&(h.message=u.toImage(h.message))}if(e.pagination.totalItems=t.total,e.currentKeyboard=e.keyboardInit,e.searchDone=!0,q(),f(),e.events.newSpotlightAttempt&&r!==n.localStorage.getItem("queryBeforeFocus")){try{n.localStorage.setItem("spotlightAttemptId",t.requestId)}catch(e){console.error(e)}var y={event:"click",location:"dash_home",sublocation:"spotlight_search",timestamp:new Date,userId:g.user.userId,data:[{spotlight_attempt_id:n.localStorage.getItem("spotlightAttemptId"),query:r,org_id:g.user.orgId,event_label:"type_in_srch_box"}]};m.log(y),d.ga("Search","spotlight search","initiated",{searchQuery:r}),e.events.newSpotlightAttempt=!1}try{n.localStorage.setItem("spotlightRequestId",t.requestId)}catch(e){console.error(e)}var I={event:"impression",location:"dash_home",sublocation:"spotlight_results",timestamp:new Date,userId:g.user.userId,data:[{search_request_id:n.localStorage.getItem("spotlightRequestId"),query:r,org_id:g.user.orgId}]};m.log(I)})}},A=(t.noop,function(t){t?(l.addClass("active"),e.active=!0):(l.removeClass("active"),e.active=!1,e.isInRoomSearch&&a.$broadcast("inroomsearch:close"),delete e.currentlySelected)}),T=function(e){e.preventDefault(),e.stopPropagation()};l.on("click",T);var V=function(){e.$applyAsync(function(){A(!1)})};t.element(n).on("click",V),e.$on("$destroy",function(){t.element(n).off("click",V),l.off("click",T)}),e.$watch("search.query",function(t){A(!!t||e.isInRoomSearch),k(t)});var C={ESCAPE:27,ENTER:13,ARROW_UP:38,ARROW_DOWN:40},E=function(t){e.$applyAsync(function(){var o=t.keyCode||t.which;if(o===C.ESCAPE)t.preventDefault(),t.stopPropagation(),e.$evalAsync(function(){A(!1)});else if(-1!==[C.ARROW_DOWN,C.ARROW_UP,C.ENTER].indexOf(o)){t.preventDefault(),t.stopPropagation();var a=e.isInRoomSearch?e.pagination.itemsPerPage-1:e.pagination.totalItems;switch(e.maxSelectionIndex=a,o){case C.ARROW_DOWN:e.currentlySelected=void 0===e.currentlySelected?0:++e.currentlySelected,e.currentlySelected=e.currentlySelected>a?0:e.currentlySelected;break;case C.ARROW_UP:e.currentlySelected=void 0===e.currentlySelected?a:--e.currentlySelected,e.currentlySelected=e.currentlySelected<0?a:e.currentlySelected;break;case C.ENTER:r(function(){l.find(".selected").click()},0,!1)}}})};l.on("keydown",E),e.$on("$destroy",function(){l.off("keydown",E)}),e.goToResult=function(t){switch(A(!1),t.type){case"room":case"interviewRoom":e.goToRoom(t);break;case"contact":e.goToContactRoom(t);break;case"message":e.goToStory(t)}},e.goToContactRoom=function(o){o.metaData.roomId?e.open(o.metaData.roomId.stringVal):e.openContact(o.metaData.userId.stringVal,o.metaData.orgId.stringVal),e.toggleRooms(!0);var a=o.id;e.logClick({section:"contact",rank:t.element(".spotlight-results").find("a.result[value]").index(t.element(".spotlight-results").find('a.result[value="'+a+'"]')),id:o.metaData.userId.stringVal})},e.goToStory=function(o){o.metaData&&o.metaData.roomId&&o.metaData.storyId&&(e.open(o.metaData.roomId.stringVal,o.metaData.storyId.stringVal),e.toggleRooms(!0));var a=o.id;e.logClick({section:"message",rank:t.element(".spotlight-results").find("a.result[value]").index(t.element(".spotlight-results").find('a.result[value="'+a+'"]')),id:o.metaData.storyId.stringVal})},e.goToRoom=function(o){e.open(o.metaData.roomId.stringVal),e.toggleRooms(!0);var a=o.id;e.logClick({section:"room",rank:t.element(".spotlight-results").find("a.result[value]").index(t.element(".spotlight-results").find('a.result[value="'+a+'"]')),id:o.metaData.roomId.stringVal})},e.goToCompleteResults=function(){A(!1);var t={event:"click",location:"dash_home",sublocation:"main_search",timestamp:new Date,userId:g.user.userId,data:[{spotlight_attempt_id:n.localStorage.getItem("spotlightAttemptId"),query:e.search.query,org_id:g.user.orgId,event_label:"start_full_srch_from_spotlight"}]};m.log(t),d.ga("Search","open main search page","from spotlight search",{searchQuery:e.search.query}),a.$emit("view:main:show"),e.$state.go("rooms.search.results",{query:e.search.query,section:"message"})},e.changePage=function(){R(e.search.query),_.focus()},e.isPaginationVisible=function(){return e.pagination.totalItems>e.pagination.itemsPerPage},e.logClick=function(t){var o={event:"click",location:"dash_home",sublocation:"spotlight_results",timestamp:new Date,userId:g.user.userId,data:[{search_request_id:n.localStorage.getItem("spotlightRequestId"),query:e.search.query,org_id:g.user.orgId,section_name:t.section,clicked_rank:t.rank,doc_id:t.id,event_label:"select_spotlight_result"}]};return m.log(o),d.ga("Search","search result clicked","from spotlight search"+t.rank),!0},e.checkSelected=function(){return e.results&&e.results.length&&!e.isInRoomSearch&&(void 0===e.currentlySelected||+e.maxSelectionIndex===e.currentlySelected)}}}}])});