define(["./room","angular","lodash"],function(e,t,o){"use strict";e.directive("eoRoomStory",["$sce","$modal","$modalStack","$document","$window","$timeout","emojione","eoAuth","eoRoomStory","eoRooms","dateFilter","eoRoomStoryReportDialog","eoGoogleAnalytics","eoUsers","eoTourService","eoDashContext","eoDashConfig","eoOrganizations","eoAlert",function(s,r,i,n,a,d,y,c,m,l,u,h,f,p,g,w,v,S,b){function R(e,t){e.showTime=!1,!t||!t.lastStoryTimeShown||e.userId!==t.userId||e.created-t.lastStoryTimeShown>v.rooms.lastStoryTimeShown?(e.lastStoryTimeShown=e.created,e.showTime=!0):e.lastStoryTimeShown=t.lastStoryTimeShown}function T(e,t){if(t){var o=new Date(t.created).setHours(0,0,0,0),s=new Date(e.created).setHours(0,0,0,0);e.shouldShowTimestamp=s!==o}else e.shouldShowTimestamp=!0}function E(e,t){R(e,t),T(e,t);var o=t?t.created:e.created;!t||e.userId!==t.userId||e.orgId!==t.orgId||e.shouldShowTimestamp||e.integrationData||t.integrationData||"eo:post"!==t.actionType||t.isSystemStory||"eo:post"!==e.actionType||e.created-o>v.rooms.createdLastStoryTime?e.hideHeader=!1:e.hideHeader=!0}function I(e,t){E(e,t),t&&e.hideHeader&&e.userId===t.userId&&e.orgId===t.orgId&&(e.paragraph=!0)}function $(e,t,o){-1!==o.userLastReadPreviousTimestamp&&e.created>o.userLastReadPreviousTimestamp&&(!t||t.created<=o.userLastReadPreviousTimestamp)?e.isFirstUnread=!0:e.isFirstUnread=!1}function O(e,t,o){-1!==o.userLastReadTimestamp&&e.created<o.userLastReadPreviousTimestamp&&(e.wasRead=!0)}function M(e,t,o){(!e.processedTime||e.processedTime<e.updated||t&&e.processedTime<t.updated)&&I(e,t),e.isRecruiter=o.isUserRecruiter(e.userId),e.isRecruiter&&S.get(e.orgId).then(function(t){e.org=t}),e.processedTime=Date.now()}return{restrict:"EA",replace:!0,priority:1001,transclude:!0,scope:{story:"=story",previousStory:"=previousStory",room:"=room",showHistory:"=showHistory"},templateUrl:e.templatePath+"room-story-directive.html",controller:["$scope","$rootScope","deviceDetector",function(o,s,n){o.isMobileDevice=n.isMobile(),o.quote=function(){w.isReadOnlyMode()||o.$emit("room:quote",o.story)},o.report=function(){w.isReadOnlyMode()||h.openReport(o.story)},o.cancelReport=function(){w.isReadOnlyMode()||(o.showBlocked=!1,o.story.cancelAbuseReport())},o.$on("editmode:cancel",function(){o.cancelEdit(),d(function(){var e='div[eo-story-id="'+o.storyObj.storyId+'"]';s.$emit("story:scrollToElement",t.element(e))},200)}),o.$on("story:edit",function(e,t){o.story.storyId===t&&o.story.hasEditCapability()&&(g.getSettings().then(function(e){e.storyEditNew||g.updateSettings({storyEditNew:!0})}),o.editStory(),o.$apply())});var a=o.$on("story:highlightoptions:"+o.story.storyId,function(){o.highlightOptions()}),c=o.$on("story:downplayoptions:"+o.story.storyId,function(){o.downplayOptions()});o.unownedStoryActionsTemplate=e.templatePath+"unowned-story-actions-popover.html",o.storyActionsTemplate=e.templatePath+"story-actions-popover.html",o.storyErrorTemplate=e.templatePath+"story-error-popover.html",o.toggleIsFavorite=function(e){w.isReadOnlyMode()||(e.getFavorite()?f.ga("Rooms","message unfavorited"):f.ga("Rooms","message favorited"),e.setFavorite(!e.getFavorite()),g.getSettings().then(function(e){e.favorite||g.updateSettings({favorite:!0,favoriteView:!0})}))},o.showAnyway=function(){o.showBlocked=!0},o.editStory=function(){w.isReadOnlyMode()||(f.ga("Rooms","message edited"),o.storyObj=m.fromData(t.copy(o.story)),o.storyObj.blocked||(o.storyObj.message&&(o.storyObj.message=y.toShort(o.storyObj.message)),o.editMode=!0,d(function(){var e='div[eo-story-id="'+o.storyObj.storyId+'"]';s.$emit("story:scrollToElement",t.element(e))},200)),g.getSettings().then(function(e){e.storyEditNew||g.updateSettings({storyEditNew:!0})}))},o.cancelEdit=function(){o.editMode=!1},o.deleteStory=function(){w.isReadOnlyMode()||(f.ga("Rooms","message deleted"),i.dismissAll(),d(function(){var e=[{result:!1,label:"Cancel",cssClass:"btn-link"},{result:!0,label:"Delete",cssClass:"btn-primary",focus:!0}];r.messageBox("Delete Message","Are you sure you want to delete this message?",e).result.then(function(e){e&&o.room.deleteStory(o.story)})},300),g.getSettings().then(function(e){e.storyEditNew||g.updateSettings({storyEditNew:!0})}))},o.retryPending=function(){o.story.isUpdateError?o.room.retryUpdate(o.story):(o.room.deleteStory(o.story),o.room.newStory(o.story))},o.removePending=function(){o.story.isUpdateError?(o.room.cancelUpdate(o.story),o.cancelEdit()):o.room.deleteStory(o.story)},o.showMarkAsUnread=!w.isWidget(),o.markUnread=function(){w.isReadOnlyMode()||(f.ga("Rooms","message marked as unread"),g.getSettings().then(function(e){e.markUnread||g.updateSettings({markUnread:!0})}),o.room.markRoomAsUnread(o.story).then(function(){s.$emit("story:markedUnread",o.story)}))},o.forceOptionsVisibility=!1,o.highlightOptions=function(){o.forceOptionsVisibility=!0},o.downplayOptions=function(){o.forceOptionsVisibility=!1},o.$watch("story.storyId",function(e,t){e!==t&&(a(),c(),a=o.$on("story:highlightoptions:"+e,function(){o.highlightOptions()}),c=o.$on("story:downplayoptions:"+e,function(){o.downplayOptions()}))})}],compile:function(){return function(e,r,i){var n=function(t){e.loading=!0,e.room.loadStoriesFromTo(t.metadata.fromTime,t.metadata.toTime,t.storyId).catch(function(){e.loading=!1,b.inline({type:"danger",template:"Could not fetch messages. Please try again later.",duration:3e3})})},a=function(){var t,o=e.story.hasAttachments(),s=e.story.hasFiles(),r=!1;if(o&&(e.story.attachments=e.story.objectReferences),e.hasFiles=s,(e.message||e.modified)&&(r=!0),!e.deleted&&e.story.attachments)for(t=0;t<e.story.attachments.length;t++){var i=e.story.attachments[t];if(("eo:file"===i.objectType||"eo:url"===i.objectType&&i.metadata&&e.story.hasVisibleAttachment||"eo:quote"===i.objectType||i.templateParsed)&&"true"!==i.metadata.deleted){r=!0;break}}e.deleted&&(r=!1),e.isVisible=r,e.showStoryAction=function(){return!e.story.blocked&&!e.story.deleted&&(e.story.message||e.hasFiles||e.canEdit||e.story.isBroadcastStory())}};e.$watch("story",function(){!e.story.userId||e.story.user||e.story.integrationData||e.room.ensureUsers([e.story.userId],e.story),M(e.story,e.previousStory,e.room)});var y=!0;e.$watch("previousStory",function(){if(y)return void(y=!1);E(e.story,e.previousStory)}),e.$watch("room.userLastReadPreviousTimestamp",function(){$(e.story,e.previousStory,e.room),O(e.story,e.previousStory,e.room)});var c=function(){e.story.isDeleted()&&(e.deletedTimestamp=u(e.story.getDeletedTimestamp(),"EEEE, MMMM d, y h:mm a"))};if(e.story){e.id=e.story.storyId,e.timestamp=e.story.created,e.updated=u(e.story.updated,"EEEE, MMMM d, y h:mm a");var m=function(){e.created=u(e.story.created,"h:mm a"),e.createdLong=u(e.story.created,"EEEE, MMMM d, y h:mm a")};m(),e.message=s.trustAsHtml(e.story.messageHtml),e.highlight=!1,e.canEdit=e.story.canEdit(),e.showGearForStoryActionOption=e.canEdit&&(!e.room.isReadOnly||e.showMarkAsUnread),e.$on("story:highlight:"+e.story.storyId,function(){e.highlight=!0,d(function(){e.highlight=!1},5e3)});var h=e.$watch("story.storyId",function(t){e.id=t}),f=e.$watch("story.hideHeader",function(t){e.headerless=t});if(e.story.metadata&&e.story.metadata.modified)e.modified=!0;else var g=e.$watch("story.fieldChanges",function(s){t.isArray(s)&&(e.modified=o.some(s,{fieldChanged:"message"})&&!e.story.isDeleted(),c())});var w,v=e.$watch("story.messageHtml",function(t){e.message=s.trustAsHtml(t)}),S=e.$watch("story.updated",function(t){e.updated=u(t,"EEEE, MMMM d, y h:mm a"),c(),a()}),R=e.$watch("story.objectReferences",function(){a()});e.story.pending&&(w=e.$watch("story.pending",function(e){e||(m(),w(),w=null)}));var T;e.story.system&&(T=e.$watch("story.system",function(t){t.eoUserId&&p.several([t.eoUserId],!0).then(function(t){t.length&&t[0].info&&(e.story.system.eoUser=t[0].info.fullName)}),t.eoObjectUserId&&p.several([t.eoObjectUserId],!0).then(function(t){t.length&&t[0].info&&(e.story.system.eoObjectUser=t[0].info.fullName)})})),e.$on("$destroy",function(){h(),f(),S(),v(),R(),g&&g(),w&&w(),T&&T()}),e.headerless=e.$eval(i.headerless),e.paragraph=e.$eval(i.paragraph),e.isApp=e.story.integrationData&&e.story.integrationData.integrationId,a(),e.story.system?(e.system=e.story.system,e.story.system.eoObjectRoomId&&!e.story.system.eoObjectRoom&&(e.story.system.eoObjectRoom="the room",l.getInfo(e.story.system.eoObjectRoomId).then(function(e){return t.isDefined(e.context)?e:l.getInfo(e.roomId,!0)}).then(function(t){"eo:contract"===e.story.actionType?(t.context.jobName&&(e.story.system.eoNoun='"'+t.context.jobName+'". '),e.story.system.eoObjectRoom="View Interview Conversation"):e.story.system.eoObjectRoom=t.roomName,e.system=e.story.system}))):"eo:post"!==e.story.actionType&&e.story.actionVerb&&e.story.objectReferences&&e.story.objectReferences[0]&&e.story.objectReferences[0].noun&&("hr:send"===e.story.actionType&&"hr:offer"===e.story.objectReferences[0].objectType&&(e.story.objectReferences[0].noun="an offer"),e.action=e.story.actionVerb+" "+e.story.objectReferences[0].noun),"_loadMore"===e.story.actionVerb&&(e.story.system=e.system={eoLink:"... load more stories from "+u(e.story.metadata.fromTime,"M/d/yy h:mm a")+" to "+u(e.story.metadata.toTime,"M/d/yy h:mm a"),eoCallback:function(){n(e.story)}})}}}}}])});