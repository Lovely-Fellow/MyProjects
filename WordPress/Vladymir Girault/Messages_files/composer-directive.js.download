define(["../room","angular","lodash","autosize","dropboxjs","./composer-quote-attachment-directive","../../common/composer-enter-setting-service","./typeahead-directive","./mentions-input-directive"],function(e,o,t,n){"use strict";var r=[["room",1],["channel",3],["group",3],["everyone",4],["everybody",4],["all",3]];e.directive("eoRoomsComposer",["$window","$document","$q","$modal","$timeout","$http","$templateCache","$cacheFactory","$log","$modalStack","htmlToTextFilter","eoQuoteAttachment","eoFileGroup","eoDashConfig","eoUsers","eoAuth","eoUserPreference","eoThriftRoomType","eoSearch","dateFilter","eventLog","eoDashContext","eoGoogleAnalytics","eoFileAttachment","eoFiles","$sce","eoTourService","eoComposerEnterSetting","eoScreenSnap","eoDisintermediation","eoUserPresence","eoStoryProcessor","upGiphyDashPlugin","eoAlert","deviceDetector",function(i,s,a,c,m,d,l,u,g,p,f,h,y,v,b,S,I,$,x,M,E,O,w,k,_,C,D,R,T,N,z,j,A,P,F){var L=u("emoji"),H=v.assets.url+"/emoji_strategy.json";return d.get(H,{cache:L}),{restrict:"E",transclude:!0,scope:{story:"="},templateUrl:e.templatePath+"composer/composer-directive.html",controller:["$scope","$rootScope","$element","$attrs","$q","$modalStack","emojione","eoBreakpoint",function(s,a,c,u,g,p,f,h){s.breakPoints=h,s.composerSlideCollapse=!(O.isWidget()||O.isMobile()||F.isMobile()),s.hideArrow=!s.composerSlideCollapse,s.isSliderOpen=!s.composerSlideCollapse,s.editMode=o.isDefined(u.editMode),s.singleMode=o.isDefined(u.singleMode),s.roomMode=!s.editMode&&!s.singleMode,s.contactsLookupErrorMessage="We're sorry, your contacts are temporarily unavailable.",s.mentionsCounterLog=0,s.settings={},s.settings.noSendOnEnter=R.get(),s.isMobileDevice=F.isMobile(),s.emojiTemplatePath=e.templatePath+"composer/emoji-panel.html";var y=function(){return b.getLocalSettings(S.user.userId).then(function(e){s.settings.noSendOnEnter=e.composer.noSendOnEnter,s.$emit("composer:lineSettingChanged")})};s.$on("settings:updated",function(e,o){o&&o.composer&&m(function(){s.settings.noSendOnEnter=o.composer.noSendOnEnter}),y()}),y(),s.$on("composer:lineSettingChanged",function(){R.get()!==s.settings.noSendOnEnter&&(R.set(s.settings.noSendOnEnter),m(function(){n.update(s.ta)}))});var v=function(e){return{type:"emoji",text:e.shortname,emoji:f.toImage(e.shortname)}},I=function(e){return e.text.length};s.getEmoji=function(e){return!e.length||e.match(/:/)?g.when([]):d.get(H,{cache:L}).then(function(o){var n,r=o.data,i=[],s=[],a=[];return r[e]&&i.push(v(r[e])),t.some(r,function(o,t){return t!==e&&(n=t.indexOf(e),0===n?i.push(v(o)):n>0?s.push(v(o)):o.aliases&&o.aliases.indexOf(e)>-1&&a.push(v(o)),i.length>10)}),e.length>1&&(i=t.sortBy(i,I),i.length<10&&(s=t.sortBy(s,I),i.length+s.length<10&&(a=t.sortBy(a,I)))),i.concat(s).concat(a)})},s.$on("rooms-chat:files-attached",function(e,o){w.ga("Files","file attach","from drag drop"),s.attach(o.files)}),s.getUsers=function(e){var n;n=e.length?x.browse(e,"mention",10).then(function(e){var t=[];return e.records&&o.forEach(e.records,function(e){"contact"===e.type&&e.user?t.push({text:e.user.info.fullName,info:e.user.info,presence:z.presence[e.user.userId],fullName:e.user.info.fullName,username:e.user.info.legacyId,data:e.user.userId+":"+e.user.orgId,orgId:e.user.orgId,userId:e.user.userId}):"room"===e.type&&e.room&&t.push({type:"room",room:e.room,roomId:e.room.roomId,text:e.room.roomName})}),t}):g.when([]);var i=s.singleMode?g.when([]):s.room.ensureUsers(t.map(s.room.users,"userId")).then(function(){return s.room.users.map(function(e){return{text:e.info.fullName,info:e.info,presence:z.presence[e.userId],fullName:e.info.fullName,username:e.info.legacyId,data:e.userId+":"+e.orgId,orgId:e.orgId,fname:e.info.personName.firstName.toLowerCase(),lname:e.info.personName.lastName.toLowerCase(),userId:e.userId}})});return g.all([n,i]).then(function(n){var i=n[0],a=n[1],c=["0:0"];s.singleMode||s.room.roomType===$.ONE_ON_ONE||o.forEach(s.room.users,function(e){c.push(e.userId+":"+e.orgId)});var m=e.toLowerCase();a.map(function(o){t.find(i,{data:o.data})||e.length&&0!==o.fullName.toLowerCase().indexOf(m)||i.unshift(o)});var d=function(o){return(0===i.length||e.length>=o[1])&&0===o[0].indexOf(m)};return s.singleMode||e.length&&!t.some(r,d)||i.unshift({data:"0:0",text:"Room",fullName:"Room"}),i.map(function(e){return e.type||(e.type="user"),"user"!==e.type?e:(e.inRoom=s.singleMode||s.room.roomType===$.ONE_ON_ONE||c.indexOf(e.data)>-1,e.class=e.inRoom?"user-in-room":"user-not-in-room","0:0"===e.data&&(e.class+=" user-the-room"),e)}).sort(function(e,o){return"0:0"===e.data?-1:"0:0"===o.data?1:e.type!==o.type?"user"===e.type?-1:1:"user"===e.type?o.inRoom-e.inRoom:0})}).then(function(e){return b.settleDuplicates(e,function(e){return e.text},function(e){return e.orgId},function(e){return e.username},"subtext")})},s.addEmoji=function(e){var o=s.ta.get(0).selectionStart,t=s.ta.get(0).selectionEnd,r=s.ta.val();r=r.slice(0,o)+e+r.slice(t),s.ta.val(r),m(function(){s.ta.get(0).selectionStart=s.ta.get(0).selectionEnd=o+e.length,s.ta.change(),s.ta.focus(),n.update(s.ta)})},s.setComposerEnterBehavior=function(){b.saveComposerSettings(S.user.userId,{noSendOnEnter:s.settings.noSendOnEnter}),s.ta.focus(),s.$emit("composer:lineSettingChanged")},s.$watch("settings.showEnterBehaviorPopover",function(e){e&&D.getSettings().then(function(e){e.composerSettingPopup||D.updateSettings({composerSettingPopup:!0})})}),s.$onRootScope("tour:start:composerSettings",function(){s.settings.showEnterBehaviorPopover=!0}),s.$onRootScope("tour:end:composerSettings",function(){s.settings.showEnterBehaviorPopover=!1}),s.triggerDropboxChooser=function(){i.Dropbox.init({appKey:"6zhtzduhg6zksr0"}),i.Dropbox.choose({success:function(e){o.forEach(e,function(e){var o=_.validateDropboxFile(e),t=k.create();t.objectUrl=e.link,t.fileName=e.name,t.fileSize=e.bytes,o.valid||(t.status.errorMessage=o.message),s.story.attachments.push(t)}),w.ga("Files","dropbox","file shared")},linkType:"preview",multiselect:!0})},s.newVideoSessionStarted=function(e){a.$emit("video:start",e)},s.emojiTab=0,s.selectedEmoji={name:":smile:",img:C.trustAsHtml(f.shortnameToImage(":smile:"))},s.selectEmojiTab=function(e){s.emojiTab=e},s.emojiImageHover=function(e){s.selectedEmoji={name:e,img:C.trustAsHtml(o.element("a[emoji="+e.replace(/:/g,"\\:")+"]").html())}},s.emojiLoaded=!1,d.get(s.emojiTemplatePath,{cache:l}).then(function(){s.emojiLoaded=!0});var M={};s.typing="";var E=0,T=function(){var e=++E;b.several(t.map(M,"user"),!0).then(function(t){if(e===E){var n=[];switch(o.forEach(t,function(e){n.push(e.info.fullName)}),n.length){case 0:s.typing="";break;case 1:s.typing=n[0]+" is typing...";break;case 2:s.typing=n[0]+" & "+n[1]+" are typing...";break;default:s.typing=n[0]+", "+n[1]+" & "+(n.length-2)+" more are typing..."}s.$emit("room.uiResize")}})},N=function(e,o){if(e!==S.user.userId||o!==S.user.orgId){var n=e+"_"+o;M[n]?M[n].bump():t.some(s.room.users,function(r){if(r.userId===e&&r.orgId===o){var i=!1;return M[n]={user:r.userId,bump:t.debounce(function(){i||s.$apply(function(){j(e,o)})},5e3),cancel:function(){i=!0}},M[n].bump(),T(),!0}})}},j=function(e,o){var t=e+"_"+o;M[t]&&(M[t].cancel(),delete M[t],T())};if(s.roomMode){var A,P;s.$evalAsync(function(){A=s.room.on("typing",function(e){N(e.userId,e.orgId)}),P=s.room.onStory("newStory",function(e){j(e.userId,e.orgId)})}),s.$on("$destroy",function(){A&&A(),P&&P()});var U=function(e){var n,r,c;if(e.originalEvent&&(n=e.originalEvent.clipboardData))r=n.getData("text/html");else{if(!(n=i.clipboardData))return;var d=i.localStorage.getItem("eo-dash-html-clipboard");if(d){var l=o.element(d).get(0).innerText;"windows"===F.os&&(l=l.replace(/\r?\n/g,"\r\n")),l&&l===n.getData("text")?r=d:i.localStorage.removeItem("eo-dash-html-clipboard")}}if(r){var u;if(null!==(u=r.match(/<!--StartFragment-->(.*)<!--EndFragment-->/i))?r=u[1]:null!==(u=r.match(/<body>(.*)<\/body>/i))&&(r=u[1]),/data-story-id=/.test(r)&&(r=r.replace(/data-text="[^"]*"/g,function(e){return e.replace(/>/g,"&gt;")}),r=o.element("<div>").html(r),(c=r.find("[data-story-id]")).size())){var g,f=function(e){if(e.hasOwnProperty("innerText"))return e.innerText;var t="";return o.forEach(e.childNodes,function(e){3===e.nodeType?t+=e.nodeValue:"BR"===e.tagName?t+="\n":t+=f(e)}),t};c.each(function(e,t){t=o.element(t),g={_undoState:s.story.message,message:t.attr("data-text")||f(t[0]),created:t.attr("data-timestamp"),storyId:t.attr("data-story-id"),roomId:t.attr("data-room-id")},t.attr("data-userid")?(g.userId=t.attr("data-userid"),g.user=b.getFromCache(g.userId)||{},t.attr("data-orgid")&&(g.user.orgId=t.attr("data-orgid"))):t.attr("data-user")&&(g.integrationData={integrationName:t.attr("data-user"),integrationIconUrl:t.attr("data-photo")}),s.$emit("room:quote",g)}),e.preventDefault();var h=function(){D.closeStep("pasteMessage")};m(function(){var e=t.last(s.room.stories),n='div[eo-story-id="'+e.storyId+'"] a.story-actions[eo-panel-open]',r=o.element(n),c=!e.blocked&&!!e.message&&!s.room.isReadOnly,d=function(){a.$emit("story:scrollToElement",r),m(function(){r.click(),o.element(i).on("click",h)},100)},l=function(){p.dismissAll(),o.element(i).off("click",h)};D.setBeforeOpen("pasteMessage","prevMessage",d),D.setOnClose("pasteMessage","prevMessage",l),D.setTargetElement("pasteMessage","prevMessage",r),r.length&&c&&D.show("pasteMessage")})}}};c.bind("paste",U),s.$on("$destroy",function(){s.room=null,s.ta=null,c.unbind("paste",U),D.setBeforeOpen("pasteMessage","prevMessage",null),D.setOnClose("pasteMessage","prevMessage",null)})}s.checkForComposerSettings=function(){return!s.readOnly&&!s.singleMode&&s.roomMode&&!s.isMobileDevice}}],link:function(e,r,d){function l(){if(x.length&&y.is(":visible")){var e=x.height()/2-$;e=Math.max(e,19),y.css({maxHeight:e})}}var u,p=r.find(".msg-composer-input"),f=r.find(".msg-composer-highlighter"),y=r.find(".msg-composer-maxheight"),b=r.find(".msg-composer-area"),I=b.parents(".story-box"),$=r.height()-p.height(),x=r.parents(".story-box"),k=o.element(i),_=e.story.message,R=function(e){if(!(r.find(".msg-composer-file-drag-over").length>0)){e.stopPropagation(),e.preventDefault();var o=e.originalEvent.dataTransfer;o.effectAllowed=o.dropEffect="none"}},z=r.find(".mobile-slider-arrow"),L=r.find(".mobile-sender-btn"),H=r.find(".mobile-msg-icon  .call-icon, .msg-composer-attach");e.room=e.$parent.room,e.ta=p,e.isTextAreaFocused=!1;var U;e.roomMode&&(U=e.room.getFileGroup(),e.readOnly=e.room.isReadOnly);var B=function(t){e.readOnly=!!t,O.isSudo()?(e.readOnly=!0,e.placeholder="Compose is disabled in Sudo mode"):e.readOnly?e.room.getReadOnlyReason().then(function(o){e.placeholder=o}):!e.placeholder&&o.isDefined(d.placeholder)?e.placeholder=d.placeholder:e.placeholder=""};e.$watch("room.isReadOnly",function(e){B(e)}),p.hide();try{n(p)}catch(e){}p.show(),p.on("autosize:resized",function(){f&&(f.height(p.height()),e.$emit("room.uiResize"),e.editMode&&q())}),e.$on("$destroy",function(){p.off("autosize:resized")});var K,q=function(){m(function(){var e,o=r.parent(".composer-edit-panel"),t=o.find(".msg-composer-maxheight");K?K<t[0].scrollHeight?e=o.outerHeight():(o.css("height","auto"),e=o.outerHeight()):e=o.outerHeight(),K=t[0].scrollHeight,t[0].scrollHeight>t.outerHeight()==0?o.css("height",e+"px"):o.css("height",o.outerHeight()+"px")})};o.element(p).on("$destroy",function(){n.destroy(this)}),m(function(){try{n.update(p)}catch(e){}},10);var G=function(){var e=o.element("#file-upload")[0];e&&(e.value="")};e.$on("composer:attachment:deleted",function(o,t){U.remove(t),e.$emit("room.uiResize"),G()}),e.$on("typeahead:submit",function(o,t){e.singleMode||e.isMobileDevice||e.settings.noSendOnEnter||(e.submit(),t.preventDefault(),D.getSettings().then(function(e){e.composerSettingPopup||D.updateSettings({enterKeyPressed:!0})}))}),e.$on("typeahead:cancel",function(){e.cancel()}),e.roomMode&&(e.$on("typeahead:keyup",function(){e.$emit("story:editLast")}),s.bind({dragenter:R,dragover:R}),e.$on("$destroy",function(){s.unbind("dragenter",R),s.unbind("dragover",R)}),e.$onRootScope("room:quote",function(o,t){var n=h.create(t);n.messageHtml=j.parseMessage(n.message,{roomId:e.room.roomId},!0),n.trustedMessage=C.trustAsHtml(n.messageHtml),e.story.attachments.push(n),m(function(){p.focus(),y.scrollTop(y.height()),e.$emit("room.uiResize")},10,!1),e.$emit("room.uiResize");var r={event:"click",location:"chat room",sublocation:"compose story",timestamp:new Date,userId:S.user.userId,data:[{org_id:S.user.orgId,room_id:e.room.roomId,action:"quote event",opening_uid:e.room.context&&e.room.context.jobUid,contract_id:e.room.contractId,contractor_uid:e.room.context&&e.room.context.freelancerId,event_label:"quote_event"}]};E.log(r),w.ga("Rooms","compose story","quote user",{roomId:e.room.roomId})}),e.$onRootScope("editmode:cancel",function(){p.focus()}),e.$onRootScope("screensnap:added",function(o,t){e.story.attachments.push(t),U.add(t),p.focus()}));var W,V=function(){e.tour&&e.tour.closeTour(),e.room.notifyTyping()},Q=function(){W=t.throttle(V,4e3,{trailing:!1})};Q();var J=[9,13,16,17,18,19,27,33,34,35,36,37,38,39,40,45,91,92,93,112,113,114,115,116,117,118,119,120,121,122,123,144,145],X=function(t){var r,i,s,a;switch(t.keyCode){case 13:(t.altKey||t.ctrlKey)&&(e.settings.noSendOnEnter?e.submit():(r=p.get(0).selectionStart,i=p.get(0).selectionEnd,s=p.val(),s=s.slice(0,r)+"\n"+s.slice(i),p.val(s),n.update(p),p.get(0).selectionStart=p.get(0).selectionEnd=r+1),t.preventDefault());break;case 90:if(t.ctrlKey!==t.metaKey&&!t.shiftKey&&!t.altKey&&e.story.attachments)for(var c=e.story.attachments.length-1;c>=0;--c)if(a=e.story.attachments[c],o.isDefined(a._undoState)&&a._undoState===e.story.message){e.$broadcast("composer:attachment:delete",c),t.preventDefault();break}break;case 86:t.ctrlKey&&m(function(){n.update(p)},5);break;case 66:case 73:if(t.ctrlKey){r=p.get(0).selectionStart,i=p.get(0).selectionEnd,s=p.val();var d=O.markdownEnabled()?"**":"*",l=66===t.keyCode?d:"_",u=l===d?"_":"\\"+d,g=s.slice(r,i);if(g.length){var f;f=1===l.length?"["+l+"]":"["+l.substr(1)+"]{"+l.length+"}";var h=new RegExp("^("+u+"?)"+f+"(.*)"+f+"\\1$"),y=g.match(h);g=y?y[1]+y[2]+y[1]:l+g+l}else g=l;s=s.slice(0,r)+g+s.slice(i),p.val(s),n.update(p),p.get(0).selectionStart=r+(1===g.length?1:0),p.get(0).selectionEnd=r+g.length,t.preventDefault()}}!e.singleMode&&J.indexOf(t.keyCode)<0&&W()};p.bind("keydown",X);var Y=function(){e.composerSlideCollapse=!0,e.hideArrow=!1,e.isSliderOpen=!1};p.bind("click",Y);var Z=function(){m.cancel(u),e.isTextAreaFocused=!0,e.composerSlideCollapse=!0,e.hideArrow=!1,e.$emit("room.uiResize"),m(function(){n.update(p)},10)};p.bind("focus",Z);var ee=function(){u=m(function(){e.isTextAreaFocused=!1,e.editMode&&e.breakPoints.mdDown&&e.cancel(),e.composerSlideCollapse=!1,e.hideArrow=!p||!p.val().length,e.isSliderOpen=p&&p.val().length,e.$emit("room.uiResize")},200)};if(p.bind("blur",ee),e.editMode){var oe=function(t){o.element(t.target).closest("eo-rooms-composer").length>0&&e.breakPoints.mdDown&&m.cancel(u)};s.bind("click",oe),e.$on("$destroy",function(){s.unbind("click",oe)})}var te=function(){p.focus(),m.cancel(u),e.composerSlideCollapse=e.isSliderOpen,e.hideArrow=!1,e.isSliderOpen=!e.isSliderOpen};z.bind("click",te);var ne=function(){m.cancel(u),e.isSliderOpen=!1};L.bind("click",ne);var re=function(){m.cancel(u)};H.bind("click",re),e.$on("$destroy",function(){p.unbind("keydown",X),p.unbind("click",Y),p.unbind("focus",Z),p.unbind("blur",ee),z.unbind("click",te),L.unbind("click",ne),H.unbind("click",re)}),k.on("resize layout-resize",l),l(),e.$on("$destroy",function(){k.off("resize layout-resize",l),e.roomMode&&s.unbind({dragenter:R,dragover:R})}),e.enableDropboxUpload=S.isDropboxUploadEnabled(),e.triggerAttach=function(){w.ga("Files","file attach","from icon"),o.element("#file-upload").trigger("click"),m(function(){o.element(".edit-mode-panel .text-close").trigger("click")},10,!1)},e.cantSendReason=null,e.canSend=function(){return e.cantSendReason=e.story.cantSend(e.roomMode,e.readOnly),!e.cantSendReason},("autofocus"in d&&!(O.isWidget()||O.isMobile()||F.isMobile())||e.editMode)&&m(function(){p.focus(),p.get(0).selectionStart=p.get(0).selectionEnd=p.val().length},10,!1),e.moveCaretToEnd=function(){var e=r.find(".msg-composer-input")[0];e.selectionStart=e.selectionEnd=e.value.length},e.pasteFiles=function(t,n){if(t=t.map(function(e){return{name:e.name,size:e.size,type:e.type,file:e}}),v.openAnnotationOnComposerPaste&&1===t.length&&"image/png"===t[0].type)return void e.snapDialog(t[0].file);e.roomMode&&(o.forEach(t,function(e){e.name="Pasted File at "+M(new Date,"MMMM d, y h:mm a")+".png"}),e.attach(t)),n.stopPropagation(),n.preventDefault()},T.isSupported().then(function(o){e.screenSnapSupported=o,o&&(D.getSettings().then(function(e){e.interstitial&&D.show("screenSnap")}),T.getShortcuts().then(function(o){e.screenSnapShortcuts=o}))}),e.snapDialog=function(o){T.show({image:o,roomName:e.room.roomName,roomId:e.room.roomId})},e.snapCustomArea=function(){T.snapCustomArea(e.room.roomId,e.room.roomName)},e.snapActiveScreen=function(){T.snapActiveScreen(e.room.roomId,e.room.roomName)},e.attach=function(t){if(!e.room.isReadOnly&&t.length){var n={event:"click",location:"chat room",sublocation:"compose story",timestamp:new Date,userId:S.user.userId,data:[{org_id:S.user.orgId,room_id:e.room.roomId,action:"message compose",opening_uid:e.room.context&&e.room.context.jobUid,contract_id:e.room.contractId,contractor_uid:e.room.context&&e.room.context.freelancerId,event_label:"attach_file_locally",file_share_type:"upload"}]};E.log(n),U.attach(t).then(function(t){o.forEach(t,function(o){e.story.attachments.push(o)}),e.$emit("room.uiResize"),p.focus()},function(){c.messageBox("Error uploading the file","Sorry, we could not contact the server, please try attaching the file again.",[{label:"Ok",cssClass:"btn-primary",result:!0}])})}},e.$on("composer:attachment:previewLoaded",function(){e.$emit("room.uiResize")}),e.$on("composer:attachment:errorStateChange",function(){e.$emit("room.uiResize")}),e.$on("composer:submit",function(){n.update(p)}),e.cancel=function(){e.roomMode||(e.story.message=_,e.editMode&&(e.$broadcast("mentions:update",e.story.message),e.$emit("editmode:cancel")))},e.submit=function(){if(this.canSend()){var o,t;e.roomMode?(t=U.commit(),U.hasFiles()):t=a.when({}),t.then(function(){if((e.story.message||e.editMode||e.story.attachments.length)&&(e.editMode?e.story.message!==_?(N.checkStory(e.room.roomId,e.story),e.room.updateStory(e.story.plain()).then(function(){e.$emit("editmode:cancel")}).catch(function(e){P.inline({type:"danger",template:e,duration:3e3})})):e.$emit("editmode:cancel"):A.parse(e.story).then(function(t){o=e.room.newStory(t.plain()),N.checkStory(e.room.roomId,t),D.getSettings().then(function(e){e.storyEditNew&&e.videoTour&&e.notes&&e.markdownTour||(e.numberOfStories?(e.numberOfStories=parseInt(e.numberOfStories),e.numberOfStories++):e.numberOfStories=1,D.updateSettings({numberOfStories:e.numberOfStories}))})}).finally(function(){e.story.message="",e.$broadcast("mentions:update",e.story.message),e.story.attachments=[],e.$emit("room.uiResize")})),o&&o.then(Q),G(),e.$broadcast("composer:submit"),e.$emit("room.uiResize"),e.mentionsCounterLog>0){var t={event:"click",location:"chat room",sublocation:"compose story",timestamp:new Date,userId:S.user.userId,data:[{org_id:S.user.orgId,room_id:e.room.roomId,num_of_mentions:e.mentionsCounterLog,action:"mentions event",opening_uid:e.room.context&&e.room.context.jobUid,contract_id:e.room.contractId,contractor_uid:e.room.context&&e.room.context.freelancerId,event_label:"mentions_event"}]};E.log(t),w.ga("Rooms","compose story","mentioned user",{roomId:e.room.roomId})}e.mentionsCounterLog=0;var n={event:"click",location:"chat room",sublocation:"compose story",timestamp:new Date,userId:S.user.userId,data:[{org_id:S.user.orgId,room_id:e.room.roomId,action:"message compose",message_length:e.messageLengthLog,opening_uid:e.room.context&&e.room.context.jobUid,contract_id:e.room.contractId,contractor_uid:e.room.context&&e.room.context.freelancerId,event_label:"message_compose"}]};E.log(n),w.ga("Rooms","compose story","text story",{roomId:e.room.roomId}),i.opener&&i.opener.analytics&&i.opener.analytics.addAction("messageSent",{message_length:e.messageLengthLog}),e.roomMode&&p.focus()},function(e){w.ga("Files","file upload","failed"),g.error("Error commiting the files",e),c.messageBox("Error sending the message","Sorry, we could not send the message with the selected attachments, please try again.",[{label:"Ok",cssClass:"btn-primary",result:!0}])})}},e.$on("mentions:updated",function(o,t){e.story.message=t,e.$digest()}),e.$on("$destroy",function(){p=f=y=b=I=$=x=k=_=null})}}}])});