define(["./common","angular","lodash","./organizations-service","config-service","./retry-service","./context-service","./workplace-connections-service","./user-presence-service","./oauth-service"],function(e,n,t){"use strict";e.constant("DIRECTORY_GET_PERSONS_LIMIT",50),e.factory("eoUsers",["$rootScope","$cacheFactory","$window","$interval","$q","$log","tlAuth","tlUser","tlSettings","eoOrganizations","eoDashConfig","eoRetry","eoDashContext","eoDashCache","tlDirectory2","upWorkplaceConnections","eoUserPresence","DIRECTORY_GET_PERSONS_LIMIT","tlOrpc","eoOauth","$http","upUserPreferencesApi","upDashMetrics",function(e,r,o,i,s,c,a,u,f,l,p,d,h,g,m,v,k,b,I,y,U,S,w){function P(e){A.length&&k.fetch(A,e)}function E(e,n){var t=e?e.length:0;if(!t||n<1)return[];for(var r=0,o=0,i=[];r<t;)i[o++]=e.slice(r,r+=n);return i}var W=r("users"),A=[],C=!1,_={blocked:[],blockedBy:[]},N={},B=function(e){return-1!==_.blocked.indexOf(e)},D=function(e){return-1!==_.blockedBy.indexOf(e)},O=function(e){return B(e)||D(e)},$=function(e){B(e)||_.blocked.push(e)},M=function(e){B(e)&&_.blocked.splice(_.blocked.indexOf(e),1)},x=function(e){D(e)||_.blockedBy.push(e)},T=function(e){D(e)&&_.blockedBy.splice(_.blockedBy.indexOf(e),1)},L=function(e){return W.get(e)},K=/^https?:/,V=function(e,t){e.photoUrl&&(e.photoUrl=e.photoUrl.replace(K,"https:")),t=!!n.isUndefined(t);var r=e.personName,o=e.uid||e.userId,i=e.orgId||e.companyUid;if(!r||!o)return{info:e,userId:o,orgId:i};if(e.fullName=r.firstName+" "+r.lastName,delete e.orgId,delete e.companyUid,!1===t)return{info:e,userId:o,orgId:i};var s=L(o);if(s){for(var c in e)s[c]=e[c];e=s}else W.put(o,e),A.push(o);return{info:e,userId:o,orgId:i}};e.$on("auth:change",function(e,n){n&&n.user||(C=!1,W.removeAll(),A.length=0),N=n}),e.$on("organization:change",function(){W.removeAll(),A.length=0}),e.$on("socket:reconnect",function(){Z(A),P(!1)}),e.$on("auth:refresh",function(){Z(A)}),i(function(){e.user&&e.tlConnected&&P()},1e3*(p.user.presenceCacheTTL||600)),u.$on("updatedUser",function(n){n.photoUrl&&(n.photoUrl+="&now="+Date.now());var t=V(n);e.$emit("eoUsers:updatedUser",t)});var j=function(e){var n=e&&e.user;return n&&(e.user.userId=e.user.uid,e.user=V(n,!1).info),e.organizations&&e.organizations.map(function(e){l.cache(e.uid,e)}),N=e,e},R=function(e){return e.then(j)},z=function(e){var t=e&&(e.persons||e.contacts),r=[];return t&&n.forEach(t,function(e){var n=e.person||e,t=V(n);r.push(t)}),P(!0),r},F=[],q={},G=function(e,n){n=n||b;var r=E(e.uids,n);e=t.clone(e),delete e.uids;var o=[];return t.forEach(r,function(n){var r=t.clone(e);r.uids=n,o.push(m.getPersons(r))}),s.all(o).then(function(e){var n={persons:[]};return t.forEach(e,function(e){e&&e.persons&&n.persons.push.apply(n.persons,e.persons)}),n})},J=function(e,t){var r=[];n.forEach(e,function(e){q[e]&&(r.push(e),q[e].reject(t),delete q[e])}),r.length&&console.warn(t,r)},Y=function(){if(F.length){var e=F.slice();G({uids:e}).then(z,function(n){return J(e,n),s.reject(n)}).then(function(n){for(var t=0;t<n.length;++t)q[n[t].userId]?(q[n[t].userId].resolve(n[t]),delete q[n[t].userId]):console.info("throttleGetUsers error",n[t]);J(e,"User not included in the response")},function(n){J(e,n)}),F=[]}},H=t.debounce(Y,10,{maxWait:200}),Q=function(e){for(var n,t=[],r=0;r<e.length;++r)n=e[r],q[n]||(F.push(n),q[n]=s.defer()),t.push(q[n].promise);return H(),s.all(t)},X=function(e){if(e.uids){for(var n=0;n<e.uids.length;n++){if(!e.uids[n])return s.reject("User IDs can not be null");e.uids[n].match(/^int/)&&(console.warn("An integration id is incorrectly being used as a parameter to getUsers"),e.uids[n]=null)}return e.uids=e.uids.filter(function(e){return null!==e}),Q(e.uids)}if(e.query)return v.getMentions(e).then(z);if(e.email)return v.getContacts(e).then(z);var t="Either user ids (UIDs), a search query, or an email address must be supplied";return console.warn(t),s.reject(t)},Z=function(e,t){var r,o=function(){var t,r=[];return n.forEach(e,function(e){(t=L(e))&&r.push({info:t,userId:e,orgId:null})}),r};return t?(r=[],n.forEach(e,function(e){L(e)||r.push(e)})):r=e,r.length?X({uids:r}).then(o):s.when(o())},ee=function(){var n={params:{orgUid:e.user.orgId}};h.useOauth2()&&(n.headers={Authorization:"Bearer "+y.getToken(),Accept:"application/json"});var t=p.odeskBaseURL+"/messages/broadcast/teams";return U.get(t,n).then(function(e){return e.data},function(e){return e})},ne=null,te=function(e){return e.info||e._info?(e.info||e._info).fullName:null},re=function(e){return e.orgId},oe=function(e){return e.info||e._info?(e.info||e._info).legacyId:null},ie={search:X,several:Z,getActiveContractTeamList:ee,getFromAddressBook:function(e){return this.search({uids:[e]})},isInAddressBook:function(e){return this.getFromAddressBook(e).then(function(e){return e.length>0})},isInOrganization:function(e){return v.getContacts({includeIds:[e]}).then(function(e){return e.contacts.length>0})},getFromCache:function(e){var n=L(e);return n?{userId:e,orgId:null,info:n}:null},settleDuplicates:function(e,t,r,o,i){if(!e)return s.when(e);var c,a,u,f,p,d={},h={};for(t||(t=te),r||(r=re),o||(o=oe),i||(i="tag"),c=0;c<e.length;++c)(p=t(e[c]))&&(d[p]||(d[p]=[]),d[p].push(c));for(c in d)if(!(d[c].length<2))for(a=0;a<d[c].length;++a)(u=r(e[d[c][a]]))&&!h[u]&&(h[u]=l.get(u));return s.all(h).then(function(t){var s,c,a,u,l,p,h,g,m={},v={};for(h in d)if(!(d[h].length<2)){for(a=[],u=[],l=[],p=[],g=0;g<d[h].length;++g){s=r(e[d[h][g]]);var k=e[d[h][g]];c=k.user?k.user.userId:k.userId,s&&(l.indexOf(s)<0?l.push(s):a.push(s),c&&(p.indexOf(c)<0?p.push(c):u.push(c)))}for(g=0;g<d[h].length;++g)if(f=e[d[h][g]],delete f[i],s=r(f)){var b=-1!==a.indexOf(s);m[h]=a.length&&u.length,!b||m[h]?(v[s]||(v[s]=[]),v[s].push(f),m[h]&&(f[i]=o(f))):f[i]=o(f)}}n.forEach(v,function(e,n){t[n]&&(t[n].isSoleProprietor()?e.map(function(e){e[i]=o(e)}):e.map(function(e){var r=t[n].name;e[i]=e[i]?e[i]+" - "+r:r}))});for(h in d)if(!(d[h].length<2||m[h])){for(l=[],g=0;g<d[h].length;++g)f=e[d[h][g]],f[i]===o(f)&&l.push(f);1===l.length&&delete l[0][i]}return e})},searchForTags:function(e){var n=this;return this.search(e).then(function(e){return n.settleDuplicates(e)}).then(function(e){return e.map(function(e){return{text:e.info.fullName,subtext:e.tag,img:e.info.photoUrl,presence:k.presence[e.userId],fullName:e.info.fullName,username:e.info.legacyId,data:e.userId,orgId:e.orgId}})})},resolveInvitedUsers:function(e){return v.resolveInvitedUsers(e)},getInvitations:function(e){return v.getInvitations(e).then(function(e){var t=e.invites;return n.forEach(t,function(e){switch(e.status){case 1:e.status="Pending";break;case 2:e.status="Joined";break;case 3:e.status="Error"}}),t})},_loadSettings:function(e){return n.fromJson(o.localStorage.getItem("settings_"+e))||{}},getParsedSettings:function(e){var n=this;return this.getSettings(e).then(function(e){return n.parseSettings(e)})},parseSettings:function(e){var t={};return n.forEach(e.componentPreferences,function(e){var r={};n.forEach(e.preferences,function(e){r[e.prefKey]=e.prefValue}),t[e.componentName]=r}),t},mapUserSettings:function(e,n){var t=this.parseSettings(e),r=n||{};return t.WorkplaceDisintermediation&&(r.disintermediation=t.WorkplaceDisintermediation),t.WorkplaceNotificationsEmail&&(r.notifications.email=t.WorkplaceNotificationsEmail.notifyWhen,r.notifications.emailApproximately=t.WorkplaceNotificationsEmail.frequency,r.notifications.emailPresence="idle_or_offline"===t.WorkplaceNotificationsEmail.presence),t.WorkplaceNotificationsDesktop&&(r.notifications.desktop=t.WorkplaceNotificationsDesktop.notifyWhen,r.notifications.sound="false"!==t.WorkplaceNotificationsDesktop.playSound),t.WorkplaceMessageCounter?r.counter.show=t.WorkplaceMessageCounter.show:r.counter.show="important"===r.notifications.desktop?"important":"all",t.Composer&&(r.composer.noSendOnEnter="true"===t.Composer.noSendOnEnter),t.WorkplaceBanners&&(r.banners=t.WorkplaceBanners),h.isIntegratedDesign()&&t.WorkplaceNotificationsTeamApp&&(r.notifications.desktop=t.WorkplaceNotificationsTeamApp.notifyWhen,r.notifications.sound="false"!==t.WorkplaceNotificationsTeamApp.playSound),r},getUserSettings:function(e,n){var r=this,o=this._loadSettings(e),i={notifications:{desktop:"all",email:"all",emailApproximately:"fifteen_minutes",sound:!1,emailPresence:!1},counter:{show:"all"},composer:{noSendOnEnter:!1},disintermediation:{},banners:{downloadMobileApp:0},url:{hidePreview:!1}};return d.create(function(){return n||r.getSettings(!0)}).try().then(function(n){if(p.enableDashCache){var s=g.get(e);try{s.put("preferences",n)}catch(e){console.warn("There was an error saving the cache",e)}}return n&&n.componentPreferences?(o=t.merge(i,o),o=r.mapUserSettings(n,o),r._saveLocalSettings(e,o)):r._saveLocalSettings(e,i),t.merge(i,o)},function(){return c.warn("Count not fetch settings from server, using stored settings"),t.merge(i,o)})},getLocalSettings:function(e){if(!C)return ne||(ne=this.getUserSettings(e).then(function(e){return C=!0,ne=null,e}));var n=this._loadSettings(e);return s.when(n)},saveSettings:function(e,t,r){var o=[];n.forEach(r,function(e,n){o.push({prefKey:n,prefValue:e})});var i={global:e?"true":"false",component:t,preferences:{preferenceList:o}};return f.saveSettings(i)},saveDisintermediationSettings:function(n,t){var r=this;return this.saveSettings(!0,"WorkplaceDisintermediation",t).then(function(){r._saveLocalSettings(n,{disintermediation:t}),e.$broadcast("settings:updated")})},saveComposerSettings:function(n,t){var r=this;return t={composer:t},f.saveMultiCompSettings({global:"true",preferences:{componentList:[{componentName:"Composer",preferences:[{prefKey:"noSendOnEnter",prefValue:t.composer&&t.composer.noSendOnEnter}]}]}}).then(function(){r._saveLocalSettings(n,t),e.$broadcast("settings:updated",t)})},getSettings:function(e){return h.webApiEnabled()?(w.startMetric("getUserPreferencesUsingWebApi"),S.enableGlobalSettings(e),S.getUserPreferences().then(function(e){return w.endMetric("getUserPreferencesUsingWebAPI"),e},function(n){return w.count("getUserPreferencesUsingWebAPIFailure"),w.endMetric("getUserPreferencesUsingWebAPI"),console.warn("failed to fetch user preferences using web api:",n),f.getSettings({global:e?"true":"false"})})):f.getSettings({global:e?"true":"false"})},saveUserSettings:function(n,t){var r=this;"none"===t.notifications.email&&(t.notifications.emailApproximately="none");var o=h.isIntegratedDesign()?"WorkplaceNotificationsTeamApp":"WorkplaceNotificationsDesktop",i=[{componentName:"WorkplaceNotificationsEmail",preferences:[{prefKey:"notifyWhen",prefValue:t.notifications&&t.notifications.email},{prefKey:"frequency",prefValue:t.notifications&&t.notifications.emailApproximately},{prefKey:"onlyUnread",prefValue:"true"},{prefKey:"presence",prefValue:t.notifications.emailPresence?"idle_or_offline":"always"}]},{componentName:o,preferences:[{prefKey:"notifyWhen",prefValue:t.notifications&&t.notifications.desktop},{prefKey:"playSound",prefValue:t.notifications&&t.notifications.sound}]},{componentName:"WorkplaceMessageCounter",preferences:[{prefKey:"show",prefValue:t.counter&&t.counter.show}]},{componentName:"Composer",preferences:[{prefKey:"noSendOnEnter",prefValue:t.composer&&t.composer.noSendOnEnter}]},{componentName:"Url",preferences:[{prefKey:"hidePreview",prefValue:t.url&&t.url.hidePreview}]}],s=function(t){t?(r._saveLocalSettings(n,t),e.$broadcast("settings:updated")):r.getUserSettings(n).then(function(){e.$broadcast("settings:updated")})};return h.webApiEnabled()?(w.startMetric("saveUserPreferencesUsingWebApi"),S.saveUserPreferences(i).then(function(e){w.endMetric("saveUserPreferencesUsingWebApi"),s(r.mapUserSettings(e,t))},function(n){return w.count("saveUserPreferencesUsingWebApiFailure"),w.endMetric("saveUserPreferencesUsingWebApi"),console.warn("failed to save user preferences using web api:",n),f.saveMultiCompSettings({global:!0,preferences:{componentList:i}}).then(function(){e.$broadcast("settings:updated",t),s()})})):f.saveMultiCompSettings({global:!0,preferences:{componentList:i}}).then(function(){s()})},preferencesUpdateReceived:function(n,t){this.getUserSettings(n,t).then(function(){e.$emit("settings:updated",t)})},_saveLocalSettings:function(e,r){var i=this._loadSettings(e);try{o.localStorage.setItem("settings_"+e,n.toJson(t.merge(i,r)))}catch(e){console.error(e)}return s.when()},login:function(e,n){return this.fetchAuthData({username:e,password:n})},logout:function(){return y.revokeToken().catch(function(){a.logout()})},changeCompany:function(e){return a.changeCompany({orgId:e})},fetchAuthData:function(e){return R(a.auth(e))},getBlockInfo:function(e){return!_.fetched||e?v.getBlockInfo().then(function(e){return _.fetched=!0,e&&(_.blocked=n.isArray(e.blocked)?e.blocked:_.blocked,_.blockedBy=n.isArray(e.blockedBy)?e.blockedBy:_.blockedBy),_}):s.when(_)},_blockabilityCache:{},fetchBlockability:function(e,r){var o=!1,i=this,c=[];if(n.isString(e))o=!0,e=[e];else if(!n.isArray(e))return s.reject("Must supply a single (string) user ID or an array of user IDs");r?t.forEach(e,function(e){n.isDefined(i._blockabilityCache[e])||c.push(e)}):c=e;var a;return a=c.length?v.canBlock({uids:c.join()}).then(function(e){t.forEach(c,function(n,t){i._blockabilityCache[n]=e.canBlock[t]})}):s.when(),a.then(function(){return o?i._blockabilityCache[e[0]]:e.map(function(e){return i._blockabilityCache[e]})})},getProfile:function(e){return e?I.getProfileUrl({legacyId:e}):s.when()},canInviteUser:function(){return v.canInviteUser()},blockPerson:function(e){return this.hasBlockedUser(e)?s.when(e):($(e),v.blockPerson({blockeePersonId:e}).then(function(){return e},function(n){return M(e),s.reject(n)}))},unblockPerson:function(e){return this.hasBlockedUser(e)?(M(e),v.unblockPerson({blockeePersonId:e}).then(function(){return e},function(n){return $(e),s.reject(n)})):s.when(e)},hasBlockedUser:function(e){return B(e)},isBlockedByUser:function(e){return D(e)},blockExists:function(e){return O(e)}};return u.$on("userBlocked",function(e){e.blockeeId===N.user.userId?x(e.blockerId):e.blockerId===N.user.userId&&$(e.blockeeId)}),u.$on("userUnblocked",function(e){e.blockeeId===N.user.userId?T(e.blockerId):e.blockerId===N.user.userId&&M(e.blockeeId)}),e.$on("auth:change",function(e,n){n&&n.user&&ie.getBlockInfo(!0)}),ie}])});