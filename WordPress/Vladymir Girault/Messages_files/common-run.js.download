define(["./common","angular","./auth-service","config-service","./idle-service","./context-service","./app-version-service","./updater-service","./auth-service","./notification-service","./response-handler-service","./integration-permission-service","./debug-service","./organization-unread-updater-service","./users-service","./keyboard-shortcut-service","./oauth-service","./visibility-service","./team-app-service","./cross-communication-service","./applet-service","./user-presence-service","./cache-sync-service","./dash-metrics-service","./retry-workflow-service"],function(e,o){"use strict";e.config(["$provide",function(e){e.decorator("$state",["$delegate","$window",function(e,t){var r=e.transitionTo;return e.transitionTo=function(i,n,a){return t.widgetOptions&&t.widgetOptions.enabled&&(a=o.extend({location:"replace"},a)),r.call(e,i,n,a)},e}])}]),e.run(["$window","$rootScope","$location","$state","$stateParams","$timeout","$interval","$http","$log","$q","eoIdle","eoDashConfig","eoDashContext","tlSocket","tlUser","tlPlugins","appVersion","eoUpdater","eoAuth","eoNotification","eoResponseHandler","eoIntegrationPermission","eoDebug","eoOrganizationUnreadUpdater","eoModelFactory","eoChannel","eoUsers","eoKeyboardShortcut","eoOauth","eoVisibility","eoTeamApp","eoTeamAppDashHandler","eoCrossCommunication","eoApplet","eoUserPresence","eoCacheSync","upDashMetrics","eoRetryWorkflow","upWebApiConfiguration","eoSlaveTokenHelpers","SB_ENDPOINTS",function(e,t,r,i,n,a,s,c,d,l,u,g,m,p,f,h,v,w,$,k,y,I,T,O,A,U,b,R,S,D,q,C,E,L,M,N,W,P,V,H,x){console.info("Dash web client version: "+v),R.capture();var B=e.localStorage;t.reload=function(){w.forceReload()},w.start(),t.closeUpdate=function(){t.update=!1,t.$emit("autoheight:recalculate")},t.isWidget=m.isWidget(),t.isWidget&&e.widgetOptions.roomId&&(t.widgetRoomId=e.widgetOptions.roomId),t.$state=i,t.$stateParams=n;var z=["deviceHardware","deviceToken","deviceOsName","deviceOsVersion","deviceAppVersion"];p.query.app=m.getClientName(),p.query.appVersion=v,o.forEach(z,function(e){r.search()[e]&&(p.query[e]=r.search()[e])}),r.search().deviceToken&&(p.query.deviceAppName="Dash"),m.useSessionCookie()&&L.getVar("sessionId")&&(p.query.token=L.getVar("sessionId")),m.isMobile()&&(t.isMobile=!0),m.isTeamApp()&&(e.document.domain=g.baseDomain,C.installOTAHandler(),q.install(),e.opener&&e.opener.dashOnReady&&e.opener.dashOnReady(),t.isIntegratedDesign=q.isIntegratedDesign()),m.useOauth2()&&S.hasToken()&&(p.query.oauth2_token=S.getToken());var F=S.getToken();V.setOAuthToken(F),H.setSlaveToken(F),t.$on("auth:tokenChanged",function(e,o){p.query.oauth2_token=o.access_token;var t=S.getToken();V.setOAuthToken(t),H.setSlaveToken(t)}),r.search().orgId?p.query.orgId=r.search().orgId:m.getOrgId()&&(p.query.orgId=m.getOrgId());var J,_,j=function(o){t.isWidget&&e.parent?e.parent.location.href=g.loginUrl+"?redir="+e.parent.location:g.redirectToLogin?e.location.href=g.loginUrl+"?redir="+r.url():i.go("login",o)};t.$on("tl:errorResponse",function(e,o,t){"auth"!==o&&"logout"!==o&&d.warn(o,JSON.stringify(t))});var G=!!e.WebSocket;if(!G){var K={showDiagnose:!1,showReload:!1,showWebsocketError:!0};i.go("error",{data:o.toJson(K)})}t.$on("$stateChangeStart",function(r,n,s,c,l){if(!G)return void r.preventDefault();if(m.isMobile()&&/^rooms\.chat-*/.test(n.name)&&t.$emit("view:main:show"),_&&a.cancel(_),_=a(function(){t.viewLoading=n.name},10),J||$.isAuthorized(n.resourceGroups)){if(t.widgetRoomId){if(s.force)return;if(/^inactive(\.|$)/.test(n.name))r.preventDefault(),i.go(n.name,{force:!0},{location:!1});else if(/^rooms(\.|$)/.test(n.name)&&(!/^rooms\.chat(\.|$)/.test(n.name)||s.id!==t.widgetRoomId))if(r.preventDefault(),/^rooms\.chat(\.|$)/.test(c.name)&&l.id===t.widgetRoomId)a.cancel(_),t.viewLoading=!1;else{var u="";"rooms.widget"===n.name&&e.widgetOptions.flags["/files"]?u=".files":"rooms.widget"===n.name&&e.widgetOptions.flags["/users"]&&(u=".users"),i.go("rooms.chat"+u,{id:t.widgetRoomId},{location:"replace"})}}}else J={state:n,params:s},r.preventDefault(),$.isAuthenticated()?(j(),J=null):m.useSessionCookie()||m.isTeamApp()||m.useOauth2()&&S.hasToken()?$.fetchAuthData().catch(function(e){var t;t=o.isArray(e)&&e[0]&&e[0].message?e[0].message:"Unknown",W.count("loadAuthError"),d.error('An error occurred while fetching auth data. Error: "%s"',t)}):(j(),J=null)}),t.$on("$stateChangeSuccess",function(){a.cancel(_),t.viewLoading=!1,i.includes("rooms.chat.**")&&m.isWidget()&&i.params.force&&(t.widgetRoomId=i.params.id),i.includes("rooms.**")||k.setUnread(0),i.current.data&&i.current.data.title&&i.current.data.title!==e.document.title&&(e.document.title=i.current.data.title)}),t.$on("$stateChangeError",function(e,o,r,n,s,c){a.cancel(_),t.viewLoading=!1,m.isMobile()&&/^rooms\.chat-*/.test(o.name)&&t.$emit("view:rooms:show"),c.requireModules?(d.warn("Require modules failed to load:",c.requireModules),P.create(function(){d.info("Attempting to recover by trying to load failed require modules.");var e=l.defer();return c.requireModules.forEach(function(e){require.undef(e)}),require(c.requireModules,function(){d.info("Successfully recovered by loading previously failed modules."),e.resolve()},function(o){d.info("Failed require modules have still not loaded."),e.reject(o)}),e.promise}).try().then(function(){i.go(o,r)},function(){d.error("Fatal Error. Require modules failed to load."),y.errors(c,!0)})):y.errors(c,!0)}),E.install($);var Q=!1;t.$watch(function(){return p.connected},function(e){t.tlConnected=e}),o.element(e).on("beforeunload",function(){Q=!0,p.connected&&p.emit("off")}),p.setSudoMode(m.isSudo()),B.getItem("debug")?T.restoreDefaults():T.disableAll();var X=!1;t.$on("organization:change",function(e,o){V.setOrgId(o.uid)}),t.$on("auth:change",function(e,r){if(r){var n=S.getToken();V.setOrgId(r.orgId).setOAuthToken(n),r.user&&V.setUserId(r.user.userId),H.setSlaveToken(n)}a(function(){if(r&&r.user)b.several([r.user.userId],!0).then(function(e){e&&D.setVisibilityFromPresence(M.presence[r.user.userId])}),X=!0,J?(i.go(J.state,J.params),J=null):i.go("rooms.index"),u.watch(),O.start(),N.start(),t.$emit("plugins:start");else{var e=r?r.errors:[],n=e&&e.length>0&&("connect"===e[0].type||"timeout"===e[0].type);u.unwatch(),O.stop(),N.stop(),t.$emit("plugins:stop");var a={connectError:n,showDiagnose:n&&m.isODC(),errors:e};!n&&(!X&&m.isODC()||m.isTeamApp())&&(n=!0,a.title="UNABLE TO AUTHENTICATE USER"),n?(a.showReload=!0,i.go("error",{data:o.toJson(a)})):($.clear(),B.removeItem("token"),a.errors&&a.errors.length>0&&(401===a.errors[0].code?a.errors[0].message="Session expired, please login again":a.errors[0].message="Unknown error, please login again"),j({data:o.toJson(a)}))}})}),h.$on("integrationPermission",function(e){I.confirm(e)}),g.odeskBaseURL||(g.baseURL=e.location.protocol+"//"+e.location.host+g.baseURL,g.odeskBaseURL=e.location.protocol+"//"+e.location.host),x.validateUrl&&"/"===x.validateUrl[0]&&(x.validateUrl=g.odeskBaseURL+x.validateUrl)}])});