define(["./common","angular","video","swfobject"],function(e,i,t,o){"use strict";t.options.flash.swf="/bower_components/video.js/dist/video-js/video-js.swf",e.directive("eoUrlPreview",["$sce","$timeout","nl2brFilter","escapeHtmlFilter","htmlToTextFilter","eoDashConfig",function(a,d,r,n,l,m){return{restrict:"E",priority:1001,scope:{attachment:"=",deleteReference:"&",waitFor:"=",canRemove:"=",adjust:"=",loaded:"=",onImageLoading:"=",onImageLoaded:"=",onImageError:"=",onImageRemoved:"=",story:"="},templateUrl:e.templatePath+"url-preview-directive.html",controller:["$scope","$element","$attrs",function(e,s,h){if(e.previewData=e.attachment.metadata.preview,e.hideimg=e.attachment.hideimg,e.link=e.attachment.metadata.url,e.link&&e.link.match(/^https?:\/\//i)){e.referenceUrl=e.link;var c=m.previewHtmlURL,g=c.indexOf("/",c.indexOf("://")+3);g&&(c=c.substr(0,g)),e.toggleImg=function(){e.hideimg=!e.hideimg},e.imageError=function(){e.description||e.video||e.flash||(e.loaded=!1),i.isDefined(h.onImageError)&&e.$eval(h.onImageError),e.image=""};var v=function(e){return m.previewImageURL+encodeURIComponent(e)},f=function(i){i["video:type"]?"application/x-shockwave-flash"===i["video:type"]?(e.flash=v(i.video),e.flashImage=v(i._image),delete i.video,delete i.image):(e.videoData={controls:!0,autoplay:!1,preload:"auto",poster:v(i._image)},i["video:width"]&&(e.videoData.width=i["video:width"]),i["video:height"]&&(e.videoData.height=i["video:height"]),e.videoSrc=a.trustAsResourceUrl(v(i.video)),delete i.image):delete i.video},u=function(e,i,t){if(e[i]||e[t]){var o=e[i]||0,a=e[t]||0;5*o>7*a?o>700&&(a*=700/o,o=700):a>500&&(o*=500/a,a=500),o&&(e[i]=o),a&&(e[t]=a)}},p=function(i){if(i._image=i.image,i.image!==i.url&&"article"!==i.type&&delete i.image,i.embed&&("photo"===i.embed.type&&(i.image=i.embed.thumbnailUrl||i.embed.url),i.width=i.embed.thumbnailWidth||i.embed.width,i.height=i.embed.thumbnailHeight||i.embed.height,i.embed.title&&(i.title=i.embed.title),delete i.embed),i.title!==i.url||i.description||i.image||i.video||delete i.title,i.description||i.image||i.video){i.video&&f(i),i.image&&(i.image=v(i.image));for(var m in i)e[m.replace(/:/g,"_")]=i[m];e.description&&(e.description=a.trustAsHtml(r(n(l(e.description))))),e.loaded=!0,e.adjust&&e.adjust(s),e.videoData&&(u(e.videoData,"width","height"),d(function(){t(s.find("video").get(0),e.videoData),e.adjust&&e.adjust(s)})),e.flash&&(u(i,"video:width","video:height"),e.showFlash=function(){o.embedSWF(v(e.flash),s.find(".url-preview-flash *:first-child").get(0),i["video:width"]||500,i["video:height"]||200,10)})}},w=null,b=e.$watch("previewData",function(t){try{w=i.fromJson(t)}catch(e){}if(w){var o=i.copy(w);p(o),e.loaded&&!e.story.hasVisibleAttachment&&(e.story.hasVisibleAttachment=!0)}});e.$on("$destroy",function(){w=null,b(),p=f=u=b=e.toggleImg=e.showFlash=e.imageError=i.noop,e.videoData&&t(s.find("video").get(0)).dispose()})}}]}}])});