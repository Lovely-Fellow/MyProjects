define(["./room","angular","lodash"],function(e,t,a){"use strict";e.controller("broadcastMessageDialogCtrl",["$scope","$rootScope","$timeout","$window","teams","eoFileGroup","eoRoomStory","$modalInstance","$q","eoAlert","eoGoogleAnalytics","eoUsers",function(e,o,n,r,i,s,c,l,d,u,h,f){e.teams=[],e.total=0,i=a.filter(i,function(e){return e.total>0}),i.length>1?(i.map(function(t){e.teams.push(t),e.total+=t.total}),e.teams.unshift({rid:"",name:"All Teams"})):i&&i.length&&(e.total=i[0].total),e.broadcastStory=c.create();var m=s.create("private");e.triggerAttach=function(){r.setTimeout(function(){t.element("#file-upload-for-broadcast").trigger("click")},0)};var g=function(){var e=t.element("#file-upload-for-broadcast")[0];e&&(e.value="")};e.canSend=function(){return e.disableSave?(e.cantSendReason="Sending..",!1):(e.cantSendReason=e.broadcastStory.cantSend(),!e.cantSendReason)},e.$on("composer:attachment:deleted",function(e,t){m.remove(t),g()}),e.attach=function(a){if(a.length){var o=[];m.attach(a).then(function(e){t.forEach(e,function(e){o.push(e)})},function(){u.inline({type:"danger",duration:5e3,template:"Sorry, we could not contact the server, please try attaching the file again."})}),e.broadcastStory.attachments=o}},e.submit=function(){e.showLoader=!0;var o;o=m.hasFiles()?m.commit():d.when({});var n;n=e.broadcastStory.teamRid?[e.broadcastStory.teamRid]:a.pluck(i,"rid");var r=t.copy(e.broadcastStory);delete r.teamRid,o.then(function(){e.disableSave=!0,r.broadcast(n).catch(function(t){e.showLoader=!1,1001===t[0].appCode?u.inline({type:"danger",duration:5e3,template:"With this request you would exceed the maximum number of rooms that you can post to in one day.Please contact support and request that your account is white-listed."}):u.inline({type:"danger",duration:5e3,template:"There was an error broadcasting your message. Please try again later."})})},function(){e.disableSave=!1,u.inline({type:"danger",duration:5e3,template:"Sorry, we could not reach the server. Please try attaching the file again."})})},h.ga("Broadcast","Pop-up opened"),e.$onRootScope("broadcast:success",function(){e.showLoader=!1,l.close(),h.ga("Broadcast","Message sent"),u.inline({type:"success",duration:5e3,template:"Your message was broadcast successfully."})}),e.$onRootScope("broadcast:error",function(t,o){e.showLoader=!1,l.close();var n="Sorry, we could not reach the server. Please try sending the message again.";if(o.failedContractorUids&&o.failedContractorUids.length){n="We failed to deliver your message to the users below. There are multiple possible reasons for that, including one or more of the users being blocked. You can try sending the message again after unblocking or removing any blocked users or getting in touch with support. <br/>";var r=[];f.several(a.takeWhile(o.failedContractorUids,10),!0).then(function(e){r=a.map(e,function(e){return e.info.fullName}),n+=r.join(", "),o.failedContractorUids.length>10&&(n+=" and "+(o.failedContractorUids.length-r.length)+" more."),u.inline({type:"danger",duration:5e3,template:n})})}else u.inline({type:"danger",duration:5e3,template:n})}),e.$on("modal.closing",function(t){e.showLoader&&t.preventDefault()})}])});