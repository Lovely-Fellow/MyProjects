define(["./common","angular"],function(e,o){"use strict";e.directive("eoUserPanel",["eoUsers","eoRooms","eoRoomDialog","eoAuth","$http","$templateCache","$compile","$rootScope","eoOrganizations","$window","$timeout","$state","eoTimezone","$q","eoUserBlockConfirmDialog","$modal","eoDashConfig","eoThriftRoomType","eoGoogleAnalytics","eoDashContext","eventLog","eoResponseHandler",function(r,n,t,s,i,u,c,a,d,l,f,m,h,g,I,p,v,k,w,R,B,U){function y(e,r){var n,t,s;n=b.outerHeight(!0),t=b.prop("offsetWidth"),s={top:r+5,left:e+5},s.top+n+5>l.innerHeight&&(s.top=s.top-n-15),s.top<0&&(s.top=0),s.left+t+5>l.innerWidth&&(s.left=l.innerWidth-t-5),s.left<0&&(s.left=0);var i=b.find(".dropdown-submenu .dropdown-menu"),u=i.height(),c=i.width();if(i.css({top:0}),T.expandLeft=!1,T.hideAddTo=!1,s.top+n+5+u>l.innerHeight){var a=l.innerHeight-(s.top+n+u)+20;i.css({top:a})}s.left+t+5+c>=l.innerWidth&&(T.expandLeft=!0),o.element(".mobile-menu").is(":visible")&&(T.hideAddTo=!0),b.css(s)}var b,S=null,T=a.$new(),$={left:"",top:""},A=function(e,o){S&&f.cancel(S),y(e,o),T.show=!0},P=function(){T.show=!1,S=f(function(){b.css($)},150)};T.hide=P,T.showKick=function(){return!(!s.organization||!s.organization.enableEditStory)&&(T.room&&T.user&&T.user.isInAddressBook&&(T.user.userId!==s.user.userId||T.user.orgId!==s.user.orgId)&&T.room.canKick(T.user)&&T.room.getUser(T.user.userId,T.user.orgId))},T.showInvite=function(){return T.room&&T.user&&(T.user.userId!==s.user.userId||T.user.orgId!==s.user.orgId)&&!T.room.getUser(T.user.userId,T.user.orgId)&&!r.blockExists(T.user.userId)&&T.room.canInvite()&&T.user.isInOrganization&&T.user.isInAddressBook},T.showDirect=function(){return!a.isWidget&&!T.isRecruiter&&T.openRoom&&T.user&&T.user.orgId&&!r.blockExists(T.user.userId)&&(T.user.userId!==s.user.userId||T.user.orgId!==s.user.orgId)&&T.user.isInOrganization&&T.user.isInAddressBook&&(!T.room||T.room.roomType!==k.ONE_ON_ONE||T.room.targetUserId!==T.user.userId||T.room.targetOrgId!==T.user.orgId)},T.showGroup=T.showPresence=function(){return T.openRoom&&T.user&&(T.user.userId!==s.user.userId||T.user.orgId!==s.user.orgId)&&s.isClient()&&T.user.isInAddressBook},T.showAddToGroup=function(){return!a.isWidget&&!T.isRecruiter&&T.user&&!T.hideAddTo&&T.user.isInOrganization&&!r.isBlockedByUser(T.user.userId)&&!r.hasBlockedUser(T.user.userId)&&(T.showGroup()||T.invitable&&T.invitable.length)};var z;T.$onRootScope("$stateChangeStart",function(){z&&(z.close(),z=null)}),T.addToGroup=function(){P(),z=t.showGroupInvite(T)},T.showBlock=function(){return!a.isWidget&&!T.isRecruiter&&T.user&&T.user.isInOrganization&&T.user.userId!==s.user.userId&&!r.hasBlockedUser(T.user.userId)&&!1!==T.canBlock},T.showUnblock=function(){return T.user&&r.hasBlockedUser(T.user.userId)};var D=o.element(l.document.body),x=i.get(e.templatePath+"user-panel-directive.html",{cache:u}).then(function(e){return b=c(e.data)(T,function(e){e.appendTo(D)}),D.bind("click",function(e){T.show&&(b.find(e.target).size()||P(),e.stopPropagation())}),T});return T.kick=function(){R.isSudo()||(P(),T.room.leave(T.user.userId,T.user.orgId))},T.blockPerson=function(){if(!R.isSudo())return P(),I.confirmUserBlock(T.user.info.fullName).result.then(function(e){if(e)return w.ga("Rooms","User Blocked","from user panel"),r.blockPerson(T.user.userId).catch(function(e){e&&e[0]&&400===e[0].code&&e[0].message.match(/contract/i)?p.messageBox("Contract Exists","Sorry, you can't block someone you have an active contract with."):U.errors(e,!0)})})},T.unblockPerson=function(){if(!R.isSudo())return P(),w.ga("Rooms","User Unblocked","from user panel"),r.unblockPerson(T.user.userId)},T.inviteToGroup=T.invite=function(e){if(R.isSudo())return void p.messageBox("Not allowed in Sudo mode","Sorry, you can't add the user to a group in Sudo mode.");if(e){var o=T.rooms.findById(e);o.inviteUser(T.user.userId,T.user.orgId).then(function(){a.isWidget?l.top.location.href=m.href("rooms.chat",{id:o.roomId}):m.go("rooms.chat",{id:o.roomId})})}else T.room.inviteUser(T.user.userId,T.user.orgId);P()},T.openDirect=function(){P();var e;R.isSudo()&&(e=!1),n.getDirectRoom(T.user.userId,T.user.orgId,e).then(function(e){T.openRoom(e)},function(e){404===e[0].code&&R.isSudo()&&p.messageBox("Not allowed in Sudo mode","Sorry, you can't create new room in Sudo mode.")})},T.openGroup=function(){if(!R.isSudo()){var e=s.user.fullName+" - "+T.user.info.fullName,o=r.several([T.user.userId]).then(function(e){return e.map(function(e){return{text:e.info.fullName,img:e.info.photoUrl,fullName:e.info.fullName,username:e.info.legacyId,data:e.userId,orgId:T.user.orgId}})});P(),t.create("private",e,o).result.then(function(e){T.openRoom(e.roomId)})}},T.logEvent=function(e){var o={event:e,location:"dash",sublocation:"userpanel",timestamp:new Date,userId:s.user.userId,data:[]};B.log(o),w.ga("PSM",e)},T.showUserProfileDivider=function(){return T.user&&T.user.profile&&(T.showDirect()||T.showKick()||T.showInvite()||T.showAddToGroup()||T.showBlock()||T.showUnblock())},{restrict:"AE",scope:!0,link:function(e,t,i){var u=e.$eval(i.openRoom);t.on("click","[eo-user-id]",function(t){var i=o.element(t.currentTarget);if(!o.element(t.target).closest(".photo-tip-container").length){var c=i.attr("eo-user-id"),a=i.attr("eo-user-room"),l=i.attr("eo-user-org-id"),m=i.attr("eo-user-external");c&&(t.preventDefault(),t.stopPropagation(),x.then(function(i){i.isRecruiter=!1,i.user=null,i.location=null,i.show=!1,i.canBlock=!1,i.invitable=[],r.several([c],!0).then(function(I){if(I.length){var p=I[0];r.fetchBlockability(p.userId,!0).then(function(e){i.canBlock=e}),r.isInAddressBook(p.userId).then(function(I){i.user=p,i.user.orgId=l,i.user.isInAddressBook=I;var k=r.isInOrganization(p.userId).then(function(e){i.user&&(i.user.isInOrganization=e)});i.rooms=e.rooms;var w=[];c!==s.user.userId&&l&&!m&&(w=i.rooms.getInvitableRooms(c,l,10)),i.invitable=n.settleDuplicates(w),o.isDefined(a)?i.room=n.getFromCache(a):i.room=null,i.room&&(i.isRecruiter=i.room.isUserRecruiter(c),i.isRecruiter&&i.logEvent("PSM user clicked"));var R=d.get(l).then(function(e){if(i.user&&(i.user.org=e,i.isRecruiter&&(e.isPsm()?i.recruiterInfoUrl=v.odeskSupportURL+"/hc/en-us/articles/115003546407":e.isTeamBuilder()&&(i.recruiterInfoUrl=v.odeskSupportURL+"/hc/en-us/articles/220987288-Team-Builder-Program-for-Clients")),!e.isClient()||i.isRecruiter))return r.getProfile(i.user.info.rid).then(function(e){i.user.profile={url:e[1]}})});o.isFunction(u)?i.openRoom=u:i.openRoom=null;var B=[];if(o.isDefined(p.info.location)){p.info.location.city&&B.push(p.info.location.city),p.info.location.country&&B.push(p.info.location.country);var U=h.getLocalTime(p.info.location.timezone);i.time=U.time,i.offset=U.offset,i.timezone=U.timezone}i.location=B.join(", "),g.race([f(o.noop,500),g.all([k,R])]).finally(function(){i.$applyAsync(function(){A(t.clientX,t.clientY)})})})}})}))}}),e.$on("$destroy",function(){t.off("click")})}}}])});