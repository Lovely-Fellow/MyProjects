define(["./room","angular","lodash","angular-clipboard"],function(e,t,o){"use strict";e.directive("eoRoomStoryAttachment",["$window","eoFileAttachment","eoAuth","$filter","$sce","eventLog","eoGoogleAnalytics","eoDashContext","eoUsers","upStoryNotification","eoVideo","eoRoomTimestampFormat",function(r,n,a,i,s,c,d,l,m,u,f,h){return{restrict:"E",replace:!0,scope:!0,templateUrl:e.templatePath+"room-story-attachment-directive.html",link:function(e){e.deleteReference=function(t){if(!l.isReadOnlyMode()){var r=o.indexOf(e.quotes,t);-1!==r&&e.quotes.splice(r,1),e.room.deleteReference(e.story,t).catch(function(){e.quotes.splice(r,0,t)})}};var p=function(t){return e.showHistory||!(t.metadata&&t.metadata.deleted)},g=function(o){o=o||[];var r=i("filter")(o,{objectType:"eo:quote"}),a=i("filter")(o,{objectType:"eo:file"}),c=i("filter")(o,{objectType:"eo:url"}),d=i("filter")(o,{objectType:"giphy:image"});e.self=e.story.isOwner(),e.canEdit=e.story.canEdit()&&e.room&&!e.room.isReadOnly,e.urls=y(c),e.giphyImages=y(d),e.urls.length>2&&(e.urls=[]),I(),e.generics=i("filter")(o,function(e){return!!p(e)&&e.templateParsed}),e.trustHtml=function(e){return s.trustAsHtml(e)},e.files=[],t.forEach(a,function(t){var o=n.fromJSON(t);e.files.push(o)}),r.length&&(e.quotes=r,t.forEach(e.quotes,function(e){!e.user&&e.metadata.userId&&m.several([e.metadata.userId],!0).then(function(t){t.length&&(e.user=t[0]),!e.user.orgId&&e.metadata.orgId&&(e.user.orgId=e.metadata.orgId)}),e.trustedMessage=s.trustAsHtml(e.messageHtml)})),e.quoteTimestampFormat=h},y=function(e){return i("filter")(e,function(e){return!!(p(e)&&e.metadata&&e.metadata.preview)})},I=function(){e.hideUrlPreview?e.urlAndGiphy=e.giphyImages:e.urlAndGiphy=o.merge(e.urls,e.giphyImages)},w=e.$watch("story.objectReferences",g),v=e.$watch("hideUrlPreview",I);if(l.hasDashOboAccess())var b=e.$watch("showHistory",function(t,o){t!==o&&g(e.story.objectReferences)});e.$onRootScope("story:objectReferenceUpdate",function(t,r){-1!==o.findIndex(e.story.objectReferences,{objectReferenceId:r.objectReferenceId})&&g(e.story.objectReferences)}),e.$on("$destroy",function(){w(),v(),t.isDefined(b)&&b()}),e.openUrl=function(o,n){if(!o)return!0;if(t.isString(o)&&(o={url:o}),!o.url)return!0;if(o.url.indexOf("upvideo")>-1){u.stopNotificationSound();var i=o.url.indexOf("video=true")>-1;f.open(e.room.roomId,i),n.preventDefault();var s={event:"call_initiated",location:"dash",sublocation:"message_link",timestamp:new Date,userId:a.user.userId,data:[{type:"dash_call",env:l.getName(),roomId:e.room?e.room.roomId:"",roomType:e.room?e.room.roomType:""}]};c.log(s)}else if(o.attr&&o.attr.window){if(l.isTeamApp()){var d=r.open("","",'"width='+o.attr.window.width+", height="+o.attr.window.height+'"');d.location=o.url}else r.open(o.url,"",'"width='+o.attr.window.width+", height="+o.attr.window.height+'"');n.preventDefault()}},e.logOpenFile=function(){var t={event:"click",location:"room story list",sublocation:"story attachment file name",timestamp:new Date,userId:a.user.userId,data:[{org_id:a.user.orgId,room_id:e.room?e.room.roomId:"",action:"click on file name to open",event_label:"click_on_file_name_to_open_in_story"}]};e.room&&(t.data.opening_uid=e.room.context&&e.room.context.jobUid,t.data.contract_id=e.room.contractId,t.data.contractor_uid=e.room.context&&e.room.context.freelancerId),c.log(t),d.ga("Files","open file","from story list",{roomId:e.room.roomId})},e.goToStory=function(t,o){o.metadata&&o.metadata.storyId&&o.metadata.roomId&&e.open(o.metadata.roomId,o.metadata.storyId)}}}}])});