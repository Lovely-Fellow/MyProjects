define(["angular","./rooms-chat-controller","./rooms-chat-autoheight-directive","./rooms-side-panel-directive","ngSanitize","ui.router","xeditable"],function(e,o,r,t){"use strict";var i=e.module("eoRoomsChat",["ui.router","xeditable","ngSanitize","eoCommon"]);return i.config(["$stateProvider",function(r){r.state("rooms.widget",{url:"/{id:room[^/]+}/widget",controller:["$state","$stateParams",function(e,o){e.go("rooms.chat",{id:o.id},{location:"replace"})}]}),r.state("rooms.chat",{url:"/{id:room[^/]+}",templateUrl:"@templates/rooms/rooms-chat/rooms-chat.html",controller:o,params:{force:null},resolve:{room:["$stateParams","eoRooms","$window","$timeout","$location","$state","$interpolate","$log","eoDebug","eoAuth","eoOrganizations","eoDashContext","$q","$rootScope","eoContextSwitcher","eoRetry","eoRetryDialog","eoRetryWorkflow","upDashMetrics",function(o,r,t,i,n,s,a,c,u,d,m,g,l,h,f,I,p,R,v){var y=v.getFirstRunSequence();return y.time("RoomResolveStart"),R.create(function(){return r.getDetailed(o.id,!0)},{scale:5e3,maxWait:6e4,maxAttempts:10,preflightCheck:function(){return c.info("Running preflight check to see if Rooms API is responding."),r.isUp()},shortCircuitCheck:function(o){return!(e.isArray(o)&&500===o[0].code)}}).try().then(function(e){u.debug("room:events")("Change to room",o.id,e.roomName);var n=e.getUser(d.user.userId,d.user.orgId),s=o.id+"#"+d.user.userId+"#"+d.user.orgId;if(n=n||e.getValidUser(d.user.userId,d.user.organizations),!g.isSudo()&&(!n||n&&n.orgId!==d.user.orgId)){if(!n&&e.isPublic&&e.orgId===d.user.orgId)return i(function(){return e.inviteUser(d.user.userId,d.user.orgId).then(function(){e.isHidden&&e.setHidden(!1);try{t.localStorage.setItem("lastRoom",s)}catch(e){console.error(e)}return e.addUser(d.user.userId,e.orgId),e},function(o){return o&&o.message&&o.message.match("Subscription already exists")?r.get(e.roomId,!1,!0,!0,!0).then(function(e){return e}):l.reject(o)})});if(n&&!d.hasCompany(n.orgId)){var c=a('The room "{{roomName}}" belongs to a different company.')({roomName:e.roomName}),m=s===t.localStorage.getItem("lastRoom");return f.noAccessToRoomDialog(o.id,c,m)}if(n){console.info("switching orgs without 400 error");var h=n?d.getOrganization(n.orgId):d.getOrganization(e.orgId);return f.switchCompanyDialogHandler(h,e,o.id,"rooms.chat")}}e.isHidden&&e.setHidden(!1);try{t.localStorage.setItem("lastRoom",o.id+"#"+d.user.userId+"#"+d.user.orgId)}catch(e){console.error(e)}return y.time("RoomResolveStop"),e},function(r){if(r[0]&&404===r[0].code)return{roomId:o.id,error:r};if(r[0]&&(400===r[0].code||403===r[0].code)){if(!r[0].message||"SWITCH_ORG_REQUIRED"!==r[0].codeExtended&&-1===r[0].message.indexOf("Switch Org Required"))return f.noAccessToRoomDialog(o.id,"",!1).catch(function(){var o=e.merge({},r[0],{hideMessage:!0});return l.reject([o])});var t=r[0].message.replace(/\\\\/g,"\\").split("\\"),i={roomName:t[1]},n=t[3].replace(/\D/g,"");return d.hasCompany(n)?m.get(n).then(function(e){return f.switchCompanyDialogHandler(e,i,o.id,"rooms.chat")}):f.noAccessToRoomDialog(o.id)}return l.reject(r)})}]}}),r.state("rooms.chat.story",{url:"/{storyId:story[^/]+}"}),r.state("rooms.chat.preview",{url:"/preview",controller:["$scope","$state","room","eoAuth","tlStory",function(e,o,r,t,i){r.getUser(t.user.userId,t.user.orgId)&&o.go("rooms.chat",{id:r.roomId});var n=i.$on("newStory",function(e){"eo:join"!==e.actionType&&"eo:invite"!==e.actionType||o.go("rooms.chat",{id:r.roomId})});e.$on("$destroy",function(){n()})}]})}]).directive("eoRoomsChatAutoheight",r).directive("eoRoomsSidePanel",t).run(["editableOptions",function(e){e.theme="bs3"}]),i});