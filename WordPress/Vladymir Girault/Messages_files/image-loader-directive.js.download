define(["./common","angular"],function(t){"use strict";t.filter("trusted",["$sce",function(t){return function(a){return t.trustAsResourceUrl(a)}}]),t.directive("eoImageLoader",["eoImageRuler","eoImageSize","$window",function(t,a,e){return{restrict:"EA",template:'<a class="image-loader"   ng-class="[imageLoader.loadingState, imageLoader.orientation, imageLoader.measured]"   ng-style="{width: imageLoader.boundWidth, height: imageLoader.boundHeight}">  <img ng-src="{{imageLoader.src}}" /></a>',replace:!0,controllerAs:"imageLoader",link:function(t){t.imageLoader.init()},controller:["$scope","$element","$attrs","$timeout","$log",function(n,i,r,o,d){var h=this,u=i.find("img");n.$imageLoader=this,h.loadingState="loading";var g=!1,l=function(){var t=i.parent()[0];if(t&&h.maxWidth&&h.maxHeight){var e=t.getBoundingClientRect(),n="auto"===h.naturalWidth?Math.min(e.width||h.maxWidth,h.maxWidth):h.naturalWidth,r="auto"===h.naturalHeight?Math.min(e.height||h.maxHeight,h.maxHeight):h.naturalHeight,o=Math.min(e.width||n,h.maxWidth||n),d=Math.min(r,h.maxHeight||r),u=a.calc({image:{width:h.naturalWidth,height:h.naturalHeight},container:{width:o,height:d},size:"contain"});h.boundWidth=u.width,h.boundHeight=u.height}},s=!1;h.fitParentDimensions=function(){s||(e.requestAnimationFrame(function(){s=!1,l()}),s=!0)},e.addEventListener("resize",h.fitParentDimensions);var m,c=function(){if(!m){if(!r.hasOwnProperty("setInitialBounds")||"true"===r.setInitialBounds){h.naturalWidth=h.naturalWidth||"auto";var a=.5625*h.maxWidth;isNaN(a)?h.boundHeight=h.maxHeight||"auto":h.boundHeight=a}h.orientation="landscape",l(),m=t.measureImage(h.src,h.maxWidth,h.maxHeight).then(function(t){return h.naturalWidth=t.naturalWidth,h.naturalHeight=t.naturalHeight,h.boundWidth=t.boundWidth,h.boundHeight=t.boundHeight,h.orientation=h.naturalWidth>=h.naturalHeight?"landscape":"portrait",h.measured="measured",l(),r.hasOwnProperty("onImageMeasure")&&n.$eval(r.onImageMeasure),m=null,t},function(t){m=null;try{d.warn("rejected: "+t)}catch(t){}})}return m},f=function(){var t={};r.hasOwnProperty("naturalWidth")&&(h.naturalWidth=n.$eval(r.naturalWidth),t.width=h.naturalWidth),r.hasOwnProperty("naturalHeight")&&(h.naturalHeight=n.$eval(r.naturalHeight),t.height=h.naturalHeight),r.hasOwnProperty("maxWidth")&&(h.maxWidth=n.$eval(r.maxWidth),t.maxWidth=h.maxWidth),r.hasOwnProperty("maxHeight")&&(h.maxHeight=n.$eval(r.maxHeight),t.maxHeight=h.maxHeight),i.css(t)},H=function(){h.naturalWidth&&h.naturalHeight?"auto"===h.naturalWidth||"auto"===h.naturalHeight?c():h.naturalWidth>h.maxWidth||h.naturalHeight>h.maxHeight?c():(h.boundWidth=h.naturalWidth,h.boundHeight=h.naturalHeight,h.orientation=h.naturalWidth>=h.naturalHeight?"landscape":"portrait",h.measured="measured"):c(),l()};h.init=function(){g||(f(),r.$observe("src",function(t){h.src=t,h.src&&(r.hasOwnProperty("onImageLoading")&&n.$eval(r.onImageLoading),H())}),i.on("transitionend",function(){r.hasOwnProperty("onTransitionEnd")&&n.$evalAsync(function(){n.$eval(r.onTransitionEnd)})}),u.on("load",function(){h.loadingState="loaded",n.$digest(),r.hasOwnProperty("onImageLoaded")&&n.$evalAsync(function(){n.$eval(r.onImageLoaded)})}),u[0].complete&&(h.loadingState="loaded",r.hasOwnProperty("onImageLoaded")&&n.$eval(r.onImageLoaded)),u.on("error",function(){var t=u.data("recoveryAttempts")||0;t<2?(t+=1,u.data("recoveryAttempts",t),o(function(){u.prop("src",u.prop("src"))},2e3*t),n.$evalAsync(function(){h.loadingState="error",r.hasOwnProperty("onImageError")&&n.$eval(r.onImageError)})):u.off("error")}),n.$on("$destroy",function(){u.off("error"),u.off("load"),e.removeEventListener("resize",h.fitParentDimensions)}),r.hasOwnProperty("onImageRemoved")&&i.on("$destroy",function(){n.$eval(r.onImageRemoved)}),g=!0)}}]}}])});