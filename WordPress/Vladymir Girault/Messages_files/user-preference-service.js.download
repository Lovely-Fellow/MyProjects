define(["./common","angular"],function(e,t){"use strict";e.provider("eoUserPreference",function(){var e={};this.config=function(r){if(!t.isObject(r))return e;e.defaults=r.defaults||e.defaults,e.storageNamespace=r.storageNamespace||e.storageNamespace},e.defaults={},e.storageNamespace="userPreferences",this.$get=["$window","$q","$log","$rootScope","tlUser","eoUsers","eoAuth",function(r,n,s,o,a,i,c){var u;a.$on("PREFERENCES_UPDATE",function(e){e={componentPreferences:e},i.preferencesUpdateReceived(c.user.userId,e)});var f=function(){var o;if(u)o=n.when(u);else{var a=n.defer();o=a.promise;var i=r.localStorage.getItem(e.storageNamespace);if(i)try{u=JSON.parse(i)}catch(e){s.warn("Failed to deserialize user preferences. Using default preference settings."),u={}}u=t.isObject(u)?u:{},u=t.extend({},e.defaults,u),a.resolve(u)}return o};return new function(){this.save=function(){return f().then(function(t){try{r.localStorage.setItem(e.storageNamespace,JSON.stringify(t))}catch(e){console.error(e)}return t})},this.reset=function(){return u=t.extend({},e.defaults),this.save()},this.getItem=function(e){return f().then(function(t){return t[e]})},this.setItem=function(e,t){return e?f().then(function(r){return r[e]=t,r[e]}):n.reject('The item "key" was not provided')},this.getAll=function(){return f()}}}]})});