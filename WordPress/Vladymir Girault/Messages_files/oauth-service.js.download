define(["./common","angular","jquery","./team-app-service","./context-service","config-service","./applet-service"],function(e,o,t){"use strict";e.factory("eoOauth",["$injector","$window","$cookies","eoDashConfig","eoDashContext","$exceptionHandler","$rootScope","$q","eoTeamApp","eoAuthHelper","AUTH_CONFIG","eoApplet",function(e,r,n,a,s,c,i,u,f,p,h,k){var d=a.oauth2TokenCookie,l={domain:a.oauthCookieDomain,path:"/",secure:a.secureCookie},g=function(e){r.localStorage.setItem("upwork_oauth",o.toJson(e)),n.put(d,e.access_token,l),i.$emit("auth:tokenChanged",e)};return{notifyTokenChanged:function(){i.$emit("auth:tokenChanged",{access_token:this.getToken()})},clearToken:function(){r.localStorage.removeItem("upwork_oauth"),n.remove(d)},hasToken:function(){return this.getToken()},getToken:function(){var e;if(s.isTeamApp())e=f.getAccessToken(),n.put(d,e,l);else if(s.isODC())e=k.getVar("dashAccessTokenCookieName")?n.get(k.getVar("dashAccessTokenCookieName")):p.getCCSTToken();else{var t=r.localStorage.getItem("upwork_oauth");t&&(e=o.fromJson(t),e=e.access_token,n.put(d,e,l))}return e},refreshToken:function(){var n=this,c=e.get("$http");if(s.isODC())return c.get(h.accountLoginEndpoint).then(function(){return c.post(a.prefixURL+"/refresh-token").then(function(){n.notifyTokenChanged()})}).catch(function(){r.location.reload()});if(s.isTeamApp()){var i=u.defer();return f.refreshAccessToken(function(){i.resolve({}),n.notifyTokenChanged()},function(){i.reject({})}),i.promise}var p=r.localStorage.getItem("upwork_oauth");if(!p)return u.reject({});p=o.fromJson(p);var k=a.oauthUrl,d={grant_type:"refresh_token",refresh_token:p.refresh_token,client_id:a.oauthClientId},l=u.defer();return c.post(k,t.param(d),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e,t){o.isDefined(e.error)?l.reject({data:e,status:401}):(g(e),l.resolve({data:e,status:t}))}).error(function(e,o){l.reject({data:e,status:o})}),l.promise},createToken:function(r,n){var s,i,f=u.defer(),p=0,h=e.get("$http");try{var k=function(){var e=a.oauthUrl,c={grant_type:"password",username:r,password:n,client_id:a.oauthClientId},u={code:"unknown",message:"Unknown error. Please try again"};i=h.post(e,t.param(c),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e,t){o.isDefined(e.error)?f.reject({code:e.error,message:e.error_description}):(s={access_token:e.access_token,refresh_token:e.refresh_token},g(s),f.resolve({data:s,status:t}))}).error(function(e,o){if(e&&e.error&&500===o)f.reject(u);else{var t=u;e&&(t={code:e.error,message:e.error_description}),p++,p>1?f.reject(t):k()}})};k()}catch(e){c(e)}return f.promise},revokeToken:function(){var r,n=this,s=u.defer(),i=0,f=e.get("$http");try{var p=function(){var e=a.oauthUrl+"/revoke",c={token:n.hasToken(),token_type_hint:"access_token"},u={code:"unknown",message:"Unknown error. Please try again"};r=f.post(e,t.param(c),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e,t){o.isDefined(e.error)?s.reject({code:e.error,message:e.error_description}):s.resolve({data:e,status:t})}).error(function(){i++,i>1?s.reject(u):p()})};p()}catch(e){c(e)}return s.promise}}}])});