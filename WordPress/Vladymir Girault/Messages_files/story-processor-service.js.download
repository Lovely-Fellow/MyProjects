define(["./room","angular","lodash"],function(e,t,o){"use strict";var a="does not currently have access to Upwork and will not receive messages until access is restored";e.factory("eoStoryProcessor",["eoAuth","eoUsers","eoDashConfig","emojione","eoTimezone","eoDashContext","eoExternalLinkChecker","eoBasicFormatFilter","upMarkdownItFormatFilter","$sce","$filter","eoThriftRenderTemplateColorType","eoDisintermediation",function(e,r,s,n,i,d,m,c,l,u,f,p,g){function y(e,t){if(t){for(var o,a,r=function(e){return e.replace(/\u0001/g,":")},s=0;s<t.length;++s)a=t[s].replace(/\\:/g,"").split(":").map(r),o=a.shift(),O[o]&&(a.unshift(e),e=O[o].apply(O[o],a));return e}}function h(e,t){t=t||e,e.metadata=e.metadata||t.metadata||{},e.objectReferences=e.objectReferences||t.objectReferences||[]}function b(n,i){try{!n.user&&n.userId&&(n.user=r.getFromCache(n.userId),n.user&&!n.user.orgId&&(n.user.orgId=n.orgId)),"eo:post"!==n.actionType&&n.actionVerb&&n.objectReferences&&n.objectReferences[0]&&"hr:send"===n.actionType&&"hr:offer"===n.objectReferences[0].objectType&&(n.objectReferences[0].noun="an offer"),n.self=e.user.userId===n.userId&&e.user.orgId===n.orgId;var m=w(n.objectReferences,n.objectTemplates,n);if(t.isUndefined(n.messageHtml)&&(n.storyTemplate&&(n.message=R(n.storyTemplate,m.story.metadata[0],m)),n.messageHtml=v(n.message,n)),n.userId&&n.integrationData&&!n.integrationData.integrationId&&!n.integrationData.integrationName&&delete n.integrationData,n.integrationData&&(n.user={userId:n.integrationData.integrationId,orgId:n.orgId,info:{userId:n.integrationData.integrationId,fullName:n.integrationData.integrationName,photoUrl:n.integrationData.integrationIconUrl}},n.user.info.photoUrl&&"/"===n.user.info.photoUrl.slice(0,1)&&(n.user.info.photoUrl=s.assets.url+n.user.info.photoUrl),m.eoUser={value:"<%"+n.user.userId+":"+n.user.orgId+":"+n.user.info.photoUrl.replace(":","%3A")+"|"+n.user.info.fullName+">",metadata:[{}]}),n.isSystemStory&&!n.system){var c=n.objectReferences&&n.objectReferences.length?n.objectReferences[0]:null;if(n.system={},n.system.eoUserId=n.userId,n.system.eoUserOrgId=n.orgId,n.system.eoVerb=n.actionVerb,"hp-interview:send"===n.actionType)n.system.eoVerb=n.message,n.system.eoNoun="",n.system.eoObjectRoom="";else if("eo:kick"===n.actionType&&c)n.system.eoVerb="left",n.system.eoUserId=c.metadata.userId,n.system.eoUserOrgId=c.metadata.orgId||c.user&&c.user.orgId,n.system.eoNoun="the room";else if("eo:leave"===n.actionType)n.system.eoNoun="the room",c&&"eo:room"===c.objectType&&c.metadata&&"ACCOUNT_CLOSURE"===c.metadata.reason&&(n.system.eoNoun="",n.system.eoVerb=a);else if("upwork:lost_access"===n.actionType)n.system.eoNoun="this room",c&&"eo:room"===c.objectType&&c.metadata&&"ACCOUNT_CLOSURE"===c.metadata.reason&&(n.system.eoNoun="",n.system.eoVerb=a);else if("eo:rename"===n.actionType)n.system.eoVerb="changed",n.system.eoNoun="the room name",c&&c.metadata.oldRoomName&&(n.system.eoNoun+=' from "'+c.metadata.oldRoomName+'"'),c&&c.metadata.newRoomName&&(n.system.eoNoun+=' to "'+c.metadata.newRoomName+'"');else if("eo:invite"===n.actionType){var l=o.find(n.objectReferences,function(e){return"eo:user"===e.objectType});l&&l.metadata.userId&&(n.system.eoVerb="added",n.system.eoNoun="to the room",n.system.eoObjectUserId=l.metadata&&l.metadata.userId,n.system.eoObjectUserOrgId=l.metadata&&l.metadata.orgId)}else"eo:join"===n.actionType?n.system.eoNoun="the room":"eo:change"===n.actionType?(n.system.eoNoun=c?c.noun:"",c.metadata.newTopic&&(n.system.eoNoun+=" to: "+c.metadata.newTopic)):"eo:archive"===n.actionType?(n.system.eoNoun="the room",c&&"eo:room"===c.objectType&&c.metadata&&"JOB_CANCELED"===c.metadata.reason&&(n.system.eoUser="",n.system.eoUserId="",n.system.eoNoun="",n.system.eoVerb="This room has been archived because the job has been cancelled by the client")):"eo:link"===n.actionType?c&&"eo:room"===c.objectType&&c.metadata&&(n.system.eoObjectRoomId=c.metadata.roomId,n.system.eoNoun=""):"eo:contract"===n.actionType?c&&"eo:room"===c.objectType&&c.metadata&&(n.system.eoUser="",n.system.eoUserId="",n.system.eoVerb="Contract created for",n.system.eoObjectRoomId=c.metadata.roomId,n.system.eoNoun=""):"eo:block"===n.actionType?c&&(n.system.eoNoun="",n.system.eoObjectUserId=c.metadata.blockeeId,n.system.eoObjectUserOrgId=c.metadata.blockeeOrgId):"eo:unblock"===n.actionType?c&&(n.system.eoNoun="",n.system.eoObjectUserId=c.metadata.blockeeId,n.system.eoObjectUserOrgId=c.metadata.blockeeOrgId):n.system.eoNoun=c?c.noun:""}d.hasDashOboAccess()&&I(n),n.titleTemplate&&(n.titleTemplate=R(n.titleTemplate,m.story.metadata[0],m),n.headerHtml=v(n.titleTemplate,n,!1,!0))}catch(e){console.error("Story Processing Error. storyId: %s. Caught Error:",n.storyId,e)}return n.blocked=n.blockedTimestamp&&n.blockedTimestamp>0,n.notes&&n.notes.abuseType&&(n.markedAbusive="NONE"!==n.notes.abuseType&&!("THIRDPARTY"===n.notes.abuseType&&!n.blocked)),h(n,i),n}function T(e){return e.replace(k,"$1<@0:0|Room>")}function I(e){if(e.fieldChanges){var a=t.copy(e.fieldChanges),r=o.find(a,{fieldChanged:"deletedTimestamp"});r&&a.push({fieldChanged:"message",timestamp:r.timestamp,oldFieldValue:e.message,deleted:!0}),e.historyList=a.filter(function(e){return"message"===e.fieldChanged&&t.isString(e.oldFieldValue)}).map(function(e){var o={timestamp:e.timestamp,message:e.oldFieldValue,deleted:!!e.deleted};return t.isString(o.message)&&(o.message=u.trustAsHtml(v(o.message,o))),o}).filter(function(o,a,r){if(t.isUndefined(o.message))return!1;if(o.deleted)return!0;var s=0===a?e.messageHtml:r[a-1].message;return t.isUndefined(s)||o.message.toString()!==s.toString()}).reverse(),e.deleted&&(e.historyList.length&&(e.historyList[0].deleted=!0),t.forEach(e.objectReferences,function(t){t.metadata&&!t.metadata.deleted&&(t.metadata.deleted=!0,t.metadata.updated=e.updated)}))}}function j(e){return e}function v(e,o,a,r){var n=a?j:V;if(e&&(e=e.replace(/\n+$/,"\n").replace(/^\n+/,"\n")),o&&!a&&(t.isUndefined(o.mentioned)&&(o.mentioned=!1),t.isUndefined(o.directMentioned)&&(o.directMentioned=!1),o.objectReferences&&o.objectReferences.length>0&&"eo:video"===o.objectReferences[0].objectType&&"eo:initiate"!==o.actionType)){var i=s.baseURL+"/upvideo/"+o.roomId,m="Video/Voice Call has been initiated. <"+i+"|Click here to join>";o.objectReferences[0].metadata&&o.objectReferences[0].metadata.videoEnabled&&"false"===o.objectReferences[0].metadata.videoEnabled&&(i+="?video=0",m="Voice Call has been initiated. <"+i+"|Click here to join>"),e=m}var u={emoji:!0,highlighter:n};return o&&(u.roomId=o.roomId,a||(u.mention=function(e){o.mentioned=!0,o.directMentioned=e})),r&&(u.single=!0),o&&(u.escaped=!0,u.asPlainText=!o.verified),o&&!d.markdownEnabled(o.updated||o.created)?c(e||"",u):l(e||"",u)}function U(e,t){e.metadata.userId?(e.user=r.getFromCache(e.metadata.userId),e.metadata.orgId&&e.user&&(e.user.orgId=e.metadata.orgId)):e.metadata.user&&(e.user={info:{fullName:e.metadata.user,photoUrl:e.metadata.photo}}),e.messageHtml=v(e.metadata.message,t,!0)}function R(e,a,r){var s,n,i,d,m=!0;!t.isString(e)&&e.toString&&(e=e.toString());var c=e.replace(/%!\$\[([^\]]+)\]/g,function(e,c){if(!m)return"";var l=c.replace(/\\\|/g,"\0").split("|").map(function(e){return e.replace(/\u0000/g,"|")});return c=l.shift(),t.isDefined(a[c])?y(a[c],l):r[c]?y(r[c].value,l):(s=c.indexOf("."))>-1&&(n=c.slice(0,s),c=c.slice(s+1),i=n.match(/^(.+)\$(\d+)$/),i?(n=i[1],d=1*i[2]):d=0,r[n]&&r[n].metadata&&r[n].metadata[d]&&t.isDefined(r[n].metadata[d][c]))?y(r[n].metadata[d][c],l):o.some(l,function(e){return e.match(/^default:/)})?y("",l):void(m=!1)});return m?c:""}function N(e,o,a){var r,s,n,i,d,c=t.copy(e),l=function(e){return v(R(e,o,a),null,!1,!0)};c.title&&(c.title=l(c.title)),c.url&&(c.url=R(c.url,o,a)),(!c.width||c.width<1)&&(c.width=2),c.width>4&&(c.width=4);var u=["none","info","ok","warn","error"];if(c.color&&(u.map(function(e){c.color===p[e.toUpperCase()]&&(c.color=e)}),c.color=R(c.color,o,a).toLowerCase()),(!c.color||u.indexOf(c.color)<0)&&(c.color="none"),e.fields){for(c.fields=[],i=[],d=0,r=0;r<e.fields.length;++r)s=t.copy(e.fields[r]),s.value&&(s.value=l(s.value),!s.value.trim().length)||(s.title&&(s.title=l(s.title)),(!s.width||s.width<1||s.width>c.width)&&(s.width=c.width),s.cellWidth=100*s.width/c.width,d+s.width>c.width&&(c.fields.push(i),i=[],d=0),i.push(s),d+=s.width);i.length&&c.fields.push(i)}if(c.actions){var f=[];for(r=0;r<c.actions.length;++r)n=c.actions[r],n.index=r,n.name&&(n.name=l(n.name).trim()),n.url&&(n.url=R(n.url,o,a).trim()),n.name&&n.url&&(n.attr=m.process(n.url),f.push(n));c.actions=f}return c.title||c.fields&&c.fields.length||c.actions&&c.actions.length?c:null}function w(e,o,a){var n=[];if(a&&(n={story:{value:a.message,metadata:[a.metadata||{}]},eoUser:{value:"<%"+a.userId+":"+a.orgId+">",metadata:[{}]}},n[a.actionType]=n.eoVerb={value:a.actionVerb,metadata:[{}]}),n.__upworkUrl={value:s.odeskBaseURL,metadata:[{}]},n.__videoUrl={value:s.baseURL+"/upvideo/",metadata:[{}]},e){var i,d,m={};if(o)for(i=0;i<o.length;++i){var c=o[i];c.objectType&&(m[c.objectType]=c)}for(i=0;i<e.length;++i)d=e[i],"eo:quote"===d.objectType?U(d,a):"eo:user"===d.objectType&&(d.user=r.getFromCache(d.metadata.userId||d.metadata.blockeeId),t.isUndefined(d.user)&&(d.user={})),n[d.objectType]||(n[d.objectType]={value:d.noun,metadata:[]}),d.context=d.metadata||{},t.isUndefined(n.eoNoun)&&(n.eoNoun={value:d.noun,metadata:[{}]}),n[d.objectType].metadata.push(d.context);for(i=0;i<e.length;++i)d=e[i],m[d.objectType]&&(d.templateParsed=N(m[d.objectType],d.context,n),d.image=R(m[d.objectType].image||"",d.context,n),d.name=R(m[d.objectType].title||"",d.context,n))}return n}function C(e){var t=e.message;if("eo:broadcast"===e.actionType&&(t=o.find(e.objectReferences,function(e){return"eo:quote"===e.objectType}).metadata.message),!t)return"";for(var a,r=/<([^|>]+)(?:\|([^>]+))?>/g,s="",i=0;null!==(a=r.exec(t));)s+=t.slice(i,a.index),i=r.lastIndex,s+=a[2]||a[1];return s+=t.slice(i),n.toShort(s.trim()).replace(/</g,"&lt;").replace(/>/g,"&gt;")}var k=/(^|\s|[!"#$%&(+,.:;<=>?[^{~*_`-])@room(?=[!"#$%),.:;=?\]^}<*_`-]|\s|$)/gi,O={date:function(t,o){return t?i.getLocalTime(e.user.location.timezone,1*t,o).time:t},default:function(e,t){return e||t||""},lower:function(e){return e.toLowerCase()},upper:function(e){return e.toUpperCase()},trim:function(e){return e.trim()},slice:function(e,t,o){return e.slice(t,o)},replace:function(e,t,o){return e.replace(new RegExp(t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),"g"),o)},number:function(e,t){return e?f("number")(e,t||0):e}},V=g.highlight.bind(g);return{processStoryData:b,parseMessage:v,processQuote:U,parseTemplateString:R,processTemplate:N,processObjectReferences:w,getStoryPlainText:C,replaceRoomMentions:T}}])});