define(["./common","angular","lodash","config-service","./location-service","./context-service","./users-service","./organization-collection"],function(e,t,n){"use strict";var r=function(e,n){var i=this,s=0;if(t.isArray(e))t.forEach(e,function(e){s|=r.call(i,e,n)});else{if(!t.isString(e))throw new Error('The "userRoleNames" parameter must be a User-Role name or an Array of User-Role names.');s|=n[e]}return s},i=function(e,n){var r=this,s=0;if(t.isArray(e))t.forEach(e,function(e){s|=i.call(r,e,n)});else{if(!t.isString(e))throw new Error('The "resourceGroupNames" parameter must be a Resource-Group name or an Array of Resource-Group names.');s|=n[e]}return s},s=function(e,s,o,a,u,c,l,g,h,d,f,b,O,m,p,I,v,E,A,y,R,U){var D=this,S=this.user={userId:"0",orgId:"0",name:"Guest",roles:["guest"]};this.authStatus=null,c.on("CONNECTION_CLOSED",function(e){"LOGOUT"===e.reason||"REMOVED_FROM_ORG"===e.reason||"INVALID_ORG"===e.reason?D.isAuthenticated()&&D.logout():"CONN_CLOSED_REASON_THROTTLING"===e.reason&&(D.connectionClosedReason=e.reason,U.go("error",{data:t.toJson({throttling:!0,showReload:!1})}))}),e.$on("auth:expired",function(e,t){D.clear(),D.setAuthStatus(2,t),c.disconnect()}),e.$on("eoUsers:updatedUser",function(n,r){r.userId===D.user.userId&&(t.extend(D.user,r.info),e.$emit("auth:update"))}),this.getUserAccessPrivileges=function(e){return r.call(this,e,f)},this.getResourceAccessGrants=function(e){return i.call(this,e,b)},this.setAuthStatus=function(t,n){this.authStatus!==t&&(this.authStatus=t,e.user=n&&n.user,n?e.$emit("auth:change",n):e.$emit("auth:change"))},this.login=function(e,t,n){var r=this;if(n)try{o.localStorage.setItem("username",e)}catch(e){console.error(e)}else o.localStorage.removeItem("username");return I.createToken(e,t).then(function(){return r.fetchAuthData()},function(e){return r.logAuthError("createToken",[e]),s.reject([e])})},this.logout=function(){var e=this;if(!h.isWidget())return h.isODC()?(o.document.getElementById("nav-logout").submit(),s.when({})):l.logout().finally(function(){e.clear(),e.setAuthStatus(2),c.disconnect()})},this.isDropboxUploadEnabled=function(){return!(this.organization&&d.disableDropboxUploadOrgs&&n.contains(String(d.disableDropboxUploadOrgs).split(","),this.organization.uid)||h.isTeamApp())},this.isPublicRoomsEnabledForOrg=function(e){return t.isUndefined(e.enablePublicRooms)?"*"===d.enablePublicRoomOrgs||n.contains(String(d.enablePublicRoomOrgs).split(","),e.uid):e.enablePublicRooms},this.isRoomMutingEnabledForOrg=function(e){var r=!1,i=d.feature&&d.feature.roomMuting;return t.isUndefined(e.enableRoomMuting)?i&&(r=i.enabled&&("*"===i.allowedOrgs||n.contains(String(i.allowedOrgs).split(","),e.uid))):r=!!e.enableRoomMuting,r},this.isPluginsEnabledForOrg=function(e){return t.isDefined(e.enablePlugins)?e.enablePlugins:"*"===d.enablePluginsOrgs||(","+d.enablePluginsOrgs+",").indexOf(","+e.uid+",")>-1},this.isInternalVideoEnabledForOrg=function(e){return t.isDefined(e.enableInternalVideo)?e.enableInternalVideo:"*"===d.enableInternalVideoOrgs||(","+d.enableInternalVideoOrgs+",").indexOf(","+e.uid+",")>-1},this.isEditStoryEnabledForOrg=function(e){return t.isDefined(e.enableEditStory)?e.enableEditStory:"*"===d.enableEditStoryOrgs||n.contains(String(d.enableEditStoryOrgs).split(","),e.uid)},this.isGiphyEnabledForOrg=function(e){var r=!1,i=d.feature&&d.feature.giphy;return t.isDefined(e.enableGiphy)?r=!!e.enableGiphy:i&&(r=i.enabled&&("*"===i.allowedOrgs||n.contains(String(i.allowedOrgs).split(","),e.uid))),r},this.isDebugEnabledForOrg=function(e){return t.isDefined(e.enableDebug)?e.enableDebug:"*"===d.enableDebugOrgs||n.contains(String(d.enableDebugOrgs).split(","),e.uid)},this.setUser=function(e){var n=this;e.userId||(e.userId=e.uid),this.user=e,this.user.organizations=g.mixInto(e.organizations.map(function(e){return A.fromData(e)}));var r=this.user.organizations.getSoleProprietor();r&&!r.photoUrl&&(r.photoUrl=e.photoUrl),this.user.orgId=e.orgId,this.user.orgId||(h.getOrgId()?this.user.orgId=h.getOrgId():this.user.orgId=e.organizations[0].uid),this.organization=this.getOrganization(this.user.orgId),t.forEach(this.user.organizations,function(e){e.enableRoomMuting=n.isRoomMutingEnabledForOrg(e),e.enablePublicRooms=n.isPublicRoomsEnabledForOrg(e),e.enablePlugins=n.isPluginsEnabledForOrg(e),e.enableInternalVideo=n.isInternalVideoEnabledForOrg(e),e.enableEditStory=n.isEditStoryEnabledForOrg(e),e.enableGiphy=n.isGiphyEnabledForOrg(e)})},this.getOrganization=function(e){return n.find(this.user.organizations,{uid:e})},this.hasCompany=function(e){return t.isDefined(this.getOrganization(e))},this.changeCompany=function(t){var n=this;return l.changeCompany(t).then(function(){n.user.orgId=t,n.organization=n.getOrganization(t),h.setOrganization(t),c.query.orgId=t,e.$emit("organization:change",n.organization)})},this.clear=function(){this.user=S,h.useOauth2()&&(I.clearToken(),t.isDefined(c.query)&&delete c.query.oauth2_token)};var C;return this.fetchAuthData=function(){if(!C){var e,t=this;h.useOauth2()&&I.hasToken()&&(e={oauth2_token:I.getToken()});C=v.create(function(){return l.fetchAuthData(e)},{maxAttempts:2,shortCircuitCheck:function(e){var t=!(e&&e[0])||401!==e[0].code;return c.disconnect(),!t}}).try().then(function(e){C=null,e.user.organizations=e.organizations;var n=h.getOrgId();if(n&&e.orgId!==n)return void(h.isODC()?U.go("error",{data:'{"noAccess":true,"showReload":false}'}):(h.setOrganization(e.orgId),a.navigate("/")));if(e.user.orgId=e.orgId,h.setOrganization(e.orgId),t.setUser(e.user),t.setAuthStatus(1,e),t.logLogin(e.user.orgId,e.user.userId),d.enableDashCache){var r=y.get(t.user.userId);try{r.put("organizations",e.organizations.map(function(e){return e.uid}))}catch(e){console.warn("There was an error saving the cache",e)}}return e}).catch(function(e){return"CONN_CLOSED_REASON_THROTTLING"===t.connectionClosedReason&&e&&"close"===e.type?s.reject(e):(C=null,e instanceof Error&&(e=[{message:e.message}]),!h.isODC()&&c.query&&delete c.query.orgId,t.setAuthStatus(2,{errors:e}),t.logAuthError("fetchAuthData",e),c.disconnect(),s.reject(e))})}return C},this.isAuthenticated=function(){return!this.isGuest()},this.isAuthorized=function(e){var t,n=this.user.roles||["user"];return e=e||["restricted"],t=this.getResourceAccessGrants(e),!!(this.getUserAccessPrivileges(n)&t)},this.isGuest=function(){return this.user===S},this.isClient=function(){return this.organization.isClient()},this.logLogin=function(e,t){try{O.log({event:"page",location:"dash_home",sublocation:"dash_home",timestamp:new Date,userId:t,data:[{org_id:e,action:"new session (login)"}]})}catch(e){p(e)}},this.logAuthError=function(e,t){h.isWidget()&&E.postParent({type:"dash:widget:error",action:e,error:t})},this.canInviteUser=function(){var e=this;return t.isDefined(e.canInviteUserCache)?s.when(e.canInviteUserCache):l.canInviteUser().then(function(t){return e.canInviteUserCache=t,t},function(){return!1})},this};e.provider("eoAuth",function(){var e={guest:1,user:2,admin:4,superUser:8},t=16;this.getUserAccessPrivileges=function(t){return r.call(this,t,e)},this.addUserRole=function(n){return e[n]=t,t*=2,this};var n={public:this.getUserAccessPrivileges(["guest","user","admin","superUser"]),restricted:this.getUserAccessPrivileges(["user","admin","superUser"]),administration:this.getUserAccessPrivileges(["admin","superUser"]),operations:this.getUserAccessPrivileges("superUser")};this.getResourceAccessGrants=function(e){return i.call(this,e,n)},this.addResourceGroup=function(e,t){return n[e]=this.getUserAccessPrivileges(t),this},this.$get=["$rootScope","$q","$window","$location","$cookies","tlSocket","eoUsers","eoOrganizationCollection","eoDashContext","eoDashConfig","eventLog","eoModelFactory","$exceptionHandler","eoOauth","eoRetry","eoCrossCommunication","eoOrganizationModel","eoDashCache","eoApplet","$state",function(t,r,i,o,a,u,c,l,g,h,d,f,b,O,m,p,I,v,E,A){return new s(t,r,i,o,a,u,c,l,g,h,e,n,d,f,b,O,m,p,I,v,E,A)}]})});