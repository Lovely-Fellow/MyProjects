define(["./common","angular","angularFileUploadShim","angularFileUpload","./files-service"],function(e,t){"use strict";var a=["JPG","JPEG","PNG","GIF","WEBP"];e.provider("eoFileAttachment",function(){var e={thumbnailMaxWidth:128,thumbnailMaxHeight:128};this.config=function(a){return t.extend(e,a),this},this.$get=["$q","$upload","$log","$window","$rootScope","$sce","$interpolate","eoDashConfig","eoFiles","eoImageRuler","eoDashContext","eoOauth",function(i,r,o,s,n,l,u,d,h,c,g,m){var p=["fileName","fileSize","imageUrl","objectUrl","uploaded","fileId","afs","imageUid","spaceId","mimeType","thumbnailWidth","thumbnailHeight","measured"],f=function(){this.objectType="eo:file",this.status={uploading:!1,progress:0,errorMessage:null,uploadHandler:!1},this.metadata={},this.options=e;var a=this;return t.forEach(p,function(e){a.__defineGetter__(e,function(){return a.metadata[e]}),a.__defineSetter__(e,function(t){a.metadata[e]=t,a.metadataSize=Object.keys(a.metadata).length})}),this};f.prototype.upload=function(a,o){function n(){p++,u.status.uploadHandler=r.upload(v).progress(function(e){d.notify({loaded:e.loaded,total:e.total}),u.updateProgress(e.loaded,e.total)}).success(function(e,t){u.status.uploadHandler=null,201===t?(console.log("[files] File uploaded correctly"),u.fileId=e.fileUid,u.afs=!0,u.objectUrl=e.fileUrl,u.externalId=e.fileUid,u.trustedObjectUrl=l.trustAsResourceUrl(u.objectUrl),e.imageUid&&e.imageUrl&&(u.imageUrl=e.imageUrl,u.imageUid=e.imageUid,u.measured=!0,u.thumbnailWidth=e.imageWidth,u.thumbnailHeight=e.imageHeight,u.trustedImageUrl=l.trustAsResourceUrl(u.imageUrl)),u.status.uploading=!1,d.resolve()):d.reject("There server rejected the file upload.")}).error(function(e,t){1===p&&401===t&&g.useOauth2()?m.refreshToken().then(function(){b.Authorization="Bearer "+m.getToken(),n()},function(){d.reject("There was an error during file upload.")}):d.reject("There was an error during file upload.")})}var u=this,d=i.defer(),p=0;this.spaceId=o,this.fileName=a.name,this.fileSize=a.size,this.mimeType=a.type,console.log("[files] Uploading file "+this.fileName+" ("+a.size+")");var f=h.validateFile(a);if(!f.valid)return void(u.status.errorMessage=f.message);this.status.uploading=!0,a=a.file||a,u.isImage()&&t.isFunction(s.FileReader)&&c.measureImage(a,e.thumbnailMaxWidth,e.thumbnailMaxHeight).then(function(e){u.previewUrl=e.previewDataUrl});var U=h.getUploadLink(o),b={Accept:"application/json"};g.useOauth2()&&(b.Authorization="Bearer "+m.getToken());var v={headers:b,url:U,data:{},fileName:this.fileName};return a.dataURL?v.file=r.dataUrltoBlob(a.dataURL,this.fileName):v.file=a,n(),d.promise.catch(function(e){return console.log("[files] File upload failed with "+e),u.status.uploading=!1,u.status.uploadHandler=null,u.status.errorMessage=e||"Sorry, we couldn't contact the server. Please try again.",i.reject(u.status.errorMessage)})},f.prototype.commit=function(){var e=[this.fileId];return this.imageUid&&e.push(this.imageUid),h.commitFiles(e)},f.prototype.abort=function(){this.status.uploading&&this.status.uploadHandler&&(this.status.uploadHandler.abort(),this.status.uploading=!1)},f.prototype.updateProgress=function(e,t){this.status.progress=Math.min(parseInt(100*e/t,10),100)},f.prototype.isUploading=function(){return this.status.uploading},f.prototype.isImage=function(){return-1!==a.indexOf(this.getFileExtension().toUpperCase())},f.prototype.hasError=function(){return null!==this.status.errorMessage},f.prototype.getErrorMessage=function(){return this.status.errorMessage},f.prototype.toJSON=function(){return{objectType:this.objectType,metadataSize:Object.keys(this.metadata).length,externalId:this.externalId,metadata:this.metadata}},f.prototype.getFileExtension=function(){if(!this.fileName)return"";var e=this.fileName.split(".");return 1===e.length||""===e[0]&&2===e.length?"":e.pop()};var U=["naturalHeight","naturalWidth","thumbnailHeight","thumbnailWidth"],b=function(e){if(e.metadata)for(var t=0;t<U.length;t++){var a=U[t],i=parseInt(e.metadata[a],10);isNaN(i)||(e.metadata[a]=i)}},v=d.filesDomain.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&").replace(/,/g,"|");d.devFilesDomain&&(v+="|"+d.devFilesDomain);var j=new RegExp("^https?://("+v+")/"),y=function(e){return j.test(e)},I=function(e){e.objectUrl&&(0===e.objectUrl.indexOf("/")&&(e.objectUrl=d.odeskBaseURL+e.objectUrl),y(e.objectUrl)||delete e.objectUrl),e.imageUrl&&(0===e.imageUrl.indexOf("/")&&(e.imageUrl=d.odeskBaseURL+e.imageUrl),y(e.imageUrl)||delete e.imageUrl)};return{create:function(){return new f},fromJSON:function(e){b(e),e.metadata&&I(e.metadata);var a=new f;return t.extend(a,e),a.metadataSize=Object.keys(a.metadata).length,a.objectUrl&&(a.trustedObjectUrl=l.trustAsResourceUrl(a.objectUrl)),a.imageUrl&&(a.trustedImageUrl=l.trustAsResourceUrl(a.imageUrl)),a},sanitizeUrls:I}}]})});