define(["./common","angular","moment","lodash"],function(t,e,n,i){"use strict";function o(t,e,n){this.name=t,this.customFunctions=this.getFunctions(e),this.excludedCustomFunctions=this.getFunctions(n);var i=this.getKeyWords(n),o=this.getKeyWords(e);i.length>0&&(this.excludedRegExp=new RegExp(i.join("|"),"ig")),o.length>0&&(this.regExp=new RegExp(o.join("|"),"ig"))}o.prototype.match=function(t){if(e.isString(t)){var n;if(this.regExp&&(n=t.match(this.regExp)))return n[0];for(var i=0;i<this.customFunctions.length;i++){if(n=(0,this.customFunctions[i])(t))return n}}},o.prototype.highlight=function(t){var n=this;if(e.isString(t)){var i=function(t){return'<mark class="disintermediation" eo-disintermediation-category="'+n.name+'">'+t+"</mark>"};if(this.excludedRegExp&&t.match(this.excludedRegExp))return t;for(var o=0;o<this.excludedCustomFunctions.length;o++){if((0,this.excludedCustomFunctions[o])(t))return t}this.regExp&&(t=t.replace(this.regExp,i));for(var r=0;r<this.customFunctions.length;r++){t=(0,this.customFunctions[r])(t,i)}return t}},o.prototype.getKeyWords=function(t){return t.filter(function(t){return!e.isFunction(t)}).map(function(t){return"\\b"+(t instanceof RegExp?t.source:t)+"\\b"})},o.prototype.getFunctions=function(t){return t.filter(function(t){return e.isFunction(t)})},t.factory("eoDisintermediation",["$rootScope","eoGoogleAnalytics","autolinker","eventLog","eoAuth","eoUsers",function(t,r,s,a,u,c){var h=[new o("payment",["Venmo","Payoneer","Skrill","Wire Transfer",/Western ?Union/,"Direct Deposit","ACH","Bank account",/p[@a]y ?p[@a]l/,"Moneybookers","Payza","Perfectmoney","Webmoney","Bitcoin","Money gram","Moneygram","Sique coinstar","Perfect Money"],[]),new o("messaging",["skype","Hangout","Hangouts","Slack"],[]),new o("contactInfo",[/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/,function(t,e){var n=/(phone|telephone|phn|tel\.?)\s+(number|num|no|#)/gi;if(e)return t.replace(n,e);var i=t.match(n);return i?i[0]:null},function(t,e){if(e)return s.link(t,{email:!1,urls:!1,phone:!0,replaceFn:function(t){return"phone"===t.getType()&&e(t.matchedText)}});var n=s.parse(t,{email:!1,urls:!1,phone:!0});return n&&n.length>0?n[0].matchedText:null}],[/([a-zA-Z0-9._-]+@([a-zA-Z0-9._-]+\.)?upwork.com?$)/])];return{_checkCategory:function(t){if(!i.find(h,{name:t}))throw new Error("Disintermediation category "+t+" not found.")},isEnabled:function(){return!0},highlight:function(t){if(!this.isEnabled())return t;var n=this;return e.forEach(h,function(e){n.shouldDisplay(e.name)&&(t=e.highlight(t))}),t},process:function(t){var n={};return e.forEach(h,function(e){var i=e.match(t);i&&(n[e.name]=i)}),n},checkStory:function(t,n){var i=this,o=this.process(n.message);e.forEach(o,function(e,o){i.report(t,n.message,e,o)})},getSettings:function(){return c._loadSettings(u.user.userId).disintermediation||{}},turnOff:function(e){this._checkCategory(e);var i=this.getSettings();i[e]=n().add(30,"days").toDate().getTime(),c.saveDisintermediationSettings(u.user.userId,i).then(function(){t.$emit("disintermediation:turnOff",e),r.ga("Disintermediation","disable "+e)})},shouldDisplay:function(t){var e=this.getSettings();return!e[t]||Date.now()>+e[t]},report:function(t,e,n,i){n=n?n.toLowerCase():"",console.log("Reporting disintermediation",t,n,i),r.ga("Disintermediation",i,"contactInfo"===i?"redacted":n);var o={event:"disintermediation",location:"dash",sublocation:"disintermediation",timestamp:new Date,userId:u.user.userId,data:[{room_id:t,org_id:u.user.orgId,category:i,keyword:n,message:e}]};a.log(o)}}}])});