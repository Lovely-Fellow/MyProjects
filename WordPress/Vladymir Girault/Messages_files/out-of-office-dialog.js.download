define(["../common/common","angular"],function(e){"use strict";e.controller("outOfOfficeDialogCtrl",["eoUsers","eoAuth","tlSettings","$scope","$modalInstance","$timeout","$window","eoAlert","eoDashConfig","eoGoogleAnalytics","eventLog","eoTimezone","autolinker",function(e,t,a,o,s,n,r,i,l,u,f,c,m){u.ga("OutOfOffice","modal opened");var p=this,g=function(e){return e.getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2)},O=function(e){var t=new Date(e);return t.setDate(t.getDate()+1),t},y=function(){p.lastDayOut=O(h),p.firstDayOut=h},D=function(){p.message="I am out of office until "+g(p.lastDayOut)+" and may not respond immediately. Thank you for your understanding."};p.isClient=t.isClient(),p.hasMultipleCompanies=!1,p.isAgencyUser=!1,t.user.organizations.length>1&&(p.hasMultipleCompanies=!0),"Business"===t.organization.type&&(p.isAgencyUser=!0),p.userTimezone=t.user.location.timezone;var d=c.getLocalTime(t.user.location.timezone,(new Date).getTime(),"YYYY-MM-DD").momentObject,h=new Date(d.year(),d.month(),d.date());p.odeskBaseUrl=l.odeskBaseURL,p.errors=[],p.oooSwitch=!1,p.lastDayOut=O(h),p.firstDayOut=h,p.minDate=h,p.message="",D(),a.getPreferencesByComponent({component:"DashOutOfOffice",global:"true"}).then(function(e){if(e.preferences&&e.preferences.length>0){var a=!1;for(var o in e.preferences){var s=e.preferences[o];switch(s.prefKey){case"enabled":a="true"===s.prefValue;break;case"message":p.message=s.prefValue;break;case"endTimestamp":var n=c.localToTimezone(parseInt(s.prefValue),t.user.location.timezone);p.lastDayOut=new Date(n.year(),n.month(),n.date());break;case"startTimestamp":var r=c.localToTimezone(parseInt(s.prefValue),t.user.location.timezone);p.firstDayOut=new Date(r.year(),r.month(),r.date())}}new Date(p.lastDayOut).setHours(0,0,0,0)<(new Date).setHours(0,0,0,0)&&(a=!1,y(),D()),p.oooSwitch=a}},function(){s.dismiss(),i.inline({type:"danger",template:"Error retrieving Out-of-Office settings"})}),p.firstOpened=!1,p.lastOpened=!1,p.dateOptions={formatYear:"yy",startingDay:1,showWeeks:!1,showButtonBar:!1},p.openFirstDay=function(e){e.preventDefault(),e.stopPropagation(),p.firstOpened=!0,p.lastOpened=!1},o.$watch("ctrl.firstDayOut",function(){if(p.lastDayOut<p.firstDayOut){p.lastDayOut=O(p.firstDayOut);var e=p.lastDayOut.getMonth()+1,t=p.lastDayOut.getDate();p.lastDayOut=[p.lastDayOut.getFullYear(),!e[1]&&"0",e,!t[1]&&"0",t].join("-"),p.lastDayOut=O(p.firstDayOut)}}),o.$watch("ctrl.lastDayOut",function(e,t){p.message.indexOf(g(t))>-1&&(p.message=p.message.replace(g(t),g(e)))}),p.openLastDay=function(e){e.preventDefault(),e.stopPropagation(),p.lastOpened=!0,p.firstOpened=!1},o.$watch("ctrl.oooSwitch",function(e,t){e!==t&&n(function(){r.dispatchEvent(new Event("resize"))})}),p.freelancerLinkClicked=function(){u.ga("OutOfOffice","freelancer link clicked")},p.save=function(){p.errors=[];var e=m.parse(p.message,{newWindow:!0,stripPrefix:!1,urls:!0,email:!0,twitter:!1,phone:!1});if(p.lastDayOut<p.firstDayOut&&p.oooSwitch)p.errors.push("Your last day out cannot be before your first day!");else if(p.message.length<1&&p.oooSwitch)p.errors.push("You need to supply a message.");else if(p.firstDayOut<new Date(h).setHours(0,0,0,0)&&p.oooSwitch)p.errors.push("Your first day cannot be in the past.");else if(e.length>0&&p.oooSwitch)p.errors.push("Your cannot have URLs in your message");else{var o=[];if(p.oooSwitch){u.ga("OutOfOffice","turned on");var n=!1;85!==p.message.length&&(u.ga("OutOfOffice","custom message saved"),n=!0);var r={event:"turned on",location:"dash",sublocation:"outofoffice",timestamp:new Date,userId:t.user.userId,data:[{oooMessage:p.message,customMessage:n}]};f.log(r);var l=g(p.firstDayOut),O=c.localToTimezone(l+" 00:00:55",t.user.location.timezone).format("x"),y=g(p.lastDayOut),D=c.localToTimezone(y+" 23:59:59",t.user.location.timezone).format("x");o=[{prefKey:"enabled",prefValue:p.oooSwitch},{prefKey:"startTimestamp",prefValue:O},{prefKey:"endTimestamp",prefValue:D},{prefKey:"message",prefValue:p.message}]}else o=[{prefKey:"enabled",prefValue:p.oooSwitch}];a.saveMultiCompSettings({global:"true",preferences:{componentList:[{componentName:"DashOutOfOffice",preferences:o}]}}).then(function(){s.close(),i.inline({type:"success",template:"Out-of-Office settings were saved"})},function(){s.dismiss(),i.inline({type:"danger",template:"Error saving Out-of-Office settings"})})}}}]).factory("eoOutOfOfficeDialog",["$modal",function(t){return{showDialog:function(){return t.open({templateUrl:e.templatePath+"out-of-office-dialog.html",controller:"outOfOfficeDialogCtrl as ctrl",windowClass:"modal-compact"})}}}])});