define(["./room","angular","lodash"],function(e,t,s){"use strict";e.factory("eoRoomStory",["eoStoryProcessor","eoAuth","tlStory","tlRoom","$q","eoDashContext","$rootScope","htmlToTextFilter","upRoomApi","upDashMetrics",function(e,n,r,o,i,a,u,c,p,b){var d=function(){this.storyId=null,this.blocked=!1,this.message="",this.objectReferences=[],this.attachments=[],this.metadata={},this.notes={}};d.prototype.updateNotes=function(e){var t=this,n=s.merge({},this.notes);s.assign(this.notes,e);var o={storyId:this.storyId,notes:e};return r.updateStoryNotes(o).then(function(e){return n=null,e},function(e){return t.notes=n,n=null,i.reject(e)})},d.prototype.setFavorite=function(e){return this.updateNotes({isFavorite:!!e})},d.prototype.getFavorite=function(){return!!this.notes.isFavorite&&!this.isDeleted()},d.AbuseTypes={NONE:"NONE",ABUSE:"ABUSE",SPAM:"SPAM",MESSAGE_IS_THREATENING:"MESSAGE_IS_THREATENING",DISINTERMEDIATION:"DISINTERMEDIATION",THIRDPARTY:"THIRDPARTY",OTHER:"OTHER"},d.AbuseTypeHumanLabels={},d.AbuseTypeHumanLabels[d.AbuseTypes.NONE]="Not abusive.",d.AbuseTypeHumanLabels[d.AbuseTypes.ABUSE]="Contains a suspicious link.",d.AbuseTypeHumanLabels[d.AbuseTypes.SPAM]="Looks like spam.",d.AbuseTypeHumanLabels[d.AbuseTypes.MESSAGE_IS_THREATENING]="Message is threatening or abusive.",d.AbuseTypeHumanLabels[d.AbuseTypes.DISINTERMEDIATION]="Requesting to pay or work outside of Upwork.",d.AbuseTypeHumanLabels[d.AbuseTypes.THIRDPARTY]="Marked as abusive by our partner.",d.AbuseTypeHumanLabels[d.AbuseTypes.OTHER]="It's something else.",d.AbuseTypeEnum=[],d.AbuseTypeEnum[0]=d.AbuseTypes.NONE,d.AbuseTypeEnum[1]=d.AbuseTypes.ABUSE,d.AbuseTypeEnum[2]=d.AbuseTypes.THIRDPARTY,d.AbuseTypeEnum[3]=d.AbuseTypes.DISINTERMEDIATION,d.AbuseTypeEnum[4]=d.AbuseTypes.OTHER,d.AbuseTypeEnum[5]=d.AbuseTypes.MESSAGE_IS_THREATENING,d.AbuseTypeEnum[6]=d.AbuseTypes.SPAM,d.prototype.getAbuseLabel=function(){var e="";return this.notes&&this.notes.abuseType&&(e=this.notes.abuseType===d.AbuseTypes.OTHER?this.notes.abuseDetails:d.AbuseTypeHumanLabels[this.notes.abuseType]),e},d.prototype.updateObjectReference=function(t){var n=s.findIndex(this.objectReferences,{objectReferenceId:t.objectReferenceId});-1!==n&&(this.objectReferences[n]=t,e.processObjectReferences(this.objectReferences,this.objectTemplates,this))},d.prototype._isMarkedAbusive=function(e,t){return e&&"NONE"!==e&&!("THIRDPARTY"===e&&!t)},d.prototype.setAbuseType=function(e,t){if(!s.isString(e))throw new Error("Abuse type must be specified");if(!s.contains(d.AbuseTypes,e))throw new Error("Invalid abuse type "+e.toString());var n=this.markedAbusive;this.markedAbusive=this._isMarkedAbusive(e,this.blocked);var r=this,o={abuseType:e};return t&&(o.abuseDetails=t),this.updateNotes(o).catch(function(e){return r.markedAbusive=n,i.reject(e)})},d.prototype.cancelAbuseReport=function(){var e=this;return this.setAbuseType(d.AbuseTypes.NONE).then(function(){e.markedAbusive=!1},function(t){console.error("changing abuse type failed: %O",t),e.markedAbusive=e._isMarkedAbusive(e.notes.abuseType,e.blocked)})},d.prototype.getAbuseType=function(){return this.notes.abuseType},d.prototype.getAbuseDetails=function(){return this.notes.abuseDetails},d.prototype.setAbuseWhiteListed=function(e){return this.updateNotes({whiteList:!!e})},d.prototype.getAbuseWhiteListed=function(){return this.notes.whiteList},d.prototype.update=function(s){return s&&s.notes&&void 0!==s.notes.abuseType&&!isNaN(s.notes.abuseType)&&(s.notes.abuseType=d.AbuseTypeEnum[s.notes.abuseType]),s.deleted&&!a.hasDashOboAccess()&&(s.message=""),t.extend(this,e.processStoryData(s,this)),this},d.prototype.deleteReference=function(e){var s=this,n=(new Date).getTime(),r=t.copy(e);e.metadata.deleted=!0,e.metadata.updated=n,delete e.context;var o={objectReferenceId:e.objectReferenceId,referenceUpdateRequest:e};return s.updateStoryObjectReference(o).catch(function(){s.updateObjectReference(r),u.$emit("story:objectReferenceUpdate",r)})},d.prototype.isDeleted=function(){return!!this.deleted},d.prototype.getDeletedTimestamp=function(){if(!this.isDeleted())return null;var e=s.find(this.fieldChanges,{fieldChanged:"deletedTimestamp"});return e?e.timestamp:this.updated},d.prototype.delete=function(){var e={roomId:this.roomId,storyId:this.storyId};return a.webApiEnabled()?(b.startMetric("removeStoryUsingWebApi"),p.deleteStory(e).then(function(e){return b.endMetric("removeStoryUsingWebApi"),e},function(t){return b.count("removeStoryUsingWebAPIFailure"),b.endMetric("removeStoryUsingWebApi"),console.warn("failed to remove story using web api:",t),o.deleteStory(e)})):o.deleteStory(e)},d.prototype.isOwner=function(){return this.userId===n.user.userId&&this.orgId===n.user.orgId},d.prototype.isDisplayUser=function(){return this.user?this.user.userId===n.user.userId&&(this.user.orgId||this.orgId)===n.user.orgId:this.isOwner()},d.prototype.canEdit=function(){return this.isDisplayUser()&&"eo:post"===this.actionType&&n.organization.enableEditStory},d.prototype.hasEditCapability=function(){return(new Date).getTime()-this.created<a.storyActionInterval()},d.prototype.plain=function(){return t.copy({storyId:this.storyId,message:e.replaceRoomMentions(this.message),attachments:this.attachments||[],metadata:this.metadata,notes:this.notes,deleted:!!this.deleted})},d.prototype.hasAttachments=function(){return!!this.objectReferences&&this.objectReferences.some(function(e){return"eo:message"!==e.objectType})},d.prototype.hasFiles=function(){return!!this.objectReferences&&this.objectReferences.some(function(e){return"eo:file"===e.objectType})},d.prototype.cantSend=function(e,s){var n,r,o=null;if((t.isUndefined(e)||e)&&!this.message&&0===this.attachments.length)return o="Please enter a message.";if(t.isDefined(e)&&!e)return o=null;u.tlConnected||(o="Network disconnected."),t.isDefined(s)&&s&&(o="Room is read only.");var i=c(this.message).trim().length;if(!i){var a=!1;for(n=0;n<this.attachments.length;++n)if(r=this.attachments[n],"eo:file"!==r.objectType||!r.hasError()){a=!0;break}a||(o="Please enter a message.")}for(i>1e4&&(o="Please limit the message length to 10000 characters."),n=0;n<this.attachments.length;++n)if(r=this.attachments[n],"eo:file"===r.objectType&&r.isUploading()){o="Upload in progress.";break}return o},d.prototype.isBroadcastStory=function(){return"eo:broadcast"===this.actionType},d.prototype.broadcast=function(e){var s=this.plain();s.userId=n.user.userId,s.orgId=n.user.orgId,s.newObjectReferences&&s.newObjectReferences.length||(s.newObjectReferences=[{objectType:"eo:message",metadata:{}}]),s.attachments&&t.forEach(s.attachments,function(e){e.hasError&&!e.hasError()&&s.newObjectReferences.push(e.toJSON())}),s.attachments=null,s.sourceClient=a.getClientName(),s.actionType||(s.actionType="eo:post");var o={broadcastStory:{newStory:s,teamRids:e}};return r.broadcastStory(o)},d.prototype.updateStoryObjectReference=function(e){return a.webApiEnabled()?(b.startMetric("updateStoryObjectReferenceUsingWebApi"),p.updateObjectReference(e).then(function(e){return b.endMetric("updateStoryObjectReferenceUsingWebApi"),e},function(t){return b.count("updateStoryObjectReferenceUsingWebFailure"),b.endMetric("updateStoryObjectReferenceUsingWebApi"),console.warn("failed to update story object reference using web api:",t),o.updateObjectReference(e)})):o.updateObjectReference(e)};var y={create:function(){return new d},fromData:function(e){var t;return t=e instanceof d?e:new d,t.update(e),t},getAbuseTypes:function(){return t.extend({},d.AbuseTypes)},getLabeledAbuseTypes:function(e){var s=y.getAbuseTypes(),n=[];return t.forEach(s,function(t){e&&-1!==e.indexOf(t)||n.push({type:t,label:d.AbuseTypeHumanLabels[t]})}),n}};return y}])});