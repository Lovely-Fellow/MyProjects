define(["./room","angular"],function(o,t){"use strict";o.directive("eoRoomStoryListScrollContinuum",["$log","$q","$rootScope",function(o,r,n){return{restrict:"A",replace:!0,require:["eoScrollContinuum","^eoRoomStoryList"],controllerAs:"roomStoryListScrollContinuum",controller:["$scope","$element","$timeout","$state",function(e,i,s,l){var u=this;e.$on("scrollContinuum:topCollision",function(){u.roomStoryList.loadOlderStories()}),e.$on("scrollContinuum:bottomCollision",function(){u.scrollContinuum.enableStickyBottom()}),this.scrollToStory=function(t,n){return u.scrollContinuum.ready().finally(function(){return(n?r.when():u.roomStoryList.loadStory(t)).then(function(){var o=r.defer();return s(function(){var r=i.find("[eo-story-id="+t+"]");if(!r.size())return void o.reject("story was not loaded");u.scrollContinuum.scrollTo(r),e.$emit("scrollContinuum:userScroll"),o.resolve(r)}),o.promise},function(t){o.warn("failed to load story:",t)})})},this.scrollToStorySettings=function(o){return u.scrollContinuum.ready().then(function(){var t=r.defer();return s(function(){var r=i.find("[eo-story-id="+o+"] a.story-actions[eo-panel-open]");if(!r.size())return void t.reject("story setting element not found");u.scrollContinuum.scrollTo(r),t.resolve(r)}),t.promise})},e.$on("story:edit",function(o,t){u.scrollToStory(t)}),e.$on("story:jump",function(t,r,n){if(e.room.roomId!==r)return void o.log("not same room");u.scrollToStory(n).then(function(){u.roomStoryList.highlightStory(n)},function(t){o.warn("could not scroll to story: %s",t&&t.message?t.message:t)})});var c=n.$on("story:scrollToSettings",function(o,t){u.scrollToStorySettings(t)}),m=n.$on("story:scrollToElement",function(o,t){u.scrollContinuum.scrollTo(t)}),y=n.$on("$stateChangeStart",function(o,r,n){if(u.roomStoryList.room.roomId,n.id,!1){var e=u.scrollContinuum.getVisualContentCenterElement();if(e){var i=t.element(e),s=u.roomStoryList.getStoryByElement(i);s&&(u.roomStoryList.room.centeredStoryId=s.storyId)}}});e.init=function(o,t){u.scrollContinuum=o,u.roomStoryList=t;var r=this.roomStoryList.watchNewStory(function(o){o.isDisplayUser()&&u.scrollContinuum.enableStickyBottom()});e.$on("$destroy",function(){r.unsubscribe()}),e.$on("$stateChangeSuccess",function(){l.params.storyId&&u.scrollToStory(l.params.storyId).then(function(){u.roomStoryList.highlightStory(l.params.storyId)})}),u.scrollContinuum.ready().then(function(){u.roomStoryList.room&&u.roomStoryList.room.centeredStoryId,l.params.storyId?u.scrollToStory(l.params.storyId).then(function(){u.roomStoryList.highlightStory(l.params.storyId)}):u.scrollContinuum.enableStickyBottom()})},e.$on("$destroy",function(){y(),c(),m(),delete u.scrollContinuum,delete u.roomStoryList})}],link:function(o,t,r,n){o.init(n[0],n[1])}}}])});