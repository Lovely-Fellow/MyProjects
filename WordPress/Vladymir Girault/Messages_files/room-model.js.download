define(["./room","angular","lodash","buzz","rxjs","../common/user-model","./room-api-service"],function(e,t,r,s,o){"use strict";e.factory("eoRoomModel",["$rootScope","$q","$location","$stateParams","eoDashConfig","tlRoom","eoDebug","eoTimezone","eoRoomDialog","eoRoomStory","tlStory","eoUsers","eoAuth","eoNotification","htmlToTextFilter","eoTimeInst","eoRoomStoryCache","$timeout","eoDashContext","eoPageVisibility","eoFileGroup","eventLog","$window","$state","eoStoryProcessor","eoGoogleAnalytics","eoThriftRoomType","eoApplet","eoUserModel","upDashMetrics","upNewStoryObservable","upUpdatedStoryObservable","upWorkplaceConnections","eoRetry","eoRoomPresence","upRoomApi","upUserQtApi","eoRoomApi","MftFeedbackService","MFT_FB_ACTION_TYPES",function(e,s,i,n,a,d,u,c,h,l,m,f,g,p,I,v,b,y,S,_,R,w,U,T,O,L,M,x,N,P,j,A,E,D,$,F,k,C,W,H){var z=function(){var i=function(e,t,r,s){var o,i=0,n=[],a=[];if(e&&e.length)for(;o=e[i++];)if(o.userId===t&&(!r||r&&o.orgId===r)){if(r)return s?i-1:o;n.push(o),a.push(i-1)}return n.length>0?1===n.length?s?a[0]:n[0]:s?a:n:s?-1:null},u=function(){return g.user.userId+"-"+(new Date).getTime()%36e5+"-"+Math.floor(100*Math.random())},c=function(e){return function(t,r){var s=this;return e.$on(t,function(e){e.roomId===s.roomId&&r(e)})}},p=function(e){function t(e){return e=e||{total:0},e.stories=e.stories||[],e}return e.includeNotes=!1!==e.includeNotes,S.webApiEnabled()?(P.startMetric("getStoriesUsingWebApi"),F.getStories(e).then(function(e){return P.endMetric("getStoriesUsingWebApi"),t(e)},function(r){return P.count("getStoriesUsingWebAPIFailure"),P.endMetric("getStoriesUsingWebApi"),console.warn("failed to fetch stories using web api:",r),d.getStories(e).then(t)})):d.getStories(e).then(t)},I=function(e,r,s,o,i){t.isArray(r)&&(r=r.join(","));var n={roomId:e,objectTypes:r};return t.isDefined(s)&&(n.limit=s),t.isDefined(o)&&(n.cursor=o),t.isDefined(i)&&(n.sortDirection="asc"===i?"asc":"desc"),S.webApiEnabled()?(P.startMetric("getObjectReferencesUsingWebApi"),F.getObjectReferences(n).then(function(e){return P.endMetric("getObjectReferencesUsingWebApi"),e},function(e){return P.count("getObjectReferencesUsingWebAPIFailure"),P.endMetric("getObjectReferencesUsingWebApi"),console.warn("failed to fetch object reference using web api:",e),d.getObjectReferences(n)})):d.getObjectReferences(n)},U=function(){this._loadMissingStoriesGapsOnly=!0,this._loadMissingStoriesTimeout=null},T=function(e){return C.getRoom(e)},z=function(e){return S.webApiEnabled()?(P.startMetric("updateRoomUsingWebApi"),F.updateRoom(e).then(function(e){return P.endMetric("updateRoomUsingWebApi"),e},function(t){return P.count("updateRoomWebAPIFailure"),P.endMetric("updateRoomUsingWebApi"),console.warn("failed to update room using web api:",t),d.updateRoom(e)})):d.updateRoom(e)},B=function(e){return S.webApiEnabled()?(P.startMetric("newStoryUsingWebApi"),F.newStory(e).then(function(e){return P.endMetric("newStoryUsingWebApi"),e},function(t){return P.count("newStoryWebAPIFailure"),P.endMetric("newStoryUsingWebApi"),console.warn("failed to create new story using web api:",t),d.newStory(e)})):d.newStory(e)},q=function(e){return S.webApiEnabled()?(P.startMetric("updateStoryUsingWebApi"),F.updateStory(e).then(function(e){return P.endMetric("updateStoryUsingWebApi"),e.length},function(t){return P.count("updateStoryWebAPIFailure"),P.endMetric("updateStoryUsingWebApi"),console.warn("failed to update story using web api:",t),d.updateStory(e)})):d.updateStory(e)};return U.prototype={on:c(d),onStory:c(m),active:!1,totalStories:0,toggleNotifications:function(){if(!S.isReadOnlyMode()){this.muted=!this.muted;var e={roomId:this.roomId,userId:g.user.userId,orgId:g.user.orgId,subscriptionInfo:{muted:this.muted?1:0}};return D.create(function(){return d.updateRoomUser(e)},{maxAttempts:10}).try()}},isSelected:function(){return this.roomId===n.id},getOwner:function(){if(!this.owner){var e=r.find(this.users,{role:"owner"});e&&(this.owner={userId:e.userId,orgId:e.orgId})}return this.owner},hasNotes:function(){return this.roomNotePresent},setNotes:function(e){this.roomNotePresent=!!e,this.roomNote=e},updateNotes:function(e){return d.updateRoomUser({roomId:this.roomId,userId:g.user.userId,orgId:g.user.orgId,subscriptionInfo:{roomNote:e}})},updateRoomFeature:function(e,t){if(this.features){if(void 0!==this.features[e]&&this.features[e]===t)return}else this.features={};return this.features[e]=t,d.updateRoomUser({roomId:this.roomId,userId:g.user.userId,orgId:g.user.orgId,subscriptionInfo:{features:this.features}})},setRoomFeatures:function(e){this.features=e},isOwner:function(e){e||(e=g.user);var t=this.getOwner();return t&&t.userId===e.userId&&t.orgId===e.orgId},isAdmin:function(e){e||(e=g.user);var t=i(this.users,e.userId,e.orgId);return!!t&&"admin"===t.role},isMember:function(e){return!this.isOwner(e)&&!this.isAdmin(e)},canInvite:function(){return!this.isHourPackInterview()&&!this.isStarterProjectsRoom()&&(this.isPublic||!this.isOneOnOne()&&(this.isOwner()||this.isAdmin()))},isJustInterview:function(){return this.roomType===M.INTERVIEW&&!this.contractId},isWorkroom:function(){return this.roomType===M.INTERVIEW&&this.contractId},isHourPackInterview:function(){var e=r.find(this.objectReferences,function(e){return"upwork-ats:job"===e.objectType});return e&&e.metadata&&e.metadata.is_hour_pack&&this.roomType===M.INTERVIEW},isStarterProjectsRoom:function(){return this.context&&this.context.isStarterProjectsRoom},canInviteHM:function(){return this._.canInviteHM||(S.isStandalone()||!this.isInterviewRoom()||this.isJustInterview()&&S.isWidget()||!g.isClient()?this._.canInviteHM=s.when(!1):this._.canInviteHM=g.canInviteUser().then(function(e){if(e){if(x.getVar("helpMeHireWidget")){return k.getPersonAllocation({testName:"CE3983_HelpMeHire_DemandTest"}).then(function(e){return e&&"Treatment"===e.cellName&&"CE3983_HelpMeHire_DemandTest"===e.testName},function(e){return 404!==e.status&&console.warn("failed to fetch user QT settings using web api:",e),!1})}return!1}})),this._.canInviteHM},canLeave:function(e){return e||(e=g.user),!this.isOwner(e)&&(this.roomType===M.GROUP||!(this.roomType!==M.INTERVIEW||!this.context)&&(this.context.freelancerId!==e.userId||this.context.freelancerOrgId!==e.orgId))},canEditRoom:function(e){return e||(e=g.user),!this.isReadOnly&&(this.isAdmin(e)||this.isOwner(e))&&this.roomType!==M.ONE_ON_ONE&&this.roomType!==M.INTERVIEW},_canManage:function(e){return!(this.roomType===M.ONE_ON_ONE||!this.isOwner()&&!this.isAdmin()||this.isOwner(e))&&(this.roomType!==M.INTERVIEW||this.context.freelancerId!==e.userId||this.context.freelancerOrgId!==e.orgId)},canEdit:function(e){return this._canManage(e)&&!this.isReadOnly},canKick:function(e){return this._canManage(e)&&g.organization&&g.organization.enableEditStory},canArchive:function(){return!this.isReadOnly&&(this.isAdmin()||this.isOwner())&&this.roomType===M.GROUP},hasTopic:function(){return this.roomType===M.GROUP||this.roomType===M.INTERVIEW},hasContext:function(){return!1},getContext:function(){return this.context?this.context.jobName?this.context.amount:void 0:null},getActions:function(){var e=[];if(!this.context)return e;var t=(this.context.currentStatus||"").toLowerCase();if(this.context.jobName&&r.indexOf(["cancelled","withdrawn","declined"],t)<0&&"true"!==this.context.hidden_by_client){if((this.context.applicationId||this.context.applicationUid&&this.context.jobUid)&&!this.context.offerId&&this.context.clientOrgId===g.user.orgId&&!this.isReadOnly){var s,o=g.organization.rid,i=a.odeskBaseURL+"/e/"+o+"/offers/v2/new/?do=terms";s=this.context.applicationUid&&this.context.jobUid?i+"&application_uid="+this.context.applicationUid+"&job_uid="+this.context.jobUid:i+"&applicant="+this.context.applicationId;var n=this.context.associatedAgencyOrgId&&this.context.associatedAgencyOrgId!==this.context.freelancerOrgId;e.push({title:n?"Hire Agency":"Hire Freelancer",action:s})}}return e},_makeOwner:function(e,t){if(t||(t=this.users[0].orgId),this.getOwner()){var r=this.getUser(this.owner.userId,this.owner.orgId);r&&(r.role="admin")}var s=this.getUser(e,t);s&&(s.role="owner"),this.owner={userId:e,orgId:t}},makeOwner:function(e,r){var o=this,i=t.copy(this.owner);return this._makeOwner(e,r),d.updateRoomUser({roomId:this.roomId,userId:e,orgId:r,subscriptionInfo:{role:"owner"}}).catch(function(e){return o._makeOwner(i.userId,i.orgId),s.reject(e)})},makeAdmin:function(e){return d.updateRoomUser({roomId:this.roomId,userId:e.userId,orgId:e.orgId,subscriptionInfo:{role:"admin"}})},removeAdmin:function(e,t){return d.updateRoomUser({roomId:this.roomId,userId:e,orgId:t,subscriptionInfo:{role:"participant"}})},getUser:function(e,t){return i(this.users,e,t)},getValidUser:function(e,t){var r;if(!t)return void console.error('Expected to see an array or org IDs, but instead the parameter (validOrgs) was "undefined"');for(var s=0;s<t.length;s++){for(var o=t[s],i=0;i<this.users.length;i++){var n=this.users[i];if(n.userId===e&&n.orgId===o.uid){r=n;break}}if(r)break}return r},inviteUser:function(e,t,r){function o(){return v.startMetric("openRoom.tl.inviteUser"),d.subscribeUserToRoom(a).then(function(){return v.endMetric("openRoom.tl.inviteUser"),v.callMetric(),i}).catch(function(e){return s.reject(e)})}var i=this,n=r||"participant";t||(t=g.user.orgId);var a={roomId:i.roomId,orgId:t,subscribeUserRequest:{role:n},userId:e};return S.webApiEnabled()?(P.startMetric("subscribeUserToRoomUsingWebApi"),F.subscribeUserToRoom(a).then(function(){return P.endMetric("subscribeUserToRoomUsingWebApi"),i},function(e){return P.count("subscribeUserToRoomUsingWebAPIFailure"),P.endMetric("subscribeUserToRoomUsingWebApi"),console.warn("failed to subscribe user to room using web api:",e),"BE_ERROR"===e.codeExtended?s.reject(e):o()})):o()},inviteUsers:function(e){v.startMetric("openRoom.tl.inviteUsers");var t=e.map(function(e){return{orgId:e.orgId||g.user.orgId,role:e.role||"participant",userId:e.userId}}),r=this,o={roomId:r.roomId,subscribeUsersRequest:{userList:t}};return d.subscribeUsersToRoom(o).then(function(){return v.endMetric("openRoom.tl.inviteUsers"),v.callMetric(),r}).catch(function(e){return s.reject(e)})},inviteEmail:function(e,t,r){v.startMetric("openRoom.tl.inviteEmail");var s=this,o=a.odeskBaseURL+"/messages/rooms/invite?email="+encodeURIComponent(e)+"&orgId="+g.user.orgId+"&roomId="+s.roomId,i=r||"participant";t||(t=g.user.orgId);var n={invite:{roomId:s.roomId,redirectUrl:o,orgId:t,email:e,invitedBy:g.user.legacyId}};return"hiringManager"===i?(n.invite.role="admin",n.invite.isHiringManager=!0):(n.invite.role=i,n.invite.isHiringManager=!1),E.invite(n).then(function(t){return t.email=e,s.addInvite(t),v.endMetric("openRoom.tl.inviteEmail"),v.callMetric(),s})},removeInvite:function(r){var s=this,o=null;t.forEach(s.invites,function(e,t){e.email.toLowerCase()===r.toLowerCase()&&(o=t)}),null!==o&&(s.invites.splice(o,1),e.$emit("room:inviteremoved"))},addInvite:function(e){var t=this;if("INVITED"===e.status)return e.status="Pending",t._.getInvitationsPromise?t._.getInvitationsPromise.then(function(){t._addInvite(e)}):void 0},_addInvite:function(r){var s=!1,o=this;this.ensureUsers([r.invitedByUid]).then(function(){var i=o.getUser(r.invitedByUid);r.invitedByFullName=i.info.fullName,o.setEmailForDisplay(r),r.timestamp||(r.timestamp=(new Date).getTime()),t.forEach(o.invites,function(e){e.email.toLowerCase()===r.email.toLowerCase()&&(s=!0,e.timestamp=r.timestamp)}),s||(o.invites.push(r),e.$emit("room:inviteadded"))})},getInvites:function(){var e=this;return e._.getInvitationsPromise?e._.getInvitationsPromise:(e.invites=[],e._.getInvitationsPromise=f.getInvitations({roomId:e.roomId}).then(function(r){return t.forEach(r,function(t){"Pending"===t.status&&(f.several([t.invitedByUid],!0).then(function(e){e.length&&(t.invitedByFullName=e[0].info.fullName)}),e.setEmailForDisplay(t),e.invites.push(t))}),e.invites}),e._.getInvitationsPromise)},setEmailForDisplay:function(e){this.isOwner()||e.invitedByUid===g.user.userId?e.emailForDisplay=e.email:(e.emailForDisplay=e.email.substring(0,3)+"...@...",e.disabled=!0)},hasUsers:function(){return!r.isEmpty(this.users)},addUser:function(t,r,s){!this.getUser(t,r)&&this.users&&(this.users.push({userId:t,role:s,orgId:r,id:t+"_"+r}),e.$emit("room:useradded"),this._.roomPresence&&this._.roomPresence.addUser(t))},leave:function(e,t){var r,o=this,n=this.users,a=i(n,e,t,!0),u=a>=0;u&&(r=n[a].role,this.removeUser(e,t));var c=null,h={roomId:this.roomId,userId:e,orgId:t};return S.webApiEnabled()?(P.startMetric("removeUserUsingWebApi"),c=F.removeUser(h).then(function(e){return P.endMetric("removeUserUsingWebApi"),e},function(e){return P.count("removeUserWebAPIFailure"),P.endMetric("removeUserUsingWebApi"),console.warn("failed to remove user from room using web api:",e),d.removeUser(h)})):c=d.removeUser(h),c.catch(function(i){return u&&o.addUser(e,t,r),s.reject(i)})},removeUser:function(t,r){var s=this.users,o=i(s,t,r,!0),n=o>=0;return n&&(s.splice(o,1),e.$emit("room:userremoved"),this._.roomPresence&&this._.roomPresence.removeUser(t)),n},archive:function(){var e=this;return z({roomId:this.roomId,roomMetadata:{isReadOnly:!0}}).then(function(t){return e.isReadOnly=t.isReadOnly,e.isHidden=!0,e.roomName=t.roomName,!0},function(e){e&&e[0]&&400===e[0].code&&e[0].logMessage&&h.error("Unable to Archive",e[0].logMessage.replace(/^.*message: '(.*)'.*$/,"$1"))})},getStory:function(e){var t=null,s=this.getStories(),o=r.findIndex(s,function(t){return t.storyId===e});return o>-1&&(t=s[o]),t},newStory:function(o){var i=this,n=u();o.objectReferences&&o.objectReferences.length||(o.objectReferences=[{objectType:"eo:message",metadata:{}}]),o.attachments&&t.forEach(o.attachments,function(e){e.hasError&&!e.hasError()&&o.objectReferences.push(e.toJSON())}),o.roomId=i.roomId,o.attachments=null,o.actionType||(o.actionType="eo:post"),o.userId=g.user.userId,o.orgId=g.user.orgId,o.messageId=n,o.sourceClient=S.getClientName();var a=t.copy(o);a.titleTemplate="%!$[eoUser]",a.storyId=a.messageId,a.pending=!0,a.created=Date.now();for(var d in a.objectReferences)a.objectReferences[d].objectReferenceId=-1-d;i.userLastReadTimestamp=a.created+1,i.addStory(a,!0),delete o.storyId,delete o.attachments,delete o.user,delete o.created;var c={roomId:i.roomId,newStory:o};return B(c).then(function(s){if(W.trackAction(H.SENT_DASH_MSG),a.pending){var o=i.getStories(),n=r.findIndex(o,{storyId:a.storyId});if(n<0)return s;a=t.copy(o[n]);var d=r.findIndex(o,{storyId:s.storyId});return d<0?(t.extend(a,s),delete a.pending,a.processed=!1,a=i._processStory(a,a.user),o[n]=a,e.$emit("story:new",a),(!i.latestStory||a.created>=i.latestStory.created)&&(i.latestStory=a),i.recentTimestamp=a.created):n!==d&&o.splice(n,1),s}},function(e){if(P.count("newStoryFailure",1),e&&e[0]&&(403==+e[0].code||405==+e[0].code||500==+e[0].code&&e[0].logMessage.match(/You exceeded the maximum number of rooms/))&&(e[0].message=e[0].logMessage,h.showMessageLimitError({error:e[0]})),a.pending){var t=i.getStories(),o=r.findIndex(t,{storyId:a.storyId});if(!(o<0)){var n=t[o];for(n.error=!0;++o<t.length&&t[o].pending;);t.splice(o),i.loadMissingStories(),console.warn("failed to create new story; raw reason:",e);var d="Oops, sorry about this! Unfortunately we're having difficulty communicating with our server. Please contact support if this issue persists.";return e&&e[0]&&e[0].message&&/cannot exceed/.test(e[0].message)&&(d="Message can be a maximum length of 10000 characters."),n.errorMessage=d,s.reject(d)}}})},deleteStory:function(e){if(e.pending){var t=this.getStories(),o=r.findIndex(t,function(t){return t.storyId===e.storyId});return o>-1&&t.splice(o,1),s.when()}return e.delete()},updateStory:function(e){var o=this;if(e.pending)return s.when();var i=this.getStory(e.storyId);if(i){var n=[],a=!1;t.forEach(i.objectReferences,function(e){n.push(e)}),t.forEach(e.attachments,function(e){if("eo:url"===e.objectType&&e.url){r.find(i.objectReferences,function(t){return"eo:url"===t.objectType&&e.url===t.metadata.url})||(a=!0,n.push(e.toJSON()))}});var d={roomId:this.roomId,storyId:e.storyId,storyUpdateRequest:{message:e.message}};return a&&(d.storyUpdateRequest.objectReferences=n),i.pending=!0,i.oldMessage=i.message,i.messageHtml=O.parseMessage(e.message,e),q(d).then(function(e){return i.fieldChanges=i.fieldChanges||[],i.fieldChanges.push({fieldChanged:"message",timestamp:Date.now()}),delete i.messageHtml,delete i.pending,o.updatedStory(i),e},function(e){if(P.count("updateStoryFailure",1),i.pending){delete i.pending,i.messageHtml=O.parseMessage(i.message,i),console.warn("failed to update story; raw reason:",e);var t="";return t="STORY_EDITABLE_PERIOD_EXPIRED"===e[0].codeExtended||403===e[0].code&&e[0].message.match(/not editable anymore/)?"You can no longer edit this message as it has been sent more than one hour ago.":"Could not save changes. Please try again later.",i.errorMessage=t,s.reject(t)}})}},cancelUpdate:function(e){var t=this.getStory(e.storyId);return e.message=e.oldMessage,delete e.pending,delete e.error,delete e.isUpdateError,delete e.messageHtml,t.update(e.plain())},retryUpdate:function(e){return delete e.pending,delete e.isUpdateError,delete e.error,delete e.oldMessage,this.updateStory(e)},deleteReference:function(e,t){return e.pending?s.when():e.deleteReference(t)},loadFilesAndLinks:function(e,t,r){return I(this.roomId,["eo:file","eo:url"],e,t,r)},loadFiles:function(e,t,r){return I(this.roomId,"eo:file",e,t,r)},loadLinks:function(e,t,r){return I(this.roomId,"eo:url",e,t,r)},loadLastVideoPost:function(){return I(this.roomId,"eo:video",1,null,"desc")},loadOlderStories:function(){var e=this;return this._lazyStart(),this._.storiesLoadingDeferred.older||(this._.storiesLoadingDeferred.older=s.defer(),this.active||console.error("loadOlderStories called for inactive room"),this._.requestOlderStories$.next({olderThan:this.stories.length?this.stories[0].created:Date.now(),limit:a.rooms.olderStoriesPageSize,done:function(t){e._.storiesLoadingDeferred.older.resolve(t),e._.storiesLoadingDeferred.older=null},error:function(t){console.error("Older stories not loaded. Error: %s",t),e._.storiesLoadingDeferred.older.reject(t),e._.storiesLoadingDeferred.older=null}})),this._.storiesLoadingDeferred.older.promise},loadNewerStories:function(e,t){var r=this;if(this._lazyStart(),!this._.storiesLoadingDeferred.newer){this._.storiesLoadingDeferred.newer=s.defer();var o,i,n=this.getStories();o=n.length;do{i=o?n[--o]:null}while(i&&i.pending);this._.requestNewerStories$.next({newerThan:i?i.created:null,olderThan:t||Date.now()+864e5,limit:a.rooms.newerStoriesPageSize,inactiveRoom:e,done:function(e){r._.storiesLoadingDeferred.newer.resolve(e),r._.storiesLoadingDeferred.newer=null},error:function(e){console.error("Newer stories not loaded. Error: %s",e),r._.storiesLoadingDeferred.newer.reject(e),r._.storiesLoadingDeferred.newer=null}})}return this._.storiesLoadingDeferred.newer.promise},_loadAllStories:function(e){var t=this;if(!this.oldestStoryLoaded)return e.notify({total:t.totalStories,current:t.stories.length}),this.loadStories({olderThan:this.stories.length?this.stories[0].created:Date.now(),limit:200},!1,!0).then(function(){return t._loadAllStories(e)},function(t){e.reject(t)});e.resolve({})},loadAllStories:function(){var e=s.defer();return this.stories=[],this.noCache=!0,this.active=!0,this.oldestStoryLoaded=!1,this._loadAllStories(e),e.promise},reloadStories:function(e){var t=this;return t.freezeFirstUnread=!0,this.loadStories({limit:a.rooms.newerStoriesPageSize},e).then(function(){t.refreshed=!0,t.freezeFirstUnread=!1})},loadMissingStories:function(e){var r=[],o=this;return this._loadMissingStoriesGapsOnly=this._loadMissingStoriesGapsOnly&&!!e,y.cancel(this._loadMissingStoriesTimeout),this._loadMissingStoriesTimeout=y(function(){return o.disregardMissingStories(!0),o._loadMissingStoriesGapsOnly||r.push(o.loadNewerStories()),t.forEach(o.stories,function(e,t){var s;t&&e.nextOldestStoryId&&"_loadMore"!==e.actionVerb&&(s=o.stories[t-1],"_loadMore"!==s.actionVerb&&e.nextOldestStoryId!==s.storyId&&r.push(o.loadStoriesFromTo(s.created,e.created,e.storyId)))}),s.all(r).then(function(){o.stories.sort(function(e,t){return+e.created-+t.created})}).catch(function(e){return console.error("Error loading missing stories: %s",e),s.reject(e)}).finally(function(){o._loadMissingStoriesGapsOnly=!0,o.disregardMissingStories(!1)})},1e3),this._loadMissingStoriesTimeout},loadStories:function(e,t,r){var o=this;return e.roomId=this.roomId,p(e).then(function(e){o.totalStories=Math.max(o.totalStories,e.total);var s=e.stories;return r&&s.length<a.rooms.olderStoriesPageSize&&(o.oldestStoryLoaded=!0),o.addStories(s,t,r).then(function(){return o.getStories()})}).catch(function(e){return console.error("Error loading stories:",e),s.reject(e)})},loadStoriesFromTo:function(e,t,r){this._lazyStart();var o=s.defer();return this._.requestStoriesFromTo$.next({from:e,to:t,insertBefore:r,done:function(){o.resolve()},error:function(e){o.reject(e)}}),o.promise},disregardMissingStories:function(e){this._shouldDisregardMissingStories=!!e},loadStoriesAround:function(e){this._lazyStart();var t=s.defer();return this._.requestStory$.next({storyId:e,done:function(){t.resolve()},error:function(e){t.reject(e)}}),t.promise},addStories:function(e,t,o){var i,n,a=[],d=this;for(o||(e=e.reverse()),n=0,i=e.length;n<i;n++)a.push(this.addStory(e[n],t,o));return s.all(a).then(function(e){if(r.isString(o)&&o.match(/^loadMore/)){var t=r.findIndex(d.stories,function(e){return e.storyId===o});t>-1&&d.stories.splice(t,1)}return e})},patchName:function(){var e={event:"click",location:"room nav header",sublocation:"room name",timestamp:new Date,userId:g.user.userId,data:[{org_id:g.user.orgId,room_id:this.roomId,room_name:this.roomName,action:"room name edited",event_label:"room_name_edited",opening_uid:this.context&&this.context.jobUid,contract_id:this.contractId,contractor_uid:this.context&&this.context.freelancerId}]};return w.log(e),L.ga("Rooms","room name","edit",{roomId:this.roomId}),z({roomId:this.roomId,roomMetadata:{roomName:this.roomName}})},patchTopic:function(){var e={event:"click",location:"room nav header",sublocation:"topic name",timestamp:new Date,userId:g.user.userId,data:[{org_id:g.user.orgId,room_id:this.roomId,topic:this.topic,action:"room topic edited",event_label:"room_topic_edited",opening_uid:this.context&&this.context.jobUid,contract_id:this.contractId,contractor_uid:this.context&&this.context.freelancerId}]};return w.log(e),L.ga("Rooms","topic name","edit",{roomId:this.roomId}),z({roomId:this.roomId,roomMetadata:{topic:this.topic}})},addStory:function(e,t,r,o){var i=this,n=[];return i.ensureUsers(n,e).then(function(){return e=i._insertStory(e,r),(!e.__dupe||o)&&(r||i.updateLatestStory(e)),delete e.__dupe,e},function(e){return console.error("failed to ensure users",e),s.reject(e)})},updateLatestStory:function(e){if(!e.pending&&!e.isSystemStory){(!this.latestStory||e.created>=this.latestStory.created)&&(this.latestStory=e);var t=this;e.created&&e.created>this.recentTimestamp&&(this.isReadOnly&&!t.isStarterProjectsRoom()||(t.recentTimestamp=e.created)),this.isHidden&&this.setHidden(!1)}},isUndefinedOrNull:function(e){return t.isUndefined(e)||null===e},clearUnread:function(){this.numUnread=0,this.numUnreadMentions=0,this.unreadCounter=0,this.markAsUnread=!1},updatedRoomUser:function(e){if(e.updateLastRead&&(!this.userLastReadTimestamp||e.updateLastRead>this.userLastReadTimestamp||t.isDefined(e.markAllStoriesRead)&&!1===e.markAllStoriesRead)&&(this.clearUnread(),this.userLastReadTimestamp=e.updateLastRead),this.isUndefinedOrNull(e.isFavorite)||(this.isFavorite=e.isFavorite),this.isUndefinedOrNull(e.isHidden)||(this.isHidden=e.isHidden),this.isUndefinedOrNull(e.recentTimestamp)||(this.recentTimestamp=e.recentTimestamp),e.role){"owner"===e.role&&this._makeOwner(e.userId,e.orgId);var r=i(this.users,e.userId,e.orgId);r&&(r.role=e.role)}this.isUndefinedOrNull(e.unreadStories)||this.setNumUnread(e.unreadStories),this.isUndefinedOrNull(e.unreadMentions)||this.setNumUnreadMentions(e.unreadMentions)},updatedRoom:function(e){t.extend(this,e,{_:this._,stories:this.stories}),this.initPresence()},updatedStory:function(t){var r=this,o=null;return o=t.userId?r.ensureUsers([t.userId]):s.when(),o.then(function(){for(var s,o=r.getStories(),i=0;i<o.length;++i){s=o[i];var n=s.mentioned;if(t.storyId===s.storyId){if(t.notes||delete t.notes,!0,delete s.oldMessage,delete s.error,o[i]=s.update(t),r.latestStory&&r.latestStory.storyId===s.storyId&&r.updateLatestStory(s),!n&&o[i].mentioned){var a={room:r,story:o[i]};e.$emit("editMentionFound",a),r.updateUnreadCounter()}break}}return s})},updatedStoryNotes:function(e,s){var o=this.getStories(),i=r.find(o,{storyId:e});i&&(t.extend(i.notes,s),i.markedAbusive=i._isMarkedAbusive(i.notes.abuseType,i.blocked))},_insertStory:function(e,s){var o=this,i=f.getFromCache(e.userId),n=!1,a=this.getStories(),d=r.findIndex(a,function(t){return t.storyId===e.storyId||t.pending&&t.messageId&&t.messageId===e.messageId});if(d>-1&&(e=a[d].update(e),e.pending&&(delete e.pending,e=t.copy(e),a[d]=e,this.updateLatestStory(e)),e.error&&delete e.error,e.processed=!1,n=!0),e=o._processStory(e,i),n)return e.__dupe=!0,e;var u=-1;if(s)if("string"==typeof s){var c=r.findIndex(a,function(e){return e.storyId===s});u=c,a.splice(c,0,e)}else u=0,a.unshift(e);else{var h=a.length;if(h&&!e.pending&&e.created&&a[h-1].created&&e.created<a[h-1].created)for(var l=h-1;l>=-1;){if(-1===l||e.created>a[l].created){u=l+1,a.splice(u,0,e);break}l--}else a.push(e),u=a.length-1}return!o._shouldDisregardMissingStories&&e.storyId.match(/story_.*/)&&a[u]&&a[u-1]&&a[u].nextOldestStoryId&&a[u-1].storyId!==a[u].nextOldestStoryId&&(console.warn("Missing Messages: A new story was inserted that resulted in an gap between in memory messages. Loading missing stories."),o.loadMissingStories()),e},unreadCounter:0,updateUnreadCounter:function(){var e=this;f.getLocalSettings(g.user.userId).then(function(t){var r=t&&t.counter&&t.counter.show&&"all"===t.counter.show;e.unreadCounter=Math.max(0,r?e.numUnread:e.numUnreadMentions)})},setNumUnread:function(e){this.numUnread=e,this.updateUnreadCounter()},setNumUnreadMentions:function(e){this.numUnreadMentions=e,this.updateUnreadCounter()},ensureIntegrations:function(){for(var e,t=this,r=this.getStories(),s=0;s<r.length;++s)e=r[s],e.integrationData&&(e.hideHeader=!1,e.paragraph=!1,e.userId===e.integrationData.integrationId&&e.user||(e.user={userId:e.integrationData.integrationId,orgId:e.orgId||t.orgId,info:{userId:e.integrationData.integrationId,fullName:e.integrationData.integrationName,photoUrl:e.integrationData.integrationIconUrl}},r[s]=t._processStory(e,e.user)))},ensureUsers:function(e,r){var o=this;return e||(e=[]),e.length?f.several(e,!0).then(function(e){t.forEach(e,function(e){var r=o.users?i(o.users,e.userId,null):null;null!==r&&(t.isArray(r)||(r=[r]),t.forEach(r,function(t){switch(e.orgId||(e.orgId=t.orgId),t.role){case"owner":o.owner||(o.owner={userId:t.userId,orgId:t.orgId})}o.users&&o.users.map(function(t){t.userId===e.userId&&(t.info=e.info)})}))});var s=[];s=r?[r]:o.getStories();var n,a,d={};for(a=0;a<e.length;++a)d[e[a].userId]=e[a];for(a=0;a<s.length;++a)(n=d[s[a].userId])&&(s[a]=o._processStory(s[a],n),!0);return f.settleDuplicates(o.users).then(function(){return o})}):s.when(o)},setUsers:function(e){this.users=r.map(e,function(e){var t=f.getFromCache(e.userId);return t||(t={userId:e.userId}),t.orgId=e.orgId,t.role=e.role,t}),this._.roomPresence&&this._.roomPresence.setUsers(r.pluck(this.users,"userId"))},storiesLoaded:!1,refreshed:!1,userLastReadTimestamp:null,getOldestTimestamp:function(){var e=this.getStories(),t=Date.now()+1;if(e.length){t=e[e.length-1].created+1}return t},hasUnread:function(){return this.numUnread>0},updateLastRead:function(e,t){var r=this;if(t=t||"string"==typeof e&&e||"unknownReason",e="boolean"==typeof e&&e,!r.getUser(g.user.userId,g.user.orgId)||!r.active&&!e)return s.when(r.userLastReadTimestamp);if(!e&&!_.isVisible())return s.when(r.userLastReadTimestamp);if(this.numUnread>0){var o=new Date;o=o.getTime()-24*a.rooms.recentDays*60*60*1e3,this.recentTimestamp<o&&(this.keepRecent=!0),this.keepUnread=!0}return r.userLastReadTimestamp=r.getOldestTimestamp(),S.isSudo()?void 0:(this.clearUnread(),d.updateRoomUser({roomId:this.roomId,userId:g.user.userId,orgId:g.user.orgId,updateLastReadReason:t,subscriptionInfo:{updateLastRead:!0}}).then(function(e){e=e||{};var t=new Date(e.lastReadTimestamp);return r.userLastReadTimestamp=t.getTime()||r.getOldestTimestamp(),r.userLastReadTimestamp}))},markRoomAsUnread:function(e){var t=e.created-1,r=this;if(this.numUnread>0){var s=new Date;s=s.getTime()-24*a.rooms.recentDays*60*60*1e3,this.recentTimestamp<s&&(this.keepRecent=!0),this.keepUnread=!0}return this.clearUnread(),d.updateRoomUser({roomId:this.roomId,userId:g.user.userId,orgId:g.user.orgId,updateLastReadReason:"markedUnread",subscriptionInfo:{lastReadTimestamp:t}}).then(function(){return r.userLastReadTimestamp=t,r._calcUserLastReadPreviousTimestamp(),r.userLastReadTimestamp})},readStory:function(e){e.created>this.userLastReadTimestamp&&this.updateLastRead(!0,"readStory"),this._calcUserLastReadPreviousTimestamp(),e.isFirstUnread&&!e.wasRead&&y(function(){e.wasReadAndExpired=!0},5e3),e.wasRead=!0},toggleFavorite:function(){if(!S.isReadOnlyMode()){var e={};return this.isFavorite?(e={event:"click",location:"room nav header",sublocation:"favorite heart icon",timestamp:new Date,userId:g.user.userId,data:[{org_id:g.user.orgId,room_id:this.roomId,action:"room favored",event_label:"room_favored",opening_uid:this.context&&this.context.jobUid,contract_id:this.contractId,contractor_uid:this.context&&this.context.freelancerId}]},w.log(e),L.ga("Rooms","room favorited","",{roomId:this.roomId})):(e={event:"click",location:"room nav header",sublocation:"unfavorite heart icon",timestamp:new Date,userId:g.user.userId,data:[{org_id:g.user.orgId,room_id:this.roomId,action:"room unfavored",event_label:"room_unfavored",opening_uid:this.context&&this.context.jobUid,contract_id:this.contractId,contractor_uid:this.context&&this.context.freelancerId}]},w.log(e),L.ga("Rooms","room unfavorited","",{roomId:this.roomId})),this.setFavorite(!this.isFavorite)}},setFavorite:function(e){var t=this;return this.isFavorite=e,this.favoriteTimestamp=(new Date).getTime(),d.updateRoomUser({roomId:t.roomId,userId:g.user.userId,orgId:g.user.orgId,subscriptionInfo:{isFavorite:e}}).then(function(r){t.isFavorite=e,t.favoriteTimestamp=r.favoriteTimestamp})},setHidden:function(e){var t=this;return this.isHidden=e,d.updateRoomUser({roomId:t.roomId,userId:g.user.userId,orgId:g.user.orgId,subscriptionInfo:{isHidden:e}}).then(function(){t.isHidden=e})},fetchLastRead:function(e){function t(e){return-1===e.lastReadTimestamp?o.updateLastRead("newRoom").then(function(e){return e}):e&&e.lastReadTimestamp?(o.userLastReadTimestamp=e.lastReadTimestamp,e.lastReadTimestamp):void 0}var r,o=this;if(!o.getUser(g.user.userId,g.user.orgId)||e&&o.userLastReadTimestamp>1388556e6)r=s.when(o.userLastReadTimestamp);else{var i={roomId:o.roomId,orgId:g.user.orgId,userId:g.user.userId};S.webApiEnabled()?(P.startMetric("getLastReadWebApi"),r=F.getLastRead(i).then(function(e){return P.endMetric("getLastReadWebApi"),t(e)},function(e){return P.count("getLastReadWebAPIFailure"),P.endMetric("getLastReadWebApi"),console.warn("failed to get last read using web api:",e),d.getLastRead(i).then(t)})):r=d.getLastRead(i).then(t)}return r},notifyTyping:function(){d.$emit("typing",{roomId:this.roomId})},_processStory:function(e,t){return e.integrationData&&e.orgId!==this.orgId&&(e.orgId=this.orgId),e.user=t||e.user,e.user&&e.user.userId&&!e.user.orgId&&(e.user.orgId=e.orgId),e=l.fromData(e)},__setStories:function(e){e=r.uniq(e,"storyId"),this.stories=e;for(var t=0;t<e.length;t++)e[t]=l.fromData(e[t]);return this},getTargetUserName:function(e){var t=this.getTargetUser();return t?s(function(r){t.getInfo().then(function(e){
r(e.fullName)},function(){r(e)})}):s.when(e)},getReadOnlyReason:function(){return!this.isReadOnly||this.isBlockedByTargetUser()?s.when(""):this.isOneOnOne()?this.isBlockingTargetUser()?this.getTargetUserName("this user").then(function(e){return"You have blocked "+e+"."}):s.when("Can't send messages because this room is archived"):s.when("Can't send messages in an archived room")},isImportantRoom:function(){return this.isOneOnOne()||this.isInterviewRoom()||this.isRecruiterRoom()||this.isStarterProjectsRoom()},isInterviewRoom:function(){return this.roomType===M.INTERVIEW},isOneOnOne:function(){return this.roomType===M.ONE_ON_ONE},isGroupRoom:function(){return this.roomType===M.GROUP},isRecruiterRoom:function(){return!!this.recruiterId},isUserRecruiter:function(e){return this.isRecruiterRoom()&&this.recruiterId===e},getTargetUser:function(){return this.targetUserId?(this._targetUser||(this._targetUser=N.create(this.targetUserId,this.targetOrgId)),this._targetUser):null},isBlockedByTargetUser:function(){return this.isOneOnOne()&&f.isBlockedByUser(this.targetUserId)},isBlockingTargetUser:function(){return this.isOneOnOne()&&f.hasBlockedUser(this.targetUserId)},getStories:function(){return this.stories},reProcessStoriesMessage:function(){var e=this.getStories();t.forEach(e,function(e){e.messageHtml=O.parseMessage(e.message,e),O.processObjectReferences(e.objectReferences,e.objectTemplates,e)})},updateStoryCache:function(){var e=this;if(!this.noCache){var t=e.getStories().slice(-a.rooms.storyLimit);b.put(e.roomId,t)}},hasStoriesLoaded:function(){return this.active&&this.storiesLoaded||!this.active&&this.storiesLoaded&&(this.stories&&this.stories.length||b.has(this.roomId))},preloadData:function(){var e=this,t=s.defer();return this.watchStories({next:function(r){r&&(e.storiesLoaded||"fresh_stories"===r.context?(this.unsubscribe(),t.resolve()):"fresh_stories_error"===r.context&&(this.unsubscribe(),t.reject()))}}),t.promise},destruct:function(){this._.cacheStoriesSubscription$&&this._.cacheStoriesSubscription$.unsubscribe()},_lazyStart:function(){var e=this;this._.isHot||(this._.isHot=!0,this._.cacheStoriesSubscription$||(this._.cacheStoriesSubscription$=this._getStoriesObservable().debounce(function(){return o.Observable.interval(1e4)}).subscribe({next:function(){e.updateStoryCache()}})),this.storiesLoaded||this._getStoriesObservable().skipWhile(function(e){return!e||!e.stories||"cached_stories"===e.context&&0===e.stories.length}).first().subscribe({next:function(){e.storiesLoaded=!0,e._calcUserLastReadPreviousTimestamp()}}))},_calcUserLastReadPreviousTimestamp:function(){var e;if(this.active)if(this.stories.length)if(_.isVisible()){if(this.showNewMessages&&-1===this.userLastReadPreviousTimestamp){for(e=this.stories.length-1;e>-1&&this.stories[e].pending;)--e;e>-1&&this.userLastReadTimestamp<this.stories[e].created&&(this.userLastReadPreviousTimestamp=this.userLastReadTimestamp),this.showNewMessages=!1}}else{for(e=this.stories.length-1;e>-1&&this.stories[e].pending;)--e;e>-1&&this.userLastReadTimestamp<this.stories[e].created&&(this.userLastReadPreviousTimestamp=this.userLastReadTimestamp,this.showNewMessages=!0)}else this.userLastReadPreviousTimestamp=-1;else this.userLastReadPreviousTimestamp=-1,this.showNewMessages=!0},reload:function(e){var r=this,s={roomId:this.roomId,returnUsers:!0},o=b.get(this.roomId),i=o&&o.length;return!e&&i||(s.storyLimit=a.rooms.storyLimit,s.returnStories=!0,s.includeNotes=!0),s.includeRoomNote=!0,T(s).then(function(e){return r.setUsers(e.users),r.context=e.context,t.forEach(r.users,function(e){e.id=e.userId+"_"+e.orgId}),r})},setActive:function(){this.active=!0,this._calcUserLastReadPreviousTimestamp(),this._lazyStart()},setInactive:function(){this.active=!1,this.stories.slice(-a.rooms.storyLimit),this._.storiesLoading$.loadingNewer(!1),this._.storiesLoading$.loadingOlder(!1),this._calcUserLastReadPreviousTimestamp(),this.oldestStoryLoaded=!1},toJSON:function(){return r.chain(this).omit(this,["stories","users","invites","admins","firstUnreadStory","fileGroup","keepUnread","keepRecent","_targetUser","targetUserCanBlock","_cacheUpdateDeferred","_storyCacheUpdateTimer","_storyUnloadTimer","latestStoryDisplay","processedLatestTs","dateDisplay","processedRt","lastLatestStoryTimestamp","_","storiesLoaded","isReadOnly","tag","roomNotePresent","roomNote"]).extend({refreshed:!1,active:!1}).value()},initialize:function(){if(this.stories=this.stories||[],this.stories&&this.stories.stories){var e=this.stories.stories;e.reverse(),this.__setStories(e)}this.userLastReadTimestamp=this.userLastReadTimestamp||this.lastReadTimestamp,this.userLastReadPreviousTimestamp=-1,this.sentInvites=[],this.invites=[],this.updateUnreadCounter(),this._={},this._.requestOlderStories$=new o.Subject,this._.requestNewerStories$=new o.Subject,this._.requestStory$=new o.Subject,this._.requestStoriesFromTo$=new o.Subject,this._.storiesLoading$=new o.Subject,this._.storiesLoadingState={older:!1,newer:!1},this._.storiesLoadingDeferred={};var t=this;this._.storiesLoading$.loadingOlder=function(e){t._.storiesLoadingState.older=!!e,t._.storiesLoading$.next(t._.storiesLoadingState)},this._.storiesLoading$.loadingNewer=function(e){t._.storiesLoadingState.newer=!!e,t._.storiesLoading$.next(t._.storiesLoadingState)}},getPresence:function(){return this._.roomPresence?this._.roomPresence.getPresence():"none"},enablePresence:function(){this._.requirePresence=!0,this.initPresence()},initPresence:function(){this._.requirePresence&&!this._.roomPresence&&this.users&&(this._.roomPresence=$.create(this.targetUserId),this._.roomPresence.setUsers(r.pluck(this.users,"userId")))},_getStoriesCacheObservable:function(){var e=this;return o.Observable.defer(function(){return o.Observable.from(b.get(e.roomId)||[])}).concatMap(function(t){return o.Observable.fromPromise(e.addStory(t,null,null,!0))})},_getFreshStoriesObservable:function(){if(!this._.freshStories$){var e=this;this._.freshStories$=o.Observable.defer(function(){var r={roomId:e.roomId,returnUsers:!0,storyLimit:a.rooms.storyLimit,returnStories:!0,includeNotes:!0};r.includeRoomNote=!0;var s=T(r).then(function(r){if(e.setUsers(r.users),e.context=r.context,t.forEach(e.users,function(e){e.id=e.userId+"_"+e.orgId}),r.stories&&!t.isArray(r.stories)){var s=r.stories.stories||[];s.reverse(),e.__setStories(s),e.refreshed=!0}return e.stories});return o.Observable.fromPromise(s)})}return this._.freshStories$},_getNewerStoriesObservable:function(e){var t=this;return o.Observable.defer(function(){return o.Observable.fromPromise(t.loadStories({newerThan:e.newerThan,olderThan:e.olderThan,limit:e.limit},!e.inactiveRoom).then(function(){return t.refreshed=!0,e},function(t){return e.rejectReason=t,s.when(e)}))})},_getNewStoryObservable:function(){if(!this._.newStory$){var e=this;this._.newStory$=j.room(this.roomId).concatMap(function(t){var i;return i=e.hasStoriesLoaded()&&e.refreshed?s.when():e.loadNewerStories(!0,t.created),o.Observable.fromPromise(i.then(function(){return e.addStory(t,e.active).then(function(){return r.last(e.stories)})}))}).multicast(new o.Subject).refCount()}return this._.newStory$},_getUpdatedStoryObservable:function(){if(!this._.updateStory$){var e=this;this._.updateStory$=A.room(this.roomId).concatMap(function(t){return o.Observable.fromPromise(e.updatedStory(t).then(function(e){return e}))}).multicast(new o.Subject).refCount()}return this._.updateStory$},_getStoriesObservable:function(){if(!this._.stories$){var e=new o.BehaviorSubject,t=this,i=o.Observable.create(function(e){t._getStoriesCacheObservable().subscribe({complete:function(){e.next({context:"cached_stories",stories:t.stories})}}),t._getFreshStoriesObservable().subscribe({complete:function(){e.next({context:"fresh_stories",stories:t.stories})},error:function(t){e.next({context:"fresh_stories_error",reason:t})}});var i=t._getNewStoryObservable().subscribe({next:function(r){t.loadMissingStories(!0),_.isVisible()||t._calcUserLastReadPreviousTimestamp(),e.next({context:"new_story",storyId:r.storyId,story:r,stories:t.stories})}}),n=t._getUpdatedStoryObservable().subscribe({next:function(r){e.next({context:"updated_story",storyId:r.storyId,story:r,stories:t.stories})}}),d=t._.requestOlderStories$.concatMap(function(e){return t._.storiesLoading$.loadingOlder(!0),o.Observable.fromPromise(t.loadStories({olderThan:e.olderThan,limit:e.limit},!1,!0).then(function(){return e},function(t){return e.rejectReason=t,s.when(e)}))}).subscribe({next:function(r){t._.storiesLoading$.loadingOlder(!1),e.next({context:"older_stories",stories:t.stories}),r.rejectReason&&r.error?r.error(r.rejectReason):r.done&&r.done()},error:function(e){t._.storiesLoading$.loadingOlder(!1),console.error("Reload required: fatal error loading older stories"),e.error&&e.error(e.rejectReason)}}),u=t._.requestStoriesFromTo$.concatMap(function(e){return o.Observable.fromPromise(function(){var o=function(t){return e.rejectReason=t,s.when(e)};return p({roomId:t.roomId,newerThan:e.from,limit:a.rooms.olderStoriesPageSize+1}).then(function(s){var i=s.stories;return i.length?(i=r.filter(i,function(t){return t.created<e.to}).reverse(),i.length>a.rooms.olderStoriesPageSize&&(i[a.rooms.olderStoriesPageSize]={storyId:"loadMore_"+i[a.rooms.olderStoriesPageSize].storyId,userId:g.user.userId,orgId:g.user.orgId,actionVerb:"_loadMore",objectReferences:[],metadata:{fromTime:i[a.rooms.olderStoriesPageSize-1].created,toTime:e.to},created:i[a.rooms.olderStoriesPageSize-1].created}),t.addStories(i,!0,e.insertBefore).then(function(){return e},o)):i},o)}())}).subscribe({next:function(r){e.next({context:"stories_from_to",stories:t.stories}),r.rejectReason&&r.error?r.error(r.rejectReason):r.done&&r.done()},error:function(e){console.error("Reload required: Fatal error loading range of stories (from => to)"),e.error&&e.error(e.rejectReason)}}),c=t._.requestStory$.concatMap(function(e){return o.Observable.fromPromise(function(){var r=!1,o=0;return p({roomId:t.roomId,cursor:e.storyId,limit:10}).then(function(e){for(var r=e.stories,s=r.length?r[0].created:0,i=0,n=t.stories.length;i<n&&(o=i,!(t.stories[i].created>s));++i);return p({roomId:t.roomId,newerThan:s,limit:10}).then(function(e){var t=e.stories;return r.unshift.apply(r,t),r})}).then(function(i){if(!i.length){var n='Stories around "'+e.storyId+'" could not be loaded';return console.error(n),s.reject(n)}var a=t.stories[o].created;return r=a<i[0].created,r||i.unshift({storyId:"loadMore_"+e.storyId,userId:g.user.userId,orgId:g.user.orgId,actionVerb:"_loadMore",objectReferences:[],metadata:{fromTime:i[0].created,toTime:a},created:i[0].created}),t.addStories(i.reverse(),!0,t.stories[o].storyId).then(function(){return e})}).catch(function(t){return e.rejectReason=t,s.when(e)})}())}).subscribe({next:function(r){e.next({context:"loaded_story",storyId:r.storyId,stories:t.stories}),r.rejectReason&&r.error?r.error(r.rejectReason):r.done&&r.done()},error:function(e){console.error("Reload required: Fatal error loading stories around story:%s",e.storyId),e.error&&e.error(e.rejectReason)}}),h=t._.requestNewerStories$.concatMap(function(e){return t._.storiesLoading$.loadingNewer(!0),t._getNewerStoriesObservable(e)}).subscribe({next:function(r){t._.storiesLoading$.loadingNewer(!1),e.next({context:"newer_stories",stories:t.stories}),r.rejectReason&&r.error?r.error(r.rejectReason):r.done&&r.done()},error:function(e){t._.storiesLoading$.loadingNewer(!1),console.error("Reload required: fatal error loading newer stories"),e.error&&e.error(e.rejectReason)}});return function(){i.unsubscribe(),n.unsubscribe(),d.unsubscribe(),h.unsubscribe(),c.unsubscribe(),u.unsubscribe()}}).concatMap(function(e){return o.Observable.fromPromise(t.ensureUsers().then(function(){return e}))});this._.stories$=i.multicast(e).refCount()}return this._.stories$},watchNewStory:function(e){return this._lazyStart(),"function"==typeof e&&(e={next:e}),this._getNewStoryObservable().subscribe(e)},watchStories:function(e){"function"==typeof e&&(e={next:e});var t=this._getStoriesObservable().subscribe(e);return this._lazyStart(),t},watchStoriesLoading:function(e){return"function"==typeof e&&(e={next:e}),this._.storiesLoading$.subscribe(e)},fileGroup:null,getFileGroup:function(){return this.fileGroup||(this.fileGroup=R.create(this.roomId)),this.fileGroup}},U}();return{create:function(e){var t=new z;return r.assign(t,e),t.initialize(),t}}}])});