define(["./room","angular","lodash","./room-model","./room-collection"],function(e,t,o){"use strict";e.factory("eoRooms",["$rootScope","$cacheFactory","$q","eoRoomModel","eoRoomCollection","eoUsers","eoThriftRoomType","tlRoom","eoTimeInst","eoRoomStoryCache","eoDashConfig","eoAuth","$timeout","eoDashContext","upRoomApi","upDashMetrics",function(e,r,n,i,s,a,u,c,m,d,l,f,p,h,R,g){var b=r("WProoms"),I=function(e,t){for(var o in t)t.hasOwnProperty(o)&&"function"!=typeof t[o]&&null!==t[o]&&-1!==t[o]&&("latestStory"===o&&e.latestStory&&(!t.latestStory||e.latestStory.created>t.latestStory.created)?console.log("current latest story is newer than updated, keeping current as latest"):e[o]=t[o])},v=function(e,r,n){n=t.isUndefined(n)||n,e.roomInfo&&(e.roomInfo.stories=e.stories,e.roomInfo.users=e.users,e=e.roomInfo),o.each(e,function(t,o){o.match("^set[A-Z]|Iterator$|Size$")&&delete e[o]});var s;n?(s=b.get(e.roomId),s?(s.updatedRoom(e),e=s):e=i.create(e)):e=i.create(e),b.put(e.roomId,e),e.latestStory&&(e.latestStory=e._processStory(e.latestStory)),e.lastReadTimestamp&&(e.userLastReadTimestamp=e.lastReadTimestamp);var a=e.latestStory&&(e.latestStory.updated||e.latestStory.created);a&&!e.isReadOnly&&(void 0===e.recentTimestamp||0!==e.recentTimestamp&&a>e.recentTimestamp)&&(e.recentTimestamp=a),e.isHidden&&!e.isReadOnly&&e.userLastReadTimestamp&&a>e.userLastReadTimestamp&&(e.isHidden=!1),t.isString(e.roomType)&&(e.roomType=u[e.roomType]),e.roomType!==u.ONE_ON_ONE&&e.roomType!==u.INTERVIEW||e.setNumUnreadMentions(e.numUnread),n&&(s=b.get(e.roomId),s?(e.recentTimestamp=s.recentTimestamp,t.isArray(e.users)&&!e.users.length&&(e.users=null),I(s,e),e=s,-1===e.numUnread&&(e.numUnread=0,e.numUnreadMentions=0),e.updateUnreadCounter()):(-1===e.numUnread&&(e.setNumUnread(0),e.setNumUnreadMentions(0)),b.put(e.roomId,e)));var c=e.users;return c&&!t.isArray(c)&&(e.users=c.users||[],e.users.total=c.total),t.forEach(e.users,function(e){e.id=e.userId+"_"+e.orgId}),!0===r&&(e.active=!0),!0===r&&e.setActive(),e.roomType!==u.ONE_ON_ONE||e.targetUserId&&e.targetOrgId||!e.users||t.forEach(e.users,function(t){t.userId===f.user.userId&&t.orgId===f.user.orgId||(e.targetUserId=t.userId,e.targetOrgId=t.orgId)}),e},A=function(e){var o=e&&e.rooms,r=[];if(o){var n;t.forEach(o,function(e){n=v(e),r.push(n)})}return r.total=e&&e.total,s.mixInto(r)},M=function(e){return e.roomName?e.roomName:null},w=function(e){return e.topic?e.topic:null},U=function(e){return h.webApiEnabled()?(g.startMetric("getRoomUsingWebApi"),R.getRoom(e).then(function(e){return g.endMetric("getRoomUsingWebApi"),e},function(t){return g.count("getRoomWebAPIFailure"),g.endMetric("getRoomUsingWebApi"),console.warn("failed to fetch room using web api:",t),c.getRoom(e)})):c.getRoom(e)};return function(){var e;return{processRoomData:v,convertToList:A,isUp:function(){return h.webApiEnabled()?(g.startMetric("healthcheckWebApi"),R.healthcheck().then(function(e){return g.endMetric("healthcheckWebApi"),e},function(e){return g.count("healthcheckWebAPIFailure"),g.endMetric("healthcheckWebApi"),console.warn("failed to check health of rooms web api:",e),c.healthcheck()})):c.healthcheck()},search:function(t){function o(){return e=c.getRooms(t).then(function(t){return e=null,A(t)})}return h.webApiEnabled()?(g.startMetric("getRoomsUsingWebApi"),e=R.getRooms(t).then(function(t){return g.endMetric("getRoomsUsingWebApi"),e=null,A(t)},function(e){return g.count("getRoomsWebAPIFailure"),g.endMetric("getRoomsUsingWebApi"),console.warn("failed to fetch rooms using web api:",e),o()})):o()},builder:function(){var e=this;return{params:{id:null,useCache:!0,ensureUsers:!0,ensureStories:!1,makeActive:!1,reuseCacheRef:!0},byId:function(e){return this.params.id=e,this},useCache:function(e){return this.params.useCache=e,this},ensureUsers:function(e){return this.params.ensureUsers=e,this},ensureStories:function(e){return this.params.ensureStories=e,this},makeActive:function(e){return this.params.makeActive=e,this},reuseCacheRef:function(e){return this.params.reuseCacheRef=e,this},get:function(){return e.get(this.params.id,this.params.useCache,this.params.ensureUsers,this.params.ensureStories,this.params.makeActive,this.params.reuseCacheRef)}}},get:function(r,i,s,a,u,c){var f=function(){var e,f;if(m.startMetric(h.webApiEnabled()?"openRoom.webApi.loadRoom":"openRoom.tl.loadRoom"),i&&(f=b.get(r))&&!f.basic&&(!a||f.storiesLoaded&&(f.stories&&f.stories.length||d.has(f.roomId)))&&(!s||f.hasUsers()))u&&f.setActive(),e=n.when(f);else{var p={roomId:r,returnUserTimestamps:!0,returnUsers:!0};m.startMetric("openRoom.cache.loadStories");var R=d.get(r);t.isArray(R)&&R.length>=l.rooms.storyLimit&&function(){var e={};return!o.some(R,function(t){return!t.storyId||(!!e[t.storyId]||void(e[t.storyId]=!0))})}()?p.returnStories=!1:(p.storyLimit=l.rooms.storyLimit,p.returnStories=!0,p.includeNotes=!0,m.endMetric("openRoom.cache.loadStories"),m.callMetric()),p.includeRoomNote=!0,e=U(p).then(function(e){var t=v(e,u,c);return t.basic=!1,m.endMetric(h.webApiEnabled()?"openRoom.webApi.loadRoom":"openRoom.tl.loadRoom"),m.callMetric(),t})}return e=e.then(function(e){return e.userLastReadTimestamp?(m.startMetric("openRoom.tl.fetchLastRead"),e.fetchLastRead(!1).then(function(t){e.userLastReadTimestamp=t,m.endMetric("openRoom.tl.fetchLastRead"),m.callMetric()}),e):e.fetchLastRead(!1).then(function(t){return e.userLastReadTimestamp=t,e},function(){return e})})};return e?e.then(f,f):f()},getDetailed:function(e,t){return this.get(e,!0,!0,!0,t)},getInfo:function(e,t){var o;return m.startMetric("openRoom.cache.loadRoom"),m.startMetric(h.webApiEnabled()?"openRoom.webApi.loadRoom":"openRoom.tl.loadRoom"),!t&&b.get(e)?(o=n.when(b.get(e)),m.endMetric("openRoom.cache.loadRoom"),m.callMetric()):o=U({roomId:e}).then(function(e){var t=v(e);return t.basic=!0,m.endMetric(h.webApiEnabled()?"openRoom.webApi.loadRoom":"openRoom.tl.loadRoom"),m.callMetric(),t}),o},getRoomUsers:function(e){return U({roomId:e,returnUsers:!0}).then(function(e){return e.users})},getRoomInfoRaw:function(e){return U({roomId:e}).then(function(e){return e})},getFromCache:function(e){return b.get(e)},removeFromCache:function(e){return p(function(){d.remove(e),b.remove(e)}),!0},purgeCache:function(e){d.purge(e)},create:function(e){function t(e){var t=v(e);return t.targetUserId&&t.ensureUsers([t.targetUserId]),t}var o={roomRequest:e};return h.webApiEnabled()?(g.startMetric("newRoomUsingWebApi"),R.newRoom(o).then(function(e){return g.endMetric("newRoomUsingWebApi"),t(e)},function(e){return g.count("newRoomWebAPIFailure"),g.endMetric("newRoomUsingWebApi"),console.warn("failed to create room using web api:",e),c.newRoom(o).then(t)})):c.newRoom(o).then(t)},reorderFavorites:function(e){function r(o){var r={};t.forEach(o.rooms,function(e){r[e.roomId]=e.favoriteTimestamp}),t.forEach(e,function(e){e.favoriteTimestamp=r[e.roomId]})}var n=o.map(e,function(e){return e.roomId}),i={roomList:{roomIds:n}};return h.webApiEnabled()?(g.startMetric("reorderFavoritesWebApi"),R.reorderFavorites(i).then(function(e){return g.endMetric("reorderFavoritesWebApi"),r(e)},function(e){return g.count("reorderFavoritesWebAPIFailure"),g.endMetric("reorderFavoritesWebApi"),console.warn("failed to reorder favorite rooms using web api:",e),c.reorderFavorites(i).then(r)})):c.reorderFavorites(i).then(r)},getDirectRoomId:function(e,t,o){var r={userId:e,orgId:t,onlyRoomId:!0};void 0!==o&&(r.createRoom=!!o);var i=n.defer();return h.webApiEnabled()?(g.startMetric("getOneOnOneRoomUsingWebApi"),R.getOneOnOneRoom(r).then(function(e){g.endMetric("getOneOnOneRoomUsingWebApi"),i.resolve(e&&e.roomId)},function(e){g.count("getOneOnOneRoomUsingWebAPIFailure"),g.endMetric("getOneOnOneRoomUsingWebApi"),console.warn("failed to fetch one on one room using web api:",e),c.getOneOnOneRoom(r).then(function(e){i.resolve(e&&e.roomId)},function(e){i.reject(e)})})):c.getOneOnOneRoom(r).then(function(e){i.resolve(e&&e.roomId)},function(e){i.reject(e)}),i.promise},getDirectRoom:function(e,t,o){var r=n.defer();return this.getDirectRoomId(e,t,o).then(function(e){e?r.resolve(e):r.reject()},function(e){r.reject(e)}),r.promise},isSubscribed:function(e){m.startMetric("openRoom.tl.getLastRead");var t={roomId:e,orgId:f.user.orgId,userId:f.user.userId},o=null;return h.webApiEnabled()?(g.startMetric("getLastReadWebApi"),o=R.getLastRead(t).then(function(e){return g.endMetric("getLastReadWebApi"),e},function(e){return g.count("getLastReadWebAPIFailure"),g.endMetric("getLastReadWebApi"),console.warn("failed to get last read using web api:",e),c.getLastRead(t)})):o=c.getLastRead(t),o.then(function(){return m.endMetric("openRoom.tl.getLastRead"),m.callMetric(),!0},function(){return!1})},settleDuplicates:function(e,t,o){var r,n,i={};for(t||(t=M),o||(o=w),r=0;r<e.length;++r)(n=t(e[r]))&&(e[r].tag||(e[r].tag=o(e[r])),i[n]||(i[n]=[]),i[n].push(r));for(r in i)i[r].length<2&&(e[i[r][0]].tag="");return e}}}()}])});