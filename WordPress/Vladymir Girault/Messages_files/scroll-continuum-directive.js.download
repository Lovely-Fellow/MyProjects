define(["./common","angular","resizeObserverPonyfill","lodash","jquery"],function(t,e,n){"use strict";t.directive("eoScrollContinuum",["$log",function(o){return{restrict:"EA",transclude:!0,replace:!0,scope:!0,templateUrl:function(){return t.templatePath+"scroll-continuum-directive.html"},controllerAs:"scrollContinuum",link:function(t){t.scrollContinuum.init()},controller:["$scope","$element","$attrs","$window","$timeout","eoMutationObserver","$interval","$q",function(t,i,l,r,s,u,c,a){function h(t){t=t||p.viewportMeasurements.contentBoundingClientRect.height,t>p.viewportMeasurements.offsetHeight?p.enableFullContentMode():p.enableMinimalContentMode()}var f,m,d=i.find(".viewport"),C=d[0],v=d.find(".content"),g=v[0],p=this;this.hasStickyBottom=!1,this.viewportMeasurements={},this.visualContentCenter={},this.isMinimalContentMode=null;var w={left:1,top:35};this.setVisibilityOffset=function(t){w.left=t.left,w.top=t.top},this.getFirstVisibleElement=function(){if(this.isMinimalContentMode)return v.find(":first :first")[0];var t=d.offset();if(t)return r.document.elementFromPoint(t.left+w.left+4,t.top+w.top)},this.getLastVisibleElement=function(){if(this.isMinimalContentMode)return v.find(":first :last")[0];var t=d.offset();if(t)return r.document.elementFromPoint(t.left+5,t.top+d.innerHeight()-1)};var M=a.defer();this.ready=function(){return M.promise},this.userScrollEventName=l.emitOnUserScroll?t.$eval(l.emitOnUserScroll):"scrollContinuum:userScroll",this.topCollisionEventName=l.emitOnTopCollision?t.$eval(l.emitOnTopCollision):"scrollContinuum:topCollision",this.bottomCollisionEventName=l.emitOnBottomCollision?t.$eval(l.emitOnBottomCollision):"scrollContinuum:bottomCollision",this.loadingMessage=l.loadingMessage&&t.$eval(l.loadingMessage)||"Loading...",l.prevContentLoading&&l.$observe("prevContentLoading",function(t){p.prevContentLoading="true"===t}),l.nextContentLoading&&l.$observe("nextContentLoading",function(t){p.nextContentLoading="true"===t}),this.enableStickyBottom=function(){p.hasStickyBottom=!0,p.correctScrollPositioning()},this.disableStickyBottom=function(){p.hasStickyBottom=!1};var b=function(){t.$emit(p.topCollisionEventName),p._lastWheelEvent=null},S=function(){t.$emit(p.bottomCollisionEventName),p._lastWheelEvent=null},B=function(t){t=t||C.getBoundingClientRect();var e=t.height/2+t.top,n=r.document.elementFromPoint(t.left+t.width/2,e),o={};if(n&&n!==C&&n!==g){var i=n.getBoundingClientRect();o={element:n,height:i.height,top:i.top},i=null}return o},y=function(){p.viewportMeasurements=T()},E=function(){p.visualContentCenter=B(p.viewportMeasurements.viewportBoundingClientRect)},T=function(){m=g.getBoundingClientRect(),f=C.getBoundingClientRect();var t={offsetHeight:f.height,scrollTop:C.scrollTop,scrollHeight:m.height};return t.viewportBoundingClientRect=f,t.contentBoundingClientRect=m,t};this.getVisualContentCenterElement=function(){return this.visualContentCenter.element},this.scrollTo=function(t){if(!t)return void o.warn("Element to scroll to must be specified");var n=e.element(t);if(t=n[0],d[0]!==n.offsetParent()[0])return void o.warn('The "scroll to" Element is not a child of the viewport');var i=C.getBoundingClientRect(),l=i.height/2+i.top;p.visualContentCenter.element=t;var r=t.getBoundingClientRect();p.visualContentCenter.height=r.height,p.visualContentCenter.top=r.top,r=null;var s=l-p.visualContentCenter.height/2;s=s>i.top?s:i.top,p.visualContentCenter.top=s;var u=p.hasStickyBottom;p.disableStickyBottom(),p.correctScrollPositioning(),u&&p.isAtBottom()&&p.enableStickyBottom()},this.correctScrollPositioning=function(t){var e;if(!p.isMinimalContentMode){if(p.hasStickyBottom){if((t=t||k())-C.offsetHeight<=C.scrollTop)return;e=t}else if(p.visualContentCenter.element){e=C.scrollTop;var n=p.visualContentCenter.element.getBoundingClientRect();if(e+=n.top-p.visualContentCenter.top,n=null,(e=e<=0?0:e)===C.scrollTop)return}return d.css("-webkit-overflow-scrolling","auto"),p.viewportMeasurements.scrollTop=C.scrollTop=e,d.css("-webkit-overflow-scrolling","touch"),this}},this.isAtTop=function(){return this.isNearTop(0)},this.isNearTop=function(t){return C.scrollTop<=t},this.isAtBottom=function(){return this.isNearBottom(0)},this.isNearBottom=function(t){return C.scrollTop>=Math.floor(p.viewportMeasurements.scrollHeight-p.viewportMeasurements.offsetHeight-t)},this.detectScrollCollision=function(){!this.isAtTop()||this.wasScrolling()&&!this.wasScrollingTowardTop()?this.hasStickyBottom||!this.isAtBottom()||this.wasScrolling()&&!this.wasScrollingTowardBottom()||S():b()},this.triggerUserScroll=function(){p.hasStickyBottom&&!p.isAtBottom()&&p.disableStickyBottom(),E(),p.detectScrollCollision(),t.$emit(p.userScrollEventName)},this.triggerVisibilityChange=function(){t.$emit("scrollContinuum:visibilityChange",this.getFirstVisibleElement(),this.getLastVisibleElement())},this.enableFullContentMode=function(){!1!==p.isMinimalContentMode&&(p.isMinimalContentMode=!1,v.removeClass("minimal-content"),p.correctScrollPositioning())},this.enableMinimalContentMode=function(){!0!==p.isMinimalContentMode&&(p.isMinimalContentMode=!0,v.addClass("minimal-content"))},this.updateContentMode=function(){y(),h()};var $,k=function(){return g.getBoundingClientRect().height},O=function(){return u.supported},P=function(){if(!$){if(!O())throw new Error('"window.MutationObserver" is not supported');$=u(function(t){var e=!1;p.isMinimalContentMode&&p.triggerVisibilityChange();for(var n=0;n<t.length;n++)if("childList"===t[n].type||"subtree"===t[n].type){e=!0;break}e&&(p.correctScrollPositioning(),p.updateContentMode())})}return $};this.enableContentMutationObserver=function(){var t=v.find("> :first-child")[0];return P().observe(t,{childList:!0,subtree:!0}),this},this.disableContentMutationObserver=function(){return $&&($.disconnect(),$=null),this},p.enableMinimalContentMode();var R=!1,L=0;p.clearUserInteraction=function(){L=0},d.on("mousedown",function(t){R=t.target===d[0]}),d.on("mouseup",function(){R=!1}),d.on("scroll",function(){R&&(L=Date.now()),Date.now()-L<300&&(L=Date.now(),p.triggerUserScroll()),p.triggerVisibilityChange()}),d.on("touchstart",function(){L=Date.now()}),d.on("touchend",function(){L=Date.now()}),d.on("touchmove",function(){L=Date.now()}),d.on("mousewheel",function(t){L=Date.now(),p._lastWheelEvent=t}),this.wasScrollingTowardTop=function(){return!!p._lastWheelEvent&&p._lastWheelEvent.deltaY>0},this.wasScrollingTowardBottom=function(){return!!p._lastWheelEvent&&p._lastWheelEvent.deltaY<0},this.wasScrolling=function(){return!!p._lastWheelEvent},d.on("keydown keyup",function(t){-1!==[33,34,38,40].indexOf(t.keyCode)&&(L=Date.now())});var N=function(){p.correctScrollPositioning(),p.updateContentMode()},V=function(){p.updateContentMode(),p.enableContentMutationObserver();var e=new n(N);e.observe(C),t.$on("$destroy",function(){e.unobserve(C),e.disconnect(),C=null,e=null}),t.$emit("scrollContinuum:init"),d.css("-webkit-overflow-scrolling","touch"),M.resolve(!0)};this.init=function(){p.init=e.noop(),V()},t.$on("$destroy",function(){i.empty(),d.off(),v.off(),p.disableContentMutationObserver(),p.visualContentCenter.element=p.visualContentCenter=p.viewportMeasurements=p.updateContentMode=p._lastWheelEvent=g=v=d=null,b=S=B=y=E=T=k=O=P=N=V=e.noop})}]}}])});