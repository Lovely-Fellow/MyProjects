define(["angular","lodash","ui.router"],function(e,r){"use strict";var t=e.module("eoRoomsSearch",["ui.router","eoSearch","eoRooms"]);return t.config(["$stateProvider",function(e){e.state("rooms.search",{abstract:!0,url:"/search?q=:query",resolve:{query:["$stateParams",function(e){return e.query}]},controller:"roomsSearchCtrl",templateUrl:"@templates/rooms/rooms-search/rooms-search.html"}).state("rooms.search.results",{url:"/results?section",params:{section:"message",page:1,limit:20},controller:"roomsSearchResultsCtrl",templateUrl:"@templates/rooms/rooms-search/rooms-search-results.html"})}]).controller("roomsSearchCtrl",["$scope","$stateParams","eoSearch",function(r,t,o){r.countDone=!1,r.query=t.query;var s=function(){r.error="error"},a=function(){r.countDone=!0},n={contact:"People",interviewRoom:"Interviews",room:"Groups",message:"Messages"};r.tabs=[];var l=function(){var t=[];e.forEach(n,function(e,o){(r.resultCount[o]>0||"message"===o)&&t.push({section:o,active:r.section===o,name:e,count:r.resultCount[o]})}),r.tabs=t};o.getSearchResults(r.query,"contact",1,0).then(function(e){r.resultCount={contact:e.total,room:e.relatedTotal.room,interviewRoom:e.relatedTotal.interviewRoom,message:e.relatedTotal.message},l()},s).finally(a),r.toggleRooms(!0),r.$on("searchResultsUpdated",function(e,t){r.resultCount={contact:t.contact,room:t.room,interviewRoom:t.interviewRoom,message:t.message},r.section=t.section,l()})}]).controller("roomsSearchResultsCtrl",["$scope","$stateParams","eoSearch","eoUsers","$state","emojione","eoAuth","eventLog","$window","$exceptionHandler","$timeout","eoGoogleAnalytics",function(t,o,s,a,n,l,i,c,u,m,f,d){function p(e){if(!e)return"";var r,t=e.term?e.term+" ":"",o=["in","from","after","before"];for(r=0;r<o.length;r++)e[o[r]]&&(t+=o[r]+":",t+="in"===o[r]||"from"===o[r]?'"'+e[o[r]]+'"':e[o[r]]);return t}function g(e,r){r=r||" ";var t=new RegExp("^["+r+"]*"),o=new RegExp("["+r+"]*$");return e=e.replace(t,"").replace(o,"")}var h={itemsPerPage:20};t.query=o.query,t.section=o.section,t.pagination={currentPage:o.page||1,itemsPerPage:o.limit||h.itemsPerPage},t.showLoader=!1,t.filters={rooms:[{roomName:"Any room"}],users:[{fullName:"Everyone"}]},t.flrs=function(e){var t={in:[],from:[],after:[],before:[]},o=[],s=e.split(/(\b(?:in|from|after|before):\s*(?:"[^"]*"|[^ ]*))/g);r.each(s,function(e){var r=e.split(":");t.hasOwnProperty(r[0].trim())?t[r[0].trim()].push(g(r.slice(1).join(":"),' "')):o.push(e.trim())});var a={term:o.join(" ")};for(var n in t)a[n]=t[n].join(" ");return a}(t.query),t.selectedRoomName=t.flrs.in||"",t.custom={},t.selectedUserFullName=t.flrs.from||"",t.flrs.before?t.datepickerBeforeDate=new Date(parseInt(t.flrs.before)):t.datepickerBeforeDate=null,t.flrs.after?t.datepickerAfterDate=new Date(parseInt(t.flrs.after)):t.datepickerAfterDate=null,t.opened=!1,t.dateOptions={formatYear:"yy",startingDay:1},t.executeSearch=function(){var r=u.localStorage.getItem("searchRequestId")||null,o=function(){t.searchDone=!0,t.error="error"};s.getSearchResults(t.query,t.section,t.pagination.itemsPerPage,t.pagination.currentPage-1,r).then(function(r){return a.settleDuplicates(r.records,function(e){return"contact"!==e.type||"contact"===e.type&&e.metaData.roomType?null:e.metaData.firstName.stringVal},function(e){return e.metaData.orgId.stringVal},function(e){return e.metaData.legacyId.stringVal}).then(function(){t.results=r;var o,s,n,m;for(o=0;o<t.results.records.length;++o)if(n=t.results.records[o],"message"===n.type){if(!n.snippet)continue;for(s=0;s<n.snippet.length;++s)m=n.snippet[s],m.message&&(m.message=l.toImage(m.message))}for(t.allUserIds=[],t.allUsersHash={},s=0;s<t.results.records.length;s++)if("message"===t.results.records[s].type)for(o=0;o<t.results.records[s].snippet.length;o++)-1===t.allUserIds.indexOf(t.results.records[s].snippet[o].userId)&&t.allUserIds.push(t.results.records[s].snippet[o].userId);a.several(t.allUserIds,!0).then(function(e){for(var r=0;r<e.length;r++)t.allUsersHash[e[r].userId]=e[r];for(r=0;r<t.results.records.length;r++)if("message"===t.results.records[r].type)for(o=0;o<t.results.records[r].snippet.length;o++){var s=t.results.records[r].snippet[o].userId;t.results.records[r].snippet[o].user=t.allUsersHash[s].info.fullName}}),t.$emit("searchResultsUpdated",{contact:"contact"===t.section?t.results.total:t.results.relatedTotal.contact,room:"room"===t.section?t.results.total:t.results.relatedTotal.room,interviewRoom:"interviewRoom"===t.section?t.results.total:t.results.relatedTotal.interviewRoom,message:"message"===t.section?t.results.total:t.results.relatedTotal.message,section:t.section}),t.searchDone=!0;try{u.localStorage.setItem("searchRequestId",t.results.requestId)}catch(e){console.error(e)}if(1===t.pagination.currentPage){var f={event:"impression",location:"dash_home",sublocation:"main_search_results",timestamp:new Date,userId:i.user.userId,data:[{search_request_id:u.localStorage.getItem("searchRequestId"),query:t.query,org_id:i.user.orgId,section_name:t.section}]};c.log(f)}e.element(".search-results").scrollTop(0)})},o)},f(function(){t.searchDone=!1,f(function(){t.searchTakingLong=!0},300),t.executeSearch()}),t.filterAfter=function(){u.setTimeout(function(){var r=e.element("#datepicker-after").val();if(r){var o=new Date(r);o=o.getTime()+6e4*o.getTimezoneOffset(),t.flrs.after?t.query=t.query.replace(/\safter:[^\s\\]*/," after:"+o):t.query+=" after:"+o}else t.query=t.query.replace(/\safter:[^\s\\]*/,"");n.go("rooms.search.results",{query:t.query,section:t.section,page:1})},10)},t.filterBefore=function(){u.setTimeout(function(){var r=e.element("#datepicker-before").val();if(r){var o=new Date(r);o=o.getTime()+6e4*o.getTimezoneOffset(),t.flrs.before?t.query=t.query.replace(/\sbefore:[^\s\\]*/," before:"+o):t.query+=" before:"+o}else t.query=t.query.replace(/\sbefore:[^\s\\]*/,"");n.go("rooms.search.results",{query:t.query,section:t.section,page:1})},10)},t.filterUser=function(e){t.selectedUserFullName=e,t.flrs.from=e,"Everyone"===e&&delete t.flrs.from,t.query=p(t.flrs),n.go("rooms.search.results",{query:t.query,section:t.section,page:1})},t.autoCompleteUser=function(e){t.$apply(function(){t.showLoader=!0}),s.browse(e,"people",10).then(function(o){r.remove(t.filters.users,void 0),r.each(o.records,function(e){t.filters.users.push({fullName:e.user.info.fullName})}),i.user.fullName.trim().toUpperCase().includes(e.trim().toUpperCase())&&!r.some(t.filters.users,{fullName:i.user.fullName})&&t.filters.users.push({fullName:i.user.fullName}),t.filters.users.unshift({fullName:"Everyone"})}).finally(function(){t.showLoader=!1})};var y=r.debounce(t.autoCompleteUser,300,{maxWait:800});t.filterCustomUser=function(e){e&&(t.custom.userFullName=e,t.custom.userFullName||t.autoCompleteUser(t.custom.userFullName),y(t.custom.userFullName))},t.filterRoom=function(e){t.selectedRoomName=e,t.flrs.in=e,"Any room"===e&&delete t.flrs.in,t.query=p(t.flrs),n.go("rooms.search.results",{query:t.query,section:t.section,page:1})},t.autoCompleteRoom=function(e){t.$apply(function(){t.showLoader=!0}),s.browse(e,"allrooms",10).then(function(e){r.remove(t.filters.rooms,void 0),r.each(e.records,function(e){"oneToOneRoom"===e.type||"contact"===e.type?t.filters.rooms.push({roomName:e.user.info.fullName}):t.filters.rooms.push({roomName:e.metaData.roomName.stringVal})}),t.filters.rooms.unshift({roomName:"Any room"})}).finally(function(){t.showLoader=!1})};var v=r.debounce(t.autoCompleteRoom,300,{maxWait:800});t.filterCustomRoom=function(e){e&&(t.custom.roomName=e,t.custom.roomName||t.autoCompleteRoom(t.custom.roomName),v(t.custom.roomName))},t.goToStory=function(r){r.metaData&&r.metaData.roomId&&r.metaData.storyId&&t.open(r.metaData.roomId.stringVal,r.metaData.storyId.stringVal);try{t.logClick({section:t.section,rank:e.element('.list>.result[value="'+r.id+'"]').attr("rank"),id:r.metaData.storyId.stringVal})}catch(e){m(e)}},t.goToRoom=function(r){t.open(r.metaData.roomId.stringVal);try{t.logClick({section:t.section,rank:e.element('.list>.result[value="'+r.id+'"]').attr("rank"),id:r.metaData.roomId.stringVal})}catch(e){m(e)}},t.goToContactRoom=function(r){r.metaData.roomId?t.open(r.metaData.roomId.stringVal):t.openContact(r.metaData.userId.stringVal,r.metaData.orgId.stringVal);try{t.logClick({section:t.section,rank:e.element('.list>.result[value="'+r.id+'"]').attr("rank"),id:r.metaData.userId.stringVal})}catch(e){m(e)}},t.logClick=function(e){var r={event:"click",location:"dash_home",sublocation:"main_search_results",timestamp:new Date,userId:i.user.userId,data:[{search_request_id:u.localStorage.getItem("searchRequestId"),query:t.query,org_id:i.user.orgId,section_name:e.section,clicked_rank:e.rank,doc_id:e.id,event_label:"select_srch_result"}]};c.log(r),d.ga("Search","search result clicked","from search page")};var q=t.$watch("pagination.currentPage",function(e,r){e!==r&&t.executeSearch()});t.$on("$destroy",function(){q()})}]).directive("eoUiSelectExtender",["$timeout","eoBreakpoint",function(e,r){return{require:"uiSelect",link:function(t,o,s,a){e(function(){o.querySelectorAll(".ui-select-dropdown").prepend('<a class="back-toggle toggle-filter-btn"href="javascript:void(0)"><span aria-hidden="true" class="glyphicon air-icon-arrow-prev"></span>Back</a>'),o.querySelectorAll(".ui-select-dropdown").prepend('<div class="search-result-loader"><div class="search-result-wrapper"><span class="glyphicon glyphicon-lg air-icon-loading vertical-align-middle"></span></div></div>');var e=o.querySelectorAll("a.ui-select-match"),t=o.querySelectorAll("input.ui-select-search"),n=o.querySelectorAll("a.toggle-filter-btn"),l=o.querySelectorAll(".search-result-loader");e.bind("click",function(){a.open&&(s.searchContainerPlaceholder&&t&&(t[0].placeholder=s.searchContainerPlaceholder),s.searchContainerAutofocus&&t&&t[0].focus())}),n.bind("click",function(e){a.toggle(e)}),s.$observe("showLoadingSpinner",function(){r.smDown&&("true"===s.showLoadingSpinner?l.css("display","block"):l.css("display","none"))})})}}}]),t});