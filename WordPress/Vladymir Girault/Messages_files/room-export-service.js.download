define(["./room","angular"],function(e,t){"use strict";e.factory("eoRoomExport",["$window","$interpolate","$q","$log","$rootScope","$sce","$compile","$timeout","$filter","eoModal","eoRoomModel","eoRooms","eoFiles","eoAlert",function(o,r,n,a,i,s,l,c,d,u,m,p,f,h){function g(e,t){var o=n.defer();y.total++;var r=t?"DASH":null,a={};return e.metadata.afs?(a.fileId=e.metadata.fileId,a.afs=!0):a={spaceId:e.metadata.spaceId,fileId:e.metadata.fileId,fileName:e.metadata.fileName},f.createSharedFileLink(a,r).then(function(r){t?(e.trustedImageUrl=s.trustAsResourceUrl(r),e.metadata.imageUrl=r):(e.trustedObjectUrl=s.trustAsResourceUrl(r),e.metadata.objectUrl=r),y.current++,o.resolve({})}).catch(function(){y.current++,o.resolve({})}),o.promise}function w(e){var o=[];return y.total=0,y.current=0,y.step="Processing attachments",t.forEach(e.stories,function(e){t.forEach(e.objectReferences,function(e){if("eo:file"===e.objectType){if(!e.metadata.fileId)return;o.push(g(e,!1)),e.metadata.imageUrl&&o.push(g(e,!0))}})}),n.all(o)}var y=i.$new();y.$watchGroup(["current","total"],function(){y.progress=0===y.total?0:Math.floor(y.current/y.total*100)});var v=function(e,t,o,r,n,a){c(function(){var s=o.slice(a,a+200);if(0===s.length)return e.resolve({});var c=i.$new();c.room=t,c.showHistory=n,c.room.stories=s;var d=l("<div eo-room-story-export></div>")(c),u=(new Date).getTime();c.$digest();var m=(new Date).getTime();console.log("digest took ",m-u),r.append(d.html()),d.remove(),c.$destroy(),a+=200,e.notify({current:a,total:o.length})}).then(function(){v(e,t,o,r,n,a)})},$=function(e,t,o,r){var a=n.defer();return v(a,e,t,o,r,0),a.promise};return{export:function(i,s){var l=this;y.step="Loading messages",y.total=0,y.current=0;var c=u.custom({templateUrl:e.templatePath+"room-export-dialog.html",scope:y,keyboard:!1,windowClass:"modal-compact"});p.builder().byId(i).useCache(!1).ensureStories(!1).reuseCacheRef(!1).get().then(function(e){e.loadAllStories().then(function(){return l.processStories(e)},function(e){return a.warn(e),h.inline({type:"danger",template:"Could not fetch all messages, export aborted"}),c.dismiss(""),n.reject(e)},function(e){y.total=e.total,y.current=e.current}).then(function(){y.step="Generating report",y.total=e.stories.length,y.current=1;var n=e.stories.slice(0),i=t.element("<div/>");i.append("<h3>"+e.roomName+"</h3>"),e.topic&&i.append("<h4>"+e.topic+"</h4>"),i.append('<span class="text-muted">Exported on '+d("date")((new Date).getTime(),"MM-dd-yyyy h:mm:ss a")+"</span>"),l.generate(e,n,i,s).then(function(){var e=o.open();if(!e)return h.inline({type:"danger",template:"Could not open new window, please check if your pop windows are blocked"}),void c.dismiss("");e.document.write("<html class=export><head><title>Export</title>"),t.forEach(t.element("head").find("link"),function(t){e.document.write(r('<link rel="{{rel}}" href="{{href}}" type="{{type}}" />')({href:t.href,rel:t.rel,type:t.type}))}),e.document.write('<body class="export">'),t.element(e.document.body).append(i),e.document.write("</body>"),e.document.write("</head>"),e.document.write("</html>"),e.document.close(),c.close()},function(e){a.warn(e),h.inline({type:"danger",template:"There was an error exporting the messages"}),c.dismiss("")},function(e){y.total=e.total,y.current=e.current})})})},processStories:w,generate:$}}])});